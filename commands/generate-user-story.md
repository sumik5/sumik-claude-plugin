# /generate-user-story コマンド

## 目的
Webアプリケーションのコードを分析し、ユーザーストーリードキュメント（`docs/user-story.md`）とE2Eテストケースドキュメント（`docs/e2e.md`）を作成または更新します。

## 実行手順

### 1. 事前確認
1. プロジェクトのルートディレクトリで実行されていることを確認
2. Webアプリケーションのプロジェクトであることを確認（Next.js、React、Express等）

### 2. 既存ドキュメントの確認
1. `docs/user-story.md` が存在するかチェック
   - **存在する場合**: ファイルを読み込み、既存のユーザストーリーを把握し、それをベースに更新
   - **存在しない場合**: 一からユーザストーリーを作成
2. `docs/e2e.md` が存在するかチェック
   - **存在する場合**: ファイルを読み込み、既存のE2Eテストケースを把握し、それをベースに更新
   - **存在しない場合**: 一からE2Eテストケースを作成

### 3. コードベース分析
以下の情報を収集してユーザーストーリーを作成します：

1. **プロジェクト構造の理解**
   - ディレクトリ構造を確認（`app/`, `pages/`, `src/`, `components/` 等）
   - ルーティング構造の把握

2. **認証・認可の確認**
   - 認証機能の有無（Keycloak、NextAuth、Firebase Auth等）
   - ユーザーロールやペルソナの特定

3. **主要機能の特定**
   - ページやコンポーネントから主要な機能を抽出
   - API エンドポイントやデータモデルの確認
   - フォーム、リスト、詳細ページ等の特定

4. **データフローの理解**
   - データベーススキーマ（Prisma schema、migration files等）
   - API ルート（`/api/` 配下のファイル等）
   - 状態管理の仕組み（Zustand、Redux、Context等）

### 4. ユーザーストーリードキュメント作成（`docs/user-story.md`）

参考形式: `/Users/sumik/repo/catenas-g/shinshu-educational-platform/next-app/docs/user-story.md`

以下の構造でドキュメントを作成：

#### 必須セクション
1. **ユーザーペルソナ**
   - 主要なユーザーロールを特定（管理者、一般ユーザー、ゲスト等）
   - 各ペルソナの役割、認証方法、主な活動を記述

2. **主要なユーザーストーリー**
   - 各ペルソナごとにユーザーストーリーを作成
   - フォーマット:
     ```
     #### US-[ペルソナ略称][番号]: [ストーリータイトル]

     **As a** [ユーザーロール]
     **I want to** [実現したいこと]
     **So that** [得られる価値・理由]

     **受入基準**:
     - [具体的な基準1]
     - [具体的な基準2]
     ...
     ```

3. **ユーザーフロー図**
   - Mermaid記法でフローチャートを作成
   - 各ペルソナごとのフローを図示
   - 全体フロー（複数ペルソナ間の連携）も図示

4. **画面遷移フロー**
   - ページパス、説明、遷移先、遷移条件を表形式で記述
   - Mermaid記法で遷移図を作成

5. **データフロー**
   - 状態遷移図（Mermaid stateDiagram-v2）
   - データモデル間の関係（Mermaid erDiagram）
   - シーケンス図（Mermaid sequenceDiagram）

6. **非機能要件**
   - セキュリティ要件
   - パフォーマンス要件
   - 可用性要件
   - 保守性要件

7. **今後の拡張予定**
   - 実装予定の機能やコメントで見つかったTODO項目をリストアップ

### 5. E2Eテストケースドキュメント作成（`docs/e2e.md`）

ユーザーストーリーに基づいて、E2Eテストケースを作成：

#### 必須セクション
1. **テスト戦略**
   - テストの目的とスコープ
   - 使用するツール（Playwright、Cypress等）
   - テスト環境の説明

2. **テストケース一覧**
   - 各ユーザーストーリー（US-XX）に対応するテストケースを作成
   - フォーマット:
     ```
     ### TC-[ペルソナ略称][番号]: [テストケース名]

     **対応ユーザーストーリー**: US-[XX]

     **前提条件**:
     - [前提条件1]
     - [前提条件2]

     **テストステップ**:
     1. [ステップ1]
     2. [ステップ2]
     3. [ステップ3]

     **期待結果**:
     - [期待される結果1]
     - [期待される結果2]

     **優先度**: High/Medium/Low
     ```

3. **クリティカルパステスト**
   - 最も重要なユーザーフロー
   - 必ず成功すべきテストケースを明示

4. **エッジケースとエラーハンドリング**
   - 異常系のテストケース
   - バリデーションエラー、ネットワークエラー等

5. **パフォーマンステスト**
   - 応答時間の確認
   - 大量データでの動作確認

6. **テスト実行計画**
   - CI/CDでの自動実行
   - 手動テストが必要な項目
   - テストカバレッジ目標

### 6. 出力とフィードバック
1. `docs/user-story.md` を作成または更新
2. `docs/e2e.md` を作成または更新
3. ユーザーに以下を報告:
   - 特定したペルソナ数
   - 作成したユーザーストーリー数
   - 作成したE2Eテストケース数
   - 主要な機能の要約

## 注意事項
- 既存ファイルがある場合は、その内容を尊重し、不足している部分を追加する形で更新
- コードから推測できない部分は合理的な仮定を記述し、コメントで明示
- Mermaid図は正確な記法を使用
- ユーザーストーリーは具体的で測定可能な受入基準を含める
- E2Eテストケースは実装可能な具体的なステップを記述
