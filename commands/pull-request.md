# Git Pull Request Command

このコマンドは、現在のブランチの変更点とコミットメッセージを分析し、GitHubプルリクエスト用の文章を自動生成します。

## 使用方法

```bash
/pull-request [ベースブランチ]
```

### 引数

- `[ベースブランチ]`: **オプション**。プルリクエストのマージ先ブランチを指定します
  - 指定しない場合は `main` がデフォルトで使用されます
  - 例: `/pull-request develop`, `/pull-request staging`

### 使用例

```bash
# デフォルト（mainブランチへのプルリクエスト）
/pull-request

# developブランチへのプルリクエスト
/pull-request develop

# stagingブランチへのプルリクエスト
/pull-request staging

# 任意のブランチへのプルリクエスト
/pull-request feature/base-branch
```

### 前提条件

- Gitリポジトリ内で実行する必要があります
- 現在のブランチにコミットが存在する必要があります
- 指定されたベースブランチが存在する必要があります

### エラー条件

以下の場合はエラーを返します：

- Gitリポジトリでない場合
  - エラーメッセージ: `エラー: Gitリポジトリではありません`
- 指定されたベースブランチが存在しない場合
  - エラーメッセージ: `エラー: ブランチ '<ベースブランチ>' が見つかりません`
- 現在のブランチがベースブランチと同じ場合
  - エラーメッセージ: `エラー: <ベースブランチ> ブランチからはプルリクエストを作成できません`
- ベースブランチとの差分がない場合
  - エラーメッセージ: `エラー: ベースブランチとの差分がありません`

## 実行内容

1. **現在のブランチ確認**: 現在のブランチ名を取得
2. **ベースブランチ確定**: 引数で指定されたブランチ、または `main` をベースブランチとする
3. **ベースブランチ存在確認**: 指定されたベースブランチが存在することを確認
4. **変更情報の収集**: コミットメッセージ、ファイル差分、変更統計を取得
5. **PR文章の生成**: 収集した情報を基にプルリクエスト文章を生成
6. **出力**: 生成した文章を表示

## 手順

### ステップ0: Gitリポジトリの確認

まず、現在のディレクトリがGitリポジトリであることを確認してください：

```bash
# Gitリポジトリか確認
git rev-parse --is-inside-work-tree 2>/dev/null
```

**処理**:
- コマンドが失敗する場合はエラーで終了
- エラーメッセージ: "エラー: Gitリポジトリではありません"

### ステップ1: 現在のブランチとベースブランチの確認

現在のブランチとベースブランチを確認してください：

```bash
# 現在のブランチ名を取得
CURRENT_BRANCH=$(git branch --show-current)

# ベースブランチを確定（引数があればそれを使用、なければ main をデフォルト）
# 引数は $1 に格納されている
BASE_BRANCH="${1:-main}"

# ベースブランチが存在することを確認
if ! git show-ref --verify --quiet refs/heads/${BASE_BRANCH}; then
  echo "エラー: ブランチ '$BASE_BRANCH' が見つかりません"
  exit 1
fi

# 現在のブランチがベースブランチでないことを確認
if [ "$CURRENT_BRANCH" = "$BASE_BRANCH" ]; then
  echo "エラー: $BASE_BRANCH ブランチからはプルリクエストを作成できません"
  exit 1
fi

echo "現在のブランチ: $CURRENT_BRANCH"
echo "ベースブランチ: $BASE_BRANCH"
```

**処理**:
- `${1:-main}`: 第1引数が指定されていればそれを使用、なければ `main` を使用
- `git show-ref --verify`: 指定されたブランチが存在するか確認
- ベースブランチが存在しない場合はエラーで終了

### ステップ2: 変更情報の収集

以下のbashコマンドを実行して情報を収集してください：

```bash
# コミット履歴を取得（ベースブランチとの差分）
echo "=== コミット履歴 ==="
git log --oneline ${BASE_BRANCH}..HEAD

# コミットメッセージの詳細を取得
echo ""
echo "=== 詳細なコミットメッセージ ==="
git log ${BASE_BRANCH}..HEAD --pretty=format:"%s%n%b" --reverse

# ファイル変更の統計
echo ""
echo "=== 変更統計 ==="
git diff --stat ${BASE_BRANCH}..HEAD

# ファイル変更の詳細（追加・変更・削除されたファイル）
echo ""
echo "=== 変更ファイル一覧 ==="
git diff --name-status ${BASE_BRANCH}..HEAD

# コミット数を取得
COMMIT_COUNT=$(git rev-list --count ${BASE_BRANCH}..HEAD)
echo ""
echo "コミット数: $COMMIT_COUNT"
```

**注意**:
- すべての情報を次のステップで使用するため、出力を保持してください
- コミットが0件の場合はエラーで終了

### ステップ3: プルリクエスト文章の生成

収集した情報を基に、以下の形式でプルリクエスト文章を生成してください：

#### タイトルの生成ルール

コミットメッセージやファイル変更を分析して、適切なプレフィックスを付与：

- **新機能追加**: `[feat] add: 機能の概要`
  - 新しいファイルが多い、または "add", "feat", "feature" がコミットメッセージに含まれる
- **既存機能の改修**: `[feat] fix: 変更の概要`
  - 既存ファイルの変更が中心、または "update", "change", "improve" がコミットメッセージに含まれる
- **バグ修正**: `[bug]: 不具合の概要`
  - "bug", "fix", "hotfix" がコミットメッセージに含まれる
- **リファクタリング**: `[refactor]: リファクタリングの概要`
  - "refactor", "clean", "reorganize" がコミットメッセージに含まれる
- **ドキュメント**: `[docs]: ドキュメントの概要`
  - ドキュメントファイル（.md, docs/等）のみの変更

#### 本文の構成

```markdown
## 背景・目的
<!-- この変更が必要になった背景や目的を記載 -->
<!-- Issue番号がある場合は resolves #<Issue番号> を記載 -->

## 変更の詳細
<!-- 何をどのように変更したのかを詳細に記載 -->
<!-- 主要な変更点をリスト形式で記載 -->

## 影響範囲
<!-- この変更による影響範囲を記載 -->
<!-- 変更されたファイルや機能を記載 -->

## テスト方法
<!-- この変更をテストする方法を記載 -->
<!-- 確認手順やテストケースを記載 -->

## 確認事項
- [ ] セルフコードレビューを実施した
- [ ] コードに適切なコメントを追加した
- [ ] 関連するドキュメントを更新した
- [ ] テストを追加・実行した
- [ ] 既存のテストがすべて成功することを確認した
```

**生成ルール**:
- すべての情報をコミットメッセージとファイル差分から推測して生成
- ユーザーにとって価値のある情報を具体的に記載
- 技術的な詳細と影響範囲を明確に記述
- 変更の意図と理由を説明
- 前置きや説明文は一切含めず、PR文章のみを出力

### ステップ4: 出力

生成したプルリクエスト文章を以下の形式で出力してください：

```
=== プルリクエスト文章 ===

<生成されたタイトル>

<生成された本文>

===
```

**注意事項**:
- 前置きの説明やコメントは不要です
- PR文章のみをそのまま出力してください
- 出力後、ユーザーがコピーしてGitHubに貼り付けられる形式にしてください

## プルリクエストテンプレートの参考

このコマンドは以下のベストプラクティスに基づいています：

### セクションの意図

- **背景・目的**: レビュアーが変更の文脈を理解するため
- **変更の詳細**: 何をどのように変更したのかを具体的に理解するため
- **影響範囲**: 変更による影響を把握し、レビューの質を高めるため
- **テスト方法**: 変更の妥当性を検証する手順を明確にするため
- **確認事項**: レビュー前の品質チェックを標準化するため

### 良いプルリクエストの特徴

- 変更の背景と目的が明確
- 技術的な詳細と実装の決定事項が説明されている
- テスト方法が具体的
- レビュアーが理解しやすい構成
- 適切な粒度（大きすぎず、小さすぎず）

## 参考

- Qiita記事: https://qiita.com/to3izo/items/1a0b487af8d3c5867efb
- Axolo Blog: https://axolo.co/blog/p/part-3-github-pull-request-template
