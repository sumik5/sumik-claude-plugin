# Git Tag Command

このコマンドは、CHANGELOG.mdから該当バージョンのエントリーを抽出し、annotated tagを自動作成します。

## 使用方法

```bash
/gittag <タグ名>
```

### 引数

- `<タグ名>`: **必須**。作成するタグ名を指定します（例: `v1.2.0`）

### バージョン番号のフォーマット規則

タグ名は以下の規則に従う必要があります：

- **形式**: `v` + セマンティックバージョニング（`MAJOR.MINOR.PATCH`）
- **例**: `v1.0.0`, `v2.1.3`, `v0.5.0`
- **必須要素**:
  - 先頭の `v` プレフィックス
  - 3つの数字（メジャー、マイナー、パッチ）をドットで区切る
- **オプション**: プレリリース版やビルドメタデータ（例: `v1.0.0-beta.1`, `v2.0.0+20250104`）

### エラー条件

以下の場合はエラーを返します：

- 引数が指定されていない場合
  - エラーメッセージ: `エラー: タグ名が指定されていません。使用方法: /gittag <タグ名>`
- タグ名の形式が不正な場合
  - エラーメッセージ: `エラー: タグ名の形式が不正です。正しい形式: v1.0.0`
- CHANGELOG.mdが存在しない場合
  - エラーメッセージ: `エラー: CHANGELOG.mdが見つかりません`
- CHANGELOG.mdに該当するバージョンエントリーが存在しない場合
  - エラーメッセージ: `エラー: CHANGELOG.mdに <タグ名> のエントリーが見つかりません`
- 指定されたタグが既に存在する場合
  - 警告メッセージ: `警告: タグ '<タグ名>' は既に存在します`
  - 上書き確認を求める

### 使用例

```bash
# 正しい使用例
/gittag v1.2.0
# → CHANGELOG.mdから [v1.2.0] セクションを抽出
# → 内容をメッセージとしてannotated tagを作成

/gittag v2.0.0-beta.1
# → プレリリース版のタグを作成

# 誤った使用例（エラーになる）
/gittag          # 引数なし
/gittag 1.2.0    # v プレフィックスなし
/gittag v1.2     # パッチバージョンなし
```

## 実行内容

1. **引数の検証**: タグ名の形式を検証
2. **CHANGELOG.mdの確認**: ファイルの存在と該当エントリーの確認
3. **タグの存在確認**: 同名タグが既に存在する場合は上書き確認
4. **エントリー抽出**: CHANGELOG.mdから該当バージョンの内容を抽出
5. **タグ作成**: 抽出した内容をメッセージとしてannotated tagを作成

## 手順

### ステップ0: 引数の検証

まず、コマンドに渡された引数を検証してください：

1. **引数の存在確認**
   ```
   引数が存在しない場合:
   → エラーメッセージを表示: "エラー: タグ名が指定されていません。使用方法: /gittag <タグ名>"
   → 処理を終了
   ```

2. **タグ名の形式検証**
   ```
   正規表現パターン: ^v\d+\.\d+\.\d+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$

   形式が不正な場合:
   → エラーメッセージを表示: "エラー: タグ名の形式が不正です。正しい形式: v1.0.0"
   → 処理を終了
   ```

3. **タグ名を変数に保存**
   ```
   検証が成功した場合:
   → 引数で渡されたタグ名を変数 TAG_NAME に保存（例: v1.2.0）
   → 次のステップへ進む
   ```

### ステップ1: CHANGELOG.mdの確認

以下を確認してください：

```bash
# CHANGELOG.mdの存在確認
test -f CHANGELOG.md && echo "CHANGELOG.md found" || echo "CHANGELOG.md not found"
```

**注意**:
- CHANGELOG.mdが存在しない場合はエラーで終了
- エラーメッセージ: "エラー: CHANGELOG.mdが見つかりません"

### ステップ2: タグの存在確認

既存タグの確認と処理：

```bash
# 指定されたタグが既に存在するか確認
git tag -l "<TAG_NAME>"
```

**処理**:
- タグが存在する場合:
  1. 警告メッセージを表示: "警告: タグ '<TAG_NAME>' は既に存在します"
  2. AskUserQuestionで上書き確認を求める:
     ```python
     AskUserQuestion(
         questions=[{
             "question": f"タグ '{TAG_NAME}' は既に存在します。上書きしますか？",
             "header": "タグ上書き",
             "options": [
                 {"label": "上書きする", "description": "既存タグを削除して新規作成"},
                 {"label": "キャンセル", "description": "操作を中止"}
             ],
             "multiSelect": False
         }]
     )
     ```
  3. 「上書きする」が選択された場合のみ続行
  4. 「キャンセル」が選択された場合は処理を中止: "操作がキャンセルされました"
  5. 続行する場合は既存タグを削除: `git tag -d <TAG_NAME>`
- タグが存在しない場合:
  - 次のステップへ進む

### ステップ3: CHANGELOGエントリーの抽出

CHANGELOG.mdから該当バージョンのエントリーを抽出してください：

#### 抽出ロジック

1. **バージョンヘッダーの検出**
   ```
   パターン: ^##\s+\[?v?<バージョン番号>\]?

   例:
   - ## [v1.2.0] - 2025-10-04
   - ## v1.2.0 - 2025-10-04
   - ## [1.2.0] - 2025-10-04
   ```

   **注意**:
   - TAG_NAMEから 'v' プレフィックスを除いてバージョン番号を抽出
   - 例: `v1.2.0` → `1.2.0`
   - パターンマッチングでは 'v' があってもなくても対応

2. **エントリーの範囲**
   ```
   開始: 該当バージョンのヘッダー行
   終了: 次のバージョンヘッダー（^##\s+\[?v?[0-9]+\.[0-9]+）が見つかるまで
        または、ファイルの終わりまで
   ```

3. **内容の整形**
   ```
   - ヘッダー行を含めて抽出
   - 末尾の空行を削除
   - セクション全体を文字列として保存
   ```

#### エラーハンドリング

```
該当するバージョンエントリーが見つからない場合:
→ エラーメッセージを表示: "エラー: CHANGELOG.mdに <TAG_NAME> のエントリーが見つかりません"
→ 処理を終了
```

#### 抽出コマンド

以下のbashコマンドでCHANGELOGエントリーを抽出してください：

```bash
# バージョン番号を抽出（vプレフィックスを除く）
VERSION_NUMBER=$(echo "$TAG_NAME" | sed 's/^v//')

# CHANGELOGエントリーを抽出
# 該当バージョンの見出しから次の見出しの直前まで抽出
CHANGELOG_ENTRY=$(sed -n "/^## \[v\?${VERSION_NUMBER}\]/,/^## \[v/p" CHANGELOG.md | sed '$d')

# 最後のセクションの場合（次の見出しがない場合）の処理
if [ -z "$CHANGELOG_ENTRY" ]; then
  CHANGELOG_ENTRY=$(sed -n "/^## \[v\?${VERSION_NUMBER}\]/,\$p" CHANGELOG.md)
fi

# 末尾の空行を削除
CHANGELOG_ENTRY=$(echo "$CHANGELOG_ENTRY" | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}')

# エントリーが空でないか確認
if [ -z "$CHANGELOG_ENTRY" ]; then
  echo "エラー: CHANGELOG.mdに $TAG_NAME のエントリーが見つかりません"
  exit 1
fi

# 抽出結果を表示（デバッグ用）
echo "抽出されたエントリー:"
echo "$CHANGELOG_ENTRY"
```

**注意**:
- `sed -n "/^## \[v\?${VERSION_NUMBER}\]/,/^## \[v/p"` で該当セクションを抽出
- `\[v\?` により、`[v1.2.0]` と `[1.2.0]` の両方に対応
- `sed '$d'` で最後の行（次のセクションのヘッダー）を削除
- CHANGELOGの最後のセクションの場合は、ファイル末尾（`$`）までを抽出
- 変数置換（`${VERSION_NUMBER}`）を使用して柔軟に対応

#### 実装例

CHANGELOG.mdの例:
```markdown
# Changelog

## [v1.2.0] - 2025-10-04

### 追加
- 新しい機能Aを追加
- 機能Bのサポートを追加

### 修正
- バグXを修正

## [v1.1.0] - 2025-09-01
...
```

抽出結果（TAG_NAME = v1.2.0の場合）:
```
## [v1.2.0] - 2025-10-04

### 追加
- 新しい機能Aを追加
- 機能Bのサポートを追加

### 修正
- バグXを修正
```

### ステップ4: タグメッセージの確認

抽出した内容をユーザーに表示して確認してください：

```
タグ '<TAG_NAME>' を以下の内容で作成します:

----------------------------------------
<抽出したCHANGELOGエントリー>
----------------------------------------
```

AskUserQuestionで確認を求める：

```python
AskUserQuestion(
    questions=[{
        "question": "このままタグを作成してよろしいですか？",
        "header": "タグ作成",
        "options": [
            {"label": "作成する", "description": f"タグ '{TAG_NAME}' を作成"},
            {"label": "キャンセル", "description": "タグ作成を中止"}
        ],
        "multiSelect": False
    }]
)
```

**処理**:
- 「作成する」が選択された場合: 次のステップへ進む
- 「キャンセル」が選択された場合: 処理を中止

### ステップ5: Annotated Tagの作成

抽出したCHANGELOGエントリーをメッセージとしてannotated tagを作成します：

```bash
# annotated tagの作成
git tag -a "<TAG_NAME>" -m "<抽出したCHANGELOGエントリー>"
```

**注意**:
- `-a` オプションで annotated tag を作成
- `-m` オプションで複数行のメッセージを指定
- メッセージには抽出したCHANGELOGエントリー全体を使用

### ステップ6: 完了メッセージ

タグ作成後、以下の情報をユーザーに表示してください：

```
✓ タグ '<TAG_NAME>' が正常に作成されました

リモートにプッシュするには:
  git push origin <TAG_NAME>

すべてのタグをプッシュするには:
  git push --tags
```

## 参考

### CHANGELOG.mdのフォーマット

このコマンドは Keep a Changelog 形式のCHANGELOG.mdを想定しています：

```markdown
# Changelog

## [v1.2.0] - 2025-10-04

### 追加
- 新機能について記載

### 変更
- 既存機能への変更について記載

### 修正
- 修正されたバグについて記載

## [v1.1.0] - 2025-09-01
...
```

- 参考: https://keepachangelog.com/ja/1.1.0/

### Git Annotated Tagについて

Annotated tagは以下の情報を含みます：
- タグ名
- タグメッセージ
- タグ作成者の名前とメールアドレス
- タグ作成日時

Lightweight tagと異なり、完全なGitオブジェクトとして保存されます。

### トラブルシューティング

#### CHANGELOG.mdにエントリーが見つからない場合
1. CHANGELOG.mdの形式を確認
2. バージョン番号の表記を確認（vプレフィックスの有無）
3. `/changelog <タグ名>` コマンドで先にCHANGELOGエントリーを作成

#### タグ作成に失敗する場合
1. Gitリポジトリ内で実行しているか確認
2. 既存タグとの重複を確認
3. Gitの設定（user.name、user.email）を確認
