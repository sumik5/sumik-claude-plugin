# Webアプリケーション偵察活動リファレンス

Webアプリケーションのセキュリティ評価において、攻撃者の視点でアタックサーフェスを理解することは、防御側の開発者にとって重要な知識です。このドキュメントでは、攻撃者が利用する偵察手法を理解し、開発者がどのような情報が外部から収集可能かを把握するためのリファレンスを提供します。

## アタックサーフェスとは

**アタックサーフェス**は、攻撃者がシステムに侵入するための潜在的なエントリポイントの集合を指します。Webアプリケーションにおいて収集される情報には以下が含まれます：

- IPアドレス、ドメイン名、サブドメイン
- クラウドサービスの種類（AWS、GCP、Azure等）
- CDN、リバースプロキシの構成
- Webアプリケーション、プラグイン、ライブラリ
- プログラミング言語、フレームワーク
- OS、DBMS
- ソースコード、設定情報
- 認証情報

### 開発者への示唆

アタックサーフェスを最小化するための基本原則：

| 原則 | 実装例 |
|------|--------|
| 最小権限の原則 | 不要なポート・エンドポイントを閉じる |
| 多層防御 | CDN + WAF + アプリケーション層での検証 |
| 情報の最小化 | バージョン情報、エラーメッセージの抑制 |
| 定期的な棚卸し | 不要なサブドメイン・サービスの削除 |

---

## パッシブ偵察（対象に直接アクセスしない調査）

パッシブ偵察は、対象システムに直接アクセスせず、公開情報から調査を行う手法です。この手法は検知されにくいため、攻撃者は優先的に実施します。

### サービス構成の調査

#### IPアドレスからのクラウドサービス特定

主要クラウドプロバイダーは公開IPレンジを提供しているため、IPアドレスから利用サービスを推測可能です。

**主要クラウドのIPレンジ公開情報**

| プロバイダー | IPレンジ情報 |
|-------------|-------------|
| Google Cloud | https://www.gstatic.com/ipranges/cloud.json |
| AWS | https://docs.aws.amazon.com/vpc/latest/userguide/aws-ip-ranges.html |

**開発者への対策**

- CDN利用によるオリジンサーバのIP隠蔽
- オリジンサーバへの直接アクセス制限（CDNのIPレンジのみ許可）
- WAF導入による防御層の追加

#### 技術ブログ・SNSからの情報収集

企業の技術ブログ、採用情報、技術者のSNSアカウントからサービス構成図や技術スタックが判明することがあります。

**漏洩しやすい情報**

- アーキテクチャ図（利用サービス、データフロー）
- 使用言語・フレームワーク
- クラウドサービスの種類

**開発者への対策**

- 外部発表資料のレビュープロセス確立
- 本番環境の詳細情報（IPアドレス、内部URL等）は非公開に
- 一般化されたアーキテクチャ図の使用

#### インシデント報告書の調査

過去のインシデント報告書には、事故原因説明のためにサービス構成図や技術情報が詳細に記載されていることがあります。

**開発者への対策**

- インシデント報告書の公開範囲を慎重に検討
- 必要最小限の技術情報のみ開示
- 機密性の高い構成情報はマスキング

---

### ネットワーク調査

#### WHOIS検索

WHOISプロトコルを使用して、ドメイン名やIPアドレスの登録情報を検索できます。

**取得可能な情報**

- ドメイン登録者名
- 管理者連絡先
- IPアドレスの管理組織
- ネームサーバー情報

**開発者への対策**

- WHOIS情報の代行登録サービス利用
- 組織情報の表記統一（検索回避）
- 内部システムのドメインは非公開DNSで管理

#### AS番号・BGP Toolkitによる調査

自律システム（AS）を運用する組織は、AS番号から管理IPアドレスレンジを特定できます。

**調査可能な情報**

- 組織が管理するIPアドレスレンジ
- ピア接続情報
- 逆引きDNSからのサービス推測

**開発者への対策**

- 公開サービスと内部サービスのネットワーク分離
- 逆引きDNSの適切な設定（過度な情報開示を避ける）

---

### ドメイン・サブドメインの調査

サブドメインの探索は、意図せず公開されたテスト環境や管理画面の発見に繋がります。

#### Censys、Shodan

インターネットに接続したサーバの情報を収集・検索できるサービスです。SSL/TLS証明書からドメイン名や組織名を検索可能です。

**発見されやすいもの**

- テスト用サイト（dev、stg、test等のサブドメイン）
- デバッグ機能が有効なサイト
- 非公開予定のサービス

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| テスト環境の隔離 | VPN経由でのみアクセス可能に |
| 証明書管理 | ワイルドカード証明書の慎重な利用 |
| 定期的な棚卸し | 不要なテスト環境の削除 |

#### crt.sh（CTログ）

Certificate Transparency（CT）ログを検索し、TLS証明書の発行記録からサブドメインを発見できます。

**検索方法**

```
%.example.com
```

上記の形式で、ドメインとそのサブドメインの証明書発行履歴を検索可能です。

**開発者への対策**

- 内部サービスへのワイルドカード証明書使用を避ける
- 証明書発行前にサブドメイン名のレビュー
- 社内専用サブドメインはプライベートCAを利用

#### SecurityTrails

ドメインやWHOIS情報を収集し、DNSレコードのヒストリ情報を提供するサービスです。

**取得可能な情報**

- 現在および過去のDNSレコード
- サブドメイン一覧
- IPアドレス履歴

**開発者への対策**

- 過去に誤って公開したサービスのIPが現在も稼働していないか確認
- DNS変更履歴の定期的な監査

#### OWASP Amass / subfinder

サブドメイン探索を自動化するツールです。複数のデータソース（API、証明書、DNSなど）から包括的に情報を収集します。

**OWASP Amass データソース例**

| カテゴリ | データソース |
|---------|-------------|
| APIs | Censys、Shodan、VirusTotal、GitHub等 |
| Certificates | Censys、Crtsh、FacebookCT等 |
| DNS | ブルートフォース、ゾーン転送、NSEC探索等 |
| Web Archives | Wayback、CommonCrawl等 |

**開発者への対策**

- サブドメイン命名規則の策定（推測されにくい名前）
- 不要なサブドメインの定期的な削除
- アクセス制限のないサブドメインの定期的な監査

---

### クローリングされたWebページの探索

#### Google検索（Google Dorks）

検索演算子を利用した高度な調査が可能です。

**主要な演算子**

| 演算子 | 説明 | 例 |
|--------|------|-----|
| `site:` | 指定サイト内を検索 | `site:example.com` |
| `inurl:` | URL内に指定文字列を含む | `inurl:login` |
| `intext:` | 本文内に指定文字列を含む | `intext:"開発情報"` |
| `filetype:` | ファイル形式を指定 | `filetype:pdf` |

**検索例**

```
site:example.com inurl:"login" filetype:php
site:internal.*.example.com
site:example.com filetype:log
```

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| robots.txt | 検索エンジンからのクローリング制御 |
| 認証の徹底 | ログイン画面だけでなく、全ての非公開ページに認証を要求 |
| ファイル公開の制限 | ログ、設定ファイル、バックアップファイルの公開禁止 |
| X-Robots-Tag | 動的ページのクローリング制御 |

#### Wayback Machine

Internet ArchiveによるWebページのアーカイブサービスです。過去のサイトの状態を確認できます。

**調査可能な情報**

- 削除されたページ
- 古いバージョンのAPI
- 意図せず公開された内部情報

**開発者への対策**

- 機密情報を誤って公開した場合は、Wayback Machineに削除依頼
- 公開前のコンテンツレビュープロセスの確立
- 初期段階から適切なアクセス制御の実装

---

### サードパーティサービスを利用した調査

#### GitHub

**調査対象**

1. **リポジトリ**: ソースコード、設定ファイル
2. **コミットログ**: 強制プッシュで削除されたコミットも含む
3. **Issue / Pull Request**: 内部URLやシステム情報の記載
4. **GitHub Actions**: ワークフローログからの機密情報漏洩
5. **Gist**: コードスニペット内の開発情報

**漏洩しやすい情報**

- クラウドサービスのアクセストークン
- APIキー、秘密鍵
- データベース認証情報
- 内部システムのURL
- `.bash_history`などの操作履歴

**強制プッシュで削除されたコミットの調査方法**

1. REST API: `https://api.github.com/repos/{owner}/{repo}/events`
2. アクティビティページ: `https://github.com/<owner>/<repo>/activity`
3. Pull Request / Issue内のコミットID参照

削除されたコミットIDが判明すれば、以下のURLでアクセス可能な場合があります：

```
https://github.com/{owner}/{repo}/commit/{コミットID}
```

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| 環境変数の利用 | 機密情報はコード内にハードコード禁止 |
| .gitignoreの徹底 | `.env`、認証情報ファイルを必ず除外 |
| pre-commitフック | 機密情報検出ツール（gitleaks、TruffleHog等）の導入 |
| Secretsスキャン | GitHub Advanced Security、GitGuardianの活用 |
| コミット履歴の注意 | 誤ってコミットした場合は履歴改変ではなく、シークレットの無効化 |
| ワークフローのセキュリティ | Pull Requestトリガーのワークフローは慎重に設計 |

#### Docker Hub

コンテナイメージ内に機密情報が含まれていないか調査されます。

**調査対象**

- 各レイヤに含まれるファイル
- 環境変数
- COPYやADDで追加されたファイル
- RUNで実行されるコマンド

**解析ツール**

- **dive**: コンテナイメージの各レイヤを対話的に調査
- **docker save / tar**: イメージのエクスポートと解析

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| マルチステージビルド | ビルド時の機密情報を最終イメージに含めない |
| Secretsの外部管理 | 環境変数、ボリュームマウント、HashiCorp Vault、AWS Secrets Manager等 |
| .dockerignoreの利用 | 不要なファイルのイメージへの混入防止 |
| レイヤ最小化 | 不要なレイヤの削減 |
| 古いバージョンの削除 | 機密情報を含む古いイメージの削除 |

---

## アクティブ偵察（対象に直接アクセスする調査）

アクティブ偵察は、対象システムに直接パケットを送信し、応答を観測・分析する手法です。パッシブ偵察より検知されやすいリスクがありますが、正確な情報を取得できます。

### エンドポイントの探索

意図せず公開されているリソース（隠しディレクトリ、バックアップファイル、管理画面等）を発見する手法です。

#### 特徴的なエンドポイント例

**管理用エンドポイント**

| エンドポイント | 特徴 |
|---------------|------|
| `/admin/` | 管理者用エンドポイント |
| `/wp-login.php` | WordPressログイン画面 |
| `/wp-admin/` | WordPress管理画面 |
| `/server-status` | Apacheサーバ状態情報 |
| `/sidekiq` | Sidekiqジョブ管理 |

**開発・テスト用エンドポイント**

| エンドポイント | 特徴 |
|---------------|------|
| `/swagger-ui.html` | APIドキュメント |
| `/test.php` | テスト用ファイル |
| `/debug` | デバッグ機能 |

**公開不要な情報**

| エンドポイント | 特徴 |
|---------------|------|
| `/config/` | 設定ファイル配置先 |
| `/package.json` | npmパッケージ情報 |
| `/.git/` | gitリポジトリ |
| `/README.txt` | 開発者向け説明 |

#### ワードリストベースの探索

**主要ツール: dirsearch**

```bash
# 基本的な使用方法
docker run dirsearch -u <URL>

# 高速スキャン（大規模環境向け）
docker run -v ./:/work dirsearch \
  -l /work/urllist.txt \
  --max-rate 10 \
  --timeout 2 \
  --retries 0
```

**レスポンス分析のポイント**

| 観点 | 確認内容 |
|------|---------|
| HTTPステータスコード | 200（発見）、403（存在するがアクセス拒否）、404（存在しない） |
| Content-Length | 通常と異なるサイズは個別確認 |
| レスポンスヘッダ | Server、X-Powered-Byからミドルウェア推測 |

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| ディレクトリリスティング無効化 | Webサーバ設定で禁止 |
| デフォルトファイルの削除 | README、test.php、debug等の削除 |
| `.git`等の除外 | `.git`、`.env`、`config/`等のアクセス禁止 |
| カスタムエラーページ | 情報漏洩を防ぐエラーページ実装 |
| WAF導入 | 自動化スキャンの検知・ブロック |

---

### WordPressサイトの調査

WordPressは広く利用されているCMSであり、本体、テーマ、プラグインの脆弱性が狙われます。

#### ユーザ情報の収集

**ユーザ列挙手法**

1. **投稿者アーカイブ**: `/?author=1`、`/?author=2`...と順にアクセス
2. **REST API**: `/wp-json/wp/v2/users`（WordPress 4.7以降）
3. **ログイン画面のエラーメッセージ**: ユーザ名の存在/非存在を判別

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| ユーザ列挙の抑制 | プラグイン（Stop User Enumeration等）の利用 |
| REST API制限 | 認証なしのユーザ情報取得を無効化 |
| エラーメッセージの統一 | ユーザ名の存在を推測できないエラーメッセージに |
| 投稿者アーカイブ無効化 | テーマカスタマイズで無効化 |

#### コンポーネント情報の収集

**手動調査**

- HTMLソースコード内のCSSやJavaScriptのパス（`wp-content/plugins/`、`wp-content/themes/`）
- `readme.txt`の直接アクセス
- JavaScript/CSSのヘッダコメント

**自動調査ツール: WPScan**

```bash
# 基本スキャン
wpscan --url https://example.com

# プラグイン・テーマ・ユーザ列挙
wpscan --url https://example.com --enumerate p,t,u

# 詳細スキャン（脆弱性検出）
wpscan --url https://example.com \
  --enumerate vp,vt,cb,u \
  --plugins-detection aggressive \
  --themes-detection aggressive \
  --api-token YOUR_API_TOKEN
```

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| バージョン情報の非表示 | `remove_action('wp_head', 'wp_generator')` |
| readme.htmlの削除 | デフォルトreadmeの削除 |
| プラグイン・テーマの最新化 | 定期的なアップデート |
| 不要なコンポーネント削除 | 未使用プラグイン・テーマの削除 |
| セキュリティプラグイン導入 | Wordfence、Sucuri等の導入 |
| wp-config.phpの保護 | 適切なパーミッション設定 |

---

### クラウドストレージの探索

Amazon S3、Google Cloud Storage、Azure Blob Storage等の設定ミスを探索します。

#### Amazon S3バケットの探索

**バケット名の推測**

```
https://s3.<region>.amazonaws.com/{bucket-name}/
https://{bucket-name}.s3.amazonaws.com
https://{bucket-name}.s3-{region}.amazonaws.com
```

**よく使われるバケット名パターン**

- `dev-<service-name>`
- `stg-<service-name>`
- `prod-<service-name>`
- `<service-name>-backup`
- `<service-name>-logs`

**レスポンスによる判定**

| レスポンス | 状態 |
|-----------|------|
| `AccessDenied` | バケット存在（アクセス制限あり） |
| `ListBucketResult` | バケット存在（公開状態） |
| `NoSuchBucket` | バケット存在しない |

**自動探索ツール: CloudHunter**

```bash
python3 cloudhunter.py -t 10 http://example.com
```

**HTTPレスポンスヘッダによる判定**

S3バックエンドの特徴的なヘッダ：
- `Server: AmazonS3`
- `X-Amz-Request-ID`
- `x-amz-id-2`

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| バケットポリシーの厳格化 | デフォルトで全てプライベートに |
| パブリックアクセスブロック | AWS S3のパブリックアクセスブロック設定 |
| バケット名の推測困難化 | ランダムな文字列を含める |
| 定期的な監査 | AWS Config、Cloud Trailでの監視 |
| プリサインドURLの利用 | 限定的な一時アクセス権限の付与 |

---

### ポートスキャン

稼働しているサービスとポートを調査します。

#### Nmapによるポートスキャン

**基本的な使い方**

```bash
# 単一ホストのスキャン
nmap example.com

# 複数ホストのスキャン
nmap -iL hosts.txt

# 特定ポートのスキャン
nmap -p 22,80,443 example.com

# 全ポートスキャン
nmap -p0-65535 example.com
```

**主要オプション**

| オプション | 説明 |
|-----------|------|
| `-Pn` | ホスト検出をスキップ（firewallでping応答がブロックされている場合） |
| `-sV` | サービスバージョン検出 |
| `-sS` | SYNスキャン（高速） |
| `--top-ports 1000` | 使用頻度の高い上位1000ポートのみ |
| `-oN result.txt` | 結果をファイルに保存 |

**スキャンの使い分け**

| 状況 | コマンド例 |
|------|-----------|
| **対象が少ない（詳細調査）** | `nmap -Pn -sV -p0-65535 -iL hosts.txt -oN result.txt` |
| **対象が多い（効率重視）** | `nmap -PS22,80,443 -sS --top-ports 1000 -iL hosts.txt -oN result.txt` |

**開発者への対策**

| 対策項目 | 実装内容 |
|---------|---------|
| 不要なポートの閉鎖 | ファイアウォール、セキュリティグループでの制限 |
| サービスバナーの抑制 | バージョン情報を表示しない設定 |
| ポートノック | 追加の認証層の実装 |
| IDS/IPS導入 | スキャン検知・ブロック |
| 定期的なポート監査 | 予期しないポートが開いていないか確認 |

---

## 偵察活動の防御戦略

### 多層防御アプローチ

| 防御層 | 実装内容 |
|--------|---------|
| **ネットワーク層** | ファイアウォール、セキュリティグループ、IDS/IPS |
| **アプリケーション層** | 認証・認可、入力検証、エラーハンドリング |
| **データ層** | 暗号化、アクセス制御、監査ログ |
| **監視層** | SIEM、異常検知、アラート |

### 定期的な自己評価

開発者は定期的に以下を実施すべきです：

1. **外部からの情報収集**: 自組織に対してOSINT調査を実施
2. **エンドポイント監査**: 意図しない公開ファイル・ディレクトリの確認
3. **DNS監査**: 不要なサブドメイン、古いDNSレコードの削除
4. **クラウドストレージ監査**: パブリックアクセス設定の確認
5. **GitHubシークレットスキャン**: 機密情報漏洩の確認
6. **ポートスキャン**: 不要なポートが開いていないか確認

### インシデント対応

偵察活動を検知した場合の対応：

| フェーズ | アクション |
|---------|-----------|
| **検知** | IDS/IPS、WAFログ、アクセスログの監視 |
| **初動対応** | 攻撃元IPの特定、一時的なブロック |
| **影響評価** | アクセスされた情報の特定、漏洩範囲の確認 |
| **恒久対策** | 脆弱性の修正、監視強化 |
| **事後レビュー** | インシデントレポート作成、再発防止策の策定 |

---

## まとめ

偵察活動は攻撃の初期フェーズとして極めて重要であり、開発者はこれらの手法を理解することで、自組織のWebアプリケーションがどのような情報を外部に晒しているかを把握できます。

**防御側の基本原則**

1. **情報の最小化**: 不要な情報を公開しない
2. **多層防御**: 単一の防御に依存しない
3. **定期的な監査**: 継続的なセキュリティ評価
4. **迅速な対応**: 脆弱性の早期発見・修正

偵察活動で得られた情報は、SSRF、認証バイパス、権限昇格などの攻撃と組み合わせることで、より深刻な侵害に発展する可能性があります。開発者は偵察段階での情報漏洩を最小化することで、攻撃の成功確率を大幅に低減できます。
