# マイクロフロントエンドアーキテクチャ

## 概要

マイクロフロントエンドは、マイクロサービスの概念をフロントエンド開発に適用したアーキテクチャスタイルです。複数の独立したチームが、同一のWebアプリケーションの異なる部分を自律的に開発・デプロイできるようにします。

### いつ使うか

以下の状況でマイクロフロントエンドを検討してください：

- 複数チームが同一のフロントエンドアプリケーションを開発している
- フロントエンドモノリスが肥大化し、開発速度が低下している
- 異なるビジネスドメインが明確に分離されている
- チームごとに技術スタックを選択したい
- 独立したデプロイサイクルが必要

### いつ使うべきでないか

以下の場合、マイクロフロントエンドは適していません：

- 小規模なチーム（5人未満）での開発
- シンプルなアプリケーション
- 組織的な複雑さを受け入れる準備ができていない
- 一貫したユーザー体験の維持が技術的に困難

---

## マイクロフロントエンドの7原則

マイクロサービスの原則をフロントエンド開発に適用します：

| 原則 | 説明 |
|------|------|
| **1. ビジネスドメインのモデル化** | ドメイン駆動設計（DDD）に基づき、ビジネスドメインごとにマイクロフロントエンドを分割 |
| **2. 自動化の文化** | CI/CDパイプライン、テスト、デプロイの自動化により高速なフィードバックループを実現 |
| **3. 実装の詳細を隠す** | 各マイクロフロントエンドは内部実装を隠蔽し、明確なインターフェースを公開 |
| **4. ガバナンスの分散** | 技術選定や意思決定をチームごとに分散し、組織全体の開発効率を向上 |
| **5. 独立デプロイ可能性** | 他のマイクロフロントエンドに影響を与えずに、独立してデプロイ可能 |
| **6. 障害の分離** | 一つのマイクロフロントエンドの障害が他に波及しないよう分離 |
| **7. 高い観測性** | ログ、メトリクス、トレーシングにより、システム全体の動作を把握可能 |

**重要**: マイクロフロントエンドは銀の弾丸ではありません。技術的・組織的な複雑さが増すため、導入前に慎重な評価が必要です。

---

## 意思決定フレームワーク

マイクロフロントエンドアーキテクチャを構築するための4ステップのフレームワークです。

### ステップ1: マイクロフロントエンドの定義

各マイクロフロントエンドが担当する範囲を明確にします：

- **ビジネス機能**: どのビジネスドメインを担当するか
- **責任範囲**: UIコンポーネント、ルーティング、状態管理の範囲
- **オーナーシップ**: 担当チームとその責任

例（動画配信サービス）:

| マイクロフロントエンド | 担当機能 | ルーティング例 |
|---------------------|---------|--------------|
| ホーム | コンテンツ発見、レコメンデーション | `/home` |
| プレーヤー | 動画再生、品質調整 | `/watch/:id` |
| マイページ | ユーザー設定、視聴履歴 | `/profile` |

### ステップ2: ドメイン駆動設計（DDD）の適用

**コンテキスト境界の定義**:

1. **トラフィック分析**: どの機能が頻繁に使われるか
2. **機能境界の特定**: 独立して変更可能な機能単位を特定
3. **依存関係の最小化**: チーム間の調整コストを最小化

**適切な粒度の判断基準**:
- マイクロフロントエンドが70%以上の時間を独立して作業できる
- 他のチームとの調整が40%未満
- 明確なビジネス価値を持つ

### ステップ3: 構成方法の選択

マイクロフロントエンドをどこで統合するかを決定します：

| 構成方法 | 統合場所 | 特徴 |
|---------|---------|------|
| **クライアントサイド** | ブラウザ内 | 動的、インタラクティブ |
| **サーバサイド** | Webサーバー | SEO対応、初期表示高速 |
| **エッジサイド** | CDNエッジ | 低レイテンシ、地理的分散 |

詳細は [構成パターン詳細](./references/COMPOSITION-PATTERNS.md) を参照。

### ステップ4: ルーティングとコミュニケーション

**ルーティング戦略**:
- **アプリケーションレベル**: URL単位で異なるマイクロフロントエンドにルーティング
- **ページレベル**: 単一ページ内で複数のマイクロフロントエンドを統合

**コミュニケーション方法**:
| 方法 | 用途 | 実装例 |
|------|------|-------|
| **Custom Events** | マイクロフロントエンド間の疎結合通信 | `window.dispatchEvent()` |
| **URL/Query Parameters** | 状態の共有 | `/products?category=books` |
| **Web Storage** | 永続化されたデータ共有 | LocalStorage, SessionStorage |
| **HTTP(s)** | API経由のデータ取得 | REST, GraphQL |

---

## 垂直分割 vs 水平分割

### 垂直分割アーキテクチャ

各マイクロフロントエンドが完全なページまたはルートを所有します。

**特徴**:
- URL単位での分割（例: `/home`, `/products`, `/checkout`）
- アプリケーションシェルが共通機能を提供
- チーム間の独立性が高い

**適用シナリオ**:
- 明確なビジネスドメイン境界がある
- SEOが重要
- 各ページが独立した機能を持つ

### 水平分割アーキテクチャ

単一ページ内で複数のマイクロフロントエンドを統合します。

**特徴**:
- ページ内コンポーネント単位での分割
- より細かい粒度での統合
- リアルタイムな相互作用が可能

**適用シナリオ**:
- 複数のチームが同一ページを担当
- リアルタイムな更新が必要（EC商品ページ等）
- レガシーアプリケーションの段階的移行

### 比較テーブル

| 観点 | 垂直分割 | 水平分割 |
|------|---------|---------|
| **独立性** | 高い | 中程度 |
| **統合複雑度** | 低い | 高い |
| **デプロイ独立性** | 完全 | 部分的 |
| **SEO対応** | 容易 | 複雑 |
| **状態共有** | 最小限 | 頻繁 |
| **推奨規模** | 大規模組織 | 中〜大規模組織 |

---

## 構成パターン概要

6つの主要な構成パターンの概要です。詳細は [構成パターン詳細](./references/COMPOSITION-PATTERNS.md) を参照してください。

### パターン比較テーブル

| パターン | 統合場所 | 独立性 | パフォーマンス | SEO | 適用シーン |
|---------|---------|--------|-------------|-----|---------|
| **Module Federation** | クライアント | ★★★★★ | ★★★★ | ★★ | SPA、大規模チーム |
| **iframe** | クライアント | ★★★★★ | ★★★ | ★ | レガシー統合 |
| **Web Components** | クライアント | ★★★★ | ★★★★ | ★★★ | 汎用コンポーネント |
| **SSI/SSR Frameworks** | サーバ | ★★★★ | ★★★★★ | ★★★★★ | コンテンツサイト |
| **ESI** | エッジ | ★★★★★ | ★★★★★ | ★★★★★ | グローバル配信 |
| **Lambda@Edge** | エッジ | ★★★★ | ★★★★★ | ★★★★ | パーソナライゼーション |

### 各パターンの概要

**クライアントサイド構成**:
- **Module Federation**: webpack 5の機能。動的にJavaScriptモジュールを共有
- **iframe**: 完全な分離。レガシーシステム統合に有効
- **Web Components**: 標準技術。Shadow DOMで完全なスタイル分離

**サーバサイド構成**:
- **SSI (Server Side Includes)**: NGINX等で軽量にHTMLを統合
- **Podium, OpenComponents等**: Node.jsベースのフレームワーク

**エッジサイド構成**:
- **ESI (Edge Side Includes)**: CDNレベルでの高速統合
- **Lambda@Edge / Cloudflare Workers**: エッジでの動的レンダリング

---

## バックエンドAPI統合

マイクロフロントエンドはバックエンドAPIとの統合パターンが重要です。詳細は [バックエンドパターン詳細](./references/BACKEND-PATTERNS.md) を参照してください。

### 主要パターン

| パターン | 説明 | 適用シーン |
|---------|------|---------|
| **Service Dictionary** | APIエンドポイントをレジストリで管理 | 動的なエンドポイント検出 |
| **API Gateway** | 単一エントリポイントでAPI統合 | マイクロサービスとの統合 |
| **BFF (Backend for Frontend)** | マイクロフロントエンドごとに専用API | ドメインごとの最適化 |
| **GraphQL統合** | クエリ統合により柔軟なデータ取得 | 複数データソースの統合 |

**ベストプラクティス**:
- 1ドメイン = 1 APIエントリポイント（BFFパターン推奨）
- マイクロフロントエンドがAPIの詳細を隠蔽
- 認証・認可は共有レイヤーで一元管理

---

## ビルド&デプロイ戦略

マイクロフロントエンドの成功には自動化戦略が不可欠です。詳細は [ビルド&デプロイ詳細](./references/BUILD-AND-DEPLOY.md) を参照してください。

### 自動化の5原則

1. **フィードバックループの高速化**: CI実行時間を最小化（目標: 10分以内）
2. **頻繁な反復**: 小さな変更を頻繁にデプロイ
3. **チームの強化**: チームが自律的にデプロイ可能
4. **ガードレールの定義**: 品質基準を自動チェック
5. **テスト戦略の定義**: テストピラミッドに従う

### リポジトリ戦略

| 戦略 | メリット | デメリット | 推奨シーン |
|------|---------|----------|---------|
| **Monorepo** | 一貫性、共有容易 | ビルド時間増大 | 中規模チーム、共有ライブラリ多 |
| **Polyrepo** | 完全独立性 | 同期コスト高 | 大規模組織、完全自律チーム |

### デプロイ戦略

- **ブルーグリーンデプロイ**: 全トラフィックを一度に切り替え
- **カナリアリリース**: 段階的にトラフィックを移行（推奨）
- **ストラングラーフィグパターン**: レガシーシステムの段階的置換

---

## 組織導入戦略

マイクロフロントエンドは技術だけでなく、組織設計も重要です。詳細は [移行と組織詳細](./references/MIGRATION-AND-ORGANIZATION.md) を参照してください。

### Conway's Lawの適用

**Conway's Law**: システムの構造は、それを設計する組織のコミュニケーション構造を反映する。

**適用方法**:
- チーム構成をビジネスドメインに合わせる
- 機能チーム（フルスタック）> コンポーネントチーム（フロント/バック分離）

### チーム構造比較

| 組織モデル | 特徴 | マイクロフロントエンドとの親和性 |
|----------|------|-------------------------|
| **機能チーム** | ビジネスドメイン単位、フルスタック | ★★★★★ 推奨 |
| **コンポーネントチーム** | 技術レイヤー単位（フロント/バック） | ★★ 非推奨 |

### ガバナンスの実装

- **RFC (Request for Comments)**: アーキテクチャ変更の提案プロセス
- **ADR (Architecture Decision Records)**: 意思決定の記録と共有
- **実践共同体（CoP）**: ベストプラクティスの共有
- **タウンホール**: 定期的な全体ミーティング

### 移行戦略

**段階的移行手順**:

1. **意思決定フレームワークの適用**: サブドメイン分割、技術選定
2. **アプリケーションシェルの実装**: 共通機能の集約
3. **認証統合**: セッション管理の統一
4. **デザインシステム統合**: 一貫したUI/UX
5. **カナリアリリース**: 段階的なトラフィック移行

---

## ユーザー確認の原則

マイクロフロントエンドアーキテクチャの選択時、不明点があれば `AskUserQuestion` ツールで確認してください。

### 確認すべき判断分岐

**1. 分割戦略の選択**:
```
「マイクロフロントエンドの分割戦略を確認させてください」

選択肢:
- 垂直分割（URL/ページ単位）
- 水平分割（ページ内コンポーネント単位）
- ハイブリッド（両方の組み合わせ）
```

**2. 構成方法の選択**:
```
「マイクロフロントエンドの統合場所を確認させてください」

選択肢:
- クライアントサイド構成（SPA、動的）
- サーバサイド構成（SEO重視、初期表示高速）
- エッジサイド構成（グローバル配信、低レイテンシ）
```

**3. リポジトリ戦略の選択**:
```
「リポジトリ管理戦略を確認させてください」

選択肢:
- Monorepo（一貫性、共有容易）
- Polyrepo（完全独立性）
- Hybrid（共有コンポーネントのみMonorepo）
```

**4. デプロイ戦略の選択**:
```
「デプロイ戦略を確認させてください」

選択肢:
- ブルーグリーンデプロイ（瞬時切替）
- カナリアリリース（段階的移行、推奨）
- ストラングラーフィグ（レガシー置換）
```

**5. バックエンド統合パターンの選択**:
```
「バックエンドAPI統合パターンを確認させてください」

選択肢:
- BFFパターン（1ドメイン=1API、推奨）
- API Gateway（単一エントリポイント）
- Service Dictionary（動的エンドポイント検出）
- GraphQL統合（柔軟なクエリ）
```

---

## 関連リソース

- [構成パターン詳細](./references/COMPOSITION-PATTERNS.md) - 各構成パターンの技術詳細と実装例
- [ビルド&デプロイ詳細](./references/BUILD-AND-DEPLOY.md) - CI/CD戦略とテストピラミッド
- [バックエンドパターン詳細](./references/BACKEND-PATTERNS.md) - API統合パターンとベストプラクティス
- [移行と組織詳細](./references/MIGRATION-AND-ORGANIZATION.md) - モノリスからの移行と組織設計

---

## 次のステップ

1. **意思決定フレームワークの適用**: 4ステップに従い、プロジェクトに最適なアーキテクチャを選択
2. **構成パターンの詳細確認**: [COMPOSITION-PATTERNS.md](./references/COMPOSITION-PATTERNS.md) で技術詳細を確認
3. **自動化戦略の設計**: [BUILD-AND-DEPLOY.md](./references/BUILD-AND-DEPLOY.md) でCI/CD設計
4. **組織設計の検討**: [MIGRATION-AND-ORGANIZATION.md](./references/MIGRATION-AND-ORGANIZATION.md) でチーム構成を計画
