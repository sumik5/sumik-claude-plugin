# REFERENCE: パターン詳細仕様と安全ガイドライン

このドキュメントでは、各スライドパターンの詳細仕様、GASエラー回避のための安全ガイドライン、自己検証チェックリストを提供します。

[← SKILL.mdに戻る](./SKILL.md)

---

## 1. パターン別詳細仕様

各スライドタイプには、レイアウト崩れやテキストオーバーフローを防ぐための制限事項があります。

### 最大要素数目安

| パターン | プロパティ | 最大要素数 | 備考 |
|---------|----------|----------|------|
| **content** | `points` | 7個以内 | 単一カラム時。2カラム（`twoColumn: true`）の場合は各3-4個推奨 |
| **content** | `images` | 6個以内 | 画像は自動グリッド配置（1-6個で最適化） |
| **compare** | `leftItems` / `rightItems` | 各5個以内 | 左右ボックス内の箇条書き項目 |
| **process** | `steps` | 6個以内 | 縦並びステップ（6個で最適配置） |
| **timeline** | `milestones` | 6個以内 | タイムライン上のマイルストーン（横並び） |
| **diagram** | `lanes` | 4レーン以内 | 各レーン内 `items` は5個以内推奨 |
| **cards** | `items` | 6個以内 | 2列×3行または3列×2行のカードグリッド |
| **table** | `headers` | 5列以内 | テーブル列数 |
| **table** | `rows` | 8行以内 | テーブル行数（ヘッダー除く） |
| **progress** | `items` | 6個以内 | プログレスバー項目 |

### 文字数制限

| 要素 | 最大文字数 | 備考 |
|-----|----------|------|
| **title** (title/closing以外) | 30-35文字 | タイトルスライド・セクションスライドは40文字まで可 |
| **subhead** | 50文字 | サブヘッド（補足説明） |
| **各箇条書き項目** | 90文字 | content.points, compare.leftItems/rightItems, process.steps 等 |
| **cards.items.title** | 15文字 | カードタイトル |
| **cards.items.desc** | 70文字 | カード説明文 |
| **table.headers（各列名）** | 15文字 | テーブルヘッダー |
| **table.rows（各セル）** | 30文字 | テーブルセル |

### 禁止記号・ルール

- ❌ **箇条書きに改行（`\n`）を含めない**: `points`, `steps`, `leftItems`, `rightItems` の各要素内に改行を入れない
- ❌ **禁止記号**: `■` / `→` （箇条書きに使用しない。自動で `•` が付与される）
- ❌ **箇条書き文末に句点「。」を付けない**: 体言止めまたは「〜です」「〜します」で終わらせる
- ✅ **強調記法は許可**: `**太字**`, `[[重要語]]` は使用可能（箇条書き・タイトル・説明文すべてで有効）

---

## 2. 安全ガイドライン（GASエラー回避）

Google Apps ScriptおよびGoogle Slides APIの制約を遵守し、エラーや実行タイムアウトを回避するためのガイドラインです。

### スライド上限
- **最大50枚**: `slideData`配列は50要素以内に抑える
- 50枚を超える場合、プレゼンテーションを分割する

### 画像制約
- **ファイルサイズ**: 50MB未満
- **解像度**: 25メガピクセル以下
- **対応形式**: PNG、JPEG、GIF、WebP
- **非推奨**: SVG、PDF（GAS APIで直接サポートされていない）
- **ベストプラクティス**: 外部URL（https://）を使用し、画像ホスティングサービス（例: Imgur、Cloudinary）を活用

### 実行時間
- **Apps Script全体の実行時間制限**: 約6分
- **推奨対策**:
  - スライド数が多い場合はバッチ処理を検討
  - `SETTINGS.SHOULD_CLEAR_ALL_SLIDES = false` にして既存スライドに追加する方式も可能

### テキストオーバーフロー回避
- 上記「最大要素数目安」および「文字数制限」を厳守
- 要素数・文字数が上限を超える場合、スライドを分割する

### フォント安全性
- **デフォルトフォント**: Arial（Google Slidesで確実に利用可能）
- Arialが環境に存在しない場合、標準サンセリフフォントに自動フォールバックする
- カスタムフォントを使用する場合、Google Fontsの埋め込み可能なフォントを選択

### 文字列リテラルの安全性
- シングルクォート（`'`）とバックスラッシュ（`\`）は必ずエスケープ
- **例**: `今日の目標は「成長」です` → GAS内では `'今日の目標は¥「成長¥」です'` のようにエスケープ（JavaScript文字列として安全に扱う）
- AI生成時は自動エスケープを実装すること

---

## 3. 出力形式ルール

### 出力の唯一性
- **出力はBLUEPRINT.mdの完全な全文**であり、唯一の差分は`slideData`配列の内容
- コード以外のテキスト（前置き/解説/謝罪/補足コメント）は**一切含めない**
- **正しい出力**: コードブロック全体のみ
- **誤った出力**: 「以下のコードを使用してください」などの前置き、「ここではXXを変更しました」などの補足説明

### slideData配列の形式
- JavaScript配列リテラル形式（`const slideData = [...]`）
- 各要素はオブジェクトリテラル（`{ type: '...', ... }`）
- 文字列プロパティはシングルクォートまたはダブルクォートで囲む
- 末尾カンマ（trailing comma）は許容されるが、古い環境との互換性のため避けることを推奨

---

## 4. 自己検証チェックリスト

生成した`slideData`配列をGASに貼り付ける前に、以下をチェックしてください。

### 必須検証項目

- [ ] **全スライドが有効な`type`を持つか**
  - 有効な`type`: `title`, `section`, `content`, `compare`, `process`, `timeline`, `diagram`, `cards`, `table`, `progress`, `closing`
- [ ] **必須プロパティがすべて存在するか**
  - `title`: `title`, `date`
  - `section`: `title`
  - `content`: `title`, (`points` または `images`)
  - `compare`: `title`, `leftTitle`, `leftItems`, `rightTitle`, `rightItems`
  - `process`: `title`, `steps`
  - `timeline`: `title`, `milestones`
  - `diagram`: `title`, `lanes`
  - `cards`: `title`, `items`
  - `table`: `title`, `headers`, `rows`
  - `progress`: `title`, `items`
  - `closing`: （プロパティ不要、`notes`のみ任意）

### 文字数・要素数制限

- [ ] **文字数制限を遵守しているか**
  - title: 35文字以内（title/closing/sectionは40文字まで可）
  - subhead: 50文字以内
  - 箇条書き要素: 90文字以内
- [ ] **要素数制限を遵守しているか**
  - content.points: 7個以内
  - compare.leftItems/rightItems: 各5個以内
  - process.steps: 6個以内
  - timeline.milestones: 6個以内
  - diagram.lanes: 4レーン以内、各レーン5アイテム以内
  - cards.items: 6個以内
  - table.headers: 5列以内、rows: 8行以内
  - progress.items: 6個以内

### テキスト形式・記号

- [ ] **箇条書き要素に改行（`\n`）を含めていないか**
- [ ] **禁止記号（`■` / `→`）を含めていないか**
- [ ] **箇条書き文末に句点「。」を付けていないか**

### スピーカーノート

- [ ] **`notes`プロパティが各スライドに設定されているか**
  - プレゼンテーション時の補足説明として必須
  - 省略可能だが、設定することを強く推奨

### その他

- [ ] **title.dateは`YYYY.MM.DD`形式か**（例: `2025.08.12`）
- [ ] **アジェンダ安全装置が動作するか**
  - タイトルが「アジェンダ/Agenda/目次/本日お伝えすること」の場合
  - `points`が空でもエラーにならない（自動生成またはデフォルト値が適用される）
- [ ] **スライド上限50枚以内か**
- [ ] **画像URL形式が正しいか**（https:// から始まる有効なURL）

---

## 5. インライン強調記法の詳細

### 利用可能な強調記法

| 記法 | 効果 | 例 |
|-----|------|-----|
| `**太字**` | 太字表示 | `パフォーマンス**最適化**が必要` → パフォーマンス**最適化**が必要 |
| `[[重要語]]` | 太字＋Googleブルー（#4285F4） | `[[重要機能]]実装済み` → **重要機能**実装済み（青色） |

### 処理メカニズム

- `parseInlineStyles`関数が`**...**`および`[[...]]`を検出し、スタイル範囲を記録
- 強調記法のマーカー（`**`、`[[`、`]]`）は最終テキストから削除される
- スタイル範囲情報を元に、Google Slides API（`TextRange.getTextStyle()`）で太字・色を適用

### 適用範囲

- ✅ **利用可能**: `title`, `subhead`, `points`, `steps`, `leftItems`, `rightItems`, `cards.items.desc` 等すべてのテキストプロパティ
- ❌ **利用不可**: `notes`（スピーカーノート）
  - スピーカーノートはプレーンテキストのみで、強調記法は適用されない
  - `notes`内に`**`や`[[`を含めても無視される

### 注意事項

- 強調記法の入れ子（例: `**[[太字と青]]**`）は動作保証外
- 開始記号と終了記号が対応していない場合（例: `**太字`のみ）は無視される

---

## 6. アジェンダ安全装置の詳細

### 対象タイトル

以下のキーワードを含むタイトルを持つ`content`スライドが対象です。

- `agenda` / `Agenda`
- `アジェンダ`
- `目次`
- `本日お伝えすること`

### 動作

1. **対象タイトル検出**: `isAgendaTitle`関数が正規表現でタイトルを判定
2. **points未設定の場合**: `buildAgendaFromSlideData`関数が`slideData`内の`section`スライドの`title`を収集し、自動的に`points`を生成
3. **sectionが存在しない場合**: `content`スライドの`title`を収集して代用
4. **それでも空の場合**: デフォルト3点（`['本日の目的', '進め方', '次のアクション']`）を適用

### 目的

- アジェンダスライドの`points`を手動設定し忘れた場合でも、空のスライドにならないようにする
- プレゼンテーション全体の構成を自動的に抽出してアジェンダに反映

### カスタマイズ

- デフォルト3点を変更する場合、`createContentSlide`関数内の以下の行を編集:
  ```javascript
  if (points.length === 0) points = ['本日の目的', '進め方', '次のアクション'];
  ```

---

[← SKILL.mdに戻る](./SKILL.md)
