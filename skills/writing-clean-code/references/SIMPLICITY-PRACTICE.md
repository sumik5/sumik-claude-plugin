# 簡潔性の実践

コードの簡潔性は、読みやすさ、保守性、変更容易性に直結する。本ドキュメントでは、簡潔性を実現するための具体的な実践方法を示す。

---

## 簡潔性の法則

> **どのようなソフトウェアも、その管理のしやすさは個々の部分の簡潔性に比例する。**

平均的な規模のコンピュータプログラムは、どのような人間もそのすべてを一度に把握することはできないほど複雑である。人間は部分ごとに理解していくことしかできない。部分が簡潔であればあるほど、誰が見てもそれを理解できる可能性は高い。

**管理しやすさへの効果**:
- 小さくシンプルなピースごとに書けば、不具合の修正やシステム管理は容易になる
- 巨大で複雑な塊で設計すれば、管理は難しくなり、常にパッチやハックを加えなければ動き続けることもできない
- 長い目で見て効率的だと言えるのは、複雑なものではなく簡潔性を備えたもの

---

## 簡潔性は相対的

簡潔性の定義は、対象・文脈・親近感によって異なる。

### 対象による違い

- 作り手にとって簡潔なことが、はじめて見る人には複雑に映る
- 完成した後でそれをはじめて見る人の視点を理解するには、自分にとって未知のコードを読んでみるとよい

### 文脈による違い

- プログラムコードの文脈では、高度な技術が正しく使われることで簡潔性が導き出される
- しかし、その高度な内部構造がウェブページに直接表示され、それが唯一のインターフェースだとしたら、開発者にとってすら簡潔ではない
- 道ばたの看板に説明的な文章をたくさん表示するのは過剰に複雑だが、コンピュータプログラムのマニュアルを書く場合、具体的にあれこれ説明した文章をたくさん書くことのほうが、ずっと簡潔になる

### 親近感による違い

- 特定のツールを長い間使い続けた人は、それに慣れているため、使っている当人にとっては他のツールより簡単に感じられる
- 新しいツールが、使い古したものと同等に簡単だと感じられるようになるためには、そのツールはきわめて簡潔でなければならない

### 対処法

通常、どのような事柄にも特定の対象層があり、該当する事象についての文脈はかなり限定される。重要なのは、ソフトウェアのデザイン時にこれらのことを考慮することである。そうすれば、実際に誰かが使う段になったらその人にとって非常に簡潔なものとなるはずだ。

---

## どこまで簡潔にするか

> **本当に成功したいと思ったら、これ以上ないほど、アホでもわかるほど簡潔にすること。**

### 基準の理解

簡潔性のレベルについて良いことがあるとすれば、だいたいにおいて、普通の人が耐えられるレベルは天才にも通用するということだ。ユーザーの対象範囲がかなり広くなる。

### よくある間違い

多くの開発者が、コードを書く際に同じような間違いをしてしまう：

- 書くのに多くの時間を使ったのだから他の開発者も進んで多くの時間をコードの解読に費やしてくれるはずだ、と思い込む
- 開発者の自分にとって重要なコードが皆にとっても重要でないわけがないだろう、という理屈

これは知性の問題ではなく、**知識**の問題である。コードをはじめて見る開発者は何も知らないのだから、そのコードを勉強しなければならない。

### 簡潔にする方法

- ドキュメンテーションを簡潔にする
- デザインを簡潔にする
- ステップごとに説明したチュートリアルを用意する

### 見下ろすような態度の回避

見下ろすような目線で話しかけられ、まるでアホのように扱われることを好む人は、誰もいない。それを避けるために、難しい言葉を散りばめ、わざと少々複雑になるように作り込むのは間違いである。

逆に、製品やコードをアホみたいに簡潔にすることは、他人にも理解できるようにしているということだ。プログラムを見た人は自分が賢いと感じ、やりたいことをしているだけのその開発者に対して、悪印象を持ったりはしないだろう。

### 対象の明確化

「家族全員に読者のコードを読めるようにしろ」ということではない。簡潔性は相対的なもので、対象としている相手はあくまでも**他の開発者**だ。その開発者たちにとって、コードがたいへん簡潔であり、理解しやすいものであるようにしなければならない。

---

## 一貫性を保つ

簡潔性の大部分を占めるのは、一貫性だ。ある箇所で一つのやり方を採ったのであれば、そのやり方をコードのすべてに適用する。

### 命名規約

たとえば、ある変数を `somethingLikeThis` と名づけたのであれば、他の変数も同じ法則に従って名づける（`otherVariable`、`anotherNameLikeThat` など）。変数を `named_like_this` というかたちにするのであれば、他の変数にもすべて「小文字＋アンダースコア」を使う。

理解し、読むのがプログラマーにとって難しくなるのは、一貫性のないコードだ。

### 動作の仕組み

プログラムの内部の**働き**にも、一貫性がなければならない：

- コードの一部を使い慣れている開発者がコードの他の部分もすぐに使えるよう、同じ動作の仕組みを使うべきだ
- 部分Aでは3つの関数を呼び出し、コードを追加する必要があるとすれば、部分Bでも同様に、3つの関数を呼び出し、コードを追加する形でなければならない
- 部分Aに `dump` という関数があって、部分Aの内部変数がすべて出力できるようになっているのであれば、部分Bにある `dump` も部分Bに対して同じ動作をしなければおかしい

コードのセクションを移動するたびにシステムの動作を覚え直すような真似を、他の開発者に強いてはならない。

### コーディングスタイル

「どのような方法を採ってもかまわないが、やるのであれば最後まで**必ず**その方法を使わなければならない」ということがある。

一貫性が完全に保たれることで、プログラミングが容易になることも多い。たとえばプログラム中のオブジェクトすべてに `name` というフィールドがあった場合、プログラム全体にある、すべてのオブジェクトの `name` フィールドを処理する簡潔なコードが書ける。しかし、もしオブジェクトAのフィールド名が `a_name` で、オブジェクトBのフィールド名が `name_of_mine` だとしたら、それぞれのオブジェクトを対象とした特別なコードを書かなければ処理できない。

---

## 読みやすさ

ソフトウェア開発の世界では、「コードは書かれるよりも読まれる回数が多い」とよく言われる。だからこそ、コードを読みやすくするのは大切だ。

> **コードの読みやすさは、基本的に文字と記号の間のスペースの取り方によって変わる。**

### スペースの重要性

宇宙全体が真っ黒であれば、物体の区別がつかないだろう。すべてが真っ黒な塊になってしまうからだ。同様に、ファイル全体が、一貫性のない、論理的なスペースが挟まれていないコードの塊だったとしたら、部分ごとに見分けるのは難しい。スペース（空白）とは、ものの区別をつけるためにあるのだ。

### スペースの入れ方の原則

- スペースを入れすぎるのもよくない。物事がどのように関連しているかを示しにくくなるからだ
- スペースが小さすぎるのも、物事の分かれ目が見にくくなるのでよくない
- 一貫性を持ち、コードの構造を読み手にわかりやすくするように入れる

### 悪い例: スペースが足りない

```javascript
x=1+2;y=3+4;z=x+y;if(z>y+x){print"error";}
```

スペースが足りず、コードの構造に関する情報が非常に少ない。

### 悪い例: スペースを入れすぎ

```javascript
x            =            1+            2;
y = 3            +4;

  z = x    +      y;
if (z >      y+x)
 {        print "error" ;
        }
```

過剰なスペースのせいで読み手にはコードの構造がわからない。

### 良い例: 適切なスペース

```javascript
x = 1 + 2;
y = 3 + 4;
z = x + y;
if (z > y + x) {
    print "error";
}
```

かなり読みやすくなっただけでなく、開発者がプログラムをデザインした意図が理解できる。3つの変数が設定され、ある条件に従ってエラーが出力される。そういうシステム構造が、開発者が挿入したスペースによって読み手にもはっきりと示される。

### 読みやすさとバグ修正

コードを読みやすくしておけば、修正もしやすい。上記の良い例では、`z` は `y + x` と等しいため、それよりは大きくならないことがわかる。そうすると、`z > y + x` の部分は不要なので削除したほうがよい。

一般的に、読みにくい、バグだらけのコードがあったら、まず、読みやすくするのが先決だ。そうすれば、バグがどこにあるのかがはっきりと見えるようになる。

---

## 命名

> **名前は、対象の内容や働きが十分に伝わるだけの長さを持ちつつも、読みにくくなるほど長くなってはならない。**

### 使用方法の考慮

関数、変数などがどのように使用されるかを考えることも重要だ：

- コードの行にその名前を入れると、その行は、読むには長すぎてしまったりしないか
- ある一行だけに、一度しか呼び出さない関数があった場合、長い名前を付けても問題ない
- 何度も複雑な表現に使う関数であれば、その名前は短いほうがよい（とはいえ、それが何の関数かがわかるくらいには、長くなければならない）

### 悪い例: 名前が短すぎる

```javascript
q = s(j, f, m);
p(q);
```

これらの名前では、変数や関数が何をするのかがわからない。

### 良い例: 適切な長さの名前

```javascript
quarterly_total = sum(january, february, march);
print(quarterly_total);
```

何をしているかが明確に伝わる。

### 悪い例: 名前が長すぎる

```javascript
quarterly_total_for_company_in_2011_as_of_today =
    add_all_of_these_together_and_return_the_result(
        january_total_amount,
        february_total_amount,
        march_total_amount
    );
send_to_screen_and_dont_wait_for_user_to_respond(
    quarterly_total_for_company_in_2011_as_of_today
);
```

これらの名前は場所をとりすぎているため、読みにくい。名前を付ける、ということにおいても、スペースの挟み方などと同じく、空間に文字や記号をどう配置するか、という視点が重要になる。

---

## コメント

良いコメントをコードに入れるのは、読みやすさに大きく貢献する。

### コメントの目的

> **コメントは「何をしているか」ではなく、「なぜそうしているか」を説明しなければならない。**

### 「何を」を説明する必要はない

一般的には、コードのある部分が**何を**しているかをコメントに入れる必要はない。それは、コードを読めば明白のはずだからだ。

- コードを読んでも**明白でない**場合、コードをより簡潔にすべきだ
- コードを簡潔にできない場合にかぎり、コメントで動作を説明すればよい

### 「なぜ」を説明する

コメントを挿入する本当の目的は、**なぜ**そのようなことをしたのかを、理由が明白でない場合に説明することだ。説明しないと他の開発者が混乱するかもしれない。彼らがコードを変更する段になって、各コードの存在理由を理解できないことから重要な部分を取り除いてしまう可能性もある。

### 読みやすさだけでは不十分

コードの簡潔性を実現する秘訣はコードの読みやすさに尽きる、と考える人もいるが、これは真ではない。コードが読みやすくても複雑すぎるシステム、というのは存在しうるからだ。しかし、コードを読みやすくすることがとても重要であることに変わりはない。それは通常、良いソフトウェアデザインを目指す道の第一歩とされている。

---

## DRY原則（何度も同じことを繰り返さない）

> **システムにおいて、理想上は特定の情報はたった一度だけ存在すればよい。**

### 情報の一元化

たとえば、プログラムのUI上で「Password」というフィールドが100個の画面に出てくる場合を考える：

- フィールド名を格納する箇所が中核的な1箇所だけであれば、コードを1行変えるだけで修正は終わる
- 「Password」と100個の画面すべてにマニュアルで入力していた場合には、100個分の変更をしなければ修正ができない

### コードの塊への適用

この法則は、コードの塊にも適用できる：

- コードを塊ごとにコピーやペーストしてはならない
- その代わりに、コードのあるまとまった部分から、コードの別の部分に存在するものを「使用」「呼び出し」「組み込み」するよう、さまざまなプログラミング技術を駆使すべきだ

### 有意性

このルールを守ることの有意性として挙げられるのは：

1. **不具合発生率の低減**: 古いコードを使い回せるのであれば、新機能を追加する際にもコードの追加や変更をしなくて済むし、そうすれば不具合の発生率も減る
2. **デザインの柔軟性**: プログラムの動作を変えたい場合に、プログラム全体を見直して複数の変更をするより、決まった場所に存在するコードだけを変更すればよい

良いデザインの多くはこのルールに基づいている。コードに他のコードを「使わせ」て情報を集中させるように知恵を絞れば絞るほど、デザインは良くなる。

---

## 簡潔性の実践判断テーブル

| 状況 | 判断基準 | アクション |
|-----|---------|----------|
| 新しいコードを書く | 「これ以上はないほど、アホでもわかるほど簡潔」か | より簡潔にする方法を探す |
| 命名規約が混在 | 一貫性があるか | プロジェクト全体で統一する |
| スペースが不規則 | コードの構造が視覚的に明白か | 一貫したスペースルールを適用 |
| 変数名が `q`, `s` など | 何をするのかが伝わるか | 内容や働きが伝わる名前に変更 |
| 変数名が50文字超 | 読みにくくなっていないか | 必要な情報のみに絞る |
| コメントが「xを計算する」 | 「なぜ」を説明しているか | 理由が不明瞭な場合のみ追加 |
| 同じコードが3箇所以上 | 情報が一元化されているか | 関数/モジュールに抽出 |
| はじめて見る開発者の視点 | 勉強しやすいか | ドキュメント・チュートリアル追加 |
| 難しい言葉・複雑な構造 | 見下ろすような態度になっていないか | よりシンプルな表現に書き換え |
| 部分Aと部分Bで動作が違う | 同じ動作の仕組みを使っているか | 動作を統一する |
