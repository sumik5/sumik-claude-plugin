# DevOps実践ガイド

## 概要

### DevOpsとは

DevOpsは、ソフトウェアデリバリーを大幅に効率化するための方法論です。文化・価値観だけでなく、具体的なアーキテクチャ・プロセス・ツールセットの選択と段階的採用を含みます。

### なぜDevOpsが重要か

世界クラスのソフトウェアデリバリーを持つ企業と、そうでない企業の間には、10倍〜200倍、あるいはそれ以上の差が存在します：

| DORAメトリクス | エリート vs 低パフォーマー |
|---------------|---------------------------|
| デプロイ頻度 | 10〜200倍多い（月1回 vs 日に複数回） |
| リードタイム | 10〜200倍速い（36時間 vs 5分） |
| 変更失敗率 | 13倍低い（3件中2件 vs 20件中1件） |
| 復旧時間 | 700〜4000倍速い（24時間 vs 2分） |

---

## DevOps進化3ステージ

企業規模・トラフィック・複雑性に応じて、DevOpsアーキテクチャとプロセスは段階的に進化します。以下は典型的な進化パターンです。

### Stage 1: スタートアップ・新規プロジェクト

**ステップ1: 単一サーバー + ClickOps**
- すべてを1台のサーバーで実行
- インフラとデプロイは手動管理（ClickOps）

**ステップ2: データベース分離 + バージョン管理 + CI**
- データベースを独立サーバーに分離
- バージョン管理システム（Git等）導入
- 自動テスト + 継続的インテグレーション（CI）

**ステップ3: 複数サーバー + ロードバランシング + ネットワーキング + 監視**
- トラフィック増加に対応して複数サーバー展開
- ロードバランサーでトラフィック分散
- プライベートネットワークでセキュリティ確保
- バックアップ・スキーママイグレーション・基本監視

**適用範囲**: 多くのソフトウェアプロジェクトはStage 1で十分。問題がなければ、次のステージに進む必要はありません（複雑性のコストを避けられる）。

### Stage 2: 成長企業・大規模ユーザーベース

**ステップ4: キャッシング（データストア + 静的コンテンツ）**
- データベースの読み込みレプリカ・キャッシュ追加
- CDNで静的コンテンツ配信

**ステップ5: 複数環境 + CD + 認証・シークレット管理**
- 複数環境（dev/stage/prod）展開
- 継続的デリバリー（CD）導入
- 認証・認可・シークレット管理の強化

**ステップ6: マイクロサービス + Infrastructure as Code**
- モノリスをマイクロサービスに分割（各サービスが独自のデータストア・キャッシュを持つ）
- Infrastructure as Code（IaC）でインフラ管理

**特徴**: Stage 2は複雑性が大幅に増加。専用インフラチームが必要になることが多い。

### Stage 3: 大規模エンタープライズ・膨大なユーザーベース

**ステップ7: オブザーバビリティ + サービスディスカバリー + ハードニング + サービスメッシュ**
- トレーシング・オブザーバビリティツール導入
- サービスディスカバリーで動的通信
- サーバー・ネットワークハードニング（NIST/CIS/PCI準拠）
- サービスメッシュで統合管理

**ステップ8: アナリティクス + イベントバス + フィーチャートグル**
- データウェアハウス・機械学習プラットフォーム
- イベントバスでイベント駆動アーキテクチャ
- フィーチャートグル・カナリアデプロイ

**ステップ9: マルチデータセンター + マルチアカウント + 高度ネットワーキング + IDP**
- グローバルユーザー対応で複数データセンター
- チーム・製品ごとに複数アカウント分離
- 高度ネットワーキングでデータセンター・アカウント接続
- Internal Developer Platform（IDP）で開発者生産性向上

**適用範囲**: 最もタフな問題に直面する企業（グローバル展開・数千人の開発者・数百万の顧客）。

---

## DevOps導入の原則

### 1. 会社のステージに適した設計を採用

**悪い例**:
- 3人のスタートアップが12のマイクロサービス・サービスメッシュ・イベントバスを導入
- → 存在しない問題を解決するために膨大なコストを支払う

**良い例**:
- 自社の規模・トラフィック・複雑性に合わせて、適切なステージの設計を選択
- Stage 1で十分なら、複雑なStage 3の設計を採用しない

### 2. インクリメンタリズム（段階的採用）

**False Incrementalism（偽のインクリメンタリズム）の回避**:
- 大規模プロジェクトを小さなステップに分割しても、すべてのステップが完了しないと価値が得られない場合は失敗のリスクが高い
- 例: UIリデザイン → バックエンド書き換え → データ移行（すべて完了しないと価値なし）

**True Incrementalism（真のインクリメンタリズム）**:
- 各ステップが独立して価値を提供する
- 例: 1つのアプリ・1つのチームの問題を特定 → 具体的な解決策を実装 → 次のアプリ・チームへ展開
- 早期に価値を提供し、勢いをつける

**Key Takeaway**: DevOpsを一気に導入しない。小さなステップで、各ステップが独立して価値を提供するように分割する。

---

## Infrastructure as Code（IaC）ツール選定

IaCツールは以下の4カテゴリに分類されます。各カテゴリは特定の用途に最適化されています。

### IaC 4カテゴリ概要

| カテゴリ | 例 | 用途 | CRUD | スケール | 冪等性 | 一貫性 | 簡潔性 |
|---------|-----|------|------|---------|--------|--------|--------|
| Ad hoc scripts | Bash, Python | 小規模・一時的タスク | C | ❌ | ❌ | ❌ | ❌ |
| Configuration Management | Ansible, Chef, Puppet | サーバー設定管理 | CRU | ✅ | △ | ✅ | ✅ |
| Server Templating | Packer, Docker | イミュータブルインフラ | C | ✅ | ✅ | ✅ | ✅ |
| Provisioning | OpenTofu, CloudFormation, Pulumi | サーバー・インフラプロビジョニング | CRUD | ✅ | ✅ | ✅ | ✅ |

**詳細は [IAC-TOOLS.md](references/IAC-TOOLS.md) を参照**

### IaCツール選定の原則

1. **Ad hoc scripts**: 小規模・一時的タスクに最適。インフラ全体の管理には不向き
2. **Configuration Management**: サーバー設定管理に最適。サーバー自体のデプロイには不向き
3. **Server Templating**: イミュータブルインフラ実践に最適
4. **Provisioning**: サーバー・インフラのデプロイ・管理に最適
5. **組み合わせ**: 実際のプロジェクトでは複数カテゴリを組み合わせる

---

## オーケストレーション選定

アプリケーションの展開・管理方法を決定する際、4つのオーケストレーションアプローチから選択します。

### オーケストレーション 4分類概要

| カテゴリ | 例 | 概要 | Replicas | Load Balancing | Auto Scaling | Auto Healing | Zero-Downtime |
|---------|-----|------|----------|----------------|--------------|--------------|---------------|
| Server Orchestration | Ansible | 複数サーバーに直接デプロイ | 手動設定 | 外部LB必要 | ❌ | ❌ | 手動実装 |
| VM Orchestration | AWS ASG | 仮想マシン群の管理 | ✅ | ✅ | ✅ | ✅ | ✅ |
| Container Orchestration | Kubernetes/EKS | コンテナ群の管理 | ✅ | ✅ | ✅ | ✅ | ✅ |
| Serverless Orchestration | Lambda | 関数単位のデプロイ | 自動管理 | 自動管理 | 自動管理 | 自動管理 | ✅ |

**詳細は [ORCHESTRATION.md](references/ORCHESTRATION.md) を参照**

### オーケストレーション選定の原則

1. **Server Orchestration**: 学習コストが低い。手動管理が増えるため、小規模プロジェクト向け
2. **VM Orchestration**: AWS等のクラウド標準機能で実装可能。中規模プロジェクトに最適
3. **Container Orchestration**: Docker + Kubernetes。高速デプロイ・複雑な機能が必要な場合に最適
4. **Serverless Orchestration**: サーバー管理不要・スケールtoゼロ可能。制約が許容できる場合に最適

---

## CI/CDパイプライン

**継続的インテグレーション（CI）**:
- コード変更のたびに自動ビルド・テスト実行
- 問題を早期発見し、マージ前に修正

**継続的デリバリー（CD）**:
- 本番環境へのデプロイを自動化
- ゼロダウンタイムデプロイ戦略（ローリング・ブルーグリーン・カナリア）

**詳細は [CICD-PIPELINE.md](references/CICD-PIPELINE.md) を参照**

---

## プラットフォームエンジニアリング

Internal Developer Platform（IDP）を構築し、開発者のセルフサービス環境を提供：

- アカウントベースライン・アカウントファクトリー
- ゴールデンパス（承認済みツール・ワークフロー）
- セキュリティ・コンプライアンス自動化

**詳細は [PLATFORM-ENGINEERING.md](references/PLATFORM-ENGINEERING.md) を参照**

---

## データ・オブザーバビリティ

### データ管理
- スキーママイグレーション
- バックアップ・リカバリ戦略
- データウェアハウス・データレイク

### オブザーバビリティ
- メトリクス・ログ・トレーシング
- 分散トレーシング（OpenTelemetry）
- SLO/SLI設計

**詳細**: `designing-monitoring` スキル、`implementing-opentelemetry` スキル、および [DATA-OBSERVABILITY.md](references/DATA-OBSERVABILITY.md) を参照

---

## ユーザー確認の原則

以下の判断分岐箇所では、必ずAskUserQuestionツールでユーザーに確認してください：

### IaCツール選定時
- 複数カテゴリの組み合わせが必要な場合、どの組み合わせを選択するか
- 既存ツールがある場合、移行するか継続使用するか

### オーケストレーション選定時
- トレードオフが拮抗している場合（例: Kubernetesの学習コスト vs 機能の豊富さ）
- コスト・複雑性・スピードのバランスをどう取るか

### デプロイ戦略選定時
- ゼロダウンタイム要件の厳格さ
- ロールバック戦略の優先度

---

## クイックリファレンス

### IaCツール判断テーブル

| 要件 | 推奨カテゴリ |
|------|-------------|
| 小規模・一時的タスク | Ad hoc scripts |
| サーバー設定管理 | Configuration Management |
| イミュータブルインフラ | Server Templating |
| サーバー・インフラプロビジョニング | Provisioning |
| 複数カテゴリ組み合わせ | Provisioning + Server Templating + Orchestration |

### オーケストレーション判断テーブル

| 要件 | 推奨カテゴリ |
|------|-------------|
| 小規模・学習コスト重視 | Server Orchestration |
| 中規模・クラウド標準機能 | VM Orchestration |
| 高速デプロイ・複雑な機能 | Container Orchestration |
| サーバー管理不要・スケールtoゼロ | Serverless Orchestration |

### DevOps進化ステージ判断

| 会社規模 | トラフィック | 推奨ステージ |
|---------|-------------|-------------|
| スタートアップ・新規 | 低 | Stage 1 |
| 成長企業 | 中〜高 | Stage 2 |
| 大規模エンタープライズ | 膨大 | Stage 3 |

---

## ベストプラクティス

1. **インクリメンタリズム**: 一度にすべてを変えない。小さなステップで価値を提供
2. **適切なステージ選択**: 会社規模に合わせた設計を採用
3. **ツールの組み合わせ**: 単一ツールですべてを解決しない。適材適所で組み合わせる
4. **イミュータブルインフラ**: 可能な限りServer Templating + Provisioningを採用
5. **自動化**: ClickOpsを避け、IaCでインフラを管理
6. **監視**: 早期から基本監視を導入し、段階的に高度化

---

## 関連スキル・参照ドキュメント

### 関連スキル
- `developing-terraform` - Terraform/OpenTofu HCL開発
- `managing-docker` - Docker操作・コンテナ管理
- `designing-monitoring` - 監視システム設計
- `implementing-opentelemetry` - OpenTelemetry計装

### 参照ドキュメント
- [IAC-TOOLS.md](references/IAC-TOOLS.md) - IaCツール詳細比較
- [ORCHESTRATION.md](references/ORCHESTRATION.md) - オーケストレーション詳細比較
- [CICD-PIPELINE.md](references/CICD-PIPELINE.md) - CI/CDパイプライン実装
- [PLATFORM-ENGINEERING.md](references/PLATFORM-ENGINEERING.md) - プラットフォームエンジニアリング
- [DATA-OBSERVABILITY.md](references/DATA-OBSERVABILITY.md) - データ・オブザーバビリティ
