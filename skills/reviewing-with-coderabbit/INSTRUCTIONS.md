# CodeRabbit コードレビュー

CodeRabbit を使った AI コードレビュー。機能実装・コードレビュー・問題修正を自律的なサイクルで実行し、手動介入なしで完了させる。

## 機能

- 変更されたコードのバグ、セキュリティ問題、品質リスクを検出
- 深刻度別に分類（Critical, Warning, Info）
- ステージ済み・コミット済み・全変更に対応。ベースブランチ/コミット指定も可能
- 修正提案付き出力（`--plain`）またはAgent最適化出力（`--prompt-only`）
- **自動修正ループ**: レビュー → 修正 → 再レビューを問題解消まで繰り返す

## 使用タイミング

ユーザーが以下を依頼した場合:

- コード変更のレビュー / コードをレビューして
- コード品質のチェック / バグやセキュリティ問題の検出
- PRフィードバック / プルリクエストのレビュー
- コードの問題点を教えて / 変更内容を確認して
- coderabbit を実行して / coderabbit を使って

## レビュー手順

### 1. 前提条件の確認

```bash
coderabbit --version 2>/dev/null || echo "NOT_INSTALLED"
coderabbit auth status 2>&1
```

**CLI が未インストールの場合**、ユーザーに伝える:

```text
CodeRabbit CLI をインストールしてください:
curl -fsSL https://cli.coderabbit.ai/install.sh | sh
```

**未認証の場合**、ユーザーに伝える:

```text
認証を行ってください:
coderabbit auth login
```

### 2. レビュー実行（デフォルト: 未コミットの変更）

デフォルトでは未コミットの変更のみをレビューする:

```bash
coderabbit review --prompt-only --type uncommitted
```

**オプション:**

| フラグ           | 説明                                     |
| ---------------- | ---------------------------------------- |
| `-t all`         | 全変更                                   |
| `-t committed`   | コミット済みの変更のみ                   |
| `-t uncommitted` | 未コミットの変更のみ（デフォルト）       |
| `--base main`    | 特定のブランチと比較                     |
| `--base-commit`  | 特定のコミットハッシュと比較             |
| `--prompt-only`  | Agent最適化の簡潔な出力                  |
| `--plain`        | 修正提案付きの詳細出力                   |

**省略形:** `cr` は `coderabbit` のエイリアス:

```bash
cr review --prompt-only --type uncommitted
```

### 3. 結果の提示

深刻度別にグループ化して報告:

1. **Critical** - セキュリティ脆弱性、データ損失リスク、クラッシュ
2. **Warning** - バグ、パフォーマンス問題、アンチパターン
3. **Info** - スタイルの問題、提案、軽微な改善

### 4. 自動修正ループ（デフォルトワークフロー）

レビュー指摘を自動修正し、問題がなくなるまで繰り返す。これがデフォルトのワークフロー。

#### フロー

```
┌─────────────────────────────────────┐
│  1. レビュー実行                      │
│  coderabbit review                  │
│    --prompt-only                    │
│    --type uncommitted               │
├─────────────────────────────────────┤
│  2. 結果解析                         │
│  - Critical / Warning / Info        │
├─────────────────────────────────────┤
│  3. Critical または Warning あり？    │
│  ├─ YES → 問題を修正                 │
│  │   └─ ステップ1に戻る              │
│  └─ NO  → 完了 ✓                    │
└─────────────────────────────────────┘
最大イテレーション: 5回
```

#### 手順

1. **レビュー実行**:
   ```bash
   coderabbit review --prompt-only --type uncommitted
   ```

2. **出力の解析**: レビュー結果を解析し、深刻度別（Critical, Warning, Info）に分類する。

3. **Critical または Warning の問題がある場合**:
   - Critical と Warning の全問題をタスクリストに作成
   - Critical から順に体系的に修正
   - 全修正が完了したらステップ4へ

4. **再レビュー実行**:
   ```bash
   coderabbit review --prompt-only --type uncommitted
   ```

5. **結果確認**:
   - 新たな Critical/Warning がある → ステップ3から繰り返す
   - Info のみまたは問題なし → **レビュー完了**

6. **イテレーション上限**: 最大5回。5サイクル後も問題が残る場合、残存する問題をユーザーに報告して停止する。

#### ユーザー確認

修正が不明確またはリスクがある場合、必ず `AskUserQuestion` ツールを使ってユーザーに確認を取ること:

- 修正方法が複数ある場合 → 選択肢を提示して確認
- 修正の影響範囲が大きい場合 → 修正内容を説明して確認
- レビュー指摘の意図が不明確な場合 → 解釈を確認

#### 注意事項

- **Info レベルの指摘は許容** - 特に要求がない限り、Info レベルの問題は修正しない
- **イテレーション回数を追跡** - 現在のイテレーションを報告する（例: 「レビュー イテレーション 2/5」）
- **進捗を報告** - 各イテレーション後に、修正内容と残存する問題を要約する
- **新しい問題を生まない** - 修正時に新たな問題を作り込まないよう注意する
- **修正が不明確またはリスクがある場合** - `AskUserQuestion` ツールを使ってユーザーに確認を取ってから適用する

### 5. 特定の変更をレビュー

**全変更をレビュー（未コミットに限らない）:**

```bash
cr review --prompt-only -t all
```

**特定のブランチと比較してレビュー:**

```bash
cr review --prompt-only --base main
```

**特定のコミット範囲をレビュー:**

```bash
cr review --prompt-only --base-commit abc123
```

## ドキュメント

詳細: <https://docs.coderabbit.ai/cli>
