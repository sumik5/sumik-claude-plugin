# 長時間夜間ランニングテスト リファレンス

開発用マシンを活用した長時間連続E2Eテスト実行の設計・運用パターン。
CI では検出困難な問題を発見するための補完的手法として活用する。

---

## 1. 夜間テストの目的

CI/CDで実行されるE2Eテストは動作環境が毎回ほぼ同じになりがち。
長時間テストは以下を目的として実施する：

- 通常のテスト実行では再現しない**タイミング依存の問題**の発見
- さまざまな動作パラメータの組み合わせによる**動作条件の網羅**
- 個人の開発用マシン（スペック・ネットワーク環境）の**差異を活用**した問題発見

---

## 2. よく発見される問題パターン

| 問題カテゴリ | 具体例 |
|------------|--------|
| データベーストランザクションエラー | 高並列実行時のデッドロック・Abortedエラーに対するリカバリー処理の欠如 |
| タイムゾーン計算誤り | 午前0時〜9時（UTC と JST の日付跨ぎ）にのみ発生する計算誤り |
| データ競合（data race） | Go の `-race` フラグで検出。コードレビューでは発見困難 |
| 競合状態 | 並列リクエストが特定の順序で到着した場合のみ発生する誤動作 |
| テスト順序依存 | テスト間のグローバル状態の汚染（`-shuffle=on` で発見） |

---

## 3. 実行タイミング

テストに要する時間が長くても問題にならない時間帯を活用する：

- 就寝中（夜間）
- 休日・週末
- 昼間の食事・外出・別業務中

---

## 4. パラメータ組み合わせ

以下のパラメータを組み合わせたスクリプトを作成して繰り返し実行する。

### Go 向けパラメータ

| パラメータ | 設定値の例 | 目的 |
|-----------|-----------|------|
| `GOMAXPROCS` | 1, 4, 8, 16, 32, 64, 128 | ゴルーチンスケジューリングへの影響 |
| `-race` フラグ | 有効 / 無効 | データ競合検出器（追加コード挿入でスケジュールにも影響） |
| `-cover` フラグ | 有効 / 無効 | カバレッジ計測（追加コード挿入でスケジュールにも影響） |
| `-p` フラグ | 2, 4, 8 | 並列パッケージ数。テスト対象サービスへの同時リクエスト数に影響 |
| `TZ` 環境変数 | `UTC` / `Asia/Tokyo` | タイムゾーン計算誤りの発見 |
| `-shuffle=on` | 毎回有効推奨 | テスト順序ランダム化。順序依存バグの発見 |

### スクリプト構成例

```bash
#!/bin/bash
# パラメータ組み合わせを定義してテストが失敗するまで繰り返す

GOMAXPROCS_VALUES=(1 4 8 32)
RACE_FLAGS=("-race" "")
TZ_VALUES=("UTC" "Asia/Tokyo")

while true; do
    for gomaxprocs in "${GOMAXPROCS_VALUES[@]}"; do
        for race in "${RACE_FLAGS[@]}"; do
            for tz in "${TZ_VALUES[@]}"; do
                GOMAXPROCS=$gomaxprocs TZ=$tz \
                    go test -tags=e2e $race -shuffle=on ./... || exit 1
            done
        done
    done
done
```

---

## 5. テスト失敗時の対応

### 基本原則：再現している状態で徹底的に調査する

- **再実行して正常なら OK」は禁止**。タイミング依存の問題は再現確率が低い
- 失敗が検出されたマシンの状態のまま、原因を特定するまで調査を続ける
- マルチスレッド・並列処理の問題は、コアダンプやデバッガで停止状態を解析

### 調査時の心理的ハードル

自分が実装していないコードで失敗が発生した場合でも、
自分のマシンで発見した問題として自分で調査する責任を持つ。
これは長時間テストの運用として必要な姿勢である。

---

## 関連資料

- `GO-E2E-IMPLEMENTATION.md` — テスト並列化（`t.Parallel()`）の詳細
- `INSTRUCTIONS.md` Section 3 — E2Eテストフレームワークの全体アーキテクチャ
