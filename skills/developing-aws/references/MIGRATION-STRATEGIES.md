# AWSクラウド移行戦略ガイド

オンプレミスからAWSへの移行戦略、移行パターン（7R）、AWS Migration Hub、AWS MGN（Application Migration Service）、データベース移行、大規模データ移行、および移行後の最適化を包括的に解説する。

> **関連**: データベース移行は [DATABASE-MIGRATION.md](./DATABASE-MIGRATION.md)、エンタープライズ基盤は [ENTERPRISE-ARCHITECTURE.md](./ENTERPRISE-ARCHITECTURE.md) を参照

---

## 1. 移行戦略の全体像

### 1.1 7つの移行戦略（7R）

| 戦略 | 説明 | コスト | 時間 | 最適化度 | 適用場面 |
|------|------|--------|------|---------|---------|
| **Retire** | 廃止 | 最低 | 短 | - | 不要なシステム |
| **Retain** | 現状維持 | なし | なし | なし | 移行対象外（依存関係等） |
| **Relocate** | VMware Cloud on AWS等へ移動 | 低 | 短 | 低 | VMware環境の維持 |
| **Rehost** (Lift & Shift) | そのままクラウドに移行 | 低 | 短 | 低 | 迅速な移行が必要 |
| **Replatform** (Lift & Reshape) | 一部最適化して移行 | 中 | 中 | 中 | DB→RDS、サーバー→コンテナ |
| **Repurchase** | SaaS/PaaS に置換 | 中 | 中 | 中 | CRM→Salesforce等 |
| **Refactor** (Re-architect) | クラウドネイティブに再設計 | 高 | 長 | 高 | ビジネス価値の最大化 |

### 1.2 移行戦略の選定フロー

```
対象システムの評価
├── 不要なシステム → Retire（廃止）
├── 移行できない/しない → Retain（現状維持）
├── VMware環境を維持したい → Relocate
├── とにかく早くクラウドへ
│   ├── 変更なしで移行 → Rehost（Lift & Shift）
│   └── 一部最適化（DB/OS等）→ Replatform（Lift & Reshape）
├── 既存SaaS/PaaSで代替可能 → Repurchase
└── ビジネス要件で根本的な再設計が必要 → Refactor（Re-architect）
```

---

## 2. Cloud Lift（Rehost）: 13ステップ移行プロセス

### 2.1 フェーズ概要

| フェーズ | ステップ | 内容 |
|---------|---------|------|
| **評価** | 1. 現状評価 | インベントリ作成、依存関係マッピング |
| | 2. TCO分析 | オンプレミスvsクラウドのコスト比較 |
| | 3. 移行計画策定 | ウェーブ（移行バッチ）の定義 |
| **準備** | 4. AWS環境構築 | Landing Zone、VPC、IAM設定 |
| | 5. ネットワーク接続 | VPN/Direct Connect設定 |
| | 6. セキュリティ設計 | SG、NACL、WAF設定 |
| **移行** | 7. パイロット移行 | 小規模システムで検証 |
| | 8. サーバー移行 | AWS MGNでVMレプリケーション |
| | 9. データベース移行 | AWS DMS/SCTで移行 |
| | 10. データ移行 | AWS DataSync/Snowball |
| **検証** | 11. テスト実施 | 機能テスト、性能テスト、セキュリティテスト |
| | 12. カットオーバー | DNS切替、トラフィック移行 |
| **最適化** | 13. 最適化 | rightsizing、Savings Plans、クラウドネイティブ化 |

### 2.2 移行アセスメント

#### インベントリ収集

| ツール | 用途 | 収集データ |
|--------|------|----------|
| **AWS Application Discovery Service** | サーバー情報自動収集 | CPU、メモリ、ディスク、プロセス、ネットワーク依存関係 |
| **AWS Migration Hub** | 移行進捗の一元管理 | 移行状態、サーバーマッピング |
| **TSO Logic / Migration Evaluator** | TCO分析 | コスト比較、rightsizing推奨 |

#### 依存関係マッピング
- **Application Discovery Service**のエージェントモードでプロセス間通信を自動検出
- サーバー間の依存グラフを生成し、移行ウェーブ（バッチ）を定義
- 依存関係が強いサーバー群は同一ウェーブで移行

---

## 3. AWS MGN（Application Migration Service）

### 3.1 MGN の仕組み

```
オンプレミス                        AWS
┌─────────────┐                ┌──────────────────┐
│ Source Server│  レプリケーション  │ Staging Area     │
│ + MGN Agent  │ ──────────→ │ (軽量EC2+EBS)    │
└─────────────┘                └────────┬─────────┘
                                        │
                                        │ カットオーバー
                                        ↓
                                ┌──────────────────┐
                                │ Target Server    │
                                │ (本番EC2)        │
                                └──────────────────┘
```

### 3.2 MGN 移行フロー

| ステップ | アクション | 説明 |
|---------|----------|------|
| 1 | エージェント導入 | ソースサーバーにMGNエージェントをインストール |
| 2 | 初期同期 | ディスク全体をAWSにブロックレベルでレプリケーション |
| 3 | 継続的レプリケーション | 差分のみをリアルタイム同期（ダウンタイムなし） |
| 4 | テスト起動 | Staging Areaからテストインスタンスを起動して検証 |
| 5 | カットオーバー | 最終同期→本番インスタンス起動→DNS切替 |
| 6 | ソース切断 | オンプレミス側の停止、MGNエージェント削除 |

### 3.3 MGN の制約と注意点

| 項目 | 制約 |
|------|------|
| **対応OS** | Windows Server 2008 R2+, Linux各種ディストリビューション |
| **ネットワーク** | TCP 443（API）+ TCP 1500（レプリケーション） |
| **ディスクサイズ** | 最大4TBのEBSボリューム |
| **カットオーバー時間** | 数分～数十分（データ量に依存） |
| **注意** | ソースサーバーのリブート不要、本番稼働中にレプリケーション可能 |

---

## 4. Cloud Shift（Replatform/Refactor）

### 4.1 Replatform のパターン

| 対象 | Before | After | メリット |
|------|--------|-------|---------|
| **Database** | オンプレミスMySQL | Amazon Aurora | 高可用性、自動バックアップ、Read Replica |
| **Web Server** | EC2 + Apache | ECS Fargate | サーバー管理不要、自動スケーリング |
| **バッチ処理** | EC2 Cron | Lambda + EventBridge | サーバーレス、実行時間のみ課金 |
| **ファイルサーバー** | EC2 NFS | Amazon EFS / FSx | マネージド、自動バックアップ |
| **メッセージング** | RabbitMQ on EC2 | Amazon MQ / SQS | マネージド、高可用性 |

### 4.2 Refactor のアプローチ

#### Strangler Fig パターン（段階的置換）

```
Phase 1: 新機能のみクラウドネイティブで構築
┌─────────────┐     ┌──────────────┐
│ モノリス     │ ←→ │ 新マイクロSVC │
│ (既存)       │     │ (Lambda/ECS) │
└─────────────┘     └──────────────┘

Phase 2: 既存機能を順次マイクロサービス化
┌─────────────┐     ┌──────────────┐
│ モノリス     │ ←→ │ マイクロSVC群 │
│ (縮小中)     │     │ (拡大中)      │
└─────────────┘     └──────────────┘

Phase 3: モノリス完全置換
                     ┌──────────────┐
                     │ マイクロSVC群 │
                     │ (完全移行)    │
                     └──────────────┘
```

- **APIゲートウェイ**: 旧システムと新システムのルーティングを制御
- **データ同期**: Change Data Capture (CDC) で旧→新DBの同期
- **段階的切替**: Weighted Routingで新システムへ段階的に誘導

---

## 5. データベース移行

### 5.1 AWS DMS（Database Migration Service）

| 移行タイプ | 説明 | ダウンタイム |
|----------|------|------------|
| **Full Load** | テーブル全体をコピー | 長い（データ量依存） |
| **CDC (Change Data Capture)** | Full Load後の差分を継続的にレプリケーション | 最小限（カットオーバー時のみ） |
| **Full Load + CDC** | 推奨。全コピー→差分同期→カットオーバー | 最小限 |

### 5.2 AWS SCT（Schema Conversion Tool）

| ソースDB | ターゲットDB | SCTの役割 |
|---------|------------|---------|
| Oracle | PostgreSQL/Aurora | スキーマ変換、ストアドプロシージャ変換 |
| SQL Server | MySQL/Aurora | データ型マッピング、インデックス変換 |
| DB2 | PostgreSQL | COBOL変換支援 |

### 5.3 DB移行の判断マトリクス

```
同種DB移行（例: MySQL → Aurora MySQL）
  → DMS のみで対応可能（SCT不要）
  → 互換性高い、リスク低い

異種DB移行（例: Oracle → PostgreSQL）
  → SCT + DMS の組み合わせ
  → スキーマ変換の互換性検証が必要
  → ストアドプロシージャの書き換えが最大の課題
```

---

## 6. 大規模データ移行

### 6.1 データ転送方式の選定

| 方式 | データ量 | 転送時間 | コスト | 適用場面 |
|------|---------|---------|--------|---------|
| **インターネット経由** | ～数TB | ネットワーク帯域依存 | 低 | 少量データ |
| **AWS DataSync** | ～数十TB | ネットワーク帯域依存 | 中 | NFS/SMBからS3/EFS |
| **AWS Transfer Family** | 随時 | リアルタイム | 中 | SFTP/FTPS/FTP |
| **AWS Snowball Edge** | 10TB～80TB | 物理輸送（数日） | 中 | ネットワーク帯域不足時 |
| **AWS Snowmobile** | 10PB～100PB | 物理輸送（数週間） | 高 | 超大規模データ |

### 6.2 転送時間の見積もり

```
ネットワーク帯域別のデータ転送時間:

1 Gbps回線:
  1TB  →  約2.3時間
  10TB →  約23時間（≈1日）
  100TB → 約230時間（≈10日）

10 Gbps回線（Direct Connect）:
  1TB  →  約14分
  10TB →  約2.3時間
  100TB → 約23時間（≈1日）

判断基準: ネットワーク経由で1週間以上かかる場合はSnowball検討
```

---

## 7. 移行後の最適化（Cloud Shift フェーズ）

### 7.1 段階的最適化ロードマップ

| フェーズ | 期間目安 | アクション | 効果 |
|---------|---------|----------|------|
| **即時（Rehost直後）** | 0-1ヶ月 | rightsizing、不要リソース削除 | コスト削減20-30% |
| **短期** | 1-3ヶ月 | Savings Plans導入、Auto Scaling設定 | コスト削減さらに20-30% |
| **中期** | 3-12ヶ月 | DB→マネージドDB、コンテナ化 | 運用負荷削減、可用性向上 |
| **長期** | 12ヶ月以降 | サーバーレス化、イベント駆動化 | アジリティ向上、コスト最適化 |

### 7.2 最適化チェックリスト

- [ ] **Compute Optimizer** で rightsizing 推奨を確認
- [ ] **Cost Explorer** で使用率の低いリソースを特定
- [ ] **Savings Plans** / **Reserved Instances** の購入検討
- [ ] **Auto Scaling** の設定（CPU/メモリ閾値でスケーリング）
- [ ] **マネージドサービス化**: EC2上のDB → RDS/Aurora
- [ ] **コンテナ化**: EC2上のアプリ → ECS/EKS (Fargate)
- [ ] **サーバーレス化**: バッチ処理 → Lambda + EventBridge
- [ ] **ストレージ最適化**: S3ライフサイクルポリシー、Glacier移行
- [ ] **ネットワーク最適化**: VPC Endpoint、CloudFront導入

---

## 8. 移行の落とし穴と対策

| 落とし穴 | 対策 |
|---------|------|
| **依存関係の見落とし** | Application Discovery Serviceで自動検出、手動マッピングも実施 |
| **ライセンスの問題** | BYOL可否の確認、AWS License Managerで管理 |
| **性能劣化** | 移行前ベンチマーク取得、移行後に同等テスト実施 |
| **セキュリティギャップ** | オンプレのセキュリティ要件をAWSサービスにマッピング |
| **コスト超過** | TCO分析の定期見直し、Cost Anomaly Detection設定 |
| **移行期間の長期化** | ウェーブ計画の厳守、パイロット移行で早期検証 |
| **カットオーバー失敗** | ロールバック計画の策定、DNS TTL短縮 |
| **チームスキル不足** | AWS Training & Certification、APN パートナー活用 |
