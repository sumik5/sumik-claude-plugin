# AWS SysOps運用リファレンス

AWSシステム運用管理のための包括的ガイド。監視、自動化、コスト管理、トラブルシューティングを網羅。

> **関連**: セキュリティは [SECURITY-ADVANCED.md](./SECURITY-ADVANCED.md)、ネットワークは [NETWORKING.md](./NETWORKING.md) を参照

---

## 目次

1. [AWS Systems Manager](#aws-systems-manager)
2. [CloudWatch監視](#cloudwatch監視)
3. [Auto Scalingと容量管理](#auto-scalingと容量管理)
4. [コスト管理と最適化](#コスト管理と最適化)
5. [バックアップと復旧](#バックアップと復旧)
6. [運用自動化](#運用自動化)
7. [トラブルシューティング](#トラブルシューティング)
8. [運用ベストプラクティス](#運用ベストプラクティス)

---

## AWS Systems Manager

### 概要

**AWS Systems Manager (SSM)** は、AWSリソースの運用管理を一元化するサービス。

### 主要コンポーネント

| コンポーネント | 説明 | ユースケース |
|--------------|------|------------|
| **Session Manager** | セキュアなリモートアクセス | SSHキー不要のEC2接続 |
| **Run Command** | リモートコマンド実行 | 一括パッチ適用、設定変更 |
| **Patch Manager** | パッチ管理自動化 | OSセキュリティパッチ |
| **State Manager** | 状態管理 | 設定のドリフト防止 |
| **Automation** | 運用タスク自動化 | AMI作成、インスタンス起動 |
| **Inventory** | ソフトウェアインベントリ | アセット管理 |
| **Parameter Store** | 設定データ管理 | 環境変数、シークレット |
| **OpsCenter** | 運用問題管理 | インシデント追跡 |

### Session Manager

**特徴**
- SSHキー管理不要
- 踏み台サーバー不要
- IAMによるアクセス制御
- 全セッションの監査ログ
- CloudWatch Logs/S3へのログ出力

**要件**
- SSM Agentのインストール
- EC2インスタンスにIAMロール
- VPCエンドポイントまたはインターネット接続

### Run Command

**ユースケース**
- OSコマンド実行
- スクリプト配布と実行
- ソフトウェアインストール
- 設定変更

**コマンド実行オプション**

| オプション | 説明 |
|----------|------|
| ターゲット | インスタンスID、タグ、リソースグループ |
| 実行方式 | 同時実行数、エラー許容数 |
| タイムアウト | コマンドタイムアウト設定 |
| 出力先 | S3、CloudWatch Logs |

### Patch Manager

**パッチベースライン**

| 設定項目 | 説明 |
|---------|------|
| 製品 | 対象OS（Windows, Amazon Linux等） |
| 分類 | Critical, Important, Moderate等 |
| 重要度 | パッチ重要度でフィルタ |
| 自動承認 | 承認までの日数 |
| 除外パッチ | 適用除外リスト |

**メンテナンスウィンドウ**
- スケジュール: cron/rate式
- ターゲット: タグ/リソースグループ
- タスク: Run Command、Automation等
- 同時実行制御

### Parameter Store

**パラメータタイプ**

| タイプ | 説明 | 暗号化 |
|--------|------|--------|
| String | 平文文字列 | なし |
| StringList | カンマ区切りリスト | なし |
| SecureString | 暗号化文字列 | KMS |

**階層構造**
```
/myapp/
  ├── prod/
  │   ├── db-host
  │   └── db-password (SecureString)
  └── dev/
      ├── db-host
      └── db-password (SecureString)
```

**ティア比較**

| 項目 | Standard | Advanced |
|------|----------|----------|
| 最大サイズ | 4KB | 8KB |
| パラメータ数 | 10,000 | 100,000 |
| ポリシー | なし | あり（有効期限等） |
| 料金 | 無料 | 有料 |

### Automation

**Runbook (オートメーションドキュメント)**

**一般的なユースケース**
- AMI作成の自動化
- インスタンスの起動/停止
- スナップショット管理
- パッチ適用ワークフロー

**アクションタイプ**

| タイプ | 説明 |
|--------|------|
| aws:executeScript | Python/PowerShellスクリプト実行 |
| aws:executeAwsApi | AWS API呼び出し |
| aws:runCommand | SSM Run Command実行 |
| aws:waitForAwsResourceProperty | リソース状態待機 |
| aws:approve | 手動承認ステップ |

---

## CloudWatch監視

### メトリクス

**標準メトリクス（EC2）**

| メトリクス | 説明 | 単位 |
|----------|------|------|
| CPUUtilization | CPU使用率 | パーセント |
| NetworkIn/Out | ネットワークトラフィック | バイト |
| DiskReadOps/WriteOps | ディスクI/O操作 | カウント |
| StatusCheckFailed | ステータスチェック失敗 | カウント |

**カスタムメトリクス**
- CloudWatch Agent経由
- PutMetricData API
- EMF (Embedded Metric Format)

**CloudWatch Agent収集項目**
- メモリ使用率
- ディスク使用率
- プロセス数
- アプリケーションログ

### アラーム

**状態**

| 状態 | 説明 |
|------|------|
| OK | しきい値以下 |
| ALARM | しきい値超過 |
| INSUFFICIENT_DATA | データ不足 |

**アラーム設定要素**

| 要素 | 説明 |
|------|------|
| メトリクス | 監視対象 |
| 統計 | Average, Sum, Maximum等 |
| 期間 | 評価間隔（秒） |
| 評価期間数 | アラーム発報までの期間数 |
| しきい値 | 比較値 |
| アクション | SNS、Auto Scaling、EC2アクション |

**複合アラーム**
- 複数アラームのAND/OR条件
- アラームノイズ削減
- 複雑な条件監視

### Logs

**ロググループとストリーム**
- ロググループ: 論理的なログのコンテナ
- ログストリーム: 同一ソースからのログシーケンス

**保持期間設定**

| 期間 | 用途 |
|------|------|
| 1日〜10年 | カスタム設定 |
| 永続 | 無期限保持 |

**Logs Insights**

```sql
-- エラー検索
fields @timestamp, @message
| filter @message like /ERROR/
| sort @timestamp desc
| limit 20

-- リクエスト統計
stats count(*) as requests by bin(1h)
| sort requests desc

-- レイテンシ分析
fields @timestamp, @message
| parse @message /latency=(?<latency>\d+)/
| stats avg(latency), max(latency) by bin(5m)
```

**メトリクスフィルター**
- ログパターンからメトリクス生成
- アラームとの連携
- ダッシュボード表示

### ダッシュボード

**ウィジェットタイプ**

| タイプ | 用途 |
|--------|------|
| Line | 時系列データ |
| Stacked area | 累積表示 |
| Number | 単一値表示 |
| Gauge | ゲージ表示 |
| Text | テキスト/マークダウン |
| Alarm status | アラーム状態 |
| Logs insights | ログクエリ結果 |

---

## Auto Scalingと容量管理

### EC2 Auto Scaling

**コンポーネント**

| コンポーネント | 説明 |
|--------------|------|
| 起動テンプレート | インスタンス設定 |
| Auto Scalingグループ | スケーリング単位 |
| スケーリングポリシー | スケール条件 |

**容量設定**

| 設定 | 説明 |
|------|------|
| 最小容量 | 最小インスタンス数 |
| 希望容量 | 目標インスタンス数 |
| 最大容量 | 最大インスタンス数 |

### スケーリングポリシー

**ポリシータイプ比較**

| タイプ | 説明 | ユースケース |
|--------|------|------------|
| Target Tracking | 目標値維持 | CPU使用率50%維持 |
| Step Scaling | 段階的スケーリング | しきい値に応じた段階変更 |
| Simple Scaling | 単純スケーリング | 固定数の追加/削除 |
| Scheduled | スケジュール | 定期的な容量変更 |
| Predictive | 予測スケーリング | 過去パターンに基づく予測 |

**Target Tracking**
- 最も推奨されるポリシー
- 自動的にスケールイン/アウト
- クールダウン自動管理

**Predictive Scaling**
- 過去14日間のパターン分析
- 予測に基づく事前スケーリング
- 週次/日次パターン対応

### ヘルスチェック

**ヘルスチェックタイプ**

| タイプ | ソース | 確認内容 |
|--------|--------|---------|
| EC2 | EC2ステータス | インスタンス実行状態 |
| ELB | ロードバランサー | ターゲットヘルス |
| カスタム | 外部システム | アプリケーションヘルス |

**グレースピリオド**
- 起動後のヘルスチェック猶予期間
- アプリケーション起動時間を考慮
- デフォルト: 300秒

### Application Auto Scaling

**対応サービス**
- ECS
- DynamoDB
- Aurora
- Lambda (プロビジョンド同時実行)
- SageMaker

---

## コスト管理と最適化

### Cost Explorer

**機能**
- 過去12ヶ月のコスト分析
- 将来12ヶ月の予測
- フィルタリングとグルーピング
- 保存済みレポート

**分析軸**

| 軸 | 説明 |
|----|------|
| サービス | AWS サービス別 |
| リンクアカウント | アカウント別 |
| リージョン | リージョン別 |
| タグ | コスト配分タグ別 |
| インスタンスタイプ | EC2タイプ別 |
| 使用タイプ | 使用タイプ別 |

### Budgets

**予算タイプ**

| タイプ | 説明 |
|--------|------|
| コスト予算 | 金額ベース |
| 使用量予算 | 使用量ベース |
| 予約予算 | RI/Savings Plans活用率 |
| Savings Plans予算 | Savings Plans活用率 |

**アラートしきい値**
- 実績値 vs 予算
- 予測値 vs 予算
- パーセンテージ指定

**通知アクション**
- SNS通知
- メール通知
- Chatbot統合

### コスト最適化

**リソース最適化**

| 手法 | 説明 | 適用 |
|------|------|------|
| Right Sizing | 適切なサイズ選択 | Compute Optimizer活用 |
| 予約インスタンス | 1/3年コミット | 安定ワークロード |
| Savings Plans | 柔軟な割引 | EC2/Fargate/Lambda |
| Spot Instances | 余剰容量活用 | 中断許容ワークロード |
| 不使用リソース削除 | 未使用リソースの特定と削除 | Trusted Advisor活用 |

**AWS Compute Optimizer**

| 推奨タイプ | 説明 |
|----------|------|
| EC2インスタンス | 最適インスタンスタイプ |
| Auto Scalingグループ | 最適設定 |
| EBSボリューム | 最適ボリュームタイプ |
| Lambda関数 | 最適メモリサイズ |
| ECS (Fargate) | 最適CPU/メモリ |

### コスト配分タグ

**タグ戦略**

| タグキー | 例 | 用途 |
|---------|---|------|
| Environment | prod, dev, staging | 環境別コスト |
| Project | project-a | プロジェクト別 |
| CostCenter | cc-1234 | 部門別 |
| Owner | team-alpha | 所有者別 |

**有効化手順**
1. タグを作成・適用
2. Billing > Cost allocation tagsで有効化
3. 24時間後からレポートに反映

---

## バックアップと復旧

### AWS Backup

**サポートサービス**
- EC2 (AMI/EBS)
- RDS
- DynamoDB
- EFS
- FSx
- Storage Gateway
- Aurora

**バックアップ計画**

| 要素 | 説明 |
|------|------|
| バックアップルール | スケジュール、保持期間 |
| バックアップボールト | 保存先 |
| リソース割り当て | タグ/ARN指定 |
| クロスリージョンコピー | 別リージョンへの複製 |
| クロスアカウントコピー | 別アカウントへの複製 |

**バックアップボールト**
- 暗号化（KMS）
- アクセスポリシー
- ボールトロック（WORM）

### RDS バックアップ

**自動バックアップ**
- 日次フルバックアップ
- トランザクションログ（5分間隔）
- 保持期間: 1-35日
- PITR対応

**手動スナップショット**
- 任意タイミング
- 保持期間無制限
- クロスリージョンコピー可能

### DynamoDB バックアップ

**オプション**

| タイプ | 説明 | RPO |
|--------|------|-----|
| オンデマンド | 手動バックアップ | 時点指定 |
| PITR | 継続的バックアップ | 秒単位 |

---

## 運用自動化

### EventBridge

**イベントソース**
- AWSサービス
- カスタムアプリケーション
- SaaSパートナー

**ルール構成**

| 要素 | 説明 |
|------|------|
| イベントパターン | マッチング条件 |
| スケジュール | cron/rate式 |
| ターゲット | Lambda、SNS、SQS等 |

**一般的なユースケース**
- EC2状態変更の検知と通知
- ログイン監視とアラート
- 自動修復アクション

### CloudFormation

**テンプレート構造**

| セクション | 必須 | 説明 |
|----------|------|------|
| AWSTemplateFormatVersion | No | バージョン |
| Description | No | 説明 |
| Parameters | No | 入力パラメータ |
| Mappings | No | 静的マッピング |
| Conditions | No | 条件分岐 |
| Resources | Yes | リソース定義 |
| Outputs | No | 出力値 |

**スタック操作**

| 操作 | 説明 |
|------|------|
| Create | スタック作成 |
| Update | スタック更新 |
| Delete | スタック削除 |
| Drift Detection | ドリフト検出 |
| Change Set | 変更プレビュー |

**StackSets**
- 複数アカウント/リージョンへのデプロイ
- Organizations統合
- 自動デプロイメント

### Lambda 運用

**運用メトリクス**

| メトリクス | 説明 | 監視ポイント |
|----------|------|------------|
| Invocations | 呼び出し回数 | トラフィック |
| Duration | 実行時間 | パフォーマンス |
| Errors | エラー数 | 品質 |
| Throttles | スロットリング | 容量 |
| ConcurrentExecutions | 同時実行数 | スケール |

**バージョンとエイリアス**
- バージョン: イミュータブルなスナップショット
- エイリアス: バージョンへのポインタ
- 加重エイリアス: カナリアデプロイ

---

## トラブルシューティング

### EC2 トラブルシューティング

**起動失敗**

| 原因 | 確認方法 | 対処 |
|------|---------|------|
| 容量不足 | エラーメッセージ | 別AZ/インスタンスタイプ |
| AMI問題 | AMI状態確認 | AMI再作成 |
| EBSボリューム問題 | ボリューム確認 | スナップショット復元 |
| セキュリティグループ | ルール確認 | 許可設定 |
| サブネット/VPC | ネットワーク確認 | 設定修正 |

**接続問題**

| レイヤー | 確認ポイント |
|---------|------------|
| ネットワーク | セキュリティグループ、NACL、ルートテーブル |
| インスタンス | パブリックIP、EIP割り当て |
| OS | OS起動状態、SSMAgent |
| アプリケーション | サービス起動状態 |

### EBS トラブルシューティング

**パフォーマンス問題**

| 指標 | しきい値 | 対処 |
|------|---------|------|
| VolumeQueueLength | 高い値 | IOPSアップ/ボリュームタイプ変更 |
| BurstBalance | 0%に近い | gp3へ移行/IOPSプロビジョニング |

**ボリュームタイプ選択**

| タイプ | IOPS | スループット | ユースケース |
|--------|------|------------|------------|
| gp3 | 3,000-16,000 | 125-1,000 MB/s | 汎用 |
| gp2 | 100-16,000 | 128-250 MB/s | 汎用（レガシー） |
| io2 | 100-256,000 | 4,000 MB/s | 高性能DB |
| st1 | - | 500 MB/s | スループット重視 |
| sc1 | - | 250 MB/s | コールドデータ |

### RDS トラブルシューティング

**パフォーマンス問題**

| 確認項目 | ツール | 対処 |
|---------|--------|------|
| クエリパフォーマンス | Performance Insights | クエリ最適化 |
| 接続数 | CloudWatchメトリクス | 接続プーリング |
| ストレージ | FreeStorageSpace | ストレージ拡張 |
| CPU/メモリ | CloudWatch | スケールアップ |

**Performance Insights**
- Top SQL: 負荷の高いクエリ
- Top waits: 待機イベント
- Database load: DB負荷

### ネットワークトラブルシューティング

**確認フロー**

```
接続問題発生
    ↓
1. セキュリティグループ確認
    - インバウンド/アウトバウンドルール
    ↓
2. ネットワークACL確認
    - 許可/拒否ルール
    - 番号順評価
    ↓
3. ルートテーブル確認
    - 宛先へのルート存在
    - IGW/NAT GW設定
    ↓
4. VPC Flow Logs確認
    - ACCEPT/REJECT
    - トラフィックパターン
```

---

## 運用ベストプラクティス

### タグ付け戦略

**必須タグ**

| タグ | 目的 |
|------|------|
| Name | リソース識別 |
| Environment | 環境区分 |
| Owner | 責任者 |
| Project | プロジェクト |
| CostCenter | コスト配分 |

### 監視戦略

**監視レベル**

| レベル | 対象 | ツール |
|--------|------|--------|
| インフラ | EC2, RDS, EBS | CloudWatch |
| アプリケーション | ログ, メトリクス | CloudWatch Logs, X-Ray |
| ビジネス | KPI, SLA | カスタムダッシュボード |

### インシデント対応

**対応フロー**

1. **検知**: アラーム、モニタリング
2. **分類**: 重要度判定
3. **対応**: トラブルシューティング
4. **解決**: 根本原因対処
5. **事後分析**: 再発防止策

### ドキュメント化

**必要ドキュメント**

| ドキュメント | 内容 |
|------------|------|
| アーキテクチャ図 | 構成図、データフロー |
| 運用手順書 | 日常運用、定期作業 |
| 障害対応手順 | インシデント対応 |
| 復旧手順 | DR手順、RTO/RPO |

---

## 関連リファレンス

- [SECURITY-ADVANCED.md](./SECURITY-ADVANCED.md) - セキュリティ詳細
- [NETWORKING.md](./NETWORKING.md) - ネットワーキング
- [SERVERLESS-PATTERNS.md](./SERVERLESS-PATTERNS.md) - サーバーレス運用
- [COST-OPTIMIZATION.md](./COST-OPTIMIZATION.md) - コスト最適化詳細
