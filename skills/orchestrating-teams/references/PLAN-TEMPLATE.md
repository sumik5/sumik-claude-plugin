# 計画ドキュメントテンプレート

Agent Team実行前に必ず `docs/plan-{feature-name}.md` を作成します。このファイルがチーム実行の設計図・進捗管理・回復の起点となります。

---

## テンプレート全文

```markdown
# {feature-name} 実装計画

## 概要

**目的:**
（なぜこの変更が必要か？）

**背景:**
（現状の問題点・ユーザーからの要求）

**スコープ:**
（今回の変更に含まれるもの・含まれないもの）

---

## チーム構成

| メンバー | モデル | 担当 | ファイル所有権 |
|---------|--------|------|-------------|
| frontend | Sonnet | Reactコンポーネント実装 | src/components/**, src/pages/** |
| backend | Sonnet | REST API実装 | src/api/**, src/services/**, src/models/** |
| tester | Sonnet | E2Eテスト作成 | tests/e2e/** |

**モデル戦略:** Adaptive（Opus リーダー + Sonnet メンバー）

---

## タスクリスト

### backend担当
- [ ] タスク1: ユーザーモデルのスキーマ設計（PostgreSQLテーブル定義・マイグレーション）
- [ ] タスク2: REST API CRUD エンドポイント実装（GET/POST/PUT/DELETE /api/users）
- [ ] タスク3: バリデーション・エラーハンドリング（依存: タスク2）

### frontend担当
- [ ] タスク4: ユーザー一覧コンポーネント実装（データテーブル、ページネーション）
- [ ] タスク5: ユーザー編集フォーム実装（バリデーション、API連携）
- [ ] タスク6: エラー表示・ローディング状態（依存: タスク5）

### tester担当
- [ ] タスク7: E2Eテストシナリオ作成（Playwright、登録・編集・削除フロー）
- [ ] タスク8: エラーケーステスト（バリデーションエラー、API障害時の挙動）

---

## ファイル所有権パターン

**🔴 重要: 同一ファイルへの同時書き込みを絶対に避ける**

| メンバー | 所有権パターン | 説明 |
|---------|--------------|------|
| frontend | `src/components/**`, `src/pages/**` | Reactコンポーネント・ページ |
| backend | `src/api/**`, `src/services/**`, `src/models/**`, `migrations/**` | API・ビジネスロジック・DBスキーマ |
| tester | `tests/e2e/**`, `tests/integration/**` | E2Eテスト・統合テスト |

**競合リスク:**
- `src/types/**`（型定義）は競合の可能性あり → backendが先に定義、frontendは参照のみ
- 設定ファイル（`tsconfig.json`, `package.json`）は競合の可能性あり → 必要な場合は順次実行

**競合が予想される場合の対処:**
- タスクを順次実行に変更
- 共有ファイルは事前にリーダー（Claude Code本体）が作成

---

## 依存関係

```
タスク1: スキーマ設計
  ↓
タスク2: API実装 → タスク3: バリデーション
  ↓（並列）
タスク4: 一覧コンポーネント → タスク6: エラー表示
タスク5: 編集フォーム
タスク7: E2Eテスト → タスク8: エラーケーステスト
```

**ブロック設定（TaskUpdate）:**
- タスク3は タスク2 に依存（`addBlockedBy: ["2"]`）
- タスク6は タスク5 に依存（`addBlockedBy: ["5"]`）
- タスク8は タスク7 に依存（`addBlockedBy: ["7"]`）

---

## 実行ログ

（チーム実行中の進捗・完了状況をここに記録）

### 形式
```
- [YYYY-MM-DD HH:MM] イベント内容
```

### 記録すべき内容
- チーム作成・メンバースポーン
- 各タスクの完了時刻
- メンバー間の調整・問題解決
- エラー・再試行の記録

### 例
```markdown
- [2026-02-18 10:00] チーム作成完了（team_name: user-management）
- [2026-02-18 10:05] frontend/backend/testerスポーン完了
- [2026-02-18 10:30] タスク1完了（backend: スキーマ設計）
- [2026-02-18 10:45] タスク4完了（frontend: 一覧コンポーネント）
- [2026-02-18 11:00] タスク2完了（backend: API実装）
- [2026-02-18 11:05] メッセージ送信（backend → frontend: API仕様共有）
- [2026-02-18 11:20] タスク5完了（frontend: 編集フォーム）
- [2026-02-18 11:30] タスク7完了（tester: E2Eテスト）
- [2026-02-18 11:40] 全タスク完了
- [2026-02-18 11:45] 統合テスト完了
- [2026-02-18 11:50] CodeGuardセキュリティチェック完了
```

---

## 回復手順

**失敗時はこのファイルのタスクリストを確認し、未完了タスク（`- [ ]`）から再開。**

### 手順

1. **未完了タスクの特定**
   - タスクリストで `- [ ]`（未完了）のタスクを特定
   - 実行ログで最後に完了したタスクを確認

2. **チーム再作成**
   - TeamCreate で新チームを作成（**同じ `team_name` を使用**）
   ```json
   {
     "team_name": "user-management",
     "description": "ユーザー管理機能の開発（再開）"
   }
   ```

3. **未完了タスクのみをTaskCreate**
   - 完了済みタスクは作成しない
   - 未完了タスクのみを TaskCreate で作成
   - 依存関係（`blockedBy`）も再設定

4. **メンバーをスポーン**
   - 未完了タスクを担当するメンバーのみをスポーン
   - Task tool で `team_name` + `run_in_background: true` で起動（tmux pane）

5. **タスクリスト更新**
   - 完了したら `- [x]` に変更
   - 実行ログに再開時刻・完了時刻を記録

### 例（タスク5-8が未完了の場合）

```markdown
## 実行ログ

- [2026-02-18 10:00] チーム作成完了（team_name: user-management）
- [2026-02-18 10:05] frontend/backend/testerスポーン完了
- [2026-02-18 10:30] タスク1完了（backend: スキーマ設計）
- [2026-02-18 10:45] タスク4完了（frontend: 一覧コンポーネント）
- [2026-02-18 11:00] タスク2完了（backend: API実装）
- [2026-02-18 11:10] ⚠️ エラー発生（frontend: タスク5実行中にAPI仕様の誤解）
- [2026-02-18 11:15] チーム停止
- [2026-02-18 14:00] チーム再作成（team_name: user-management、再開）
- [2026-02-18 14:05] frontend/testerスポーン完了（backendは完了済みのため不要）
- [2026-02-18 14:20] タスク5完了（frontend: 編集フォーム、API仕様修正後）
- [2026-02-18 14:30] タスク6完了（frontend: エラー表示）
- [2026-02-18 14:40] タスク7完了（tester: E2Eテスト）
- [2026-02-18 14:50] タスク8完了（tester: エラーケーステスト）
- [2026-02-18 15:00] 全タスク完了
```

---

## 注意事項・リスク

（プロジェクト固有の注意点を記載）

### 技術的リスク
- 例: `src/types/user.ts` の型定義が競合する可能性 → backendが先に作成、frontendは参照のみ
- 例: PostgreSQLマイグレーションがローカル環境で実行されるため、DB接続情報の確認が必要

### スケジュール的リスク
- 例: タスク2（API実装）が予定より時間がかかる可能性 → frontendのタスク4-6に影響

### 依存関係リスク
- 例: backendのタスク2が失敗すると、frontendのタスク5-6がブロックされる → 早期のタスク2完了を優先

---
```

---

## 実行ログの記録方法

### タイムスタンプ形式
```
[YYYY-MM-DD HH:MM] イベント内容
```

### 記録すべき内容

| カテゴリ | 記録内容 |
|---------|---------|
| **チーム作成** | チーム名・メンバー構成・スポーン完了時刻 |
| **タスク完了** | タスク番号・担当メンバー・完了時刻 |
| **メッセージング** | 送信元・送信先・メッセージ概要 |
| **エラー** | エラー内容・発生時刻・影響範囲 |
| **再試行** | 再開時刻・再開理由・未完了タスク |
| **統合** | 統合テスト・品質チェック・完了時刻 |

### 良い実行ログの例

```markdown
## 実行ログ

- [2026-02-18 10:00] チーム作成完了（team_name: user-management）
- [2026-02-18 10:05] frontend/backend/testerスポーン完了
- [2026-02-18 10:30] タスク1完了（backend: スキーマ設計）
- [2026-02-18 10:35] メッセージ送信（backend → frontend: スキーマ情報共有）
- [2026-02-18 10:45] タスク4完了（frontend: 一覧コンポーネント）
- [2026-02-18 11:00] タスク2完了（backend: API実装）
- [2026-02-18 11:05] メッセージ送信（backend → frontend: API仕様共有）
- [2026-02-18 11:20] タスク5完了（frontend: 編集フォーム）
- [2026-02-18 11:25] タスク3完了（backend: バリデーション）
- [2026-02-18 11:30] タスク7完了（tester: E2Eテスト）
- [2026-02-18 11:35] タスク6完了（frontend: エラー表示）
- [2026-02-18 11:40] タスク8完了（tester: エラーケーステスト）
- [2026-02-18 11:45] 全タスク完了
- [2026-02-18 11:50] 統合テスト完了（全E2Eテストパス）
- [2026-02-18 11:55] CodeGuardセキュリティチェック完了（脆弱性0件）
- [2026-02-18 12:00] シャットダウン完了（frontend/backend/tester）
- [2026-02-18 12:02] TeamDelete完了
```

---

## テンプレート使用のベストプラクティス

1. **計画は詳細に**: タスク数・所有権パターン・依存関係を明確に記述
2. **実行ログは即座に記録**: メンバー完了報告を受けたらすぐに実行ログに追記
3. **競合リスクを事前に特定**: 共有ファイル・設定ファイルの扱いを明示
4. **回復手順を事前に想定**: 失敗時の再開方法を計画段階で検討
5. **ドキュメントは削除しない**: 作業完了後も将来の参照用として保持
