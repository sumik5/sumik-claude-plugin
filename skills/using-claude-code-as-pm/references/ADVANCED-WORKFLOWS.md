# 高度なワークフロー

PM向けスキル設計、MCP外部連携、Subagent並列処理、エンジニアとの協業パターン。

---

## PM向けスキル設計

### 5つの必須PMスキル

| スキル | 用途 | 推定ROI |
|--------|------|---------|
| **フィードバック分析** | NPS・サポートチケット・アンケートのテーマ分析 | 四半期2回で投資回収 |
| **競合プロファイリング** | 構造化された競合調査・比較マトリクス | 四半期更新で累積価値 |
| **リリースノート生成** | git履歴からユーザー向けチェンジログ | リリース毎に30分節約 |
| **スタンドアップメモ** | 直近のgitコミットから日次報告 | 毎日5分節約 |
| **PRD監査** | PRDの完全性チェック | PRD作成毎に品質向上 |

### スキル化の判断基準（3回ルール）

| 条件 | アクション |
|------|----------|
| 2回以上実施済み ＋ 今後1回以上予定 | スキル化する |
| 1回のみ実施 or 今後予定なし | プロンプトテンプレートとして保存（テキストファイル） |
| 要件が頻繁に変わる | スキル化しない（メンテナンスコストが回収不能） |

### スキルROI計算

- スキル構築: 30-60分（初回）
- スキル利用: 5-10分（毎回）
- 手動実行: 30-45分（毎回）

| 利用回数 | スキルあり | 手動 | 節約時間 |
|---------|-----------|------|---------|
| 2回 | 80分 | 90分 | 10分 |
| 5回 | 110分 | 225分 | 115分 |
| 10回 | 160分 | 450分 | 290分 |

---

## MCP（Model Context Protocol）連携

### MCP概要

MCPはClaude Codeを外部システムに直接接続するプロトコル。エクスポート→インポートの手動サイクルを排除。

### PM関連MCPサーバー

| MCP サーバー | 機能 | PM用途 |
|-------------|------|--------|
| **Jira/Atlassian** | チケット検索・更新・コメント | バグ報告、スプリント分析 |
| **Slack** | チャンネル読取・投稿・検索 | フィードバック収集、レポート共有 |
| **Figma** | デザインスペック取得 | 要件とデザインの整合性確認 |
| **GitHub** | リポジトリ・Issue・PR | 変更履歴の自動追跡 |
| **PostgreSQL/MySQL** | 読取専用クエリ（推奨） | メトリクス取得（SQL不要） |
| **Linear/Asana** | プロジェクト管理 | Jira代替 |

### MCP設定スコープ

| スコープ | ファイル | 用途 |
|---------|--------|------|
| **Project** | `.mcp.json` (プロジェクトルート) | チーム共有。gitにコミット。認証情報は含めない |
| **Project-local** | `.claude/settings.local.json` | 個人用。`.gitignore`に追加 |
| **User-wide** | `~/.claude/settings.local.json` | 全プロジェクト共通（Slack、Jira等） |

### 設定例（Jira）

```json
{
  "mcpServers": {
    "jira": {
      "command": "npx",
      "args": ["@anthropic-ai/mcp-server-jira"],
      "env": {
        "JIRA_HOST": "https://yourcompany.atlassian.net",
        "JIRA_USER_EMAIL": "${JIRA_EMAIL}",
        "JIRA_API_TOKEN": "${JIRA_TOKEN}"
      }
    }
  }
}
```

### セキュリティ考慮事項

- 認証情報は環境変数で管理（ハードコード禁止）
- 必要最小限の権限のAPIトークンを使用（可能なら読取専用）
- 認証情報をバージョン管理にコミットしない
- セッション前にアクティブなMCPサーバーを確認
- 外部システムのAPIクォータ・レート制限に注意

### MCP導入判断

| 条件 | MCP | 手動エクスポート |
|------|-----|---------------|
| 月1回以上の反復ワークフロー | ✓ | |
| 複数システム横断の分析 | ✓ | |
| データ確認が思考プロセスの一部 | | ✓ |
| 1回限りの分析 | | ✓ |
| システム境界を跨がないタスク | | ✓ |

---

## Subagent並列処理

### Subagentの仕組み

Subagentはメインセッションから起動される独立したClaudeインスタンス。固有のコンテキストウィンドウで独立実行し、結果をメインに返す。

### 4つのPMパターン

#### パターン1: 並列リサーチ

**用途**: 複数の独立ソースから情報収集＋統合
- 競合分析（競合ごとに1 subagent）
- フィードバック分析（データを分割して並列処理）

**例**: 4社の競合分析
- 順次: 45分（10分/社 + 5分統合）
- 並列: 12分（全社同時 + 統合）

#### パターン2: 専門レビュアー

**用途**: 特定の観点に制約した分析
- コードレビュー（読取専用権限）
- ドキュメント監査
- PRD完全性チェック

#### パターン3: 順次委譲

**用途**: 前のステップの出力が次の入力になるワークフロー
- 調査→分析→レポート生成
- メインのコンテキストをクリーンに保つ

#### パターン4: フォーマット変換

**用途**: 同じコンテンツを複数フォーマットに変換
- 詳細レポート→エグゼクティブサマリー
- 技術ドキュメント→ユーザー向けガイド

### コスト・時間トレードオフ

| 方式 | トークン | コスト | 時間 |
|------|---------|--------|------|
| 順次実行 | ~20K | ~$0.60 | ~90分 |
| 並列Subagent (5体) | ~160K | ~$4.80 | ~15分 |

**判断基準**: 節約時間の価値 > 追加トークンコスト か？
- 時給換算で$5以上 → Subagentの方がROI高い

### Subagent使用時の注意

- 各Subagentが独立にファイルを読むため、トークン消費は積み上がる
- `/cost` で定期的にコスト確認
- 50件以下のデータ、10分以下の順次タスクは並列化の価値なし
- タスクが真に独立でない場合（依存関係あり）は並列化不可

---

## エンジニアとの協業

### PM/エンジニアの使い分け

| PM | エンジニア |
|----|----------|
| 調査・説明 | 検証・実装 |
| 問題箇所の推定 | 根本原因の確認 |
| プロダクト成果物（PRD、リリースノート） | 技術成果物（ADR、コードコメント） |
| plan mode で探索 | full access で実装 |

### ハンドオフベストプラクティス

**良いハンドオフ:**
```
ユーザーから「決済されたが注文確認がない」との報告。
調査結果: 決済処理は payment-processor.js で実行、
その後 order.service.js で注文作成。
決済成功後に注文作成が失敗した場合、
payment-reconciliation.js の調停キューがキャッチするはず。
仮説: 調停キューが処理されていない、またはエラーハンドリングの問題。
確認お願いします: キューの状態と直近の失敗ログ。
```

**悪いハンドオフ:**
```
チェックアウトにバグがあると思います。確認お願いします。
```

### 調査結果の共有時の言い回し

| ❌ 避ける | ✓ 推奨 |
|----------|--------|
| 「このバグの原因は〜です」 | 「調査によると〜が原因の可能性があります。確認お願いします」 |
| 「コードは〜をします」 | 「コードは〜をしているように見えます」 |
| （事実として断言） | （仮説として提示、検証を依頼） |

### 共有CLAUDE.md設計

PM・エンジニア双方が使うリポジトリでのCLAUDE.md:

- **プロダクトドメイン用語集**: 全員が同じ用語を使う
- **コード領域マッピング**: 機能→ファイル/ディレクトリの対応表
- **調査ログ**: 過去のPM調査で判明した事実（重複調査防止）
- **チーム規約**: ドキュメント配置先、命名規則、ワークフロー

---

## 5つの失敗モード（詳細）

### 1. Spec Dumping
- **症状**: 長大なPRDを丸投げ → 浅い出力
- **根本原因**: 大入力 + 曖昧な指示 = 大出力 + 曖昧な価値
- **対策**: セクション単位に分割、具体的な指示
- **警告サイン**: プロンプトが500語超、指示が20語未満

### 2. 過信（Overconfidence）
- **症状**: Claude Code分析を事実として扱い、エンジニアに否定される
- **根本原因**: 静的解析をランタイム真実として扱う
- **対策**: 「仮説」として共有、エンジニアに検証依頼
- **警告サイン**: 分析のみに基づいてプロダクト判断しようとしている

### 3. コンテキスト消耗
- **症状**: 30分超で回答品質低下、繰り返し、以前読んだファイルの忘却
- **根本原因**: コンテキストウィンドウの容量限界
- **対策**: `/clear` で新規セッション、`/compact` で要点保持
- **警告サイン**: `/cost` で150K+トークン、拒否済み提案の繰り返し

### 4. ツールミスマッチ
- **症状**: コードベースアクセス不要のタスクにClaude Code使用
- **対策**: 「ファイル操作・成果物生成・コマンド実行が必要か？」→ No なら Claude.ai
- **Claude.ai向きのタスク**: ブレインストーミング、プレゼン推敲、メール添削、一般概念の説明

### 5. スキル過剰設計
- **症状**: 3時間かけたスキルを1回しか使わない
- **対策**: 3回ルール（2回実施済み + 今後1回以上）
- **警告サイン**: 手動実行の前にスキル構築に着手している
