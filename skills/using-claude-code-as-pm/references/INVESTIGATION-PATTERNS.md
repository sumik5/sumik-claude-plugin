# コードベース調査・バグトリアージ

PMがClaude Codeを使ってコードベースを調査し、バグをトリアージするための実践ガイド。

## コードベースのメンタルマップ構築

新しいリポジトリで最初に実行すべきセッション（20分、$0.10-0.25）:

```bash
claude --permission-mode plan
```

### 初回アーキテクチャ概要プロンプト

```
このコードベースのアーキテクチャをプロダクトマネージャー向けに説明してください:
- 主要コンポーネントとそれぞれの責務
- データがシステムをどう流れるか
- ユーザー向け機能が通常どこに配置されるか
- フロントエンドとバックエンドの接続方法
- 理解すべき主要な抽象化やパターン

技術的な説明は避け、メンタルモデル構築に役立つ概念的説明に集中してください。
```

成果物: `docs/architecture-overview.md` として保存、または CLAUDE.md に統合

### フォローアップ質問（ドメイン固有）
- 認証・認可はどこで処理される？
- 決済はどう処理される？連携先の外部サービスは？
- 価格ロジックはフロントエンド・バックエンド・両方のどこ？

---

## 4つの調査パターン（詳細）

### パターン1: 「Xはどう動く？」（機能実装）

**場面**: 顧客から「割引コードとプロモーションは併用できないの？」と質問された

**プロンプト例:**
```
このアプリケーションで割引コード検証はどう動きますか？具体的に:
- 割引コードロジックはどこに実装されている？
- コードが適用可能かどうかを判断するルールは？
- 割引コードは他のプロモーションと併用できる？できない理由は？
- 無効なコードを入力した場合のユーザー体験は？

プロダクト用語で説明してください。コードの詳細は不要です。
```

**期待される回答**: ファイルパス、ビジネスルールの平文説明、判断ロジックの概要

### パターン2: 「Xはどのデータにアクセス？」（データ依存）

**場面**: 購入履歴機能の新機能を計画中。利用可能なデータと制約を確認

**プロンプト例:**
```
購入履歴機能がアクセスするユーザーデータは何ですか？:
- 具体的にどのデータフィールドを読み取るか（注文詳細、支払い情報、配送先等）
- データの格納場所（DBテーブル、外部API、ローカルストレージ）
- コード内でこのデータにアクセスする箇所（どのサービス・コンポーネント）
- プライバシーやセキュリティ上の注意点
```

### パターン3: 「Xが起きたら？」（エッジケース）

**場面**: チェックアウト中に決済が失敗した場合のユーザー体験を確認

**プロンプト例:**
```
チェックアウト中に決済が失敗したらどうなりますか？:
- ユーザーに何が表示されるか（エラーメッセージ、ページ状態）
- カートと注文はどうなるか
- リトライされるのか、最初からやり直しか
- 部分的な完了をどう処理するか（注文作成後に決済失敗した場合）
```

### パターン4: 「なぜXが起きる？」（動作説明）

**場面**: ユーザーから「もっと見るを押すと検索フィルタが消える」との報告

**プロンプト例:**
```
ユーザーから「もっと見るボタンをクリックすると検索フィルタがリセットされる」と報告がありました。なぜこれが起きますか？意図的な動作かバグか？

コード内でこの動作を引き起こしている箇所と、プロダクト上の理由があるかを説明してください。
```

---

## バグトリアージ5ステップワークフロー

### ステップ1: ユーザー報告の詳細収集（5分）

Claude Code起動前に以下を整理:
- ユーザーが何をしようとしていたか
- 期待される動作
- 実際の動作
- エラーメッセージ（正確なテキスト）
- 発生日時
- ブラウザ/デバイス/環境
- 再現可能性

### ステップ2: 関連コード領域の特定

```bash
claude --permission-mode plan
```

プロンプト:
```
ユーザー報告の問題を調査中です: [1文の要約]

コンテキスト:
- ユーザーの操作: [何をしていたか]
- 期待: [何が起きるべきだったか]
- 実際: [何が起きたか]
- エラーメッセージ: [正確なテキスト]

関係するコード領域を特定してください:
- エントリポイント（ユーザー操作がコードのどこから始まるか）
- 実行パス上の主要ファイル
- エラーがキャッチ・処理される箇所
- 失敗の可能性がある箇所
```

### ステップ3: 疑わしいコードパスの詳細確認

特定されたファイルについて深掘り:
```
[payment-processor.js] がステップバイステップで何をするか説明してください:
- 何が失敗の原因になりうるか
- 外部サービスがエラーを返した場合の処理
- ユーザーに具体的なエラーメッセージが表示されるか汎用的なものか
- 失敗時に何がログされるか
```

### ステップ4: 仮説の定式化

調査結果から検証可能な仮説を形成:
「ユーザーは決済サービスにより正常に課金されたが、後続の注文作成が失敗した可能性がある。DBエラー、タイムアウト、またはバリデーション問題が考えられる。システムは決済成功にもかかわらず汎用エラーを表示した。」

### ステップ5: エンジニアハンドオフ文書作成

プロンプト:
```
このバグのエンジニアハンドオフ用に調査を要約してください:
- ユーザー報告の内容
- 調査した内容
- レビューしたファイル・コード領域
- 根本原因の仮説
- エンジニアへの具体的な質問
- 推奨される次のステップ
```

**所要時間**: 20-40分
**トークン消費**: 30,000-80,000トークン
**API コスト**: $0.15-0.40

---

## 問題レイヤーの特定

ユーザー報告の問題がどのレイヤーに属するかを切り分ける:

```
ユーザーが [症状] を経験しています。以下のどれに該当しそうか判断してください:
- フロントエンド（表示、クライアントサイドロジック、ブラウザ互換性）
- バックエンド（サーバーロジック、APIレスポンス、ビジネスルール）
- データ（DB状態、ユーザーレコード、データ欠損）
- 設定（環境設定、フィーチャーフラグ、外部サービス）

各判断の根拠を説明してください。
```

---

## バグ分類パターン

| バグカテゴリ | 特徴 | PM調査で判別可能か |
|------------|------|------------------|
| バリデーションエラー | 入力チェックの漏れ・不整合 | ✓ バリデーションロジックを読める |
| 状態管理バグ | UI状態とサーバー状態の不一致 | △ コードパスから推測可能 |
| 競合条件 | タイミング依存の間欠的問題 | × ランタイム情報が必要 |
| 設定ミス | 環境変数・フラグの設定誤り | △ 設定ファイルの確認で一部可能 |
| 外部サービス障害 | API連携先の問題 | △ エラーハンドリングの有無を確認 |

---

## 調査時の注意事項

- **具体性**: 「認証はどう動く？」→ 広すぎ。「ログイン済みユーザーが保護ページにアクセスする際の認証確認は？」→ 具体的
- **プロダクト言語の要求**: 「プロダクト用語で説明して」「ユーザー体験に集中して」を常に含める
- **フォローアップ**: 最初の回答から深掘り。「92行目のビジネスルールの理由は？」
- **ファイル参照の記録**: エンジニアへの共有用にファイルパスと行番号を必ず記録
- **仮説としての扱い**: Claude Codeの分析は静的解析。ランタイム動作、設定依存のパス、実際に本番で使われるコードパスは見えない

---

## 実践例: 決済失敗バグのトリアージ

### 初期報告
「チェックアウト時にクレジットカードが拒否され、エラーページが表示されました。カートは空になりましたが注文確認メールは届きませんでした。」

### 調査プロンプト1（コード領域特定）
```
ユーザー報告の問題を調査中です: チェックアウト時の決済失敗後にカートが空になった

コンテキスト:
- ユーザーの操作: チェックアウトフローで決済情報を入力
- 期待: 決済失敗時はカートが保持され、エラーメッセージ表示
- 実際: エラーページ表示、カートが空、注文メールなし
- エラーメッセージ: 「処理中にエラーが発生しました」

関係するコード領域を特定してください。
```

### 調査結果の例
「checkout-service.js の processPayment() → cart-manager.js の clearCart() の順で呼ばれている。決済が失敗してもカート削除が実行される可能性がある。」

### 調査プロンプト2（深掘り）
```
checkout-service.js の processPayment() がエラーを返した場合、clearCart() は実行されますか？されるとしたらなぜですか？
```

### エンジニアハンドオフ例
```markdown
## バグ報告: 決済失敗時にカートが空になる

### ユーザー影響
決済失敗時にカートが消失し、ユーザーが商品を再選択する必要がある。

### 調査結果
- ファイル: checkout-service.js (L142-L178)
- 問題箇所: clearCart() が try-finally ブロックの finally に配置されている
- 仮説: 決済失敗でもカート削除が実行される設計ミス

### 推奨アクション
1. processPayment() の成功時のみ clearCart() を呼ぶように変更
2. 決済失敗時のユーザーフィードバック改善
3. テストケース追加（決済失敗シナリオ）
```
