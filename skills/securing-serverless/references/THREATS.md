# サーバーレス脅威体系

## 概要

サーバーレスアプリケーションは、従来のシステムと共通のセキュリティ課題を持ちながらも、アーキテクチャ特有の脅威に直面する。本ファイルでは、サーバーレス環境で特に重要となる17種類の脅威について、攻撃パターン、影響、対策を体系的に整理する。

これらの脅威は単独で発生するだけでなく、連鎖的に組み合わさることで重大なセキュリティ侵害につながる可能性がある。

---

## 脅威分類テーブル

| # | 脅威カテゴリ | 攻撃ベクトル | 影響度 | 対策概要 | 関連クラウド |
|---|------------|------------|--------|---------|------------|
| 1 | Publicly Accessible Functions | Function URL、API Gateway経由の直接アクセス | 高 | 認証・認可、WAF、レート制限 | AWS, Azure, GCP |
| 2 | Misconfigured Cloud Storage | 不適切なアクセス制御、公開バケット | 高 | 最小権限、暗号化、バケットポリシー監査 | S3, Azure Blob, GCS |
| 3 | Leaked Credentials | ソースコード、ログ、環境変数への埋め込み | 高 | Secrets Manager、環境変数分離、シークレットスキャン | All |
| 4 | Insecure Storage of Credentials | ハードコード、平文保存 | 高 | Key Management Service、動的シークレット取得 | All |
| 5 | Injection Attacks | コードインジェクション、SQL/NoSQL/コマンドインジェクション、SSRF | 致命的 | 入力検証、パラメータ化クエリ、最小権限 | All |
| 6 | Over-Privileged Permissions | 過剰なIAMロール、ワイルドカードポリシー | 高 | 最小権限原則、リソースベースポリシー | AWS IAM, Azure RBAC, GCP IAM |
| 7 | Business Logic Vulnerabilities | レース条件、状態管理不備、並行実行の悪用 | 中〜高 | トランザクション制御、べき等性設計、状態整合性チェック | All |
| 8 | Insecure Network Configuration | VPC設定ミス、セキュリティグループ過開放 | 中 | ネットワークセグメンテーション、プライベートエンドポイント | AWS VPC, Azure VNet, GCP VPC |
| 9 | Insufficient Logging/Monitoring | ログ欠如、アラート不備、監査証跡不足 | 中 | 構造化ログ、集中監視、異常検知 | CloudWatch, Azure Monitor, Cloud Logging |
| 10 | Security Mechanism Limitations | タイムアウト、実行時間制限、コールドスタート | 中 | 適切なタイムアウト設計、Provisioned Concurrency | All |
| 11 | Compromised CI/CD Pipelines | ビルドプロセス侵害、デプロイメント改ざん | 致命的 | パイプラインセキュリティ、署名検証、SBOM | All |
| 12 | Broken Authentication | 認証バイパス、トークン管理不備、セッション管理脆弱性 | 高 | マネージド認証サービス、トークン検証、MFA | Cognito, Auth0, Azure AD |
| 13 | Vulnerable Dependencies | 脆弱性を含むライブラリ、古いランタイム | 高 | 依存関係スキャン、自動更新、SBOM管理 | All |
| 14 | Denial of Service / Wallet | リソース枯渇攻撃、コスト爆発 | 中〜高 | レート制限、予算アラート、リザーブドキャパシティ | All |
| 15 | Cross-Site Scripting (XSS) | DOM-based XSS、Reflected XSS | 中 | 出力エスケープ、CSP、サニタイゼーション | Web全般 |
| 16 | API Gateway Misconfigurations | 認証・認可の不備、CORS設定ミス、過剰なエンドポイント公開 | 高 | APIゲートウェイセキュリティポリシー、OpenAPI定義 | API Gateway, Azure APIM, Apigee |
| 17 | Supply Chain Attacks | 侵害されたコンテナイメージ、悪意のある依存関係 | 致命的 | イメージスキャン、署名検証、信頼できるレジストリ | All |

---

## 各脅威の詳細説明

### 1. Publicly Accessible Functions（公開可能な関数）

**攻撃パターン:**
- 開発中に一時的に公開したFunction URLやAPI Gatewayエンドポイントが本番環境に残存
- フロントエンドコードや設定ファイルに埋め込まれたエンドポイントが発見される
- ステージング環境の誤公開、孤立したリソースの放置

**影響:**
- 認証・認可をバイパスした直接アクセス
- 内部ロジックの露出と悪用
- インジェクション攻撃の起点

**対策:**
- すべての公開エンドポイントに認証・認可を実装
- API GatewayでIAM認証、Lambda Authorizer、Cognitoを活用
- WAFによる保護、レート制限の設定
- 定期的なエンドポイント棚卸しと不要リソースの削除

---

### 2. Misconfigured Cloud Storage Resources（クラウドストレージの設定ミス）

**攻撃パターン:**
- S3バケット、Azure Blob Storage、GCSバケットのアクセス制御設定ミス
- 「公開読み取り」設定の意図しない有効化
- プレサインドURLの過剰な有効期限設定

**影響:**
- 機密データ（顧客情報、設定ファイル、シークレット）の漏洩
- データ改ざん、削除
- ランサムウェア攻撃の起点

**対策:**
- デフォルトでバケットをプライベートに設定
- バケットポリシーとIAMポリシーで最小権限を実施
- S3 Block Public Accessの有効化
- 保存時暗号化（SSE-S3、SSE-KMS）の適用
- プレサインドURLの短い有効期限設定

---

### 3. Leaked Credentials（認証情報の漏洩）

**攻撃パターン:**
- ソースコードリポジトリ（GitHub、GitLab等）への誤コミット
- ログファイル、エラーメッセージへの出力
- 環境変数の不適切な管理
- クライアントサイドコードへの埋め込み

**影響:**
- クラウドアカウントの完全侵害
- データベース、APIキー、サードパーティサービスへの不正アクセス
- ラテラルムーブメント（横展開攻撃）の起点

**対策:**
- AWS Secrets Manager、Azure Key Vault、GCP Secret Managerの使用
- GitGuardian、TruffleHog等のシークレットスキャンツールの導入
- `.gitignore`による機密ファイルの除外
- 環境変数と構成管理の分離
- 定期的なクレデンシャルローテーション

---

### 4. Insecure Storage of Credentials and Secret Keys（認証情報の安全でない保存）

**攻撃パターン:**
- 環境変数への平文保存
- ハードコードされたAPIキー、データベースパスワード
- 暗号化されていない設定ファイル

**影響:**
- 関数のソースコードやメタデータからシークレットが抽出される
- 侵害された際の影響範囲拡大

**対策:**
- Secrets Manager / Key Vaultから動的にシークレットを取得
- KMSによる暗号化
- 最小権限でシークレットアクセスを制限
- シークレットの定期的なローテーション
- 実行時のシークレット取得（起動時にのみメモリに読み込む）

---

### 5. Injection Attacks（インジェクション攻撃）

#### 5.1 コードインジェクション

**攻撃パターン:**
- 動的コード実行関数への入力
- テンプレートエンジンへの信頼されていない入力
- シリアライゼーション/デシリアライゼーションの脆弱性

**影響:**
- 任意コード実行（RCE）
- システム完全侵害
- データ窃取、改ざん

**対策:**
- 動的コード実行関数の使用禁止
- 入力の厳密な検証とホワイトリスト方式
- サンドボックス環境での実行

#### 5.2 SQLインジェクション / NoSQLインジェクション

**攻撃パターン:**
- 動的に構築されたSQLクエリへの悪意ある入力
- NoSQLクエリ（MongoDB、DynamoDB等）での演算子インジェクション

**影響:**
- データベース内容の窃取、改ざん、削除
- 認証バイパス
- データベースサーバーの侵害

**対策:**
- パラメータ化クエリ（Prepared Statements）の使用
- ORMの適切な利用
- 入力検証とエスケープ処理
- 最小権限のデータベースアクセス

#### 5.3 コマンドインジェクション

**攻撃パターン:**
- システムコマンド実行への入力
- シェルコマンド構築時の入力サニタイゼーション不足

**影響:**
- 任意のOSコマンド実行
- ファイルシステムへのアクセス
- ネットワークへの不正アクセス

**対策:**
- システムコマンド実行の回避（ライブラリAPIを優先）
- 必要な場合は引数を配列で渡す（シェル経由を避ける）
- 入力の厳密な検証

#### 5.4 Server-Side Request Forgery (SSRF)

**攻撃パターン:**
- 関数が外部URLを取得する際、攻撃者が制御するURLを指定
- 内部メタデータエンドポイントへのアクセス
- 内部サービスへの不正リクエスト

**影響:**
- IAMクレデンシャルの窃取
- 内部ネットワークの偵察
- 内部サービスの悪用

**対策:**
- URLホワイトリストの実装
- メタデータエンドポイントへのアクセス制限（IMDSv2の使用）
- ネットワークセグメンテーション
- プライベートリンク/VPCエンドポイントの使用

---

### 6. Over-Privileged Permissions and Roles（過剰な権限とロール）

**攻撃パターン:**
- 「全権限」を持つIAMロールの割り当て
- ワイルドカードリソースの使用
- 開発時の広い権限が本番環境に残存

**影響:**
- 侵害された関数からのラテラルムーブメント
- データ削除、リソース改ざん
- クラウドアカウント全体の侵害

**対策:**
- 最小権限の原則（Principle of Least Privilege）の徹底
- リソースベースポリシーの活用
- IAM Access Analyzerでの権限分析
- 定期的な権限レビューと監査
- タグベースのアクセス制御（ABAC）

---

### 7. Business Logic Vulnerabilities（ビジネスロジックの脆弱性）

**攻撃パターン:**
- レースコンディションの悪用（同時実行による状態不整合）
- べき等性の欠如による重複処理
- トランザクション制御の不備
- 非同期処理での状態管理ミス

**影響:**
- データ不整合
- 金銭的損失（重複決済、在庫管理の破綻）
- ビジネスプロセスの破壊

**対策:**
- DynamoDBの条件付き書き込み、楽観的ロックの実装
- べき等性キーの使用
- 分散トランザクション（Sagaパターン）の実装
- 適切なリトライ戦略とバックオフ
- 状態整合性チェックとリコンシリエーション

---

### 8. Insecure Network Configuration（安全でないネットワーク設定）

**攻撃パターン:**
- VPC内の関数に対する不適切なセキュリティグループ設定
- 過度に開放されたインバウンドルール
- パブリックサブネットへの配置
- NACLの誤設定

**影響:**
- 内部リソースへの不正アクセス
- ラテラルムーブメント
- ネットワーク経由の攻撃

**対策:**
- 関数をプライベートサブネットに配置
- セキュリティグループで最小限のポート・プロトコルのみ許可
- VPCエンドポイント/PrivateLinkの使用
- ネットワークセグメンテーション
- NACLでのレイヤー防御

---

### 9. Insufficient Tracing, Logging, Monitoring, and Alerting（不十分なトレーシング、ログ、監視、アラート）

**攻撃パターン:**
- ログ記録の欠如により攻撃の検知が遅延
- アラート設定の不備により異常が見逃される
- 監査証跡の不足により侵害後の調査が困難

**影響:**
- 攻撃の検知遅延
- インシデント対応の遅れ
- コンプライアンス違反
- 根本原因分析の困難

**対策:**
- 構造化ログ（JSON形式）の記録
- CloudWatch Logs、Azure Monitor、Cloud Loggingへの集約
- 異常検知とアラートの設定
- 分散トレーシング（AWS X-Ray、OpenTelemetry）の実装
- セキュリティイベントの監視（GuardDuty、Security Centerなど）
- ログの改ざん防止（S3バケットポリシー、CloudTrail）

---

### 10. Serverless Security Mechanism Limitations（サーバーレスセキュリティ機構の制限）

**攻撃パターン:**
- タイムアウト制限を悪用したDoS攻撃
- コールドスタート時のレイテンシ悪用
- メモリ制限を悪用したサービス停止

**影響:**
- サービスの可用性低下
- ユーザー体験の悪化
- コスト増大

**対策:**
- 適切なタイムアウト設定（短すぎず長すぎず）
- Provisioned Concurrencyでコールドスタート削減
- メモリとCPU配分の最適化
- 非同期処理とイベント駆動設計
- サーキットブレーカーパターンの実装

---

### 11. Compromised CI/CD Pipelines（侵害されたCI/CDパイプライン）

**攻撃パターン:**
- ビルドプロセスへのマルウェア混入
- デプロイメント時の成果物改ざん
- パイプライン用認証情報の窃取
- サプライチェーン攻撃

**影響:**
- バックドアの挿入
- 本番環境への悪意あるコードのデプロイ
- データ漏洩、システム侵害

**対策:**
- パイプラインのセキュアな設計（最小権限、セグメンテーション）
- コード署名と検証
- 成果物の整合性チェック（ハッシュ検証）
- SBOM（Software Bill of Materials）の生成と管理
- パイプライン用クレデンシャルの厳重な管理
- 監査ログの記録

---

### 12. Broken Authentication（認証の破綻）

**攻撃パターン:**
- 認証トークンの不適切な検証
- JWTの署名検証スキップ
- セッション管理の不備
- トークンの過剰な有効期限
- 認証バイパスロジックの脆弱性

**影響:**
- 不正アクセス、なりすまし
- 権限昇格
- データ漏洩

**対策:**
- Amazon Cognito、Auth0、Azure AD等のマネージド認証サービス活用
- JWTの署名検証と有効期限チェックの徹底
- 多要素認証（MFA）の実装
- トークンのリフレッシュ戦略
- セッション管理のベストプラクティス遵守

#### Amazon Cognitoの主要コンポーネント

- **User Pools**: ユーザーディレクトリとして機能し、サインアップ・サインイン機能を提供
- **Identity Pools**: 一時的なAWSクレデンシャルを提供し、AWS リソースへのアクセスを仲介
- **App Clients**: アプリケーションがUser Poolsと通信するための設定
- **Lambda Triggers**: 認証フローの各段階でカスタムロジックを実行

**Cognito利用時の注意点:**
- App Clientの適切なスコープ設定
- Lambda Triggersでの入力検証
- トークンの安全な保存と送信（HTTPS必須）

---

### 13. Vulnerable Application Dependencies（脆弱なアプリケーション依存関係）

**攻撃パターン:**
- 古いライブラリ、フレームワーク、ランタイムの使用
- 既知の脆弱性（CVE）を持つパッケージの利用
- トランジティブ依存関係の脆弱性

**影響:**
- 既知の脆弱性を悪用したRCE
- データ漏洩、サービス停止
- サプライチェーン攻撃の起点

**対策:**
- 依存関係スキャンツールの導入（Snyk、Dependabot、Trivy）
- 定期的な依存関係の更新
- SBOMの生成と管理
- 脆弱性データベースの監視
- ランタイムの最新版への追従

---

### 14. Denial of Service and Denial of Wallet（サービス拒否とコスト拒否）

**攻撃パターン:**
- 大量のリクエスト送信によるリソース枯渇
- 高コスト操作の繰り返し実行
- 並行実行数の上限到達
- 無限ループや長時間実行を引き起こす入力

**影響:**
- サービスの停止、遅延
- 予期しない高額なクラウド利用料金
- ビジネス継続性の喪失

**対策:**
- レート制限（API Gatewayスロットリング、WAF）
- リザーブドキャパシティの設定
- 並行実行数の制限（Reserved Concurrency）
- CloudWatchアラームと予算アラート
- DDoS対策（AWS Shield、Azure DDoS Protection）
- タイムアウトとリトライ回数の制限

---

### 15. Cross-Site Scripting (XSS)（クロスサイトスクリプティング）

**攻撃パターン:**
- 信頼されていないデータのHTMLへの挿入
- DOM操作時のサニタイゼーション不足
- サーバー側レンダリング時の出力エスケープ漏れ

**影響:**
- セッションハイジャック
- フィッシング攻撃
- マルウェア配布

**対策:**
- 出力時の適切なエスケープ処理
- Content Security Policy (CSP) ヘッダーの設定
- フレームワーク標準のテンプレートエンジン使用
- HTTPOnly、Secureフラグ付きCookie
- 入力検証とサニタイゼーション

---

### 16. API Gateway Security Misconfigurations（API Gatewayのセキュリティ設定ミス）

**攻撃パターン:**
- 認証・認可の未設定または不適切な設定
- CORS設定の過度な許可
- APIキーの不適切な管理
- 過剰なエンドポイント公開
- リクエスト/レスポンスの検証不足

**影響:**
- 認証バイパス
- クロスオリジン攻撃
- データ漏洩

**対策:**
- IAM認証、Lambda Authorizer、Cognitoの適切な利用
- CORS設定の最小化（特定のオリジンのみ許可）
- API Gatewayのリクエスト検証機能の有効化
- OpenAPI/Swagger定義によるスキーマ検証
- WAF統合
- レート制限とクォータ設定
- APIキーのローテーション

---

### 17. Supply Chain Attacks（サプライチェーン攻撃）

**攻撃パターン:**
- 侵害されたコンテナイメージの使用
- 悪意のある依存パッケージのインストール
- 改ざんされたビルドツール
- 信頼できないレジストリからのプル

**影響:**
- バックドアの混入
- データ漏洩
- インフラ全体の侵害

**対策:**
- 信頼できるコンテナレジストリの使用（ECR、ACR、GCR）
- イメージスキャン（Trivy、Clair、ECR Scan）
- コンテナイメージの署名と検証（Notary、Cosign）
- SBOMの生成と管理
- 依存関係の固定（lock file）
- プライベートレジストリの使用

---

## 攻撃チェーンの例

### シナリオ1: 公開関数からの侵害拡大

1. **初期アクセス**: 開発者が残した公開Function URLを発見
2. **インジェクション**: 入力検証不足を悪用してコードインジェクション
3. **権限昇格**: 関数に割り当てられた過剰なIAMロールを悪用
4. **ラテラルムーブメント**: 他のAWSリソース（S3、DynamoDB）にアクセス
5. **データ窃取**: 設定ミスされたS3バケットから機密データをダウンロード
6. **永続化**: 新しいIAMユーザーを作成し、バックドアを設置

### シナリオ2: CI/CDパイプライン侵害

1. **初期侵害**: GitHub等のリポジトリに漏洩したAWSクレデンシャルを発見
2. **パイプライン侵入**: CI/CD環境（CodePipeline、GitHub Actions）に侵入
3. **成果物改ざん**: ビルドプロセスに悪意あるコードを挿入
4. **本番デプロイ**: 改ざんされた関数が本番環境にデプロイ
5. **データ漏洩**: 実行中の関数からデータを継続的に窃取
6. **検知回避**: ログ記録の不備により長期間発覚せず

---

## まとめ

サーバーレスアプリケーションのセキュリティは、単一の脅威ではなく、複数の脆弱性が連鎖することで重大な侵害に発展する。以下の原則を徹底することが重要:

- **最小権限の原則**: IAM、ネットワーク、データアクセスすべてで適用
- **深層防御**: 複数のセキュリティレイヤーを組み合わせる
- **シフトレフト**: 設計段階からセキュリティを組み込む
- **継続的監視**: ログ、メトリクス、アラートによる異常検知
- **自動化**: セキュリティチェックをCI/CDパイプラインに統合

これらの脅威を理解し、適切な対策を実装することで、サーバーレスアプリケーションのセキュリティ態勢を大幅に向上できる。
