# デプロイモデル

## デプロイモデルとは

デプロイモデルは、テナントのワークロードをインフラストラクチャリソースに割り当てる戦略を定義します。これは、どのリソースを共有し、どのリソースを専用にするかを決定する重要な設計決定です。

### デプロイモデルの選択基準

デプロイモデルは、技術的な選好ではなく、ビジネス要件から逆算して選択されるべきです:

- **コスト効率**: テナント追加時のコスト増を最小化
- **コンプライアンス**: 規制要件（金融、医療等）への対応
- **パフォーマンス**: レイテンシー、スループット要件
- **分離要件**: セキュリティ、データプライバシー
- **運用効率**: 管理・監視の容易さ
- **スケーラビリティ**: テナント数の増加への対応

## サイロとプール

SaaSデプロイメントの基本用語として、「サイロ」と「プール」を理解することが重要です。

### サイロ（Silo）
リソースが特定のテナントに専用割り当てされている状態です。

**例:**
- テナント専用のコンピューティングインスタンス
- テナント専用のデータベース
- テナント専用のストレージバケット

### プール（Pool）
1つ以上のテナントがリソースを共有している状態です。

**例:**
- 複数テナントが共有するアプリケーションサーバー
- 複数テナントのデータを含むマルチテナントデータベース
- 共有ストレージサービス

### 用語の一貫性
これらの用語は、デプロイとアーキテクチャの説明で一貫して使用してください。「専用」「共有」よりも「サイロ」「プール」の方が、SaaSの文脈では明確です。

## フルスタック・サイロモデル

### 概要

フルスタック・サイロモデルでは、テナントごとに完全に独立したインフラストラクチャスタックを構築します。

**構成要素:**
- コンピューティング: 専用インスタンス
- ストレージ: 専用データベース、専用ストレージ
- ネットワーク: 専用仮想ネットワーク（例: AWS VPC）

### 適用場面

以下のような要件がある場合、フルスタック・サイロモデルが適しています:

1. **厳格なコンプライアンス要件**
   - 金融機関（PCI DSS、SOX等）
   - 医療機関（HIPAA等）
   - 政府機関（FedRAMP等）

2. **高い分離要件**
   - データの物理的分離が必須
   - 監査要件が厳格
   - 顧客の要求（契約上の理由）

3. **レガシーシステムのSaaS移行**
   - 初期段階ではサイロから開始
   - 段階的にプール化を進める

4. **ノイジーネイバー問題の完全排除**
   - パフォーマンスへの影響を完全に防ぐ
   - SLA保証が厳格

### 利点

| 利点 | 説明 |
|------|------|
| **自然な分離** | リソースが物理的に分離されているため、分離ロジックが不要 |
| **コンプライアンス対応** | 規制要件への対応が容易 |
| **ノイジーネイバー問題なし** | 他のテナントの影響を受けない |
| **カスタマイズ性** | テナントごとに異なる構成が可能 |
| **障害影響範囲の限定** | 一つのテナントの障害が他に波及しない（Blast Radius最小化） |

### 課題と考慮事項

| 課題 | 説明 | 対策 |
|------|------|------|
| **コスト効率の低さ** | テナント数に比例してインフラコスト増 | ティアリング戦略で高ティアのみサイロ化 |
| **運用の複雑さ** | テナントごとの管理オーバーヘッド | 完全な自動化、Infrastructure as Code |
| **スケーリングの課題** | テナント数が増えると管理が困難 | ポッドモデルへの移行検討 |
| **リソース利用効率** | アイドルリソースの浪費 | オートスケーリング、適切なインスタンスサイジング |

### SaaSマインドセットの維持

フルスタック・サイロモデルを採用する場合でも、SaaSマインドセットを維持することが重要です:

**維持すべき原則:**
- **統一されたコントロールプレーン**: 全テナントを単一システムで管理
- **統一されたバージョン**: 全テナントが同一バージョンの製品を使用
- **自動化**: テナントのプロビジョニング、デプロイ、運用を完全自動化
- **統一された運用**: テナントごとの手動介入を排除

**陥りがちなアンチパターン:**
- テナントごとに異なるバージョンをデプロイ → MSPになる
- 手動でのプロビジョニング → スケールしない
- テナントごとの個別対応 → 運用効率が低下

## フルスタック・プールモデル

### 概要

フルスタック・プールモデルでは、全テナントが同一のインフラストラクチャスタックを共有します。これは最大のコスト効率と運用効率を実現します。

**構成要素:**
- コンピューティング: 共有アプリケーションサーバー
- ストレージ: マルチテナントデータベース
- ネットワーク: 共有ネットワークインフラ

### 利点

| 利点 | 説明 |
|------|------|
| **最大のコスト効率** | リソースの集約により、テナント追加コストが最小 |
| **運用効率** | 一括管理により運用オーバーヘッドが最小 |
| **俊敏性** | 全テナントへの一括更新が可能 |
| **スケーラビリティ** | 大量のテナントをサポート可能 |
| **リソース利用効率** | アイドルリソースの無駄が最小 |

### 課題と考慮事項

| 課題 | 説明 | 対策 |
|------|------|------|
| **ノイジーネイバー問題** | 一つのテナントの過負荷が他に影響 | レート制限、リソースクォータ、テナント分離 |
| **テナント分離の複雑さ** | アプリケーションレベルでの分離実装が必須 | Row-Level Security、テナントコンテキストの徹底 |
| **スケーリング戦略** | 全テナントに影響するため慎重な計画が必要 | 段階的スケーリング、ポッドモデルへの移行 |
| **データ混在管理** | 複数テナントのデータが同じデータベースに存在 | パーティショニング戦略、暗号化 |
| **Blast Radius** | 障害が全テナントに影響 | 冗長化、フェイルオーバー、ポッドモデル |

### ノイジーネイバー問題への対策

ノイジーネイバー問題は、プールモデルの最大の課題です。以下の対策を実装してください:

**コンピューティングレベル:**
- リソースクォータ（CPU、メモリ制限）
- レート制限（API呼び出し制限）
- テナントごとの同時実行数制限

**データベースレベル:**
- 接続プール管理
- クエリタイムアウト
- テナントごとのIOPS制限（可能な場合）

**アプリケーションレベル:**
- テナントごとのキュー管理
- 優先度制御（ティアベース）
- サーキットブレーカーパターン

**監視と対応:**
- テナントごとのリソース使用量監視
- 異常検知とアラート
- 自動スロットリング

## ハイブリッド・フルスタックモデル

ハイブリッド・フルスタックモデルは、サイロとプールを組み合わせたアプローチです。

### 基本パターン

**パターン1: コンピューティング共有、ストレージ専用**
```
[共有アプリケーションサーバー]
    ↓
[テナントA専用DB] [テナントB専用DB] [テナントC専用DB]
```

**適用場面:**
- データコンプライアンス要件がある
- コンピューティングは共有可能
- データの物理的分離が必須

**パターン2: コンピューティング専用、ストレージ共有**
```
[テナントA専用サーバー] [テナントB専用サーバー] [テナントC専用サーバー]
    ↓
[共有マルチテナントデータベース]
```

**適用場面:**
- コンピューティング負荷が高いテナント
- データ量は小さい
- パフォーマンス分離が必要

### 選択基準

| 要件 | 推奨パターン |
|------|------------|
| データコンプライアンス重視 | コンピューティング共有、ストレージ専用 |
| パフォーマンス分離重視 | コンピューティング専用、ストレージ共有 |
| コスト重視だが部分的分離が必要 | 要件に応じて柔軟に選択 |

## 混合モードデプロイ

混合モードデプロイは、ティアに応じてデプロイモデルを使い分けるアプローチです。

### ティアベースの分離

**典型的な構成:**

| ティア | デプロイモデル | 理由 |
|--------|--------------|------|
| Free/Basic | フルスタック・プール | コスト効率最大化 |
| Standard | ハイブリッド（ストレージ専用） | バランスの取れた分離 |
| Premium/Enterprise | フルスタック・サイロ | 完全な分離とカスタマイズ性 |

### 実装上の考慮事項

**ルーティングロジック:**
```
[API Gateway]
    ↓
[テナントコンテキスト取得]
    ↓
[ティア判定]
    ├─ Basic → プール環境へルーティング
    ├─ Standard → ハイブリッド環境へルーティング
    └─ Premium → サイロ環境へルーティング
```

**課題:**
- ルーティングロジックの複雑さ
- テナント間のデータ移行（ティア変更時）
- 異なる環境間の一貫性維持

**利点:**
- ビジネス要件に最適化
- コストと分離のバランス
- ティアごとの差別化が明確

## ポッドモデル

ポッドモデルは、テナントをグループ化してリソースを集約するアプローチです。

### 基本概念

```
[Pod 1]
  └─ テナントA, B, C（地域: 北米）
[Pod 2]
  └─ テナントD, E, F（地域: 欧州）
[Pod 3]
  └─ テナントG, H, I（地域: アジア）
```

### グルーピング基準

| 基準 | 説明 | 例 |
|------|------|-----|
| **地域** | データレジデンシー要件 | 北米、欧州、アジア |
| **規模** | テナントサイズ | 小規模、中規模、大規模 |
| **業種** | コンプライアンス要件 | 金融、医療、一般企業 |
| **ティア** | サービスレベル | Basic、Premium、Enterprise |
| **テナント数** | スケーラビリティ | Pod あたり 100 テナント |

### 利点

| 利点 | 説明 |
|------|------|
| **Blast Radius制限** | 一つのPodの障害が他のPodに影響しない |
| **管理性とスケーラビリティのバランス** | プールの利点を保ちつつ管理性を向上 |
| **地域対応** | データレジデンシー要件への対応が容易 |
| **段階的スケーリング** | Pod単位での水平スケーリング |

### 実装上の考慮事項

**テナント配置戦略:**
- 新規テナントをどのPodに配置するか
- Pod間のテナント移行
- Pod内のテナント数の上限

**ルーティング:**
- テナントからPodへのマッピング管理
- Podアドレスの解決
- フェイルオーバー時のルーティング

**運用:**
- Pod単位での監視とアラート
- Pod単位でのアップグレード
- Pod間の一貫性維持

## デプロイモデル選択の指針

### 総合比較表

| 考慮事項 | フルスタック・サイロ | ハイブリッド | フルスタック・プール | ポッド |
|---------|-------------------|------------|------------------|-------|
| **コスト効率** | △ 低い | ○ 中程度 | ◎ 高い | ○ 中〜高 |
| **運用効率** | △ テナント比例 | ○ 中程度 | ◎ 一括管理 | ○ Pod単位管理 |
| **テナント分離** | ◎ 自然に実現 | ○ 部分的 | △ 追加実装必要 | ○ Pod内は共有 |
| **コンプライアンス** | ◎ 対応容易 | ○ 要件次第 | △ 追加対策必要 | ○ Pod単位で対応 |
| **ノイジーネイバー** | ◎ 影響なし | ○ 部分的影響 | △ 対策必要 | ○ Pod内のみ影響 |
| **俊敏性** | △ 更新複雑 | ○ 中程度 | ◎ 一括更新 | ○ Pod単位更新 |
| **スケーラビリティ** | △ テナント数制約 | ○ 中程度 | ◎ 高い | ◎ 高い |
| **Blast Radius** | ◎ 最小 | ○ 中程度 | △ 最大 | ○ Pod単位 |

### 意思決定フローチャート

```
[ビジネス要件分析]
    ↓
[厳格なコンプライアンス要件あり？]
    Yes → [フルスタック・サイロ]
    No ↓
[パフォーマンス分離が重要？]
    Yes → [ティアベース混合モード]
    No ↓
[大量のテナントを想定？]
    Yes → [ポッドモデル または フルスタック・プール]
    No ↓
[コスト効率最優先？]
    Yes → [フルスタック・プール]
    No → [ハイブリッド]
```

### データ駆動での進化

デプロイモデルは静的なものではなく、データに基づいて進化させるべきです。

**収集すべきメトリクス:**
- テナントごとのリソース使用量
- テナントごとのコスト
- パフォーマンス指標
- ノイジーネイバーの発生頻度
- 障害の影響範囲
- オンボーディング時間

**進化のシナリオ:**

1. **初期（小規模）**: フルスタック・サイロ
   - 理由: テナント数が少なく、運用が手に負える

2. **成長期（中規模）**: ティアベース混合モード
   - 理由: コスト効率と分離のバランスが必要

3. **成熟期（大規模）**: ポッドモデル
   - 理由: 大量のテナントを効率的に管理

## 重要な原則

### 1. デプロイモデルは時間とともに進化する
最初から完璧なモデルを選ぶ必要はありません。ビジネスの成長に合わせて進化させてください。

### 2. データ駆動でリファクタリングの機会を見つける
テナントのメトリクスを継続的に収集・分析し、最適化の機会を特定してください。

### 3. 0か100かではなく、最適な組み合わせを見つける
サイロとプールの二択ではなく、ハイブリッド、混合モード、ポッドモデルなど、ビジネス要件に最適な組み合わせを選択してください。

### 4. 万能なモデルは存在しない
どのデプロイモデルにもトレードオフがあります。ビジネス要件、コスト、コンプライアンス、スケーラビリティのバランスを考慮してください。

### 5. アーキテクチャの柔軟性を保つ
将来の変更に備え、デプロイモデルを変更しやすいアーキテクチャを設計してください。Infrastructure as Code、自動化、抽象化が鍵です。
