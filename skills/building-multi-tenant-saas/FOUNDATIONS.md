# SaaSアーキテクチャの基礎

## SaaSマインドセットとは

SaaSは単なる技術選択ではなく、ビジネスモデルそのものです。従来のインストール型ソフトウェアからの移行は、以下の課題を解決するために行われます。

### インストール型ソフトウェアの課題
- **運用効率・コスト効率**: 顧客ごとの環境管理により運用コストが増大
- **俊敏性・イノベーションの制約**: 顧客環境のバージョンが異なるため、迅速な改善が困難
- **顧客の期待変化**: 価値重視、従量課金、すぐに使えるサービスへの期待

### SaaSの核心
統一された体験を全テナントに提供することがSaaSの本質です。これにより、運用効率、俊敏性、継続的なイノベーションが実現されます。

## テナントの概念

### 顧客からテナントへの転換
SaaS環境では、「顧客」ではなく「テナント」という用語を使用します。テナントは共有インフラストラクチャの一時的な居住者を意味し、賃貸住宅の比喩が適切です。

**賃貸住宅の比喩:**
- 建物 = 共有インフラストラクチャ
- テナント = 居住者（各部屋は専用だが、建物の管理は統一）
- 家主 = SaaSプロバイダー

### テナントコンテキスト
テナントコンテキストは、すべてのリクエストに付随するテナント情報です。これにより、アプリケーションはどのテナントのためにリクエストを処理しているかを常に把握できます。

テナントコンテキストに含まれる情報:
- テナントID
- テナントティア
- ロール・権限
- 機能フラグ

## マルチテナントの再定義

### 従来の定義
従来、マルチテナントは「リソース共有」を意味していました。つまり、複数のテナントが同じコンピューティングリソースやデータベースを共有する状態です。

### 拡張された定義
現代のSaaSにおけるマルチテナントは、**統一された管理・運用**を意味します。これは、専用リソース（サイロ）を使用している場合でも含まれます。

**重要な判断基準:**
- 統一されたコントロールプレーンがあるか
- 全テナントが同一バージョンの製品を使用しているか
- 統一されたデプロイと運用が行われているか

### 「シングルテナント」という表現は避ける
フルスタックのサイロデプロイメントでも、統一されたコントロールプレーンで管理されていれば「マルチテナント」です。「シングルテナント」という表現は、マネージドサービスプロバイダー（MSP）との混同を招くため避けるべきです。

## SaaSビジネスの5つの主要目標

| 目標 | 説明 | 重要性 |
|------|------|--------|
| **俊敏性** | 市場変化への迅速な対応、短いリリースサイクル | 競争優位性の源泉 |
| **運用効率** | テナント追加に伴うコスト増の最小化 | ビジネスのスケーラビリティ |
| **イノベーション** | 顧客フィードバックに基づく継続的改善 | 顧客満足度の向上 |
| **スムーズなオンボーディング** | 摩擦のないテナント導入体験 | 顧客獲得コストの削減 |
| **成長** | スケールメリットによるビジネス拡大 | 収益性の向上 |

これらの目標は相互に関連しており、SaaSアーキテクチャの設計決定に大きな影響を与えます。

## コントロールプレーンとアプリケーションプレーン

SaaS環境は、2つの明確に分離されたプレーンから構成されます。

### コントロールプレーン

コントロールプレーンは、SaaS環境の基盤サービス群です。これはアプリケーションとは独立して存在し、SaaSプラットフォーム全体を管理します。

**主要な構成要素:**
- **オンボーディング**: 新規テナントの登録とプロビジョニング
- **アイデンティティ**: テナントとユーザーの認証・認可
- **メトリクス**: テナントごとの使用状況、パフォーマンス、ヘルス監視
- **請求**: 使用量に基づく課金情報の収集と処理
- **テナント管理**: テナント構成、ティア、ライフサイクル管理
- **管理コンソール**: シングルペインオブグラス（統一管理画面）

**重要な特性:**
- マルチテナントサービスとしては構築されない（全テナントにまたがるサービス）
- テナントに依存しない運用
- SaaS開発の出発点

### アプリケーションプレーン

アプリケーションプレーンは、SaaS製品の機能を具現化する場所です。ここでマルチテナント原則が具体的に実装されます。

**主要な構成要素:**
- **テナント分離**: テナント間のリソースとデータの分離
- **データパーティショニング**: テナントデータの論理的・物理的分離
- **ルーティング**: テナントコンテキストに基づくリクエストのルーティング
- **ドメイン機能**: ビジネスロジックとアプリケーション機能

**重要な特性:**
- 設計はドメイン・ビジネス要件に依存
- マルチテナント戦略（サイロ/プール）の実装場所
- コントロールプレーンから独立したバージョン管理

### 二つのプレーンの関係

```
[コントロールプレーン]
    ↓ 管理・監視
[アプリケーションプレーン]
    ↓ サービス提供
[テナント]
```

**構築順序:**
1. コントロールプレーンを先に構築
2. アプリケーションプレーンを後から構築

**独立性:**
- それぞれ独立したバージョン管理とデプロイサイクル
- アプリケーションプレーンのインフラが共有でも専用でも、コントロールプレーンがあればマルチテナント

**具体例:**
- テナントがフルスタックサイロ（完全専用リソース）でも、統一されたコントロールプレーンで管理されていればマルチテナントSaaS
- コントロールプレーンなしにリソースを共有しているだけでは、真のSaaSとは言えない

## SaaSの境界線

### マネージドサービスプロバイダー（MSP）との違い

MSPはSaaSではありません。以下の違いを理解することが重要です。

| 特性 | MSP | SaaS |
|------|-----|------|
| バージョン管理 | テナントごとに異なるバージョン | 全テナント同一バージョン |
| 管理方式 | 個別管理・個別構成 | 統一されたコントロールプレーン |
| デプロイ | テナントごとに個別デプロイ | 統一されたデプロイ自動化 |
| 運用 | テナント比例で運用コスト増 | テナント数に関わらず一定の運用効率 |
| 更新 | 顧客ごとに更新スケジュール調整 | 全テナント同時更新 |

### SaaSの判断基準

以下の3つの基準をすべて満たす場合、SaaSと言えます:

1. **統一されたバージョン**: 全テナントが同一バージョンの製品を使用
2. **統一されたコントロールプレーン**: すべてのテナントを単一のシステムで管理
3. **サービスとしての提供**: as-a-Service モデル（従量課金、サブスクリプション等）

### グレーゾーンの扱い

以下のケースはSaaSとして扱います:
- フルスタックサイロでも、統一されたコントロールプレーンとデプロイ自動化があればSaaS
- ティアベースで一部のテナントが専用リソースを使用していてもSaaS
- カスタマイズが許可されていても、ベース機能が統一されていればSaaS

以下のケースはSaaSではありません:
- テナントごとに異なるバージョンの製品が稼働
- 手動での個別デプロイとメンテナンス
- 統一されたコントロールプレーンの欠如

## SaaSマインドセットの実践

### 設計時の問い
SaaSアーキテクチャを設計する際、以下の問いを常に自問してください:

- この設計は運用効率を向上させるか？
- テナント追加時のコスト増を最小化できるか？
- 全テナントに迅速にイノベーションを提供できるか？
- オンボーディング体験は摩擦のないものか？
- この設計はビジネスの成長をサポートするか？

### 避けるべき思考パターン

- 「このテナントだけ特別扱いすればいい」→ 統一された体験を損なう
- 「サイロなら分離が簡単だから安全」→ 運用効率を犠牲にする
- 「とりあえず動けばいい」→ 技術的負債の蓄積
- 「顧客ごとにカスタマイズしよう」→ SaaSではなくMSPになる

### 成功のための原則

1. **統一性**: すべてのテナントに統一された体験を提供
2. **自動化**: オンボーディング、デプロイ、運用のすべてを自動化
3. **計測**: テナントごとのメトリクスを収集し、データ駆動で改善
4. **進化**: デプロイモデルは時間とともに進化させる
5. **バランス**: ビジネス要件と技術的トレードオフのバランスを取る

SaaSマインドセットは、技術的な選択だけでなく、組織文化と意思決定プロセス全体に浸透させる必要があります。
