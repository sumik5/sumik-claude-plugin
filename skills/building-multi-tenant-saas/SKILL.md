---
name: building-multi-tenant-saas
description: "Guides multi-tenant SaaS architecture design covering deployment models, tenant isolation, data partitioning, identity, onboarding, tiering, operations, and migration. Use when designing SaaS platforms, implementing multi-tenancy patterns, or evaluating silo vs pool strategies for cloud-native applications. Distinct from modernizing-architecture (system-level patterns) by focusing on SaaS-specific multi-tenancy implementation."
---

# マルチテナントSaaSアーキテクチャ構築ガイド

## 目次

- [Overview](#overview)
- [SaaSの核心原則](#saasの核心原則)
- [マルチテナントの定義](#マルチテナントの定義)
- [アーキテクチャの二つの柱](#アーキテクチャの二つの柱)
- [判断基準テーブル](#判断基準テーブル)
- [ユーザー確認の原則](#ユーザー確認の原則askuserquestion)
- [サブファイル参照ガイド](#サブファイル参照ガイド)
- [実装チェックリスト](#実装チェックリスト)

**詳細ドキュメント:**
- [FOUNDATIONS.md](FOUNDATIONS.md) - SaaSマインドセット、定義、アーキテクチャ基礎
- [DEPLOYMENT-MODELS.md](DEPLOYMENT-MODELS.md) - サイロ/プール/ハイブリッド/ポッドモデル
- [ONBOARDING-AND-IDENTITY.md](ONBOARDING-AND-IDENTITY.md) - オンボーディング、アイデンティティ、テナント管理
- [SERVICE-DESIGN.md](SERVICE-DESIGN.md) - マルチテナントサービス設計パターン
- [DATA-PARTITIONING.md](DATA-PARTITIONING.md) - データパーティショニング戦略
- [TENANT-ISOLATION.md](TENANT-ISOLATION.md) - テナント分離モデルと実装
- [COMPUTE-PATTERNS.md](COMPUTE-PATTERNS.md) - コンテナ/サーバーレスSaaSパターン
- [OPERATIONS-AND-STRATEGY.md](OPERATIONS-AND-STRATEGY.md) - 運用、移行、ティアリング、生成AI

---

## Overview

マルチテナントSaaSとは、**統一された体験を全テナントに提供するサービスモデル**である。技術的な実装パターンというよりも、ビジネスモデルとしてのSaaSの本質を理解することが重要である。

### SaaSの基本構造

SaaSアーキテクチャは**コントロールプレーン**と**アプリケーションプレーン**の二層構造で構成される：

- **コントロールプレーン**: テナント管理、オンボーディング、アイデンティティ、メトリクス、請求など、全テナントにまたがる共通サービス
- **アプリケーションプレーン**: SaaS製品の機能を具現化し、テナント分離やデータパーティショニングを実装する場所

この二層構造により、テナント固有の機能と全体管理機能が明確に分離される。

---

## SaaSの核心原則

### 1. 統一されたバージョン管理

**全テナントが常に同一バージョンのソフトウェアを使用する**ことが、SaaSの最も重要な原則である。これにより：

- 運用コストの削減
- セキュリティパッチの一括適用
- 機能改善の全テナント即時適用
- テクニカルデットの蓄積防止

### 2. サービス中心のマインドセット

SaaSは**製品を販売するのではなく、サービスを提供する**ビジネスモデルである。これは：

- 継続的な改善と最適化
- テナントエクスペリエンスの重視
- 運用効率の追求
- スケールに応じたコスト最適化

を意味する。

### 3. 効率性と規模の経済性

マルチテナンシーの最大の価値は、**リソースの共有による効率性**と**スケールによる経済性**である。個別のリソースを使用する場合でも、運用・管理の統一性が保たれる。

### 4. テナントの概念

テナント = **共有インフラの一時的な居住者**。アプリケーションはテナントを認識し、テナントごとにデータと体験を分離するが、インフラは共有される（専用リソースを使う場合も管理は統一される）。

---

## マルチテナントの定義

### テナント ≠ 顧客

- **テナント**: SaaS環境の論理的な利用者単位。組織、チーム、プロジェクト単位など
- **顧客**: 請求対象となるビジネスエンティティ。1顧客が複数テナントを持つことも多い

### マルチテナント = 共有インフラ + 統一運用

マルチテナントの本質は「**全テナントを統一されたプロセスで運用・管理すること**」である。以下はすべてマルチテナントと見なされる：

- 全テナントが単一のデータベースを共有
- 各テナントが専用データベースを持つが、統一された自動化で管理
- ティアによってインフラを使い分けるが、コントロールプレーンは共通

### サイロ vs プール の用語定義

| 用語 | 定義 | 例 |
|------|------|-----|
| **サイロ (Silo)** | テナント専用のリソースを個別に配置 | テナントごとに専用データベース、専用コンピューティングクラスター |
| **プール (Pool)** | 複数テナントでリソースを共有 | 共有データベース（テナントID列で分離）、共有コンテナクラスター |
| **ハイブリッド** | サイロとプールを組み合わせる | コンピューティングは共有、ストレージは専用 |

重要: **サイロモデルでもマルチテナント**である。統一された運用・管理プロセスがあれば、リソースが専用でもマルチテナントSaaSと呼ばれる。

---

## アーキテクチャの二つの柱

### コントロールプレーン

**役割**: 全テナントにまたがる共通サービスを提供する、SaaSの「管理層」

**主要コンポーネント**:

- **オンボーディング**: 新規テナントの登録、初期設定、リソースプロビジョニング
- **アイデンティティ**: テナントユーザーの認証・認可、トークン発行
- **テナント管理**: テナントメタデータ、設定、ティア情報の保管
- **メトリクスと分析**: テナント別の利用状況、パフォーマンス、コスト
- **請求**: 使用量ベースの課金、ティア別料金管理
- **運用コンソール**: テナント管理UI、ダッシュボード、アラート

**特徴**:
- **マルチテナント的な要素はない**（全テナント共通のサービス）
- **初日から必要**（1テナント目から構築すべき）
- SaaSビジネスの成長を支える基盤

### アプリケーションプレーン

**役割**: SaaS製品の機能を具現化し、テナントごとに分離された体験を提供する

**主要要素**:

- **テナント分離**: テナント間のリソースやデータの分離を実現
- **データパーティショニング**: テナントデータの保存戦略（サイロ/プール/ハイブリッド）
- **テナントルーティング**: リクエストを適切なテナントリソースへ振り分け
- **テナントコンテキスト**: すべてのサービスがテナント情報を認識して動作

**特徴**:
- **マルチテナント原則が具現化される場所**
- デプロイモデル（サイロ/プール）の影響を最も受ける
- テナント分離は**デプロイモデルに関係なく必須**

---

## 判断基準テーブル

### デプロイモデル選択

| モデル | 特徴 | 適用場面 | トレードオフ |
|--------|------|---------|------------|
| **フルスタック・サイロ** | テナントごとに専用インフラ全体（コンピューティング、ストレージ、ネットワーク） | 厳格なコンプライアンス要件、規制業界、高分離要件 | コスト高、運用複雑性増加、スケールの非効率性 |
| **フルスタック・プール** | 全テナントでインフラをフル共有 | コスト効率最大化、大量の小規模テナント、スタートアップ | ノイジーネイバーリスク、分離の複雑性、Blast Radius拡大 |
| **ハイブリッド** | コンピューティング共有+ストレージ個別など、部分的な共有 | コストと分離のバランス重視、中規模エンタープライズ | 設計・実装の複雑性中程度 |
| **混合モード (Mixed Model)** | ティア別にサイロ/プールを使い分け | ティアリング戦略、Premiumは専用、Basicは共有 | 設計・運用の複雑性最大、テスト範囲拡大 |
| **ポッド (Pod-based)** | テナントグループごとにリソース集約（地域別、規模別など） | 地域/法規制対応、スケールグループ管理 | 管理対象増加、ポッド間のバランス調整 |

**選択ガイドライン**:
- コンプライアンス要件が厳しい → **フルスタック・サイロ**
- コスト効率最優先、大量テナント → **フルスタック・プール**
- バランス重視、中規模 → **ハイブリッド**
- ティアリング戦略 → **混合モード**
- 地域分散、規模別管理 → **ポッド**

### テナント分離レベル選択

| レベル | 手法 | 適用場面 | 実装方法 |
|--------|------|---------|---------|
| **フルスタック分離** | テナントごとに完全なインフラを分離 | 厳格なコンプライアンス、規制業界 | サイロデプロイモデル |
| **リソースレベル分離** | 個別リソース（DB、キュー、ストレージバケット等）を分離 | 部分的な分離要件、ハイブリッドアプローチ | リソース識別子にテナントIDを含め、リソースポリシーで分離 |
| **アイテムレベル分離** | 共有リソース内でポリシーベース分離（行レベル、オブジェクトレベル） | コスト効率重視、大量テナント | アクセス制御ポリシー、アプリケーション層での分離ロジック |

**選択ガイドライン**:
- 規制要件、監査対応 → **フルスタック分離**
- コストと分離のバランス → **リソースレベル分離**
- スケール最優先、コスト効率 → **アイテムレベル分離**

**重要**: テナント分離は**すべてのデプロイモデルで必須**。プールモデルでも分離メカニズムが必要。

### データパーティショニング選択

| 戦略 | 特徴 | 適用場面 | メリット | デメリット |
|--------|------|---------|---------|---------|
| **サイロ（テナントごとDB）** | 各テナントが専用データベースを持つ | コンプライアンス、高分離要件、大規模テナント | 完全分離、Blast Radius最小、テナント固有の最適化可能 | コスト高、データ集約困難、運用管理対象増加 |
| **プール（共有DB+テナントID列）** | 単一データベースを全テナントで共有、テナントID列で分離 | 大量の小規模テナント、コスト効率重視 | コスト効率、管理容易、クロステナント分析容易 | ノイジーネイバー、分離の複雑性、クエリパフォーマンス |
| **ハイブリッド** | ティア別にサイロ/プールを使い分け | ティアリング戦略 | 柔軟性、コストと分離のバランス | 複雑性増加、データ移行の必要性 |

**選択ガイドライン**:
- コンプライアンス、高分離 → **サイロ**
- 大量テナント、コスト効率 → **プール**
- ティアリング、柔軟性 → **ハイブリッド**

### コンピューティング技術選択

| 技術 | 特徴 | 適用場面 |
|------|------|---------|
| **コンテナ** | サイロ・プール両対応、柔軟性高、状態管理可能 | 複雑なアプリケーション、長時間実行、マイクロサービス |
| **サーバーレス関数** | プールモデルに最適、コスト効率高、自動スケール | イベント駆動、短時間実行、変動的なワークロード |
| **混合** | サービスごとに最適な技術を選択 | 大規模SaaS、複雑な要件 |

---

## ユーザー確認の原則（AskUserQuestion）

マルチテナントSaaS設計には多くの判断分岐が存在する。**不明点や選択肢がある場合、推測で進めず必ずAskUserQuestionツールでユーザーに確認する。**

### 確認すべき場面

以下のトピックでは、ユーザーの要件や制約を確認する必要がある：

1. **デプロイモデルの選択**
   - サイロ/プール/ハイブリッド/混合モード/ポッドのどれを採用するか
   - ティア別に異なるモデルを使うか

2. **テナント分離レベルの決定**
   - フルスタック/リソースレベル/アイテムレベルのどの分離が必要か
   - コンプライアンス要件や業界規制の有無

3. **データパーティショニング戦略**
   - サイロ/プール/ハイブリッドのどれを選ぶか
   - ティア別に異なる戦略を使うか

4. **ティアリングモデルの設計**
   - どのようなティアを用意するか（Basic/Standard/Premium等）
   - ティアごとの機能差分、リソース配分

5. **SaaS移行戦略の選択**
   - Lift-and-Shift / Refactor / Replatform / Strangler Figのどれを採用するか
   - 段階的移行のロードマップ

6. **コンピューティング技術の選定**
   - コンテナ/サーバーレス/混合のどれを使うか
   - マイクロサービス vs モノリス

7. **マルチリージョン/SaaS Anywhereアーキテクチャの採用判断**
   - グローバル展開の必要性
   - データレジデンシー要件

8. **生成AIのマルチテナント統合戦略**
   - テナント固有のモデル調整が必要か
   - コスト配賦モデル

### 確認不要な場面（常に実施すべきベストプラクティス）

以下は、ユーザーに確認せずに実施すべき原則：

- **テナント分離は必須**（デプロイモデルに関係なく）
- **コントロールプレーンの初日からの構築**
- **統一バージョン管理の原則**
- **テナントコンテキストの全サービスへの注入**
- **オンボーディング自動化の実装**

**AskUserQuestion使用例**:

```python
AskUserQuestion(
    questions=[{
        "question": "このSaaSのデプロイモデルを選択してください。コンプライアンス要件やコスト制約を考慮してください。",
        "header": "デプロイモデル選択",
        "options": [
            {
                "label": "フルスタック・サイロ",
                "description": "テナントごとに完全に専用のインフラ。コンプライアンス要件が厳しい場合に推奨。"
            },
            {
                "label": "フルスタック・プール",
                "description": "全テナントでインフラを共有。コスト効率最優先、大量テナント向け。"
            },
            {
                "label": "ハイブリッド",
                "description": "コンピューティング共有+ストレージ専用など、部分的な共有。バランス重視。"
            },
            {
                "label": "混合モード",
                "description": "ティア別にサイロ/プールを使い分け。Premiumは専用、Basicは共有など。"
            }
        ],
        "multiSelect": False
    }]
)
```

---

## サブファイル参照ガイド

| ファイル | 内容 | 参照タイミング |
|---------|------|--------------|
| [FOUNDATIONS.md](FOUNDATIONS.md) | SaaSマインドセット、マルチテナントの定義、コントロール/アプリケーションプレーンの詳細、用語集 | SaaS概念の理解、用語の確認、アーキテクチャ全体像の把握 |
| [DEPLOYMENT-MODELS.md](DEPLOYMENT-MODELS.md) | サイロ/プール/ハイブリッド/混合モード/ポッドの詳細、選択基準、実装パターン | デプロイ戦略の設計、モデル選択の判断 |
| [ONBOARDING-AND-IDENTITY.md](ONBOARDING-AND-IDENTITY.md) | オンボーディングフロー、アイデンティティモデル、テナント管理サービス、ベースライン環境 | テナント導入フローの設計、認証・認可の実装 |
| [SERVICE-DESIGN.md](SERVICE-DESIGN.md) | マルチテナントサービス設計パターン、テナントコンテキストの注入、API設計 | アプリケーション層の設計、マイクロサービスアーキテクチャ |
| [DATA-PARTITIONING.md](DATA-PARTITIONING.md) | サイロ/プール/ハイブリッドのデータパーティショニング詳細、NoSQL/RDB戦略 | ストレージ設計、データベース選択 |
| [TENANT-ISOLATION.md](TENANT-ISOLATION.md) | テナント分離の戦略、実装メカニズム、ポリシーベース分離 | セキュリティ設計、分離要件の実装 |
| [COMPUTE-PATTERNS.md](COMPUTE-PATTERNS.md) | コンテナSaaS、サーバーレスSaaSの実装パターン、選択基準 | コンピューティング技術の選定、スケーリング戦略 |
| [OPERATIONS-AND-STRATEGY.md](OPERATIONS-AND-STRATEGY.md) | 運用モデル、SaaS移行戦略、ティアリング、生成AI統合、マルチリージョン | 運用設計、移行計画、戦略策定 |

**参照の流れ**:
1. **FOUNDATIONS.md** で概念と用語を理解
2. **DEPLOYMENT-MODELS.md** でアーキテクチャの全体像を決定
3. **ONBOARDING-AND-IDENTITY.md** でコントロールプレーンを設計
4. **SERVICE-DESIGN.md** でアプリケーション層を設計
5. **DATA-PARTITIONING.md** と **TENANT-ISOLATION.md** でストレージとセキュリティを実装
6. **COMPUTE-PATTERNS.md** でコンピューティング技術を選定
7. **OPERATIONS-AND-STRATEGY.md** で運用と戦略を策定

---

## 実装チェックリスト

### Phase 1: 基盤構築

**コントロールプレーン**:
- [ ] コントロールプレーンの設計と構築（オンボーディング、アイデンティティ、テナント管理、メトリクス）
- [ ] オンボーディングフローの実装（自動プロビジョニング、初期設定）
- [ ] アイデンティティモデルの確立（認証・認可、トークン発行、テナントコンテキスト注入）
- [ ] テナント管理サービスの構築（メタデータ管理、ティア情報、設定）
- [ ] ベースライン環境の自動構築（Infrastructure as Code）

**アーキテクチャの意思決定**:
- [ ] デプロイモデルの選択（サイロ/プール/ハイブリッド/混合/ポッド）
- [ ] テナント分離レベルの決定（フルスタック/リソースレベル/アイテムレベル）
- [ ] データパーティショニング戦略の決定（サイロ/プール/ハイブリッド）

### Phase 2: アプリケーション層

**サービス設計**:
- [ ] テナントコンテキストの注入メカニズム（全サービスがテナントを認識）
- [ ] マルチテナントサービスの設計（サイロ/プール対応）
- [ ] データパーティショニング戦略の実装（DB選定、スキーマ設計）
- [ ] テナント分離ポリシーの適用（アクセス制御、ポリシーベース分離）

**コンピューティング**:
- [ ] コンピューティング技術の選定（コンテナ/サーバーレス/混合）
- [ ] テナントルーティングの実装
- [ ] スケーリング戦略の実装（テナント別/全体）

### Phase 3: 運用と最適化

**メトリクスと可視化**:
- [ ] テナント別メトリクスの計装（コスト、パフォーマンス、利用状況）
- [ ] 運用コンソールの構築（ダッシュボード、アラート、ログ集約）
- [ ] コスト配賦モデルの構築（テナント別コスト追跡）

**ティアリングと最適化**:
- [ ] ティアリング戦略の実装（機能差分、リソース制限）
- [ ] デプロイ自動化の確立（CI/CD、ブルー/グリーンデプロイ）
- [ ] パフォーマンス最適化（ノイジーネイバー対策、スロットリング）

**セキュリティとコンプライアンス**:
- [ ] セキュリティポリシーの適用（テナント分離、データ暗号化）
- [ ] コンプライアンス要件の実装（監査ログ、データレジデンシー）
- [ ] インシデント対応計画（Blast Radius最小化、復旧手順）

---

## まとめ

マルチテナントSaaSアーキテクチャの成功には、以下の要素が不可欠：

1. **SaaSマインドセットの確立**: 技術ファーストではなく、ビジネスモデルとしてのSaaSを理解する
2. **コントロールプレーンの初日からの構築**: テナント管理、オンボーディング、メトリクスは最初から必要
3. **適切なデプロイモデルの選択**: コンプライアンス、コスト、スケール要件に基づいて判断
4. **テナント分離の徹底**: すべてのデプロイモデルで分離メカニズムが必須
5. **統一された運用**: 全テナントを統一されたプロセスで管理し、規模の経済性を実現

詳細な実装ガイドは、各サブファイルを参照すること。不明点がある場合は、AskUserQuestionツールでユーザーに確認すること。
