# ワークフローパターン集

> スキル設計で使える高度なワークフローパターン。基本パターン（Template Pattern、Examples Pattern、Conditional Workflow Pattern）はSKILL.mdを参照。

## 目次

1. [Sequential Workflow Orchestration（順次ワークフロー）](#1-sequential-workflow-orchestration順次ワークフロー)
2. [Multi-MCP Coordination（複数MCP連携）](#2-multi-mcp-coordination複数mcp連携)
3. [Iterative Refinement（反復改善）](#3-iterative-refinement反復改善)
4. [Context-Aware Tool Selection（コンテキスト依存ツール選択）](#4-context-aware-tool-selectionコンテキスト依存ツール選択)
5. [Domain-Specific Intelligence（ドメイン知識埋め込み）](#5-domain-specific-intelligenceドメイン知識埋め込み)
6. [Skills + MCP連携](#skills--mcp連携)

---

## 1. Sequential Workflow Orchestration（順次ワークフロー）

### 使用場面

ユーザーが特定の順序で実行する必要がある複数ステップのプロセスを必要とする場合。

### 構造例

```markdown
# Workflow: 新規顧客オンボーディング

## Step 1: アカウント作成

MCPツールを呼び出す: `create_customer`
パラメータ: name, email, company

## Step 2: 支払い設定

MCPツールを呼び出す: `setup_payment_method`
待機条件: 支払い方法の検証完了

## Step 3: サブスクリプション作成

MCPツールを呼び出す: `create_subscription`
パラメータ: plan_id, customer_id（Step 1から取得）

## Step 4: ウェルカムメール送信

MCPツールを呼び出す: `send_email`
テンプレート: welcome_email_template
```

### キーテクニック

- **明示的なステップ順序**: 各ステップを番号付けし、依存関係を明確にする
- **ステップ間の依存関係**: 前のステップの出力を次のステップの入力として使用
- **各段階での検証**: ステップ完了時に結果を検証
- **失敗時のロールバック指示**: エラー発生時の巻き戻し手順を含める

---

## 2. Multi-MCP Coordination（複数MCP連携）

### 使用場面

ワークフローが複数のサービスにまたがる場合。

### 構造例

```markdown
# デザインから開発へのハンドオフ

## Phase 1: デザインエクスポート（Figma MCP）

1. Figmaからデザインアセットをエクスポート
2. デザイン仕様書を生成
3. アセットマニフェストを作成

## Phase 2: アセット保存（Drive MCP）

1. Driveにプロジェクトフォルダを作成
2. すべてのアセットをアップロード
3. 共有可能なリンクを生成

## Phase 3: タスク作成（Linear MCP）

1. 開発タスクを作成
2. アセットリンクをタスクに添付
3. エンジニアリングチームに割り当て

## Phase 4: 通知（Slack MCP）

1. #engineering チャンネルにハンドオフサマリーを投稿
2. アセットリンクとタスクリファレンスを含める
```

### キーテクニック

- **明確なフェーズ分離**: 各MCPの責任範囲を分ける
- **MCP間のデータ受け渡し**: あるMCPの出力を次のMCPへの入力として使用
- **次フェーズ移行前の検証**: 各フェーズ完了時にデータ整合性を確認
- **集中的エラーハンドリング**: フェーズ間でのエラー処理を統一

---

## 3. Iterative Refinement（反復改善）

### 使用場面

出力品質が反復によって向上する場合。

### 構造例

```markdown
# 反復的レポート作成

## 初回ドラフト

1. MCP経由でデータを取得
2. 最初のレポートドラフトを生成
3. 一時ファイルに保存

## 品質チェック

1. 検証スクリプトを実行: `scripts/check_report.py`
2. 問題を特定:
   - 欠落セクション
   - フォーマット不整合
   - データ検証エラー

## 改善ループ

1. 特定された各問題に対処
2. 影響を受けたセクションを再生成
3. 再検証
4. 品質基準を満たすまで繰り返し

## 最終化

1. 最終フォーマットを適用
2. サマリーを生成
3. 最終版を保存
```

### キーテクニック

- **明示的な品質基準**: 合格条件を明確に定義
- **反復的改善**: フィードバックループを組み込む
- **検証スクリプト**: プログラマティックな品質チェックを活用
- **反復停止条件**: いつ停止するかの基準を設定

---

## 4. Context-Aware Tool Selection（コンテキスト依存ツール選択）

### 使用場面

同じ結果でも、コンテキストによって異なるツールを使い分ける場合。

### 構造例

```markdown
# スマートファイルストレージ

## 判断木

1. ファイルタイプとサイズを確認
2. 最適なストレージ場所を決定:
   - 大容量ファイル（>10MB）: クラウドストレージMCPを使用
   - 協業ドキュメント: Notion/Docs MCPを使用
   - コードファイル: GitHub MCPを使用
   - 一時ファイル: ローカルストレージを使用

## ストレージ実行

判断に基づいて:
- 適切なMCPツールを呼び出す
- サービス固有のメタデータを適用
- アクセスリンクを生成

## ユーザーへのコンテキスト提供

そのストレージが選択された理由を説明
```

### キーテクニック

- **明確な判断基準**: 選択肢のトリガー条件を明示
- **フォールバックオプション**: 第一選択が失敗した場合の代替手段
- **選択の透明性**: なぜそのツールが選ばれたかを説明
- **コンテキスト変数の活用**: ファイルサイズ、タイプ、ユーザー設定等で判断

---

## 5. Domain-Specific Intelligence（ドメイン知識埋め込み）

### 使用場面

スキルがツールアクセス以上の専門知識を追加する場合。

### 構造例

```markdown
# コンプライアンス準拠決済処理

## 処理前（コンプライアンスチェック）

1. MCP経由でトランザクション詳細を取得
2. コンプライアンスルールを適用:
   - 制裁リストを確認
   - 管轄区域の許可を検証
   - リスクレベルを評価
3. コンプライアンス判断を記録

## 処理

コンプライアンス合格の場合:
- 決済処理MCPツールを呼び出す
- 適切な不正検知チェックを適用
- トランザクションを処理

コンプライアンス不合格の場合:
- レビュー用にフラグを立てる
- コンプライアンスケースを作成

## 監査証跡

- すべてのコンプライアンスチェックをログ記録
- 処理決定を記録
- 監査レポートを生成
```

### キーテクニック

- **ドメイン専門知識の埋め込み**: ビジネスロジックとルールを組み込む
- **アクション前のコンプライアンス**: 実行前に検証
- **包括的ドキュメンテーション**: すべての決定を記録
- **明確なガバナンス**: 責任範囲とエスカレーション経路を定義

---

## Skills + MCP連携

### MCPとスキルの役割分担

スキルとMCPは相互補完的な関係にあります。

| MCP（接続性） | Skills（知識） |
|-------------|--------------|
| Claudeをあなたのサービス（Notion、Asana、Linear等）に接続する | Claudeにそのサービスを効果的に使う方法を教える |
| リアルタイムデータアクセスとツール呼び出しを提供 | ワークフローとベストプラクティスを提供 |
| Claudeが**何ができるか** | Claudeが**どのようにすべきか** |

### キッチンの例え

- **MCP**: プロのキッチン設備（ツール、食材、機器へのアクセス）
- **Skills**: レシピ（価値あるものを作るための段階的指示）

両者が組み合わさることで、ユーザーはすべてのステップを自分で考え出す必要なく、複雑なタスクを達成できます。

### 連携によるメリット

**スキルなしの場合:**
- ユーザーはMCPを接続したが、次に何をすべきか分からない
- 「統合を使ってXをする方法は？」というサポート問い合わせ
- 会話ごとにゼロから開始
- ユーザーのプロンプトが異なるため結果が不安定
- 実際はワークフローガイダンスの問題なのに、ユーザーはコネクタを責める

**スキル併用の場合:**
- 事前構築されたワークフローが必要時に自動的に起動
- 一貫性のある信頼できるツール使用
- すべてのインタラクションにベストプラクティスが組み込まれる
- 統合の学習曲線が低下

### 連携時の設計パターン

#### アプローチ選択: 問題優先 vs ツール優先

**問題優先アプローチ:**
- 例: 「プロジェクトワークスペースを設定する必要がある」
- スキルが適切なMCP呼び出しを正しい順序でオーケストレーション
- ユーザーは結果を説明し、スキルがツールを処理

**ツール優先アプローチ:**
- 例: 「Notion MCPが接続されている」
- スキルがClaudeに最適なワークフローとベストプラクティスを教える
- ユーザーはアクセスを持ち、スキルが専門知識を提供

ほとんどのスキルはどちらか一方に傾きます。あなたのユースケースに合うフレーミングを知ることで、適切なパターンを選択できます。

#### MCP統合強化スキルの構造例

```markdown
---
name: your-service-workflow
description: WorkServiceのプロジェクト管理ワークフロー。スプリント計画、タスク作成、ステータス追跡を含む。"スプリント"、"タスク作成"、"プロジェクト計画"などで使用。
metadata:
  mcp-server: workservice
---

# WorkService Workflow Skill

## 前提条件チェック

WorkService MCPサーバーが接続されていることを確認:
- Settings > Extensions > WorkService
- "Connected"ステータスであることを確認

## ワークフロー定義

（MCP呼び出しを含む段階的指示）

## エラーハンドリング

MCP接続失敗時:
1. ユーザーに接続確認を依頼
2. 認証トークンの有効性を確認
3. 再接続手順を提供
```

### 連携のベストプラクティス

1. **MCPドキュメントに言及**: スキルにMCPサーバー名を記載（`metadata.mcp-server`）
2. **前提条件を明示**: 必要なMCP接続を明確にする
3. **エラーハンドリング**: MCP接続失敗時の対処を含める
4. **ツール名を正確に**: MCPツール名は大文字小文字を区別
5. **段階的検証**: MCP呼び出し前後で状態を確認

---

## パターンの組み合わせ

実際のスキルでは、これらのパターンを組み合わせることが一般的です。

**例: 複雑なプロジェクトセットアップスキル**
- Sequential Workflow（全体構造）
- Multi-MCP Coordination（Notion + Linear + Slack）
- Context-Aware Tool Selection（プロジェクトタイプによる判断）
- Domain-Specific Intelligence（プロジェクト管理のベストプラクティス）

パターンは処方箋ではなく、早期採用者や内部チームが作成したスキルから得られた共通アプローチです。あなたのユースケースに最適なパターンを選択・組み合わせてください。
