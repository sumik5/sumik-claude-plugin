# åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«ãŠã‘ã‚‹åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ](#ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ)
- [XA/2ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒŸãƒƒãƒˆ](#XA2ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒŸãƒƒãƒˆ)
- [Sagaãƒ‘ã‚¿ãƒ¼ãƒ³](#Sagaãƒ‘ã‚¿ãƒ¼ãƒ³)
- [BASEãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³](#BASEãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³)
- [å†ªç­‰æ€§è¨­è¨ˆ](#å†ªç­‰æ€§è¨­è¨ˆ)
- [é‡è¤‡ãƒ»é †åºå¤–ã‚Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å‡¦](#é‡è¤‡é †åºå¤–ã‚Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å‡¦)
- [ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œæœ€é©åŒ–](#ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œæœ€é©åŒ–)

---

## ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ

### å…¨ä½“æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | ACIDä¿è¨¼ | æ€§èƒ½ | è¤‡é›‘æ€§ | å¯ç”¨æ€§ | é©ç”¨å ´é¢ |
|---------|---------|-----|-------|-------|---------|
| **ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³** | âœ… å®Œå…¨ | â­â­â­â­â­ é«˜é€Ÿ | â­ ç°¡å˜ | â­â­â­ ä¸­ | å˜ä¸€ã‚µãƒ¼ãƒ“ã‚¹å†… |
| **ã‚°ãƒ­ãƒ¼ãƒãƒ«XA/2PC** | âœ… å®Œå…¨ | â­ é…ã„ | â­â­â­â­ è¤‡é›‘ | â­ ä½ | é‡‘èå–å¼•ã€æ±ºæ¸ˆ |
| **Saga (Orchestration)** | âŒ çµæœæ•´åˆæ€§ | â­â­â­ ä¸­é€Ÿ | â­â­â­ ä¸­è¤‡é›‘ | â­â­â­â­ é«˜ | è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ã‚»ã‚¹ |
| **Saga (Choreography)** | âŒ çµæœæ•´åˆæ€§ | â­â­â­â­ é€Ÿã„ | â­â­â­â­ è¤‡é›‘ | â­â­â­â­â­ æœ€é«˜ | ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã€ç–çµåˆ |
| **BASE (çµæœæ•´åˆæ€§)** | âŒ æœ€çµ‚çš„ã®ã¿ | â­â­â­â­â­ æœ€é€Ÿ | â­â­ æ¯”è¼ƒçš„ç°¡å˜ | â­â­â­â­â­ æœ€é«˜ | SNSæŠ•ç¨¿ã€ãƒ­ã‚°é›†ç´„ |

### ACID vs BASE

| é …ç›® | ACID | BASE |
|-----|------|------|
| **ç•¥ç§°** | Atomicity, Consistency, Isolation, Durability | Basically Available, Soft state, Eventually consistent |
| **ä¸€è²«æ€§** | å¼·æ•´åˆæ€§ (å³åº§ã«ä¸€è²«) | çµæœæ•´åˆæ€§ (æœ€çµ‚çš„ã«ä¸€è²«) |
| **å¯ç”¨æ€§** | ä½ (ãƒ­ãƒƒã‚¯å¾…ã¡ã€èª¿æ•´æ™‚é–“) | é«˜ (å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹) |
| **æ€§èƒ½** | é…ã„ (2PCèª¿æ•´) | é€Ÿã„ (ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†) |
| **é©ç”¨å ´é¢** | éŠ€è¡Œé€é‡‘ã€åœ¨åº«å¼•å½“ | SNSã„ã„ã­æ•°ã€é–²è¦§æ•°ã‚«ã‚¦ãƒ³ãƒˆ |

---

## XA/2ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒŸãƒƒãƒˆ

### 2ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒŸãƒƒãƒˆã®ä»•çµ„ã¿

#### Phase 1: æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º (Prepare)

```
[Coordinator (Transaction Manager)]
    â†“
    â”œâ”€â†’ [Participant 1: DB Service] "æº–å‚™å®Œäº†ï¼Ÿ"
    â”œâ”€â†’ [Participant 2: Queue Service] "æº–å‚™å®Œäº†ï¼Ÿ"
    â””â”€â†’ [Participant 3: Cache Service] "æº–å‚™å®Œäº†ï¼Ÿ"

    â†“ (å…¨å“¡ãŒ "OK" ã‚’è¿”ç­”)

å…¨ParticipantãŒæº–å‚™å®Œäº† â†’ Phase 2ã¸
1ã¤ã§ã‚‚ "NG" â†’ å…¨ä½“Abort
```

#### Phase 2: ã‚³ãƒŸãƒƒãƒˆãƒ•ã‚§ãƒ¼ã‚º (Commit/Abort)

```
[Coordinator]
    â†“
    â”œâ”€â†’ [Participant 1] "Commitå®Ÿè¡Œ"
    â”œâ”€â†’ [Participant 2] "Commitå®Ÿè¡Œ"
    â””â”€â†’ [Participant 3] "Commitå®Ÿè¡Œ"

    â†“
å…¨ParticipantãŒã‚³ãƒŸãƒƒãƒˆå®Œäº† â†’ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æˆåŠŸ
```

### 2PCã®å•é¡Œç‚¹

| å•é¡Œ | èª¬æ˜ | å½±éŸ¿ |
|-----|------|------|
| **ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°** | Phase 1ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ­ãƒƒã‚¯ã€Phase 2å®Œäº†ã¾ã§å æœ‰ | ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆä½ä¸‹ |
| **å˜ä¸€éšœå®³ç‚¹ (SPOF)** | Coordinatoréšœå®³ã§å…¨ä½“åœæ­¢ | å¯ç”¨æ€§ä½ä¸‹ |
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶** | å…¨Participantã¨ã®é€šä¿¡å¾…ã¡ | ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å¢—åŠ  |
| **å®Œå…¨æ€§ã®éä¿è¨¼** | Phase 2ã§Participantéšœå®³æ™‚ã€æ‰‹å‹•ä»‹å…¥å¿…è¦ | é‹ç”¨è² è· |

### XA/2PCé©ç”¨åŸºæº–

| åˆ¤æ–­è»¸ | XA/2PCæ¡ç”¨ | XA/2PCä¸æ¡ç”¨ |
|-------|-----------|------------|
| **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¦ä»¶** | ACIDå¿…é ˆ (é‡‘èã€æ±ºæ¸ˆ) | çµæœæ•´åˆæ€§è¨±å®¹ |
| **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ** | ä½é »åº¦ (<100 TPS) | é«˜é »åº¦ (>1000 TPS) |
| **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·è¦æ±‚** | ç§’å˜ä½è¨±å®¹ | ãƒŸãƒªç§’å˜ä½å¿…é ˆ |
| **ã‚µãƒ¼ãƒ“ã‚¹æ•°** | 2ã€œ3ã‚µãƒ¼ãƒ“ã‚¹ | 5ã‚µãƒ¼ãƒ“ã‚¹ä»¥ä¸Š |
| **é‹ç”¨ä½“åˆ¶** | æ‰‹å‹•ä»‹å…¥å¯èƒ½ | è‡ªå‹•å¾©æ—§å¿…é ˆ |

### æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ä¾‹

```
// Coordinator
function executeGlobalTransaction():
    participants = [DB, Queue, Cache]

    // Phase 1: Prepare
    prepareResults = []
    for participant in participants:
        result = participant.prepare()
        prepareResults.append(result)

    if all(prepareResults == "OK"):
        // Phase 2: Commit
        for participant in participants:
            participant.commit()
        return "SUCCESS"
    else:
        // Phase 2: Abort
        for participant in participants:
            participant.rollback()
        return "ABORTED"

// Participant (ä¾‹: Database)
class DatabaseParticipant:
    function prepare():
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
        transaction = database.beginTransaction()
        try:
            // æ›¸ãè¾¼ã¿å‡¦ç† (å®Ÿè¡Œã¯ã™ã‚‹ãŒã‚³ãƒŸãƒƒãƒˆã—ãªã„)
            database.executeSQL("UPDATE ...")
            database.prepareCommit()  // ãƒ­ã‚°ã«è¨˜éŒ²
            return "OK"
        catch error:
            transaction.rollback()
            return "NG"

    function commit():
        database.commitTransaction()

    function rollback():
        database.rollbackTransaction()
```

---

## Sagaãƒ‘ã‚¿ãƒ¼ãƒ³

### Sagaæ¦‚è¦

**å®šç¾©**: åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«åˆ†è§£ã—ã€å¤±æ•—æ™‚ã¯**è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ (Compensating Transaction)** ã§å·»ãæˆ»ã™ã€‚

### Orchestrationå‹ vs Choreographyå‹

#### Orchestrationå‹ (ä¸­å¤®åˆ¶å¾¡)

```
[Saga Orchestrator (ä¸­å¤®åˆ¶å¾¡)]
    â†“
    1. CreateOrderCommand â†’ [Order Service]
    â†“ (æˆåŠŸ)
    2. ReserveInventoryCommand â†’ [Inventory Service]
    â†“ (å¤±æ•—!)
    3. CancelOrderCommand â†’ [Order Service] (è£œå„Ÿ)
```

**ç‰¹å¾´:**

- ä¸­å¤®ã®OrchestratorãŒãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
- å¯è¦–æ€§é«˜ã€ãƒ‡ãƒãƒƒã‚°å®¹æ˜“
- OrchestratorãŒå˜ä¸€éšœå®³ç‚¹ (SPOF)

#### Choreographyå‹ (ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•)

```
[Order Service]
    â†“ OrderCreatedEvent
[Inventory Service] â†’ InventoryReservedEvent
    â†“ (å¤±æ•—!)
    â†“ InventoryReservationFailedEvent
[Order Service] â†’ OrderCancelledEvent (è£œå„Ÿ)
```

**ç‰¹å¾´:**

- ã‚µãƒ¼ãƒ“ã‚¹é–“ãŒã‚¤ãƒ™ãƒ³ãƒˆã§é€£æº
- ç–çµåˆã€SPOFãªã—
- ãƒ‡ãƒãƒƒã‚°å›°é›£ã€ãƒ•ãƒ­ãƒ¼è¿½è·¡ãŒè¤‡é›‘

### Sagaæ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ«

| é …ç›® | Orchestration | Choreography |
|-----|--------------|--------------|
| **åˆ¶å¾¡æ–¹å¼** | ä¸­å¤®åˆ¶å¾¡ | åˆ†æ•£åˆ¶å¾¡ |
| **å¯è¦–æ€§** | â­â­â­â­â­ é«˜ | â­â­ ä½ |
| **ç–çµåˆ** | â­â­ ä½ | â­â­â­â­â­ é«˜ |
| **SPOF** | âœ… ã‚ã‚Š (Orchestrator) | âŒ ãªã— |
| **ãƒ‡ãƒãƒƒã‚°** | å®¹æ˜“ | å›°é›£ (åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°å¿…é ˆ) |
| **é©ç”¨å ´é¢** | è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ã‚»ã‚¹ | ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ |

---

### Saga 8ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒˆãƒªã‚¯ã‚¹

åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®**é€šä¿¡ï¼ˆåŒæœŸ/éåŒæœŸï¼‰**ã€**æ•´åˆæ€§ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯/çµæœï¼‰**ã€**èª¿æ•´ï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³/ã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£ï¼‰**ã®3æ¬¡å…ƒã‹ã‚‰ã€8ã¤ã®Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå°å‡ºã•ã‚Œã¾ã™ã€‚

#### 3æ¬¡å…ƒãƒãƒˆãƒªã‚¯ã‚¹

```
           æ•´åˆæ€§
            â†‘
   ã‚¢ãƒˆãƒŸãƒƒã‚¯â”‚  çµæœæ•´åˆæ€§
            â”‚
    â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â†’ é€šä¿¡
    åŒæœŸ    â”‚    éåŒæœŸ
            â”‚
            â†“
          èª¿æ•´
    (ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³/
     ã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£)
```

#### 8ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è¦§è¡¨

| # | ãƒ‘ã‚¿ãƒ¼ãƒ³å | é€šä¿¡ | æ•´åˆæ€§ | èª¿æ•´ | çµåˆåº¦ | è¤‡é›‘ã• | å¿œç­”æ€§ | ã‚¹ã‚±ãƒ¼ãƒ« | é©ç”¨å ´é¢ |
|---|-----------|------|-------|------|-------|-------|-------|---------|---------|
| 1 | **ã‚¨ãƒ”ãƒƒã‚¯ã‚µãƒ¼ã‚¬ (sao)** | åŒæœŸ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ | ã‚ªãƒ¼ã‚± | é«˜ | ä¸­ | ä½ | ä½ | å˜ç´”ãƒ»ä¿¡é ¼æ€§é‡è¦– |
| 2 | **ãŠã¨ãè©±ã‚µãƒ¼ã‚¬ (seo)** | åŒæœŸ | çµæœ | ã‚ªãƒ¼ã‚± | ä¸­ | ä¸­ | ä¸­ | ä¸­ | æ¨™æº–çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ |
| 3 | **ä¼è¨€ã‚²ãƒ¼ãƒ ã‚µãƒ¼ã‚¬ (sac)** | åŒæœŸ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ | ã‚³ãƒ¬ã‚ª | ä¸­é«˜ | é«˜ | ä½ | ä¸­ | åŒæœŸå¿…é ˆãƒ»åˆ†æ•£åˆ¶å¾¡ |
| 4 | **å°èª¬ã‚µãƒ¼ã‚¬ (sec)** | åŒæœŸ | çµæœ | ã‚³ãƒ¬ã‚ª | ä¸­ | é«˜ | ä¸­ | é«˜ | åŒæœŸï¼‹ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹• |
| 5 | **ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚µãƒ¼ã‚¬ (aao)** | éåŒæœŸ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ | ã‚ªãƒ¼ã‚± | ä½ä¸­ | ä¸­é«˜ | ä¸­ | ä¸­é«˜ | éåŒæœŸãƒ»è£œå„Ÿå¿…è¦ |
| 6 | **ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚µãƒ¼ã‚¬ (aeo)** | éåŒæœŸ | çµæœ | ã‚ªãƒ¼ã‚± | ä½ | ä½ | é«˜ | é«˜ | éåŒæœŸãƒ»ã‚ªãƒ¼ã‚±ç¶­æŒ |
| 7 | **ãƒ›ãƒ©ãƒ¼ã‚µãƒ¼ã‚¬ (aac)** | éåŒæœŸ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ | ã‚³ãƒ¬ã‚ª | ä¸­ | æœ€é«˜ | ä¸­ | ä¸­ | è¤‡é›‘ãƒ»é«˜ä¿¡é ¼æ€§ |
| 8 | **ã‚¢ãƒ³ã‚½ãƒ­ã‚¸ãƒ¼ã‚µãƒ¼ã‚¬ (aec)** | éåŒæœŸ | çµæœ | ã‚³ãƒ¬ã‚ª | æœ€ä½ | é«˜ | æœ€é«˜ | æœ€é«˜ | é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ |

**å‡¡ä¾‹**:
- **é€šä¿¡**: åŒæœŸ=ã‚µãƒ¼ãƒ“ã‚¹é–“ã§å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¾…ã¡ã€éåŒæœŸ=ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼çµŒç”±
- **æ•´åˆæ€§**: ã‚¢ãƒˆãƒŸãƒƒã‚¯=å…¨æˆåŠŸ/å…¨å¤±æ•—ã€çµæœ=æœ€çµ‚çš„ã«ä¸€è²«
- **èª¿æ•´**: ã‚ªãƒ¼ã‚±=ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ä¸­å¤®åˆ¶å¾¡ã€ã‚³ãƒ¬ã‚ª=ã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£åˆ†æ•£åˆ¶å¾¡

---

#### å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å¾´

**1. ã‚¨ãƒ”ãƒƒã‚¯ã‚µãƒ¼ã‚¬ (sao) - Epic Saga (Synchronous-Atomic-Orchestration)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | åŒæœŸ |
| æ•´åˆæ€§ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ |
| èª¿æ•´ | ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| çµåˆåº¦ | é«˜ã„ |
| è¤‡é›‘ã• | ä¸­ç¨‹åº¦ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | ä½ã„ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | ä½ã„ |

- **é©ç”¨**: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€ACIDä¿è¨¼å¿…é ˆ
- **å•é¡Œ**: è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤±æ•—ãƒªã‚¹ã‚¯ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å¢—åŠ 
- **ä¾‹**: é‡‘èå–å¼•ï¼ˆæ±ºæ¸ˆ â†’ é€é‡‘ â†’ é€šçŸ¥ï¼‰

**2. ãŠã¨ãè©±ã‚µãƒ¼ã‚¬ (seo) - Fairy Tale Saga (Synchronous-Eventual-Orchestration)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | åŒæœŸ |
| æ•´åˆæ€§ | çµæœ |
| èª¿æ•´ | ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| çµåˆåº¦ | ä¸­ç¨‹åº¦ |
| è¤‡é›‘ã• | ä¸­ç¨‹åº¦ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | ä¸­ç¨‹åº¦ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | ä¸­ç¨‹åº¦ |

- **é©ç”¨**: æ¨™æº–çš„ãªãƒ“ã‚¸ãƒã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
- **ç‰¹å¾´**: çŠ¶æ…‹ç®¡ç†ã§çµæœæ•´åˆæ€§ã€è£œå„Ÿä¸è¦
- **ä¾‹**: ãƒã‚±ãƒƒãƒˆå®Œäº†ï¼ˆã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé€ä¿¡å¤±æ•—æ™‚ã€NO_SURVEYçŠ¶æ…‹ã§å¾Œã§ãƒªãƒˆãƒ©ã‚¤ï¼‰

**3. ä¼è¨€ã‚²ãƒ¼ãƒ ã‚µãƒ¼ã‚¬ (sac) - Time Saga (Synchronous-Atomic-Choreography)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | åŒæœŸ |
| æ•´åˆæ€§ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ |
| èª¿æ•´ | ã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£ |
| çµåˆåº¦ | ä¸­ã€œé«˜ |
| è¤‡é›‘ã• | é«˜ã„ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | ä½ã„ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | ä¸­ç¨‹åº¦ |

- **é©ç”¨**: åŒæœŸå¿…é ˆã ãŒã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼é¿ã‘ãŸã„
- **å•é¡Œ**: ã‚¹ã‚¿ãƒ³ãƒ—çµåˆã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹ä¼æ’­å¿…è¦
- **ä¾‹**: ãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—æ‰¿èªãƒ•ãƒ­ãƒ¼

**4. å°èª¬ã‚µãƒ¼ã‚¬ (sec) - Fantasy Saga (Synchronous-Eventual-Choreography)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | åŒæœŸ |
| æ•´åˆæ€§ | çµæœ |
| èª¿æ•´ | ã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£ |
| çµåˆåº¦ | ä¸­ç¨‹åº¦ |
| è¤‡é›‘ã• | é«˜ã„ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | ä¸­ç¨‹åº¦ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | é«˜ã„ |

- **é©ç”¨**: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã ãŒåŒæœŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å¿…è¦
- **ä¾‹**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ç¢ºèª â†’ éåŒæœŸè£œæ­£

**5. ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚µãƒ¼ã‚¬ (aao) - Parallel Saga (Asynchronous-Atomic-Orchestration)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | éåŒæœŸ |
| æ•´åˆæ€§ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ |
| èª¿æ•´ | ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| çµåˆåº¦ | ä½ã€œä¸­ |
| è¤‡é›‘ã• | ä¸­ã€œé«˜ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | ä¸­ç¨‹åº¦ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | ä¸­ã€œé«˜ |

- **é©ç”¨**: éåŒæœŸã ãŒã‚¢ãƒˆãƒŸãƒƒã‚¯ä¿è¨¼å¿…è¦
- **ç‰¹å¾´**: è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’éåŒæœŸå®Ÿè¡Œ
- **ä¾‹**: ãƒãƒƒãƒå‡¦ç†ã§ã®è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°

**6. ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚µãƒ¼ã‚¬ (aeo) - Fantasy Saga (Asynchronous-Eventual-Orchestration)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | éåŒæœŸ |
| æ•´åˆæ€§ | çµæœ |
| èª¿æ•´ | ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| çµåˆåº¦ | ä½ã„ |
| è¤‡é›‘ã• | ä½ã„ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | é«˜ã„ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | é«˜ã„ |

- **é©ç”¨**: éåŒæœŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å¯è¦–æ€§ç¶­æŒã—ãŸã„ï¼ˆæ¨å¥¨ï¼‰
- **ç‰¹å¾´**: ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ç¶­æŒã€çµæœæ•´åˆæ€§è¨±å®¹
- **ä¾‹**: æ³¨æ–‡å‡¦ç†ï¼ˆéåŒæœŸã§åœ¨åº«ãƒ»æ±ºæ¸ˆãƒ»é…é€èª¿æ•´ï¼‰

**7. ãƒ›ãƒ©ãƒ¼ã‚µãƒ¼ã‚¬ (aac) - Horror Saga (Asynchronous-Atomic-Choreography)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | éåŒæœŸ |
| æ•´åˆæ€§ | ã‚¢ãƒˆãƒŸãƒƒã‚¯ |
| èª¿æ•´ | ã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£ |
| çµåˆåº¦ | ä¸­ç¨‹åº¦ |
| è¤‡é›‘ã• | æœ€é«˜ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | ä¸­ç¨‹åº¦ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | ä¸­ç¨‹åº¦ |

- **é©ç”¨**: è¤‡é›‘ãªåˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€é«˜ä¿¡é ¼æ€§
- **å•é¡Œ**: æœ€ã‚‚è¤‡é›‘ã€ãƒ‡ãƒãƒƒã‚°å›°é›£
- **ä¾‹**: åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

**8. ã‚¢ãƒ³ã‚½ãƒ­ã‚¸ãƒ¼ã‚µãƒ¼ã‚¬ (aec) - Anthology Saga (Asynchronous-Eventual-Choreography)**

| è©•ä¾¡é …ç›® | ã‚¹ã‚³ã‚¢ |
|---------|-------|
| é€šä¿¡ | éåŒæœŸ |
| æ•´åˆæ€§ | çµæœ |
| èª¿æ•´ | ã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£ |
| çµåˆåº¦ | æœ€ã‚‚ä½ã„ |
| è¤‡é›‘ã• | é«˜ã„ |
| å¿œç­”æ€§/å¯ç”¨æ€§ | æœ€é«˜ |
| ã‚¹ã‚±ãƒ¼ãƒ«/å¼¾åŠ›æ€§ | æœ€é«˜ |

- **é©ç”¨**: é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ï¼ˆæ¨å¥¨ï¼‰
- **ç‰¹å¾´**: æœ€ã‚‚ç–çµåˆã€æœ€é«˜æ€§èƒ½
- **ä¾‹**: ãƒ­ã‚°åé›†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠã‚¬ã‚¤ãƒ‰

#### åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¿…é ˆï¼Ÿ
  â”œâ”€ Yes â†’ ACIDä¿è¨¼å¿…é ˆï¼Ÿ
  â”‚         â”œâ”€ Yes â†’ åŒæœŸå¿…é ˆï¼Ÿ
  â”‚         â”‚         â”œâ”€ Yes â†’ ã‚¨ãƒ”ãƒƒã‚¯ã‚µãƒ¼ã‚¬ (sao)
  â”‚         â”‚         â””â”€ No  â†’ ãƒ‘ãƒ©ãƒ¬ãƒ«ã‚µãƒ¼ã‚¬ (aao)
  â”‚         â””â”€ No  â†’ ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼å¿…è¦ï¼Ÿ
  â”‚                   â”œâ”€ Yes â†’ ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã‚µãƒ¼ã‚¬ (aeo) â˜…æ¨å¥¨
  â”‚                   â””â”€ No  â†’ ã‚¢ãƒ³ã‚½ãƒ­ã‚¸ãƒ¼ã‚µãƒ¼ã‚¬ (aec) â˜…é«˜æ€§èƒ½
  â”‚
  â””â”€ No  â†’ çµæœæ•´åˆæ€§OK
            â”œâ”€ è¤‡é›‘ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ â†’ ãŠã¨ãè©±ã‚µãƒ¼ã‚¬ (seo)
            â””â”€ ã‚·ãƒ³ãƒ—ãƒ« â†’ ã‚¢ãƒ³ã‚½ãƒ­ã‚¸ãƒ¼ã‚µãƒ¼ã‚¬ (aec)

### Saga Orchestrationæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰

```
// Saga Orchestrator
class OrderSagaOrchestrator:
    function executeOrderSaga(orderId, userId, items):
        try:
            // Step 1: æ³¨æ–‡ä½œæˆ
            orderService.createOrder(orderId, userId, items)

            // Step 2: åœ¨åº«å¼•å½“
            inventoryService.reserveInventory(orderId, items)

            // Step 3: æ±ºæ¸ˆå‡¦ç†
            paymentService.processPayment(orderId, amount)

            // Step 4: é…é€æ‰‹é…
            shippingService.arrangeShipping(orderId, address)

            return "SUCCESS"

        catch error at step:
            // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
            compensate(step, orderId)
            return "FAILED"

    function compensate(failedStep, orderId):
        if failedStep >= 4:
            shippingService.cancelShipping(orderId)
        if failedStep >= 3:
            paymentService.refundPayment(orderId)
        if failedStep >= 2:
            inventoryService.releaseInventory(orderId)
        if failedStep >= 1:
            orderService.cancelOrder(orderId)
```

### Saga Choreographyæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰

```
// Order Service
class OrderService:
    function createOrder(orderId, userId, items):
        order = saveOrder(orderId, userId, items)
        eventBus.publish(OrderCreatedEvent(orderId, items))

    @EventHandler
    function handleInventoryReservationFailed(event):
        cancelOrder(event.orderId)
        eventBus.publish(OrderCancelledEvent(event.orderId))

// Inventory Service
class InventoryService:
    @EventHandler
    function handleOrderCreated(event):
        try:
            reserveInventory(event.orderId, event.items)
            eventBus.publish(InventoryReservedEvent(event.orderId))
        catch InsufficientStockError:
            eventBus.publish(InventoryReservationFailedEvent(event.orderId))

// Payment Service
class PaymentService:
    @EventHandler
    function handleInventoryReserved(event):
        try:
            processPayment(event.orderId)
            eventBus.publish(PaymentProcessedEvent(event.orderId))
        catch PaymentFailedError:
            eventBus.publish(PaymentFailedEvent(event.orderId))

    @EventHandler
    function handleOrderCancelled(event):
        refundPayment(event.orderId)  // è£œå„Ÿ
```

---

## BASEãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

### BASEåŸå‰‡

| åŸå‰‡ | æ„å‘³ | å®Ÿè£…ä¾‹ |
|-----|------|--------|
| **Basically Available** | åŸºæœ¬çš„ã«åˆ©ç”¨å¯èƒ½ | ãƒ¬ãƒ—ãƒªã‚«ã®ä¸€éƒ¨ãŒåœæ­¢ã—ã¦ã‚‚æ®‹ã‚Šã§å¿œç­” |
| **Soft state** | æŸ”è»ŸãªçŠ¶æ…‹ | ä¸€æ™‚çš„ã«ä¸æ•´åˆã‚’è¨±å®¹ |
| **Eventually consistent** | çµæœæ•´åˆæ€§ | æœ€çµ‚çš„ã«ã¯æ•´åˆã™ã‚‹ (æ•°ç§’ã€œæ•°åˆ†) |

### BASEã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: éåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­

```
[Write Service]
    â†“ (å³åº§ã«æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹)
[User] â† "æ³¨æ–‡å—ä»˜å®Œäº†"

    â†“ (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†)
[EventBus] â†’ [Read Service] â†’ [Materialized Viewæ›´æ–°]
```

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§éåŒæœŸã«Read Modelæ›´æ–°

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: å®šæœŸãƒãƒƒãƒèª¿æ•´

```
[Service A: æ³¨æ–‡æ•°ã‚«ã‚¦ãƒ³ãƒˆ] (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°)
    â†“ (ä¸æ•´åˆç™ºç”Ÿã®å¯èƒ½æ€§)
[Service B: é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ] â† 1æ™‚é–“ã”ã¨ã«å†é›†è¨ˆ
```

- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã¯æ¦‚ç®—å€¤
- å®šæœŸçš„ã«æ­£ç¢ºãªå€¤ã‚’å†è¨ˆç®—

### BASEé©ç”¨åˆ¤æ–­

| ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ | BASEæ¡ç”¨ | ç†ç”± |
|------------|---------|------|
| **SNSæŠ•ç¨¿ã®ã„ã„ã­æ•°** | âœ… | æ•°ç§’ã®é…å»¶OKã€é«˜å¯ç”¨æ€§å„ªå…ˆ |
| **å•†å“ãƒ¬ãƒ“ãƒ¥ãƒ¼é›†è¨ˆ** | âœ… | æ¦‚ç®—å€¤ã§ååˆ† |
| **éŠ€è¡Œå£åº§æ®‹é«˜** | âŒ | æ­£ç¢ºãªæ®‹é«˜å¿…é ˆ |
| **åœ¨åº«æ•° (EC)** | âš ï¸ | éå‰°å¼•å½“é˜²æ­¢ç­–ã¨ã‚»ãƒƒãƒˆã§æ¡ç”¨ |

---

## å†ªç­‰æ€§è¨­è¨ˆ

### å†ªç­‰æ€§ã¨ã¯

**å®šç¾©**: åŒã˜æ“ä½œã‚’è¤‡æ•°å›å®Ÿè¡Œã—ã¦ã‚‚ã€çµæœãŒ1å›å®Ÿè¡Œã—ãŸå ´åˆã¨åŒã˜ã«ãªã‚‹æ€§è³ªã€‚

```
// å†ªç­‰
SET balance = 1000  // ä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚ balance = 1000

// éå†ªç­‰
ADD balance = 100  // å®Ÿè¡Œã™ã‚‹ãŸã³ã« +100 ã•ã‚Œã‚‹
```

### å†ªç­‰æ€§ãŒå¿…è¦ãªç†ç”±

ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªã§é‡è¤‡å®Ÿè¡ŒãŒç™ºç”Ÿã™ã‚‹:

1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå±Šã‹ãšãƒªãƒˆãƒ©ã‚¤
2. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã®å†é…ä¿¡**: At-Least-Onceé…ä¿¡
3. **éšœå®³å¾©æ—§**: å‡¦ç†é€”ä¸­ã§ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•

### å†ªç­‰æ€§è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ‘ã‚¿ãƒ¼ãƒ³1: Transaction ID Pattern

```
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
Request:
    transactionId: "tx-12345"  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
    amount: 100

// ã‚µãƒ¼ãƒãƒ¼å´å‡¦ç†
function processPayment(request):
    existing = transactionStore.find(request.transactionId)
    if existing is not null:
        // é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: å‰å›çµæœã‚’è¿”ã™
        return existing.result

    // åˆå›å‡¦ç†
    result = executePayment(request.amount)
    transactionStore.save(request.transactionId, result)
    return result
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³2: Idempotent Consumer (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°)

```
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
Message:
    messageId: "msg-67890"
    orderId: "order-123"
    amount: 500

// Consumerå´å‡¦ç†
function onMessage(message):
    existing = processedMessages.find(message.messageId)
    if existing is not null:
        // é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ç„¡è¦–
        logDebug("Duplicate message ignored: " + message.messageId)
        return

    // åˆå›å‡¦ç†
    processOrder(message.orderId, message.amount)
    processedMessages.save(message.messageId, timestamp=now())
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³3: è‡ªç„¶ãªå†ªç­‰æ€§ (Setæ“ä½œ)

```
// å†ªç­‰ãªæ“ä½œã«å¤‰æ›
// âŒ éå†ªç­‰
function addBalance(userId, amount):
    user = getUser(userId)
    user.balance += amount  // é‡è¤‡å®Ÿè¡Œã§åŠ ç®—ã•ã‚Œã‚‹
    saveUser(user)

// âœ… å†ªç­‰
function setBalanceFromTransactions(userId):
    transactions = getTransactions(userId)
    totalBalance = sum(transactions.amount)  // å…¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å†è¨ˆç®—
    user = getUser(userId)
    user.balance = totalBalance  // SETæ“ä½œã¯å†ªç­‰
    saveUser(user)
```

### å†ªç­‰æ€§å®Ÿè£…ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

| é …ç›® | æ¨å¥¨å®Ÿè£… |
|-----|---------|
| **Transaction IDç”Ÿæˆ** | UUID v4ã€UUIDv7 (æ™‚åˆ»é †åºä»˜ã) |
| **Transaction IDä¿å­˜æœŸé–“** | æœ€ä½24æ™‚é–“ã€ç†æƒ³ã¯7æ—¥é–“ |
| **é‡è¤‡åˆ¤å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°** | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹å‰ (REQUIRES_NEW) |
| **ã¹ãç­‰æ€§ã®ç¯„å›²** | APIå¢ƒç•Œã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡å¢ƒç•Œ |

---

## é‡è¤‡ãƒ»é †åºå¤–ã‚Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å‡¦

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã®å•é¡Œç‚¹

| å•é¡Œ | ç™ºç”ŸåŸå›  | å½±éŸ¿ |
|-----|---------|------|
| **é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** | ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã®å†é…ä¿¡ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ | ãƒ‡ãƒ¼ã‚¿é‡è¤‡ã€äºŒé‡èª²é‡‘ |
| **é †åºå¤–ã‚Œ** | ä¸¦åˆ—å‡¦ç†ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³é–“ã®é †åºä¿è¨¼ãªã— | å¤ã„ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã |
| **æ¬ è½ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** | ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼éšœå®³ã€Producerã‚¨ãƒ©ãƒ¼ | ãƒ‡ãƒ¼ã‚¿æ¬ æ |

### é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å‡¦

#### å¯¾å‡¦1: Message Deduplication Table

```
Table: ProcessedMessages
    messageId (PK)    processedAt         status
    ----------------  ------------------  ------
    msg-001           2026-02-08 10:00    SUCCESS
    msg-002           2026-02-08 10:01    SUCCESS

function handleMessage(message):
    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œå¤–ã§å…ˆã«è¨˜éŒ² (REQUIRES_NEW)
    isDuplicate = processedMessages.insertIfNotExists(message.messageId)
    if isDuplicate:
        return  // é‡è¤‡: å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—

    // å®Ÿéš›ã®ãƒ“ã‚¸ãƒã‚¹å‡¦ç†
    processBusinessLogic(message)
```

#### å¯¾å‡¦2: Unique Constraint (DB)

```
Table: Orders
    orderId (PK)      externalId (UNIQUE)   status
    ----------------  -------------------   ------
    order-001         ext-12345             CREATED

function createOrder(externalId, items):
    try:
        order = Order(externalId, items)
        database.save(order)  // UNIQUEåˆ¶ç´„ã§é‡è¤‡é˜²æ­¢
    catch UniqueConstraintViolation:
        // é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: æ—¢å­˜æ³¨æ–‡ã‚’è¿”ã™
        return database.findByExternalId(externalId)
```

### é †åºå¤–ã‚Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å‡¦

#### å¯¾å‡¦1: Version/Timestampæ¯”è¼ƒ

```
Table: UserProfile
    userId (PK)    name      lastUpdatedAt
    ------------   -------   ------------------
    user-001       Taro      2026-02-08 10:00

function updateProfile(userId, name, messageTimestamp):
    user = database.find(userId)

    // å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç„¡è¦–
    if messageTimestamp <= user.lastUpdatedAt:
        logDebug("Outdated message ignored")
        return

    // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿é©ç”¨
    user.name = name
    user.lastUpdatedAt = messageTimestamp
    database.save(user)
```

#### å¯¾å‡¦2: Event Sourcing (å®Œå…¨ãªé †åºä¿è¨¼)

```
// å…¨ã‚¤ãƒ™ãƒ³ãƒˆã«é †åºç•ªå·ã‚’ä»˜ä¸
Event UserProfileUpdatedEvent:
    userId: user-001
    name: "Taro"
    timestamp: 2026-02-08 10:00
    sequenceNumber: 42  // é †åºç•ªå·

function applyEvent(event):
    aggregate = eventStore.load(event.userId)

    // é †åºç•ªå·ã§é‡è¤‡ãƒ»æ¬ è½ã‚’ãƒã‚§ãƒƒã‚¯
    if event.sequenceNumber <= aggregate.lastSequenceNumber:
        return  // é‡è¤‡ or å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆ

    if event.sequenceNumber != aggregate.lastSequenceNumber + 1:
        // æ¬ è½æ¤œå‡º: ãƒªã‚«ãƒãƒªãƒ¼å‡¦ç†
        recoverMissingEvents(aggregate, event)

    aggregate.apply(event)
    eventStore.save(aggregate)
```

---

## ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œæœ€é©åŒ–

### ã‚°ãƒ­ãƒ¼ãƒãƒ« vs ãƒ­ãƒ¼ã‚«ãƒ«ãƒªã‚½ãƒ¼ã‚¹

#### å•é¡Œ: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ç¯„å›²æ‹¡å¤§

```
// âŒ æ‚ªã„ä¾‹: å…¨ä½“ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
GlobalTransaction:
    Service A DB (Resource 1)
    Message Queue (Resource 2)
    Service B DB (Resource 3)

â†’ 3ã¤ã®ãƒªã‚½ãƒ¼ã‚¹ã§2PC â†’ é…ã„ã€SPOF
```

#### è§£æ±ºç­–: ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ã«ã‚ˆã‚‹ãƒ­ãƒ¼ã‚«ãƒ«åŒ–

**æœ€é©åŒ–1: Queueæ°¸ç¶šåŒ–ã¨DBçµ±åˆ**

```
// âœ… è‰¯ã„ä¾‹: Queueã®æ°¸ç¶šåŒ–ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨DBã‚’åŒä¸€ãƒªã‚½ãƒ¼ã‚¹ã«
LocalTransaction:
    Service A DB (åŒä¸€ãƒªã‚½ãƒ¼ã‚¹)
    Message Queueæ°¸ç¶šåŒ– (åŒä¸€ãƒªã‚½ãƒ¼ã‚¹å†…)

â†’ ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ â†’ é«˜é€Ÿã€ACIDä¿è¨¼
```

**æœ€é©åŒ–2: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®é…ç½®**

```
â”Œâ”€â”€â”€ Option 1: Upstreamå´ã§ãƒ­ãƒ¼ã‚«ãƒ«åŒ– â”€â”€â”€â”
â”‚                                         â”‚
â”‚  [Service A]                           â”‚
â”‚      â”œâ”€ Quote DB                       â”‚
â”‚      â””â”€ Queueæ°¸ç¶šåŒ– (åŒä¸€DB)           â”‚
â”‚              â†“                         â”‚
â”‚          [Queue]                       â”‚
â”‚              â†“ (ã‚°ãƒ­ãƒ¼ãƒãƒ«XA)          â”‚
â”‚  [Service B]                           â”‚
â”‚      â””â”€ UserBalance DB                 â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€ Option 2: Downstreamå´ã§ãƒ­ãƒ¼ã‚«ãƒ«åŒ– â”€â”€â”€â”
â”‚                                         â”‚
â”‚  [Service A]                           â”‚
â”‚      â””â”€ Quote DB                       â”‚
â”‚              â†“ (ã‚°ãƒ­ãƒ¼ãƒãƒ«XA)          â”‚
â”‚          [Queue]                       â”‚
â”‚              â†“                         â”‚
â”‚  [Service B]                           â”‚
â”‚      â”œâ”€ UserBalance DB                 â”‚
â”‚      â””â”€ Queueæ°¸ç¶šåŒ– (åŒä¸€DB)           â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¨å¥¨: Option 1 (Upstreamå´ãƒ­ãƒ¼ã‚«ãƒ«åŒ–)**

- é¡§å®¢å¯¾å¿œã‚µãƒ¼ãƒ“ã‚¹ (Upstream) ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆæœ€å¤§åŒ–
- ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹ (Downstream) ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«XAè¨±å®¹

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œè¨­è¨ˆã®åŸå‰‡

| åŸå‰‡ | èª¬æ˜ |
|-----|------|
| **1. å¢ƒç•Œã‚’æœ€å°åŒ–** | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å¯èƒ½ãªé™ã‚Šå°ã•ã |
| **2. ãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆ** | ã‚°ãƒ­ãƒ¼ãƒãƒ«XAã‚ˆã‚Šè¤‡æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ |
| **3. é¡§å®¢å¯¾å¿œã‚’å„ªå…ˆ** | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚µãƒ¼ãƒ“ã‚¹ã¯é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹å„ªå…ˆ |
| **4. ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰** | åŒä¸€ãƒ™ãƒ³ãƒ€ãƒ¼ã€åŒä¸€ãƒãƒ¼ãƒ‰ã§ãƒªã‚½ãƒ¼ã‚¹é…ç½® |

---

## å®Ÿè£…ä¾‹: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³éšœå®³ã¸ã®å¯¾å‡¦

### ã‚±ãƒ¼ã‚¹1: Quoteå‡¦ç†ã§ã®å¤±æ•—ã‚·ãƒŠãƒªã‚ª

```
// âŒ å•é¡Œã‚·ãƒŠãƒªã‚ª
LocalTransaction 1:
    Update Quote Status = "Confirmed"  // æˆåŠŸ

LocalTransaction 2:
    Update UserBalance  // å¤±æ•—!

â†’ Quoteã¯ "Confirmed" ã ãŒæ®‹é«˜æœªæ›´æ–° (ä¸æ•´åˆ)
```

### è§£æ±ºç­–1: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é †åºé€†è»¢

```
// âœ… æ”¹å–„ç‰ˆ: é †åºã‚’é€†è»¢
LocalTransaction 1:
    Update UserBalance  // å…ˆã«å®Ÿè¡Œ

LocalTransaction 2:
    Update Quote Status = "Confirmed"  // å¾Œã«å®Ÿè¡Œ

â†’ UserBalanceæ›´æ–°æˆåŠŸã‚’ç¢ºèªå¾Œã«Quote Statuså¤‰æ›´
```

**æ–°ãŸãªå•é¡Œ**: UserBalanceæ›´æ–°å¾Œã€Quote Statusæ›´æ–°å¤±æ•—

```
LocalTransaction 1:
    Update UserBalance  // æˆåŠŸ

LocalTransaction 2:
    Update Quote Status = "Confirmed"  // å¤±æ•—!

â†’ æ®‹é«˜ã¯æ›´æ–°ã•ã‚ŒãŸãŒQuoteã¯ "New" ã®ã¾ã¾
```

### è§£æ±ºç­–2: é‡è¤‡æ¤œå‡ºãƒ†ãƒ¼ãƒ–ãƒ« + å†ªç­‰æ€§

```
Table: QuotesTX (ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´)
    id    quoteId (UNIQUE)    status      createdAt
    ----  ------------------  ----------  ----------
    1     quote-001           SETTLED     2026-02-08

function settleQuote(quote):
    // REQUIRES_NEW: ç‹¬ç«‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§è¨˜éŒ²
    isDuplicate = quotesTX.insertIfNotExists(quote.id)
    if isDuplicate:
        return  // é‡è¤‡: ã‚¹ã‚­ãƒƒãƒ—

    // æ—¢ã«æ±ºæ¸ˆæ¸ˆã¿ã‹ç¢ºèª
    if quotesTX.isSettled(quote.id):
        return

    // æ±ºæ¸ˆå‡¦ç†
    updateUserBalance(quote)
    quotesTX.markSettled(quote.id)
```

### ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã«ã‚ˆã‚‹é †åºå¤–ã‚Œå¯¾å‡¦

```
Table: User
    userId    amountSold    lastQuoteAt
    -------   ----------    ------------------
    user-001  5000          2026-02-08 10:00

function reconcile(quote):
    user = getUser(quote.sellerId)

    // å£²ä¸ŠåŠ ç®—
    user.amountSold += quote.amount

    // æœ€æ–°ã®Quoteã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿ä¿å­˜
    if quote.createdAt > user.lastQuoteAt:
        user.lastQuoteAt = quote.createdAt

    saveUser(user)
```

---

## ã¾ã¨ã‚

- **XA/2PC**: ACIDä¿è¨¼ã€é‡‘èå‘ã‘ã€æ€§èƒ½ãƒ»å¯ç”¨æ€§çŠ ç‰²
- **Saga**: çµæœæ•´åˆæ€§ã€è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€Orchestration vs Choreography
- **BASE**: é«˜å¯ç”¨æ€§ã€æœ€çµ‚çš„ä¸€è²«æ€§ã€éåŒæœŸå‡¦ç†
- **å†ªç­‰æ€§**: Transaction ID Patternã€é‡è¤‡æ¤œå‡ºãƒ†ãƒ¼ãƒ–ãƒ«ã€Setæ“ä½œ
- **é †åºå¤–ã‚Œ**: Timestampæ¯”è¼ƒã€Event Sourcingé †åºç•ªå·
- **å¢ƒç•Œæœ€é©åŒ–**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å„ªå…ˆã€ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰

æ¬¡ã¯ [MESSAGING-PATTERNS.md](MESSAGING-PATTERNS.md) ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
