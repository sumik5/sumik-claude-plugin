# CQRS ã¨ Event Sourcing

Command Query Responsibility Segregation (CQRS) ã¨Event Sourcingã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [CQRSæ¦‚è¦](#CQRSæ¦‚è¦)
- [CQRSãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«](#CQRSãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«)
- [CQRSåˆ¤æ–­åŸºæº–](#CQRSåˆ¤æ–­åŸºæº–)
- [Event Sourcing](#Event-Sourcing)
- [Look-to-Bookæ¯”ç‡ã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°](#Look-to-Bookæ¯”ç‡ã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°)
- [Command-Event-Commandã‚µã‚¤ã‚¯ãƒ«](#Command-Event-Commandã‚µã‚¤ã‚¯ãƒ«)
- [èª­ã¿æ›¸ãåˆ†é›¢ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°](#èª­ã¿æ›¸ãåˆ†é›¢ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°)

---

## CQRSæ¦‚è¦

### å¾“æ¥ã‚·ã‚¹ãƒ†ãƒ  vs CQRSã‚·ã‚¹ãƒ†ãƒ 

#### å¾“æ¥ã®ãƒ¢ãƒãƒªã‚¹ã‚·ã‚¹ãƒ†ãƒ 

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼] â†’ [Controller] â†’ [Service] â†’ [Entity (DTO)] â†’ [DB (å˜ä¸€ã‚¹ã‚­ãƒ¼ãƒ)]
                â†‘                                            â†“
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        èª­ã¿æ›¸ãåŒä¸€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
```

**å•é¡Œç‚¹:**

1. **è¡¨ç¾ã®ãƒŸã‚¹ãƒãƒƒãƒ**: èª­ã¿å–ã‚Šç”¨ã¨æ›´æ–°ç”¨ã§å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç•°ãªã‚‹
2. **ãƒ­ãƒƒã‚¯ã®ç«¶åˆ**: èª­ã¿å–ã‚Šä¸­ã®æ›¸ãè¾¼ã¿ãŒåŒä¸€ãƒªã‚½ãƒ¼ã‚¹ã‚’å æœ‰
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£åˆ¶ç´„**: èª­ã¿æ›¸ãã‚’ç‹¬ç«‹ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã§ããªã„

#### CQRSã‚·ã‚¹ãƒ†ãƒ 

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    â”œâ”€â”€ [Command] â†’ [Write Model (æ­£è¦åŒ–)] â†’ [Write DB]
    â”‚                        â†“
    â”‚                   [Events]
    â”‚                        â†“
    â””â”€â”€ [Query] â† [Read Model (éæ­£è¦åŒ–)] â† [Event Handler]
```

**åˆ©ç‚¹:**

1. **ç‹¬ç«‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’å€‹åˆ¥ã«ã‚¹ã‚±ãƒ¼ãƒ«
2. **æœ€é©åŒ–ã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼**: èª­ã¿å–ã‚Šå°‚ç”¨ã®éæ­£è¦åŒ–ãƒ“ãƒ¥ãƒ¼ (Materialized View)
3. **è¤‡æ•°ã®ãƒ“ãƒ¥ãƒ¼**: åŒä¸€ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç•°ãªã‚‹ç›®çš„ã®è¤‡æ•°ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆå¯èƒ½

---

## CQRSãƒ¡ã‚¿ãƒ¢ãƒ‡ãƒ«

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Write Side â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                   â”‚
â”‚  [Controller] â†’ [Commands]                       â”‚
â”‚                     â†“                             â”‚
â”‚              [CommandGateway]                     â”‚
â”‚                     â†“                             â”‚
â”‚              [CommandHandler]                     â”‚
â”‚                     â†“                             â”‚
â”‚              [DomainEntity (Aggregate)]          â”‚
â”‚                     â†“                             â”‚
â”‚              [Repository] â†” [EventStore]         â”‚
â”‚                     â†“                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
                  [Events] â† ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
                      â†“
              [EventBus (Pub/Sub)]
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Read Side â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                   â”‚
â”‚              [EventHandler]                       â”‚
â”‚                     â†“                             â”‚
â”‚          [MaterializedView (Read Model)]         â”‚
â”‚                     â†“                             â”‚
â”‚  [Controller] â† [Query] â† [Read DB]             â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å½¹å‰² | å®Ÿè£…ä¾‹ |
|--------------|------|--------|
| **Controller** | UI/APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ | Spring MVC Controller |
| **Commands** | çŠ¶æ…‹å¤‰æ›´ã®æ„å›³ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ– | `CreateOrderCommand`, `UpdateInventoryCommand` |
| **CommandGateway** | ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã®æŠ½è±¡åŒ– (åŒæœŸ/éåŒæœŸé¸æŠ) | Axon CommandGateway |
| **CommandHandler** | ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ | `@CommandHandler` ãƒ¡ã‚½ãƒƒãƒ‰ |
| **DomainEntity (Aggregate)** | ãƒ‰ãƒ¡ã‚¤ãƒ³çŠ¶æ…‹ç®¡ç†ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆ | Order, Inventory (DDD Aggregate) |
| **Repository** | Aggregateã®æ°¸ç¶šåŒ–ãƒ»å¾©å…ƒ | Event Sourcing Repository |
| **EventStore** | ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã®æ°¸ç¶šåŒ– | RDBã€NoSQLã€å°‚ç”¨EventStore |
| **Events** | çŠ¶æ…‹å¤‰æ›´ã®äº‹å®Ÿã‚’è¡¨ç¾ | `OrderCreatedEvent`, `InventoryDeductedEvent` |
| **EventBus** | ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ (Pub/Sub) | RabbitMQ, Kafka, Axon Server |
| **EventHandler** | ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ãƒ»Read Modelæ›´æ–° | `@EventHandler` ãƒ¡ã‚½ãƒƒãƒ‰ |
| **MaterializedView** | èª­ã¿å–ã‚Šå°‚ç”¨ã®éæ­£è¦åŒ–ãƒ“ãƒ¥ãƒ¼ | Redisã€MongoDBã€Elasticsearch |
| **Query** | Read Modelã¸ã®å•ã„åˆã‚ã› | `FindOrderByIdQuery` |

### æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ä¾‹ (è¨€èªéä¾å­˜)

```
// ===== Write Side =====

// Commandå®šç¾©
Command CreateOrderCommand:
    orderId: UUID
    userId: UUID
    items: List<OrderItem>

// CommandHandler
CommandHandler handleCreateOrder(command: CreateOrderCommand):
    aggregate = OrderAggregate.create(command.orderId, command.userId, command.items)
    repository.save(aggregate)
    // AggregateãŒç”Ÿæˆã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒEventStoreã«ä¿å­˜ã•ã‚Œã‚‹

// DomainEntity (Aggregate)
Aggregate OrderAggregate:
    orderId: UUID
    userId: UUID
    items: List<OrderItem>
    status: OrderStatus

    function create(orderId, userId, items):
        this.orderId = orderId
        this.userId = userId
        this.items = items
        this.status = CREATED
        applyEvent(OrderCreatedEvent(orderId, userId, items))

    function applyEvent(event: OrderCreatedEvent):
        // çŠ¶æ…‹å¤‰æ›´ (Event Sourcing)
        this.status = CREATED

// ===== Event Propagation =====

Event OrderCreatedEvent:
    orderId: UUID
    userId: UUID
    items: List<OrderItem>
    timestamp: DateTime

EventBus.publish(OrderCreatedEvent)

// ===== Read Side =====

// EventHandler
EventHandler handleOrderCreated(event: OrderCreatedEvent):
    readModel = OrderReadModel(
        orderId: event.orderId,
        userId: event.userId,
        itemCount: event.items.size(),
        totalAmount: calculateTotal(event.items),
        createdAt: event.timestamp
    )
    readDatabase.save(readModel)

// Query
Query FindOrderByIdQuery:
    orderId: UUID

QueryHandler handleFindOrderById(query: FindOrderByIdQuery):
    return readDatabase.findById(query.orderId)
```

---

## CQRSåˆ¤æ–­åŸºæº–

### ã„ã¤CQRSã‚’ä½¿ã†ã‹

| åˆ¤æ–­è»¸ | CQRSæ¡ç”¨ã™ã¹ã | CQRSä¸è¦ |
|-------|-------------|---------|
| **èª­ã¿æ›¸ãæ¯”ç‡** | 10:1ä»¥ä¸Š (åœ§å€’çš„ã«èª­ã¿å–ã‚Šå¤š) | ã»ã¼åŒç­‰ (1:1å‰å¾Œ) |
| **ãƒ“ãƒ¥ãƒ¼è¦ä»¶** | è¤‡æ•°ã®ç•°ãªã‚‹ãƒ“ãƒ¥ãƒ¼å¿…è¦ (ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ãƒ¬ãƒãƒ¼ãƒˆã€æ¤œç´¢) | å˜ä¸€ã®CRUDãƒ“ãƒ¥ãƒ¼ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã§ç•°ãªã‚‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥å¿…è¦ | ä¸€å¾‹ã‚¹ã‚±ãƒ¼ãƒ«ã§ååˆ† |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | èª­ã¿å–ã‚Šãƒ¬ã‚¹ãƒãƒ³ã‚¹ <100mså¿…é ˆ | æ¨™æº–çš„ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  |
| **è¤‡é›‘æ€§è¨±å®¹åº¦** | çµæœæ•´åˆæ€§ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚’å—ã‘å…¥ã‚Œå¯èƒ½ | ã‚·ãƒ³ãƒ—ãƒ«ã•ãƒ»å³æ™‚æ•´åˆæ€§å„ªå…ˆ |
| **ãƒ‰ãƒ¡ã‚¤ãƒ³è¤‡é›‘åº¦** | è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ (DDDé©ç”¨) | ã‚·ãƒ³ãƒ—ãƒ«ãªCRUD |
| **ç›£æŸ»è¦æ±‚** | å®Œå…¨ãªå¤‰æ›´å±¥æ­´è¿½è·¡å¿…é ˆ | ç¾åœ¨çŠ¶æ…‹ã®ã¿ã§OK |

### CQRSã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•

| ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|---------|----------|
| âœ… èª­ã¿æ›¸ãç‹¬ç«‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° | âŒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¤‡é›‘æ€§å¢—åŠ  |
| âœ… èª­ã¿å–ã‚Šæ€§èƒ½æœ€é©åŒ– (éæ­£è¦åŒ–) | âŒ çµæœæ•´åˆæ€§ (ä¸€æ™‚çš„ãªé…å»¶) |
| âœ… è¤‡æ•°ã®ç›®çš„åˆ¥ãƒ“ãƒ¥ãƒ¼æä¾› | âŒ ãƒ‡ãƒ¼ã‚¿é‡è¤‡ (ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆ) |
| âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯åˆ†é›¢ | âŒ ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆã®é›£ã—ã• |
| âœ… ç›£æŸ»ãƒ­ã‚°ãƒ»ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«å¯èƒ½ (Event Sourcingä½µç”¨æ™‚) | âŒ ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆã®è¤‡é›‘åŒ– |

### Look-to-Bookæ¯”ç‡ã«ã‚ˆã‚‹åˆ¤æ–­

**Look-to-Bookæ¯”ç‡**: èª­ã¿å–ã‚Šæ“ä½œ (Look) ã¨æ›¸ãè¾¼ã¿æ“ä½œ (Book) ã®å‰²åˆ

```
Look-to-Book = (èª­ã¿å–ã‚Šãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°) / (æ›¸ãè¾¼ã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°)
```

| æ¯”ç‡ | æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | ç†ç”± |
|-----|-------------|------|
| **1:1 ~ 3:1** | ã‚·ãƒ³ãƒ—ãƒ«CRUD | CQRSå°å…¥ã¯éå‰°ã€èª­ã¿å–ã‚Šãƒ¬ãƒ—ãƒªã‚«ã§ååˆ† |
| **5:1 ~ 10:1** | æ®µéšçš„CQRS | èª­ã¿å–ã‚Šãƒ“ãƒ¥ãƒ¼ã®ã¿åˆ†é›¢ã€æ›¸ãè¾¼ã¿ã¯å¾“æ¥é€šã‚Š |
| **10:1 ~ 100:1** | å®Œå…¨CQRS | èª­ã¿æ›¸ãå®Œå…¨åˆ†é›¢ã€è¤‡æ•°Read Model |
| **100:1ä»¥ä¸Š** | CQRS + CDN/Cache | èª­ã¿å–ã‚Šã‚’Edgeã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€æ›¸ãè¾¼ã¿ã¯ä¸­å¤®é›†ç´„ |

**ä¾‹: ECã‚µã‚¤ãƒˆ**

- å•†å“é–²è¦§: 100,000 req/min
- è³¼å…¥: 1,000 req/min
- Look-to-Book = 100:1 â†’ **CQRSå¿…é ˆ**

---

## Event Sourcing

### Event Sourcingã¨ã¯

**å®šç¾©**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç¾åœ¨çŠ¶æ…‹ã§ã¯ãªãã€çŠ¶æ…‹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®å±¥æ­´ã‚’æ°¸ç¶šåŒ–ã™ã‚‹æ‰‹æ³•ã€‚

#### å¾“æ¥ã®State-Based Persistence

```
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€æ–°çŠ¶æ…‹ã®ã¿ä¿å­˜
User:
    id: 12345
    name: "Taro"
    email: "taro@example.com"
    balance: 5000  â† ç¾åœ¨å€¤ã®ã¿
```

#### Event Sourcing

```
// å…¨ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’ä¿å­˜
EventStore:
    [1] UserRegisteredEvent(id: 12345, name: "Taro", email: "taro@example.com")
    [2] BalanceDepositedEvent(id: 12345, amount: 10000)
    [3] BalancePurchasedEvent(id: 12345, amount: 5000)

// ç¾åœ¨çŠ¶æ…‹ã¯å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†ç”Ÿ (replay) ã—ã¦å¾©å…ƒ
balance = 0 + 10000 - 5000 = 5000
```

### Event Sourcingã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

| ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|---------|----------|
| âœ… å®Œå…¨ãªç›£æŸ»ãƒ­ã‚° (èª°ãŒã€ã„ã¤ã€ä½•ã‚’å¤‰æ›´ã—ãŸã‹) | âŒ ã‚¤ãƒ™ãƒ³ãƒˆå†ç”Ÿã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚³ã‚¹ãƒˆ |
| âœ… ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ« (ä»»æ„ã®æ™‚ç‚¹ã®çŠ¶æ…‹ã‚’å¾©å…ƒ) | âŒ ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã®è¤‡é›‘æ€§ (ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°) |
| âœ… ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è¦ªå’Œæ€§é«˜ | âŒ ãƒ‡ãƒãƒƒã‚°ã®é›£ã—ã• (ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã‚’è¿½ã†å¿…è¦) |
| âœ… ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆ (è¡Œå‹•åˆ†æã€ãƒ¬ãƒãƒ¼ãƒˆ) | âŒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡å¢—åŠ  |
| âœ… CQRS Read Modelã®è‡ªå‹•æ›´æ–° | âŒ å‰Šé™¤ã®æ‰±ã„ãŒè¤‡é›‘ (è«–ç†å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ) |

### Event Sourcingé©ç”¨åˆ¤æ–­

| ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ | Event Sourcingé©ç”¨ | ç†ç”± |
|------------|------------------|------|
| **é‡‘èå–å¼•** | âœ… å¿…é ˆ | å®Œå…¨ãªå–å¼•å±¥æ­´ã€ç›£æŸ»è¦ä»¶ |
| **æ³¨æ–‡ç®¡ç†** | âœ… æ¨å¥¨ | æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰é·ã®è¿½è·¡ |
| **åœ¨åº«ç®¡ç†** | âœ… æ¨å¥¨ | å…¥å‡ºåº«å±¥æ­´ã€æ£šå¸ã—å¯¾å¿œ |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼** | âš ï¸ é¸æŠçš„ | ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã¯æœ‰ç”¨ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¯ä¸è¦ |
| **ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿** | âŒ ä¸è¦ | é™çš„ãƒ‡ãƒ¼ã‚¿ã€å±¥æ­´ä¸è¦ |

---

## Look-to-Bookæ¯”ç‡ã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

### èª­ã¿æ›¸ãæ¯”ç‡ã«å¿œã˜ãŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### æ¯”ç‡ 1:1 (å‡ç­‰)

```
[Client] â†’ [Load Balancer] â†’ [App Server 1] â†’ [Primary DB]
                           â†’ [App Server 2] â†’ [Primary DB]
```

- ã‚·ãƒ³ãƒ—ãƒ«ãªæ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- CQRSä¸è¦

#### æ¯”ç‡ 10:1 (èª­ã¿å–ã‚Šå¤š)

```
[Client]
    â”œâ”€â”€ [Write] â†’ [Command Service] â†’ [Primary DB]
    â”‚                     â†“
    â”‚                 [Events]
    â”‚                     â†“
    â””â”€â”€ [Read] â†’ [Query Service 1] â†’ [Read Replica 1]
              â†’ [Query Service 2] â†’ [Read Replica 2]
              â†’ [Query Service 3] â†’ [Read Replica 3]
```

- CQRSã§èª­ã¿æ›¸ãåˆ†é›¢
- èª­ã¿å–ã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’ç‹¬ç«‹ã‚¹ã‚±ãƒ¼ãƒ«

#### æ¯”ç‡ 100:1 (åœ§å€’çš„èª­ã¿å–ã‚Š)

```
[Client]
    â”œâ”€â”€ [Write] â†’ [Command Service] â†’ [Primary DB]
    â”‚                     â†“
    â”‚                 [Events]
    â”‚                     â†“
    â””â”€â”€ [Read] â†’ [CDN/Edge Cache]
              â†’ [Query Service NÃ—10] â†’ [NoSQL (Materialized View)]
              â†’ [Search (Elasticsearch)]
```

- è¤‡æ•°ã®Read Model (NoSQLã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
- CDN/Edgeã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥

---

## Command-Event-Commandã‚µã‚¤ã‚¯ãƒ«

### ã‚µã‚¤ã‚¯ãƒ«ã®æµã‚Œ

```
[1. Command] â†’ [2. CommandHandler] â†’ [3. DomainEntity]
                                            â†“
                                    [4. Eventç”Ÿæˆ]
                                            â†“
                                      [5. EventBus]
                                            â†“
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â†“                               â†“
                [6a. EventHandler (Readå´)]      [6b. EventHandler (ä»–ã‚µãƒ¼ãƒ“ã‚¹)]
                            â†“                               â†“
                [7a. MaterializedViewæ›´æ–°]         [7b. æ–°ã—ã„Commandç”Ÿæˆ]
                                                            â†“
                                            [ã‚µã‚¤ã‚¯ãƒ«ç¹°ã‚Šè¿”ã—]
```

### å…·ä½“ä¾‹: æ³¨æ–‡å‡¦ç†

```
1. CreateOrderCommand
   â†“
2. OrderCommandHandler: æ³¨æ–‡ã‚’ä½œæˆ
   â†“
3. OrderAggregate: åœ¨åº«ç¢ºèªãƒ»ä¾¡æ ¼è¨ˆç®—
   â†“
4. OrderCreatedEvent
   â†“
5. EventBusçµŒç”±ã§é…ä¿¡
   â†“
6a. OrderReadModelHandler: æ³¨æ–‡ä¸€è¦§ãƒ“ãƒ¥ãƒ¼æ›´æ–°
6b. InventoryEventHandler: åœ¨åº«å¼•å½“
   â†“
7b. ReserveInventoryCommand (æ–°ã—ã„Command)
   â†“
8. InventoryCommandHandler: åœ¨åº«å¼•å½“å‡¦ç†
   â†“
9. InventoryReservedEvent
   â†“
10. EventBusçµŒç”±ã§é…ä¿¡
   â†“
11. OrderEventHandler: æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
   â†“
12. UpdateOrderStatusCommand
   â†“
(ã‚µã‚¤ã‚¯ãƒ«ç¶™ç¶š...)
```

### Command-Event-Commandã®åˆ©ç‚¹

| åˆ©ç‚¹ | èª¬æ˜ |
|-----|------|
| **ç–çµåˆ** | ã‚µãƒ¼ãƒ“ã‚¹é–“ãŒç›´æ¥å‘¼ã³å‡ºã•ãšã‚¤ãƒ™ãƒ³ãƒˆã§é€£æº |
| **æ‹¡å¼µæ€§** | æ–°ã—ã„EventHandlerã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§æ©Ÿèƒ½æ‹¡å¼µ |
| **ç›£æŸ»æ€§** | ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´ã§å…¨å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’è¿½è·¡å¯èƒ½ |
| **ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹** | ã‚¤ãƒ™ãƒ³ãƒˆãŒæ°¸ç¶šåŒ–ã•ã‚Œã‚‹ãŸã‚å‡¦ç†å¤±æ•—æ™‚ã«ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ |

---

## èª­ã¿æ›¸ãåˆ†é›¢ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

### ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æˆ¦ç•¥

#### æ›¸ãè¾¼ã¿å´ (Command Side)

**åŸºæœ¬åŸå‰‡: æ›¸ãè¾¼ã¿ã¯æ…é‡ã«ã‚¹ã‚±ãƒ¼ãƒ«**

```
[Load Balancer]
    â†“
[Command Service 1] â”€â”
[Command Service 2] â”€â”¼â†’ [Primary DB (å˜ä¸€)]
[Command Service 3] â”€â”˜
```

- **æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã¯ã‚¹ã‚±ãƒ¼ãƒ«å¯èƒ½
- **DBåˆ¶ç´„**: Primary DBã¯åŸºæœ¬çš„ã«1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ (ä¸€è²«æ€§ä¿è¨¼)
- **åŒæ™‚æ›¸ãè¾¼ã¿åˆ¶å¾¡**: æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ (Optimistic Locking) ã§ç«¶åˆè§£æ±º

#### èª­ã¿å–ã‚Šå´ (Query Side)

**åŸºæœ¬åŸå‰‡: èª­ã¿å–ã‚Šã¯ç©æ¥µçš„ã«ã‚¹ã‚±ãƒ¼ãƒ«**

```
[Load Balancer]
    â†“
[Query Service 1] â†’ [Read Replica 1]
[Query Service 2] â†’ [Read Replica 2]
[Query Service 3] â†’ [Read Replica 3]
[Query Service N] â†’ [Cache (Redis)]
```

- **ç„¡åˆ¶é™ã‚¹ã‚±ãƒ¼ãƒ«**: Read Replicaã‚’å¿…è¦ãªã ã‘è¿½åŠ 
- **è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢**: RDBã€NoSQLã€Elasticsearchã€Cacheã‚’ä¸¦è¡Œåˆ©ç”¨
- **çµæœæ•´åˆæ€§**: æ›¸ãè¾¼ã¿åæ˜ ã«æ•°ç§’ã®é…å»¶è¨±å®¹

### Primary/Standby ãƒ‘ã‚¿ãƒ¼ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€ Writeå´ â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€ Readå´ â”€â”€â”€â”€â”€â”€â”
â”‚                      â”‚         â”‚                     â”‚
â”‚  [Command Service]  â”‚         â”‚  [Query Service]   â”‚
â”‚          â†“           â”‚         â”‚         â†‘           â”‚
â”‚  [Primary DB] â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â†’  [Standby DB]      â”‚
â”‚  (Read + Write)      â”‚ éåŒæœŸè¤‡è£½ â”‚  (Read Only)       â”‚
â”‚                      â”‚         â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹æ€§:**

- **æ›¸ãè¾¼ã¿é…å»¶**: Primary DBã¸ã®æ›¸ãè¾¼ã¿å¾Œã€Standbyã¸ã®åæ˜ ã«é…å»¶ (æ•°ç§’)
- **ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼**: Primaryéšœå®³æ™‚ã€Standbyã‚’æ˜‡æ ¼ (Promote)
- **ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚°**: ç›£è¦–ãŒå¿…é ˆ (é…å»¶ãŒå¤§ãã„ã¨å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™)

---

## å®Ÿè£…æ™‚ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆ

```
// è‰¯ã„ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆ
Event OrderCreatedEvent:
    orderId: UUID           // ã‚¤ãƒ™ãƒ³ãƒˆå¯¾è±¡ã®ID
    userId: UUID            // é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ID
    items: List<OrderItem>  // å¿…è¦ãªå…¨ãƒ‡ãƒ¼ã‚¿
    totalAmount: Decimal
    timestamp: DateTime     // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚åˆ»
    version: Integer        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´å¯¾å¿œ)

// æ‚ªã„ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆ
Event OrderEvent:
    data: String  // âŒ å‹æƒ…å ±ãªã—ã€æ‹¡å¼µå›°é›£
```

### 2. Read Modelæ›´æ–°ã®å†ªç­‰æ€§

```
EventHandler handleOrderCreated(event: OrderCreatedEvent):
    existing = readDatabase.findById(event.orderId)
    if existing is not null:
        // é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆ: ç„¡è¦–
        return

    readModel = OrderReadModel(...)
    readDatabase.save(readModel)
```

### 3. EventStoreã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

```
// ã‚¤ãƒ™ãƒ³ãƒˆãŒå¤šã„å ´åˆã€å®šæœŸçš„ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä¿å­˜
if eventCount > 100:
    snapshot = aggregate.createSnapshot()
    snapshotStore.save(snapshot)

// å¾©å…ƒæ™‚ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ + ä»¥é™ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿å†ç”Ÿ
aggregate = snapshotStore.load(aggregateId)
events = eventStore.loadAfter(aggregateId, snapshot.version)
aggregate.replayEvents(events)
```

---

## ã¾ã¨ã‚

- **CQRS**: èª­ã¿æ›¸ãåˆ†é›¢ã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã€è¤‡é›‘æ€§ã¨ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•
- **Event Sourcing**: ã‚¤ãƒ™ãƒ³ãƒˆå±¥æ­´æ°¸ç¶šåŒ–ã€ç›£æŸ»ãƒ»ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«å¯èƒ½ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚³ã‚¹ãƒˆ
- **Look-to-Bookæ¯”ç‡**: èª­ã¿æ›¸ãæ¯”ç‡ã§CQRSæ¡ç”¨ã‚’åˆ¤æ–­
- **Command-Event-Command**: ç–çµåˆãªã‚µãƒ¼ãƒ“ã‚¹é€£æºã€æ‹¡å¼µæ€§é«˜
- **ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: èª­ã¿å–ã‚Šã¯ç©æ¥µçš„ã€æ›¸ãè¾¼ã¿ã¯æ…é‡ã«

æ¬¡ã¯ [DISTRIBUTED-TRANSACTIONS.md](DISTRIBUTED-TRANSACTIONS.md) ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æˆ¦ç•¥ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
