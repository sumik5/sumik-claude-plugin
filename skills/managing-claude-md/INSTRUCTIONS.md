# CLAUDE.md 管理ガイド

## 概要

CLAUDE.mdは、Claude Codeプロジェクトにおける**長期記憶**として機能します。チャットログ（短期記憶）との違いを理解し、適切に運用することで、Claudeのパフォーマンスを最大化できます。

| 種類 | 役割 | 保持期間 | 特徴 |
|-----|------|---------|------|
| **チャットログ** | 短期記憶 | 現セッションのみ | 対話的、コンテキスト圧縮により消失 |
| **CLAUDE.md** | 長期記憶 | プロジェクト全体 | 永続的、明示的に管理 |

### 使用タイミング

- **新規プロジェクト開始時**: プロジェクト固有の知識を記録
- **既存CLAUDE.mdのレビュー時**: 8原則に照らして改善
- **Claudeが同じミスを繰り返す時**: 罠（If X then Y）を追記
- **チームメンバーへのオンボーディング時**: プロジェクトルール共有

**注意**: スキルファイル（SKILL.md）の作成は `authoring-skills` スキルを使用してください。

---

## 🎯 8つの原則（クイックリファレンス）

| 原則 | 内容 | 理由 |
|-----|------|------|
| **1. 300行以下** | CLAUDE.mdは300行以下、指示は150-200個が上限 | コンテキストウィンドウは共有資源。他のファイルと共存する |
| **2. 自動生成回避** | `/init`コマンドの出力をそのまま使わない | 冗長で汎用的すぎ、保守されないドキュメントになる |
| **3. スタイル委譲** | コードフォーマット指示はLint/Formatterに委譲 | CLAUDE.mdにはプロジェクト固有知識のみ記載 |
| **4. 必須3要素** | ①プロジェクト一行説明 ②よく使うコマンド ③If X then Y形式の罠 | この3つがないと基本的な作業で迷う |
| **5. 段階的開示** | 詳細は別ファイル（rules/, docs/等）に分離 | CLAUDE.mdはインデックスとして機能 |
| **6. 優先度配置** | 重要な指示ほど先頭に配置 | LLMは文書の先頭と末尾を重視する |
| **7. 長期記憶運用** | 繰り返し説明している内容はCLAUDE.mdに移動 | チャットログは揮発する |
| **8. 生きたドキュメント** | Claudeが同じミスを繰り返したら即座に追記 | 問題が再発する前に対策を記録 |

---

## 📋 必須3要素の詳細

### 3.1 プロジェクト一行説明

**目的**: Claudeが「このプロジェクトは何をするものか」を即座に理解する

**書き方**:
- 1-2文で簡潔に
- 主要な技術スタック、目的、特徴を含める
- 誰がどんな価値を得るかを明示

**例**:

```markdown
# プロジェクト概要

Next.jsベースの決済ポータル。Stripe連携、マルチテナント対応、PostgreSQL使用。
```

**悪い例**:
```markdown
# プロジェクト概要

このプロジェクトはWebアプリケーションです。フロントエンドとバックエンドがあります。
```
→ 具体性に欠け、プロジェクト固有の情報がない

---

### 3.2 よく使うコマンド

**目的**: 開発者が毎日使うコマンドをすぐ見つけられる

**含めるべきコマンド**:
- 開発サーバー起動
- テスト実行（単体、E2E）
- Lint / Format
- ビルド / デプロイ
- データベースマイグレーション
- 環境セットアップ

**書き方**:

```markdown
## よく使うコマンド

| コマンド | 説明 |
|---------|------|
| `pnpm dev` | 開発サーバー起動（localhost:3000） |
| `pnpm test` | Vitest単体テスト実行 |
| `pnpm test:e2e` | Playwright E2Eテスト（headless） |
| `pnpm lint` | ESLint + Prettier実行 |
| `pnpm build` | 本番ビルド |
| `pnpm db:migrate` | Prismaマイグレーション適用 |
```

**Tips**:
- プロジェクト固有の複雑なコマンドを優先
- 汎用コマンド（`npm install`等）は省略可
- エイリアス・スクリプトがあれば明記

---

### 3.3 プロジェクト固有の罠（If X then Y形式）

**目的**: Claudeが繰り返すミスを事前に防ぐ

**If X then Y形式**: トリガー（X）と行動（Y）のペアで記述することで、Claudeが状況を認識したときに適切な行動を自動実行できる。

**テンプレート**:
```markdown
## プロジェクト固有の罠

| トリガー（If X） | 行動（then Y） |
|----------------|--------------|
| APIエンドポイント追加時 | 必ずOpenAPIスキーマ（`openapi.yaml`）も更新 |
| DB変更時 | Prismaマイグレーションファイル作成必須（`pnpm db:migrate`） |
| 環境変数追加時 | `.env.example`にもダミー値を追加 |
| 新コンポーネント作成時 | Storybookストーリー（`.stories.tsx`）も作成 |
```

**実例**:

| ✅ 良い例 | ❌ 悪い例 |
|---------|---------|
| `APIエンドポイント追加時 → 必ずOpenAPIスキーマも更新` | `APIドキュメントを最新に保つこと` |
| `DB変更時 → Prismaマイグレーションファイル作成必須` | `データベースの変更に注意` |
| `型定義変更時 → 影響範囲をLSPで確認してから変更` | `型安全性を保つこと` |

**なぜIf X then Y形式が重要か**:
- **トリガーが明確**: Claudeが「今この状況だ」と判断できる
- **行動が具体的**: 「どうすればいいか」が曖昧にならない
- **自動化しやすい**: ルールベースで対応可能

**追加のポイント**:
- **頻度の高いミス**を優先的に記載
- **失敗コスト**が高いもの（本番障害、データ損失等）は必ず記載
- 定期的に見直し、もう発生しないミスは削除（ドキュメントの肥大化を防ぐ）

---

## 📂 段階的開示の設計

CLAUDE.mdはインデックスとして機能し、詳細は別ファイルに分離します。

### ファイル分離の判断基準

| 内容の種類 | CLAUDE.mdに残す | 別ファイルに分離 |
|-----------|----------------|----------------|
| プロジェクト一行説明 | ✅ 必須 | — |
| よく使うコマンド | ✅ 必須 | — |
| If X then Y形式の罠 | ✅ 必須（5-10個まで） | 10個以上なら分離 |
| コーディング規約 | ❌ 要約のみ | `rules/coding-style.md` |
| テスト戦略 | ❌ 要約のみ | `docs/testing-strategy.md` |
| アーキテクチャ図 | ❌ リンクのみ | `docs/architecture.md` |
| 詳細なAPI仕様 | ❌ リンクのみ | `docs/api-spec.md` |

### 参照パターン

**CLAUDE.md内での記述例**:

```markdown
## コーディング規約

- SOLID原則必須（詳細: `rules/coding-style.md`）
- any/Any型禁止
- テストカバレッジ80%以上

詳細は [`rules/coding-style.md`](rules/coding-style.md) を参照。
```

**別ファイル（`rules/coding-style.md`）**:

```markdown
# コーディング規約

## SOLID原則
...（詳細な説明）

## 型安全性
...（詳細な説明）
```

### ディレクトリ構成例

```
project/
├── CLAUDE.md           # インデックス（300行以下）
├── rules/              # ルール・原則
│   ├── coding-style.md
│   ├── testing.md
│   └── security.md
└── docs/               # 詳細ドキュメント
    ├── architecture.md
    ├── api-spec.md
    └── deployment.md
```

---

## 🔄 改善ワークフロー（AskUserQuestion対話型）

既存のCLAUDE.mdを8原則に基づいて改善する手順です。

### Step 1: 現状分析

1. CLAUDE.mdを読み込む
2. 8原則に照らして問題点を特定:
   - 行数は300行以下か？
   - 必須3要素はあるか？
   - スタイル指示が混入していないか？
   - 重要指示が先頭にあるか？

### Step 2: 問題点の特定

**チェックリスト**:

- [ ] 行数超過（300行以上）
- [ ] `/init`自動生成の痕跡（汎用的すぎる説明）
- [ ] コードフォーマット指示が混入
- [ ] 必須3要素の不足
- [ ] 全指示が均等に扱われている（優先度なし）
- [ ] 詳細がCLAUDE.mdに直接記載（段階的開示なし）

### Step 3: ユーザーとの対話

`AskUserQuestion` を使って改善方針を決定します。

**例1: 行数超過時**

```python
AskUserQuestion(
    questions=[{
        "question": "CLAUDE.mdが450行あり、300行の上限を超えています。どのセクションを別ファイルに分離しますか？",
        "header": "分離対象セクション",
        "options": [
            {
                "label": "コーディング規約",
                "description": "SOLID原則、型安全性等の詳細 → rules/coding-style.md"
            },
            {
                "label": "テスト戦略",
                "description": "テスト種別、カバレッジ要件 → docs/testing-strategy.md"
            },
            {
                "label": "両方",
                "description": "コーディング規約とテスト戦略の両方を分離"
            }
        ],
        "multiSelect": False
    }]
)
```

**例2: 必須要素不足時**

```python
AskUserQuestion(
    questions=[{
        "question": "プロジェクトの一行説明が見つかりません。このプロジェクトは何をするものですか？",
        "header": "プロジェクト説明",
        "freeformLabel": "一行説明を入力してください（例: Next.jsベースの決済ポータル。Stripe連携、マルチテナント対応。）"
    }]
)
```

**例3: 罠の追加時**

```python
AskUserQuestion(
    questions=[{
        "question": "Claudeが繰り返したミスは何ですか？",
        "header": "繰り返しミス",
        "freeformLabel": "具体的なミスを記述してください（例: APIエンドポイント追加時にOpenAPIスキーマを更新し忘れた）"
    }]
)
```

### Step 4: 改善案の提示

ユーザーの回答に基づいて、具体的な改善案を提示します。

**改善案の例**:

```markdown
## 改善案

### 現状の問題点
- CLAUDE.mdが450行（上限300行を150行超過）
- コーディング規約の詳細（80行）が直接記載
- プロジェクト一行説明が欠如

### 改善内容
1. **プロジェクト一行説明を追加**:
   ```markdown
   # プロジェクト概要
   Next.jsベースの決済ポータル。Stripe連携、マルチテナント対応、PostgreSQL使用。
   ```

2. **コーディング規約を分離**:
   - `rules/coding-style.md` を新規作成
   - CLAUDE.mdには要約のみ残す（5行）

3. **結果**:
   - 改善後の行数: 375行（まだ超過）→ さらにテスト戦略も分離推奨

### 実装方針
タチコマに以下を委譲:
- `rules/coding-style.md` 作成
- CLAUDE.md の該当セクション削除・要約追加
```

### Step 5: 実装（タチコマ委譲）

改善内容をタチコマに委譲して実装します。

---

## 🗂️ スコープ設計（モノレポ・個人設定）

CLAUDE.mdの配置場所によってスコープが異なります。

### 1. プロジェクトルート（`CLAUDE.md`）

**用途**: チーム全体で共有するプロジェクト設定

**含める内容**:
- プロジェクト一行説明
- よく使うコマンド
- プロジェクト固有の罠
- チーム共通のコーディング規約
- バージョン管理ルール

**Git管理**: ✅ コミット対象

---

### 2. 個人設定（`claude.local.md`）

**用途**: 個人の作業スタイル、ローカル環境設定

**含める内容**:
- 個人の好み（エディタ設定、ショートカット等）
- ローカル環境固有のパス
- 個人タスク管理
- チームに共有しない実験的な設定

**Git管理**: ❌ `.gitignore` に追加

**.gitignore 例**:
```
claude.local.md
```

---

### 3. グローバル設定（`~/.claude/CLAUDE.md`）

**用途**: 全プロジェクト共通のグローバル設定

**含める内容**:
- 言語設定（日本語応答必須等）
- コード品質原則（SOLID、型安全性）
- バージョン管理ルール（Jujutsu等）
- 開発プロセス共通ルール

**例**: このプロジェクトの `~/.claude/CLAUDE.md` はタチコマシステム、Jujutsu運用等を含む

---

### 4. モノレポ構成

**ディレクトリ構成例**:

```
monorepo/
├── CLAUDE.md                    # リポジトリ全体の共通設定
├── packages/
│   ├── frontend/
│   │   └── CLAUDE.md           # フロントエンド固有の設定
│   ├── backend/
│   │   └── CLAUDE.md           # バックエンド固有の設定
│   └── shared/
│       └── CLAUDE.md           # 共有ライブラリ固有の設定
```

**ルートCLAUDE.md**:
- モノレポ全体のアーキテクチャ
- 共通のコマンド（`turbo dev`, `turbo test`等）
- パッケージ間依存関係

**各サービスのCLAUDE.md**:
- サービス固有の技術スタック
- サービス固有のコマンド
- サービス固有の罠（If X then Y）

**読み込み優先順位**:
1. 作業中のサービスのCLAUDE.md
2. ルートCLAUDE.md
3. `~/.claude/CLAUDE.md`

---

## ♻️ メンテナンスサイクル

CLAUDE.mdを生きたドキュメントとして維持するための定期的なメンテナンスです。

### 日次メンテナンス

**Claudeが同じミスを繰り返したら**:
1. チャットログで原因を特定
2. If X then Y形式で罠を追記
3. 次回から同じミスが発生しないことを確認

**例**:
```markdown
## プロジェクト固有の罠

| トリガー（If X） | 行動（then Y） |
|----------------|--------------|
| コンポーネント削除時 | Storybookストーリーも削除（孤立ファイル防止） |
```

### 週次メンテナンス

**行数チェック**:
```bash
wc -l CLAUDE.md
```
→ 300行を超えていたら段階的開示を検討

**不要な罠の削除**:
- もう発生しないミス（技術スタック変更等で無効化）
- 解決済みの問題（ツール導入で自動化等）

### 月次メンテナンス

**構造レビュー**:
- 必須3要素は最新か？
- 重要指示が先頭にあるか？
- 段階的開示が適切か？

**チームレビュー**:
- 新メンバーに見せて理解できるか確認
- フィードバックを反映

---

## 📚 詳細ドキュメント

より詳細な情報は以下を参照してください:

- **[TEMPLATES.md](references/TEMPLATES.md)**: CLAUDE.mdテンプレート集（ミニマル、スタンダード、モノレポ、個人設定）
- **[VALIDATION.md](references/VALIDATION.md)**: 品質チェックリスト、アンチパターン、If X then Y変換ガイド

---

## 🔗 関連スキル

- **authoring-skills**: スキルファイル（SKILL.md）の作成
- **writing-effective-prose**: 技術文書作成の原則（7つのCを含む）
- **using-serena**: Serenaメモリによるプロジェクト知識管理
