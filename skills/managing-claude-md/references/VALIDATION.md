# CLAUDE.md 品質チェックリスト

このドキュメントでは、CLAUDE.md の品質を保証するためのチェックリスト、アンチパターン、改善手法を提供します。

---

## 1. 量的チェック

CLAUDE.md の肥大化を防ぐための量的制約:

- [ ] **総行数**: 300行以下
- [ ] **指示数**: 150-200個以下
- [ ] **各セクション**: 50行以下が望ましい
- [ ] **コードブロック**: 1つあたり20行以下が望ましい
- [ ] **外部ファイル参照**: 詳細ドキュメントは別ファイルに分離

**測定方法**:

```bash
# 行数カウント
wc -l CLAUDE.md

# 指示数の推定（チェックリスト、箇条書き、If X then Y形式の合計）
grep -E '^- |^[0-9]+\. ' CLAUDE.md | wc -l
```

**超過時の対応**:
- 300行超過 → 段階的開示で詳細を別ファイルに移動
- 指示数超過 → 重複削除、統合、優先度の低い指示を削除

---

## 2. 構造チェック

CLAUDE.md の構造的品質を確認:

- [ ] **プロジェクト一行説明が存在する**
  - 先頭付近に配置
  - 「何を解決するか」「主な技術スタックは何か」が明記

- [ ] **よく使うコマンドセクションが存在する**
  - カテゴリ別に整理（開発、テスト、ビルド、デプロイ）
  - 各コマンドに簡潔な説明付き

- [ ] **プロジェクト固有の罠が If X then Y 形式で記述されている**
  - 最低5個以上
  - 曖昧な指示（「気をつけて」「忘れずに」）が存在しない

- [ ] **重要な指示（CRITICAL/IMPORTANT）が文書先頭付近にある**
  - `## 🚨 CRITICAL` セクションが存在
  - 最重要指示が最初の50行以内に配置

- [ ] **段階的開示が適切に設計されている**
  - 詳細ドキュメントへのリンクが明示
  - リンク先ファイルが実際に存在

- [ ] **ファイルの末尾に重要な指示が配置されていない**
  - LLMは文書の中間部を飛ばす傾向があるため、末尾への配置は避ける

---

## 3. コンテンツ品質チェック

CLAUDE.md の内容の品質を確認:

- [ ] **スタイル指示（インデント、クォート等）が含まれていない**
  - Lint/Formatter で対応可能な内容はツール設定に移動

- [ ] **自動生成（/init）の痕跡がない**
  - 汎用的すぎる指示（「ベストプラクティスに従って」等）を削除
  - プロジェクト固有の具体的な指示のみ記載

- [ ] **古い情報・無効な指示が残っていない**
  - 削除済みのファイル・コマンドへの参照がない
  - 過去のツール・ライブラリへの参照がない

- [ ] **繰り返しの説明がない**
  - 同じ内容を複数箇所に記載していない
  - 重複する指示を統合済み

- [ ] **曖昧な指示が残っていない**
  - 「できるだけ」「なるべく」「適切に」等の表現を排除
  - すべての指示が具体的かつ実行可能

---

## 4. アンチパターン一覧

CLAUDE.md でよく見られる問題パターンと解決策:

| アンチパターン | 問題 | 解決策 |
|--------------|------|--------|
| **コンテキスト汚染** | 情報過多でLLMの性能低下、重要な指示が埋もれる | 300行以下に絞る、段階的開示で分離 |
| **スタイル指示混入** | Lint/Formatter で対応可能な内容がCLAUDE.mdに含まれる | `.prettierrc`, `.eslintrc` 等のツール設定に移動 |
| **自動生成の放置** | `/init` で生成された冗長で不正確な内容がそのまま残る | 手動で必要な情報のみ記述、汎用的な指示を削除 |
| **均等重み付け** | すべての指示が同じ優先度で扱われ、重要な指示が埋もれる | `🚨 CRITICAL` / `⚠️ IMPORTANT` マーカーで優先度明示 |
| **巨大な単一ファイル** | 読み込みコストが大きく、LLMのコンテキスト制限に到達 | 段階的開示で詳細を別ファイルに分離 |
| **曖昧な指示** | 「気をつけて」「忘れずに」等の解釈が揺れる指示 | If X then Y 形式に変換 |
| **陳腐化** | 古い情報・無効な指示が残り、LLMを混乱させる | 定期レビューサイクルで削除・更新 |
| **コマンド説明不足** | コマンドのみ記載され、何をするか不明 | 各コマンドに簡潔な説明を追加 |
| **リンク切れ** | 段階的開示のリンク先ファイルが存在しない | リンク先ファイルの存在を定期確認 |
| **重複指示** | 同じ内容を複数箇所に記載 | 統合して1箇所に集約 |

---

## 5. If X then Y 変換ガイド

曖昧な指示を具体的な If X then Y 形式に変換するパターン集:

### 基本パターン

| 曖昧な指示 | If X then Y 形式 |
|-----------|-----------------|
| 「テストを書いてね」 | **新しい関数を追加した場合 → 対応するユニットテストを同一PRで追加** |
| 「セキュリティに気をつけて」 | **ユーザー入力を受け取る場合 → 必ずバリデーションとサニタイズを実施** |
| 「ドキュメントを更新して」 | **API エンドポイント変更時 → `docs/api-design.md` の OpenAPI 仕様を先に更新** |
| 「環境変数を使って」 | **機密情報（API キー、DB接続文字列）を扱う場合 → 環境変数に格納し `.env.example` に追記** |
| 「エラーハンドリングを追加」 | **外部API呼び出し時 → try-catch でエラーをキャッチし、適切なHTTPステータスコードを返す** |
| 「型安全にして」 | **関数の引数・戻り値 → 明示的な型定義を追加し、`any` を使用しない** |
| 「パフォーマンスを改善」 | **データベースクエリ実行時 → `EXPLAIN` で実行計画を確認し、必要に応じてインデックスを追加** |
| 「アクセシビリティに配慮」 | **ボタン・フォーム要素作成時 → `aria-label` と適切な `role` 属性を設定** |

### 実践的パターン（プロジェクト固有例）

| 曖昧な指示 | If X then Y 形式 |
|-----------|-----------------|
| 「データベースを変更する前に確認」 | **Prismaスキーマ変更時 → `npm run db:migrate:dry` で影響範囲を確認後、チームに通知** |
| 「コンポーネントを追加したらストーリー作成」 | **UI コンポーネント作成時 → Storybook にストーリーを作成** |
| 「認証を追加」 | **認証が必要なエンドポイント → `@UseGuards(AuthGuard)` デコレーターを使用** |
| 「リトライ処理を入れる」 | **外部API呼び出し時 → リトライロジック（最大3回）とタイムアウト設定（30秒）を実装** |
| 「ファイルサイズを制限」 | **ファイルアップロード機能 → ファイルサイズ制限（最大10MB）とMIMEタイプ検証を実装** |
| 「ページネーション対応」 | **データベースクエリでページネーション → `take` と `skip` を使用し、最大100件まで** |
| 「ログを出力」 | **エラー発生時 → `logger.error()` で詳細なスタックトレースとコンテキスト情報を記録** |
| 「キャッシュを使う」 | **外部API呼び出し時 → Redis でレスポンスをキャッシュ（TTL: 5分）** |

### 変換ステップ

1. **トリガー条件を特定** (When X): いつその指示が適用されるか
2. **具体的なアクションを定義** (Then Y): 何をすべきか
3. **具体例を追加** (任意): コード例、コマンド例、ファイル名

**例**:

**変換前**: 「パフォーマンスに気をつけて」

**変換後**:
```
データベースクエリ実行時 → 以下を実施:
1. `EXPLAIN ANALYZE` で実行計画を確認
2. N+1問題を回避（`include` または `join` を使用）
3. 必要に応じてインデックスを追加
4. クエリ実行時間が100msを超える場合 → 最適化を検討
```

---

## 6. メンテナンスサイクル

CLAUDE.md は「生きたドキュメント」として定期的にメンテナンスする必要があります。

### 月次レビューの推奨手順

**タイミング**: 毎月初め、またはスプリント終了時

**手順**:

1. **量的チェック実行**
   ```bash
   # 行数確認
   wc -l CLAUDE.md

   # 300行を超えている場合 → 段階的開示で分離
   ```

2. **陳腐化チェック**
   - 削除されたファイル・コマンドへの参照を検索
   - 使われなくなったライブラリ・ツールへの言及を削除
   - プロジェクト構成変更に伴う更新

3. **リンク切れチェック**
   ```bash
   # 段階的開示のリンク先ファイルの存在確認
   grep -o 'docs/[^)]*' CLAUDE.md | xargs -I {} test -f {} || echo "リンク切れ: {}"
   ```

4. **重複指示の統合**
   - 同じ内容を複数箇所に記載していないか確認
   - 統合できる指示をまとめる

5. **If X then Y 形式への変換**
   - 曖昧な指示を具体的に変換
   - 「気をつけて」「忘れずに」等の表現を排除

---

### 追記すべきタイミング

**即座に追記**:
- Claudeが**同じミスを2回以上繰り返した時**
- 新しいツール・ライブラリを導入した時
- プロジェクトの重要な設計決定があった時

**追記パターン**:

| 状況 | 追記内容 |
|------|---------|
| データベース破壊的変更を2回実行 | `db:migrate` 実行前に `db:migrate:dry` で確認する指示を追加 |
| APIキーを `.env` に入れ忘れ | 環境変数設定チェックを CRITICAL セクションに追加 |
| テストなしでPR作成 | 新機能追加時のテスト必須化を追加 |
| 型エラーが多発 | `any` 使用禁止を CRITICAL セクションに追加 |
| セキュリティ脆弱性発見 | 該当パターンの具体的な回避方法を追加 |

---

### 削除すべきタイミング

**即座に削除**:
- プロジェクト構成が変更された時（例: monorepo化、ディレクトリ構造変更）
- ツール・ライブラリを削除した時
- 指示が3ヶ月以上参照されていない時

**削除パターン**:

| 状況 | 削除内容 |
|------|---------|
| Webpack → Vite 移行 | Webpack 関連のコマンドと注意事項を削除 |
| Jest → Vitest 移行 | Jest 設定ファイルへの参照を削除 |
| 機能削除 | 削除された機能に関する指示を削除 |
| ディレクトリ構造変更 | 旧パスへの参照をすべて更新または削除 |

---

### メンテナンスレビューチェックリスト

月次レビュー時に以下をチェック:

- [ ] **量的制約**: 300行以下、指示数150-200以下
- [ ] **構造**: 必須3要素が存在し、重要指示が先頭にある
- [ ] **陳腐化**: 古い情報・リンク切れがない
- [ ] **重複**: 同じ内容を複数箇所に記載していない
- [ ] **曖昧さ**: すべての指示が If X then Y 形式または具体的
- [ ] **スタイル指示**: Lint/Formatter 対応内容が含まれていない
- [ ] **段階的開示**: 詳細ドキュメントが適切に分離されている

---

## 7. 自動チェックスクリプト

CLAUDE.md の品質を自動チェックするシェルスクリプト例:

```bash
#!/bin/bash
# validate-claude-md.sh

CLAUDE_MD="CLAUDE.md"

echo "🔍 CLAUDE.md 品質チェック"
echo ""

# 1. 行数チェック
LINES=$(wc -l < "$CLAUDE_MD")
echo "📏 行数: $LINES / 300"
if [ "$LINES" -gt 300 ]; then
  echo "  ⚠️ 警告: 300行を超えています"
fi

# 2. 指示数推定
INSTRUCTIONS=$(grep -E '^- |^[0-9]+\. |^## ' "$CLAUDE_MD" | wc -l)
echo "📋 指示数（推定）: $INSTRUCTIONS / 200"
if [ "$INSTRUCTIONS" -gt 200 ]; then
  echo "  ⚠️ 警告: 200指示を超えている可能性があります"
fi

# 3. 必須3要素チェック
echo ""
echo "✅ 必須要素チェック:"

if grep -q "^# " "$CLAUDE_MD" | head -n 5; then
  echo "  ✓ プロジェクト説明あり"
else
  echo "  ✗ プロジェクト説明なし"
fi

if grep -q "## コマンド\|## Commands" "$CLAUDE_MD"; then
  echo "  ✓ コマンドセクションあり"
else
  echo "  ✗ コマンドセクションなし"
fi

if grep -q "→" "$CLAUDE_MD"; then
  echo "  ✓ If X then Y 形式の指示あり"
else
  echo "  ✗ If X then Y 形式の指示なし"
fi

# 4. アンチパターン検出
echo ""
echo "🚨 アンチパターン検出:"

if grep -iq "できるだけ\|なるべく\|適切に\|気をつけ" "$CLAUDE_MD"; then
  echo "  ⚠️ 曖昧な表現が検出されました"
  grep -in "できるだけ\|なるべく\|適切に\|気をつけ" "$CLAUDE_MD"
fi

if grep -iq "indent\|quote\|semicolon\|trailing comma" "$CLAUDE_MD"; then
  echo "  ⚠️ スタイル指示が含まれている可能性があります"
fi

# 5. リンク切れチェック
echo ""
echo "🔗 リンク切れチェック:"
grep -o '\[.*\]([^)]*\.md)' "$CLAUDE_MD" | sed 's/.*(\(.*\))/\1/' | while read -r file; do
  if [ ! -f "$file" ]; then
    echo "  ✗ リンク切れ: $file"
  fi
done

echo ""
echo "✅ チェック完了"
```

---

## まとめ

高品質な CLAUDE.md を維持するための3つの原則:

1. **量的制約を守る**: 300行以下、指示数150-200以下
2. **具体的な指示**: If X then Y 形式、曖昧な表現を排除
3. **定期メンテナンス**: 月次レビュー、繰り返しミスは即座に追記、古い情報は即座に削除

これらを守ることで、LLMが効率的に理解できる「生きたドキュメント」として CLAUDE.md を運用できます。
