# ドメイン設計（Domain Design）

Product Taxonomyによるアーキテクチャの言語定義と、ドメイン境界識別のヒューリスティクスをカバーする。

---

## 1. Product Taxonomy

アーキテクチャを記述するための「言語」=構成要素のセット。

### 構成要素（Building Blocks）

```
Portfolio
  └── Product Group
        └── Product
              └── Domain
                    └── Subdomain
                          └── Independent Value Stream
```

| 構成要素 | 説明 | 例 |
|---------|------|-----|
| **Independent Value Stream** | 1チームがEnd-to-Endで価値を届ける単位 | 検索機能チーム |
| **Subdomain** | ビジネスの論理的な小領域 | ロイヤルティポイント |
| **Domain** | 関連するサブドメインのグループ | カスタマーエンゲージメント |
| **Product** | 顧客に価値を提供する製品 | ECプラットフォーム |
| **Platform** | 他のチーム/プロダクトにサービスを提供 | 決済プラットフォーム |
| **Product Group / Portfolio** | 複数プロダクトの集合 | デジタルコマース事業部 |

### Product Taxonomy 設計原則

| 原則 | 説明 |
|------|------|
| **簡単な部分から始める** | 明確な境界のある領域から着手 |
| **適切な技法を使う** | EventStorming、Domain Storytelling等を状況に応じて |
| **常に進化を期待する** | 完璧な初期設計は不可能。フィードバックで改善 |
| **設計責任を分散する** | 1つのチームが全体を設計するのではなく、各チームが担当領域を設計 |

### プロダクトとは何か

| 概念 | 定義 | 違い |
|------|------|------|
| **Product** | 顧客に独立した価値を提供 | 独立してデプロイ・運用可能 |
| **Feature** | プロダクトの一機能 | プロダクトなしでは意味がない |
| **Component** | 技術的な構成要素 | ユーザーには見えない |
| **Variant** | プロダクトのバリエーション | B2B版、B2C版等 |

---

## 2. ドメイン境界の価値

良いドメイン境界の効果:

```
良い境界 → 疎結合 → 少ない依存関係 → 高速フロー → 幸福なチーム
                                              ↓
                → 高い凝集性 → 明確な目的 → チームの動機付け → 良い製品
```

### 旅行会社のロイヤルティプログラムの例

**悪い境界**（3つのサブドメインに分散）:
```
ロイヤルティアカウント [Team A] ←→ ロイヤルティポイント [Team B] ←→ リワード [Team C]
                       3チーム間の調整が必要
```

**良い境界**（1つのドメインに統合）:
```
ロイヤルティ [1 Team]
  ├── アカウント
  ├── ポイント
  └── リワード
    1チームで完結、調整不要
```

---

## 3. ドメイン識別の原則

### 基本原則

| 原則 | 説明 |
|------|------|
| **境界は目的に依存する** | 普遍的に「正しい」境界は存在しない。組織の目標に最適なものを選ぶ |
| **概念は複数の特性で結合する** | 色でグループ化？形でグループ化？最適な軸を選ぶ |
| **全ての依存関係が同等ではない** | 除去コストと結合コストのトレードオフ |
| **複数のモデルを探索する** | 最初のモデルに固執しない |
| **表面的知識に頼らない** | ドメインへの深い没入が必要 |
| **良い境界は万能薬ではない** | 他の課題（技術的負債、スキルギャップ）も解決が必要 |
| **常に進化を準備する** | 境界は固定ではない。定期的に見直す |

---

## 4. ドメイン境界ヒューリスティクス

### 5つのガイディング・ドメイン境界ヒューリスティクス

| # | ヒューリスティクス | 質問 |
|---|-----------------|------|
| 1 | **ビジネスケイパビリティ** | 「ビジネスが行うこと」は何か？ |
| 2 | **ユーザーの意図** | ユーザーが達成したいことは？ |
| 3 | **ビジネスプロセス** | どのプロセスステップが密に結合しているか？ |
| 4 | **規制とコンプライアンス** | 法的・規制上の境界はどこか？ |
| 5 | **ドメインエキスパートの言語** | 異なる言語（Ubiquitous Language）が使われる境界はどこか？ |

### サブドメイン境界ヒューリスティクス

より詳細な粒度でサブドメインを識別するためのヒューリスティクス:

| ヒューリスティクス | 説明 | 適用例 |
|-----------------|------|--------|
| **言語の変化** | 同じ概念に異なる意味が付与される場所 | 「顧客」が営業とサポートで異なる意味 |
| **ライフサイクルの違い** | 変更頻度やリリースサイクルが異なる | 決済（安定）vs プロモーション（頻繁変更） |
| **データオーナーシップ** | 同じデータの主要な管理者が異なる | 商品情報: カタログチーム vs 在庫チーム |
| **ビジネスルールの密度** | 複雑なビジネスルールが集中する領域 | 保険の査定ルール |
| **技術的制約** | 非機能要件（パフォーマンス、スケーラビリティ）が異なる | リアルタイム処理 vs バッチ処理 |

### サブドメイン・グルーピング・ヒューリスティクス

サブドメインをドメインにグループ化する基準:

| 基準 | 質問 |
|------|------|
| **変更の結合度** | これらのサブドメインは頻繁に一緒に変更されるか？ |
| **チームの認知負荷** | 1チームが理解できる範囲に収まるか？ |
| **ビジネスの関連性** | 同じビジネス目標に貢献するか？ |
| **データの親和性** | 同じデータエンティティを共有するか？ |

---

## 5. EventStormingを使ったドメイン識別

### Pivotal Events（転換点イベント）

ビジネスフローの中で境界を示唆する重要なイベント:

- フェーズの切り替わり（探索 → 注文 → 配送）
- 責任の移転（営業 → オペレーション）
- トランザクションの開始/完了
- 外部システムとのインタラクション

### タイムラインのチャンキング

```
[Pivotal Event A]─────[Pivotal Event B]─────[Pivotal Event C]
    │                      │                      │
    └── Subdomain 1        └── Subdomain 2        └── Subdomain 3
```

1. Pivotal Eventsを特定
2. イベント間のチャンクを仮のサブドメインとする
3. 散在するサブドメインを探す（タイムライン上の離れた場所に同じ概念が出現）
4. サブドメインとユーザージャーニーを区別する

### サブドメインの分析

識別したサブドメインに対して以下を評価:

| 評価観点 | 質問 |
|---------|------|
| **凝集性** | このサブドメイン内の概念は強く関連しているか？ |
| **結合度** | 他のサブドメインとの依存関係はどの程度か？ |
| **認知負荷** | 1チームが理解・管理できる範囲か？ |
| **戦略的重要性** | Core / Supporting / Generic のどれか？ |
| **変更頻度** | どの程度の頻度で変更が必要か？ |

---

## 6. モダナイゼーション機会のマッピング

Product Taxonomyの各領域で以下を評価:

| 課題カテゴリ | 確認事項 |
|------------|---------|
| **依存関係と境界の不整合** | レガシーシステムがドメイン境界を跨いでいないか |
| **不明確/欠如したオーナーシップ** | 各領域に明確な責任者がいるか |
| **スキルギャップ** | 新しいアーキテクチャに必要なスキルがあるか |
| **複雑さと認知負荷** | チームが過大な認知負荷を抱えていないか |
| **マクロレベルの制約** | 組織全体に影響する制約（予算、規制等） |
