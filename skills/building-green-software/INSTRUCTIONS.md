# Building Green Software

## 概要

グリーンソフトウェアエンジニアリングとは、**実行時に最小限の炭素排出量をもたらすソフトウェアを設計・開発・運用する実践**です。

**Green Software Foundation (GSF) の定義:**

グリーンソフトウェアは、以下の3つの柱から構成されます:

1. **エネルギー効率** (Energy Efficiency) - 少ない電力で同じ仕事をする
2. **ハードウェア効率** (Hardware Efficiency) - 少ないハードウェアで同じ仕事をする
3. **カーボンアウェアネス** (Carbon Awareness) - 低炭素な電力が利用可能な時間・場所で動作する

これらは相互に関連し、どれか1つだけでは不十分です。エネルギー効率とハードウェア効率を合わせて**カーボン効率** (Carbon Efficiency) と呼びます。

**グリーンソフトウェアは万能性が求められる:**

グリーンソフトウェアは、生産性、回復性、信頼性、セキュリティ、パフォーマンス、スケーラビリティ、コスト効率性など、すべての要件を満たす**うえで**、カーボン効率とカーボンアウェアネスを実現する必要があります。

---

## 判断フレームワーク: どの戦略を適用すべきか

以下のマトリクスを使用して、状況に応じた最適な戦略を選択します。

| 状況 | 優先戦略 | 二次戦略 | 避けるべきもの |
|------|---------|---------|---------------|
| 新規システム設計 | 運用効率（クラウド、サーバーレス、マルチテナンシー） | カーボンアウェアネス設計（非同期ジョブ分離） | 手動スケーリング、常時稼働専用サーバー |
| 既存システムの最適化 | 運用効率（ライトサイジング、オートスケーリング、ゾンビワークロード削除） | 不要な機能・データの削除（Lean mindset） | コード全面書き換え（費用対効果が低い） |
| 高スケールサービス（数百万ユーザー） | マネージドサービス採用 | コード効率（言語・ライブラリ選定） | 車輪の再発明（自作実装） |
| 低スケールツール（数十ユーザー） | 何もしない（優先度低） | - | コード効率への過度な投資 |
| CPUヘビーなバッチジョブ | カーボンアウェアネス（デマンドシフティング） | Spotインスタンス利用 | 常時稼働・オンデマンド専用インスタンス |
| ユーザー向けアプリケーション | ハードウェア効率（デバイス寿命延長、後方互換性） | クライアントデバイス活用（オフライン対応） | 最新デバイス要求、ソフトウェア定義の陳腐化 |
| ML/AIプロジェクト | モデルサイズ削減（量子化、プルーニング、蒸留） | 学習のデマンドシフティング、専用ハードウェア活用 | 過度に大きいモデル、常に最新GPUを要求 |

**優先順位ガイド（GSMM推奨）:**

1. **運用効率** - 5〜10倍の削減が可能、既存ツール・サービスが豊富、即効性が高い
2. **カーボンアウェアネス** - 2〜5倍の削減が可能、設計段階で組み込むと効果的
3. **コード効率** - 状況次第（高スケールなら効果大、低スケールなら不要）
4. **ハードウェア効率** - デバイス製造時の排出量が大きいため長期的に重要

---

## グリーンデザインパターン クイックリファレンス

設計段階でカーボンフットプリントを最小化するための原則。

### プラットフォーム選択

| 観点 | 推奨 | 理由 |
|------|------|------|
| クラウド vs オンプレミス | クラウド（特にマネージドサービス） | 高いマシン利用率（65%+ vs 10-20%）、マルチテナンシー、運用効率の専門性 |
| インスタンスタイプ | Spot/Preemptible、Burstable（T3/B-series） | スケジューラーに柔軟性を与え、マシン利用率向上、カーボンアウェアネス対応 |
| 専用インスタンス | 避ける | マシン利用率低下、ハードウェア非効率 |
| リージョン選択 | 低炭素電力リージョン（フランス=原子力、北欧=水力・風力） | カーボンインテンシティ最小化 |

### Lean Mindset（やらないことの美学）

**最も効率的なコードは、存在しないコードです。**

| 戦略 | 具体例 |
|------|--------|
| 不要な機能を削除 | 過剰指定されたSLA緩和、実際に使われていない機能の削除 |
| データ保持期間短縮 | ログファイル保持期間の見直し、古いデータのアーカイブ |
| ゾンビワークロード削除 | 使われていないサービス・アプリケーションのシャットダウン |
| プロダクト設計での早期発見 | 要件定義段階で不要な作業を特定し、実装前に削除 |

### マイクロサービスのグリーン化

**トレードオフを理解する:**

| 要素 | グリーン化への影響 |
|------|------------------|
| マイクロサービス化 | ✅ オートスケーリング、独立デプロイ、高マシン利用率（クラスタースケジューラー活用時） |
| 過度な分割 | ❌ オーバープロビジョニング、ネットワーク通信増加、複雑性による非効率 |
| サービスメッシュ | ❌ CPU/メモリオーバーヘッド大（「サーバーでビットコインマイニングするようなもの」） |
| RPC vs REST | RPC（gRPC等）が効率的、RESTは冗長なJSONシリアライズでオーバーヘッド |

**推奨:**
- 必要以上にサービスを分割しない（Keep It Simple）
- サービスメッシュは必要性を慎重に評価
- クラスタースケジューラー（Kubernetes、Nomad等）を活用してマシン利用率向上

### データ管理

| 戦略 | 説明 |
|------|------|
| データベース最適化 | クエリチューニング、不要なデータ削除、インデックス最適化 |
| ストレージポリシー見直し | 冗長性の過剰設定回避（例: リージョン間複製をGitOpsのコールドフェイルオーバーで代替） |
| データ転送最小化 | キャッシング、CDN活用、不要なAPI呼び出し削減 |

### クライアントデバイス活用

**バッテリー充電済みデバイスへの処理移譲:**

| シナリオ | 推奨 | 注意事項 |
|---------|------|---------|
| 計算処理 | クライアントサイドで実行 | データ転送量増加、デバイスアップグレード圧力、データセンターの方が効率的な処理は避ける |
| オフラインファースト | P2Pアーキテクチャ採用 | ネットワーク問題への耐性向上、レイテンシ削減、中央集権サービス依存削減 |

### ライブラリ・サービスの効率的選択

| 原則 | 具体例 |
|------|--------|
| マネージドサービス優先 | 規模と需要があるビジネスがコード効率に投資済み。自社で最適化するよりコスト効率的 |
| 効率的なライブラリ選択 | オープンソースコミュニティにエネルギー効率優先を要求。ベンチマーク比較を参照 |
| レイヤー最小化 | 不要な抽象化レイヤーを避ける（例: 過度なORM、不要なミドルウェア） |

---

## 運用効率 クイックリファレンス

同じアウトプットを少ないマシンとリソースで達成する手法。**5〜10倍の炭素削減が可能**で、比較的容易に実装できます。

### マシン利用率最大化

**目標: アイドル時間を削減し、CPU・メモリ・ディスク・ネットワークを高利用率で稼働**

| 手法 | 説明 | 効果 |
|------|------|------|
| ライトサイジング | 過剰にプロビジョニングされたインスタンスをダウンサイジング | AWS Cost Explorer、Azure Cost Analysis等で特定 |
| オートスケーリング | 需要に応じて自動的にリソースを追加・削除 | CPU使用率、ネットワークトラフィック、予測的スケーリングに基づく。**必ずスケールダウンも設定** |
| Spotインスタンス | AWS Spot、Azure Spot、GCP Preemptible | スケジューラーに裁量を与え、高マシン利用率実現。将来的にカーボンアウェアなタイムシフトにも活用可能 |
| Burstableインスタンス | AWS T3、Azure B-series、GCP Shared-core | オートスケーリングより簡易な代替手段 |

### クラスタースケジューリング

**Google Borgの教訓:**

- コンテナ化されたジョブをTetrisのように密にパッキング
- タスクラベリングとクラスタースケジューラー（Kubernetes、Nomad等）活用
- 結果: 従来の1/3以下のハードウェア・電力で稼働

**要件:**
- ジョブのカプセル化（VM、コンテナ、Serverless関数）
- オーケストレーションレイヤー（ジョブの起動・停止・移動を管理）
- ワークロード特性の明示（適切なインスタンスタイプ選択、リソース要件の過剰指定を避ける）

### サーバーレス・マルチテナンシー

| 技術 | 効果 |
|------|------|
| Serverless（Lambda、Azure Functions、Google Serverless） | 高いマルチテナンシー、自動スケーリング、自動ライトサイジング |
| マルチテナントSaaS | 数百万ユーザー間でリソース共有、ハードウェアフットプリント最小化 |

### LightSwitchOps（電源を切る）

**「Always-onは持続不可能」- Paul Johnston**

| アクション | 理由 |
|----------|------|
| ゾンビワークロード削除 | 自動起動・停止できないサービスは価値がない証拠 |
| 未使用サービスのシャットダウン | 環境負荷だけでなくセキュリティリスクも削減 |
| 開発・テスト環境の夜間停止 | 業務時間外の無駄な稼働を削減 |

### SRE原則とグリーン運用

**Site Reliability Engineering (SRE) の実践をグリーン運用に適用:**

- **エラーバジェット**: 炭素排出量バジェットとして管理
- **トイル削減**: 手動運用を自動化し、人的ミスと非効率を削減
- **Infrastructure as Code (IaC)**: Terraform、Pulumi等でインフラを宣言的に管理、再現性と効率性向上

詳細は [EFFICIENCY-PATTERNS.md](references/EFFICIENCY-PATTERNS.md) を参照してください。

---

## カーボンアウェアコンピューティング クイックリファレンス

電力グリッドの炭素強度（Carbon Intensity）が低い時間・場所で処理を実行する手法。

### カーボンインテンシティの理解

**Carbon Intensity (CI)**: 電力1kWh生成あたりのCO₂排出量（単位: gCO₂/kWh）

| 電源 | 炭素強度（目安） |
|------|------------------|
| 石炭 | 高（800-1000 gCO₂/kWh） |
| 天然ガス | 中（400-500 gCO₂/kWh） |
| 原子力 | 低（10-50 gCO₂/kWh） |
| 水力・風力・太陽光 | 極低（0-50 gCO₂/kWh） |

**変動要因:**
- 時間帯（昼間=太陽光、夜間=化石燃料）
- 天候（風力・太陽光の変動）
- 需要（ピーク時=マージナルパワー発電所稼働）

### デマンドシフティング

**時間シフティング（Temporal Shifting）:**
- 非時間依存ジョブ（MLトレーニング、バッチ処理）を低CI時間帯に移動
- 例: 昼間の太陽光ピーク時、深夜の低需要時

**場所シフティング（Spatial Shifting）:**
- ワークロードを低CIリージョンに移動
- 例: フランス（原子力）、北欧（水力・風力）

**適用例:**
- Spotインスタンス: スケジューラーがタイムシフト可能
- 非同期ジョブキュー: 低CI時に実行タイミング調整
- Google: カーボンアウェアデータセンター運用で既に実践

### デマンドシェイピング

**Graceful Degradation（段階的劣化）:**

| CI状態 | サービスレベル | 例 |
|--------|--------------|-----|
| 低CI | フル機能提供 | HD動画、高品質画像、全機能利用可能 |
| 中CI | 一部機能制限 | SD動画、圧縮画像、一部機能遅延 |
| 高CI | 最小限機能 | 静止画のみ、テキストのみ、キャッシュデータのみ |

**実例:**
- Xbox: 低CI時にゲームダウンロード、高CI時は延期
- iPhone: 充電がクリーンエネルギー時に最適化充電
- ビデオ会議: 帯域幅不足時に画質低下（同様にCI不足時に画質低下可能）

### ツール

| ツール | 機能 | URL |
|--------|------|-----|
| Electricity Maps | 世界中のリアルタイムCI可視化 | [electricitymaps.com](https://electricitymaps.com) |
| WattTime API | 予測CI、最適実行時間推奨 | [watttime.org](https://watttime.org) |
| Carbon Intensity API（UK） | イギリスのCI予測 | [carbonintensity.org.uk](https://carbonintensity.org.uk) |
| Grid-Aware SDK | カーボンアウェアアプリ開発SDK | Green Software Foundation |

詳細は [CARBON-AWARENESS.md](references/CARBON-AWARENESS.md) を参照してください。

---

## グリーンAI/ML クイックリファレンス

機械学習（ML）・AI・LLMは膨大な計算リソースを消費します。データセンター容量の急増要因となっており、グリーン戦略が不可欠です。

### MLライフサイクル全体での最適化

| フェーズ | 戦略 |
|---------|------|
| **プロジェクト計画** | SLA/SLO見直し（過剰な精度要求を削減）、カーボンアウェアネス機能組み込み |
| **データ収集** | 既存データセット活用（再収集回避）、データ収集のデマンドシフティング |
| **モデル設計** | 小規模モデル優先、量子化・プルーニング・蒸留技術適用 |
| **学習** | 低CIリージョン・時間帯選択、専用ハードウェア（TPU、GPU最適化）、Spotインスタンス利用 |
| **デプロイ** | エッジコンピューティング活用（推論をデバイス側で実行） |
| **メンテナンス** | モデル最適化（定期的な再トレーニング、不要なモデル削除） |

### モデルサイズ削減技法

| 技法 | 説明 | 削減効果 |
|------|------|---------|
| **量子化 (Quantization)** | 浮動小数点精度を下げる（FP32 → FP16 → INT8） | メモリ・計算量50-75%削減 |
| **プルーニング (Pruning)** | 不要な重みを削除 | パラメータ数30-90%削減 |
| **蒸留 (Distillation)** | 大規模モデルの知識を小規模モデルに転移 | モデルサイズ10-100倍削減、精度は90-95%維持 |
| **Federated Learning** | データをデバイスに残し、モデル更新のみ送信 | データ転送量削減、プライバシー保護 |

### 推論の効率化

| 戦略 | 説明 |
|------|------|
| バッチ推論 | 複数リクエストをまとめて処理 |
| キャッシング | 同一入力の推論結果を再利用 |
| 事前計算 | 予測可能な推論を事前実行 |
| エッジ推論 | モデルをクライアントデバイスにデプロイ |

詳細は [GREEN-AI.md](references/GREEN-AI.md) を参照してください。

---

## 測定と成熟度

### Software Carbon Intensity (SCI) 仕様

**GSF標準の炭素測定方法論:**

```
SCI = ((E * I) + M) / R
```

- **E**: エネルギー消費量（kWh）
- **I**: カーボンインテンシティ（gCO₂/kWh）
- **M**: エンボディドカーボン（製造時排出量、gCO₂）
- **R**: 機能単位（例: APIリクエスト、ユーザー、トランザクション）

**特徴:**
- カーボンオフセット（炭素クレジット購入）は除外
- 実際の排出削減のみをカウント
- 機能単位で正規化し、比較可能

### GHG Protocol Scope 1/2/3

| Scope | 定義 | ソフトウェアへの適用 |
|-------|------|---------------------|
| Scope 1 | 直接排出（自社所有の燃焼） | オンプレミスデータセンターの発電機 |
| Scope 2 | 間接排出（購入電力） | データセンター電力消費 |
| Scope 3 | その他間接排出（サプライチェーン） | ハードウェア製造（エンボディドカーボン）、エンドユーザーデバイス |

### Green Software Maturity Matrix (GSMM)

**5レベルの成熟度モデル:**

| レベル | 状態 | 特徴 |
|--------|------|------|
| **Level 1** | 未着手 | グリーンソフトウェアへの取り組みなし |
| **Level 2** | 基礎 | 運用効率改善開始、測定ツール導入 |
| **Level 3** | 実践 | カーボンアウェアネス実装、継続的最適化 |
| **Level 4** | 最適化 | コード効率改善、エンボディドカーボン管理 |
| **Level 5** | 24/7カーボンフリー | 常時クリーンエネルギーで稼働可能 |

**GSMM推奨アプローチ:**
1. まず運用効率（Level 2）
2. 次にカーボンアウェアネス（Level 3）
3. 最後にコード効率（Level 4）- 既製品購入を優先

### 測定ツール

| カテゴリ | ツール | 説明 |
|---------|--------|------|
| **クラウドプロバイダー** | AWS Customer Carbon Footprint Tool | AWSリソースの炭素排出量推定 |
| | Azure Carbon Optimization | Azureサービスの炭素分析 |
| | Google Cloud Carbon Footprint | GCPプロジェクトの炭素追跡 |
| **オープンソース** | Cloud Carbon Footprint (CCF) | マルチクラウド炭素排出量可視化 |
| **クライアントサイド** | CO2.js | Webサイトの炭素排出量推定 |
| **ハードウェア** | Scaphandre | サーバーのリアルタイム電力消費測定 |

詳細は [MEASUREMENT-AND-MATURITY.md](references/MEASUREMENT-AND-MATURITY.md) を参照してください。

---

## ユーザー確認の原則（AskUserQuestion）

### 確認すべき場面

以下の場合は **必ず AskUserQuestion で確認** してください:

| 状況 | 確認内容 |
|------|---------|
| 大規模リファクタリング | 言語変更（Python → Rust等）、アーキテクチャ刷新 |
| SLA/SLO変更 | ユーザー影響のある性能・可用性の緩和 |
| リージョン変更 | データ主権、レイテンシへの影響 |
| 機能削除 | 使用状況不明な機能の削除提案 |
| コスト影響 | 大幅なインフラ変更、新規サービス導入 |

### 確認不要な場面

以下は **エンジニアの裁量で実行可能**（確認不要）:

| 状況 | 理由 |
|------|------|
| ライトサイジング | AWS Cost Explorer等で明確に過剰プロビジョニングが判明 |
| Spotインスタンス採用 | 既存のBest Practice、自動フェイルオーバーで透過的 |
| ゾンビワークロード削除 | 明らかに未使用（アクセスログゼロ、所有者不在） |
| オートスケーリング設定 | 技術的な運用改善、ユーザー影響なし |
| ログ保持期間短縮 | 法的要件を満たす範囲内での最適化 |

---

## Related Skills

- [designing-monitoring](../designing-monitoring/SKILL.md) - 監視システム設計、SLO/SLI、オブザーバビリティ（グリーンソフトウェア測定と相互補完）
- [architecting-microservices](../architecting-microservices/SKILL.md) - マイクロサービスアーキテクチャ（グリーン化のトレードオフを理解）
- [implementing-opentelemetry](../implementing-opentelemetry/SKILL.md) - OpenTelemetry実装（カーボンメトリクス収集に活用可能）

---

## References

- [EFFICIENCY-PATTERNS.md](references/EFFICIENCY-PATTERNS.md) - コード効率・運用効率の詳細パターン
- [CARBON-AWARENESS.md](references/CARBON-AWARENESS.md) - カーボンアウェアネスの詳細（デマンドシフティング・シェイピング、ツール詳細）
- [HARDWARE-AND-NETWORKING.md](references/HARDWARE-AND-NETWORKING.md) - ハードウェア効率・エンボディドカーボン・ネットワーク最適化
- [GREEN-AI.md](references/GREEN-AI.md) - グリーンML/AI/LLMの詳細技法
- [MEASUREMENT-AND-MATURITY.md](references/MEASUREMENT-AND-MATURITY.md) - 測定方法論・ツール・GSMM詳細
