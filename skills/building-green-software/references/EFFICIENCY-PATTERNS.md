# EFFICIENCY-PATTERNS.md

グリーンソフトウェアにおけるコード効率と運用効率のベストプラクティス集。

---

## コード効率（Code Efficiency）

### パフォーマンス vs 効率 vs グリーンの違い

- **効率的なコード**: 必要以上の処理を行わない
- **高速なコード**: 実行時間が短い
- **グリーンなコード**: 炭素排出量が少ない

これらは必ずしも同義ではない:
- 遅いコードでも、低炭素電力を待つ設計（carbon-aware）であればグリーンになる
- 高頻度取引のような高速コードは、大量のハードウェアと電力を消費し、グリーンではない
- 余剰電力を使う場合、エネルギー効率が悪くてもグリーンになりうる

### コード再利用のトレードオフ

**API利用 vs カスタム効率化**

現代の開発は、サードパーティAPIやライブラリの再利用を前提としている。これにより開発者生産性は向上するが、機械効率は犠牲になる:

- APIは汎用的に設計されており、特定のユースケースには過剰な処理を行う
- ネットワーク越しのサービス呼び出しは、ローカル処理より20倍以上遅い
- RESTful/SOAPメッセージは、RPCメッセージ（gRPCなど）より約20倍遅い

**しかし、カスタムコードを書くのは非現実的**:
- 開発者の時間が膨大にかかる
- 専門スキルが必要
- ビジネス競争力を失う

### 開発者生産性とのバランス

**Developer Productivity vs Machine Productivity**

過去30年間、ハードウェアの進化（Moore's Law）により得られた性能向上は、主に開発者生産性の向上に使われてきた:
- 抽象化レイヤーで複雑さを隠す
- サードパーティサービスの活用
- セキュリティとスピードの両立

この流れを逆戻りさせることは不可能であり、グリーンソフトウェアは開発者生産性と両立する必要がある。

### ハイパー効率的なコード（Background）

**特殊な領域でのみ実践される**:
- ネットワークデータプレーン
- クラウドプロバイダーの基盤サービス
- ヘビーに使われるオープンソースライブラリ
- 医療機器などの組み込みシステム

**手法**:
- C、C++、Rust、アセンブリ言語
- 最小限の命令数
- OSに近い実行環境
- L1/L2/L3キャッシュの最適利用

**コンパイラの役割**:
- 現代のコンパイラは人間より最適化が上手
- LLMによるコンパイラ技術の革新が進行中

---

## グリーンデザインパターン（Green Design Patterns）

### レイヤー最小化（Avoid Too Many Layers）

APIレイヤーは便利だが、各レイヤーを越える度に処理が追加される。不必要なCPU集約型アーキテクチャを避ける:
- 重複した処理を排除
- プラットフォームの意図した使い方を守る

### マイクロサービスのグリーン化（Be Mindful with Microservices）

**課題**:
- サービス間の高トラフィック
- 多層的で CPU 集約的な通信
- プラットフォームオーバーヘッド

**緩和策**:
- メッセージ数を減らす（大きなメッセージを少なく）
- RPC（gRPC）を使う（RESTfulより約20倍高速）
- サービスメッシュの慎重な選択（パフォーマンス重視のものを選ぶ）
- 適切なマイクロサービス設計（Sam Newman『Building Microservices』推奨）

**注意: Service Mesh の問題**:
- Sidecar方式は各メッセージに追加ステップを挿入
- 高パフォーマンスを約束するメッシュを選ぶ

**モノリス vs マイクロサービス**:
- モノリスはサービス間トラフィックが少なく効率的だが、運用上のグリーン化が困難
- マイクロサービスは運用上のグリーン化がしやすい
- トレードオフを理解し、適切な選択を

**事例: Amazon Prime Video (2023)**:
- 当初はサーバーレスアーキテクチャ
- スケールに応じて大きなコードチャンクに再設計
- 効率は上がるが、開発・反復コストも上がる

### 非効率なサービス・ライブラリの置き換え

**手法**:
- パフォーマンスプロファイリングで遅いライブラリ・サービスを特定
- グリーン志向のコミュニティを持つ代替品に移行
- 高品質なライブラリ・サービスの提供者に、炭素効率と炭素意識を要求する

### Lean Mindset: 不要なものを削除

**Leanソフトウェアとの整合性**:
- 無駄な時間、労力、リソース、機能を排除
- 必要になるまで実装しない（YAGNI）

**具体策**:
- 使われていない機能を削除（セキュリティホールの削減にもつながる）
- ほとんど照会されないデータを削除
- データ保持ポリシーをデフォルトで厳格に
  - デフォルトで一定期間後に自動削除
  - 長期保存が必要な場合はテープストレージ（SSDの数分の一の電力）

**データベース最適化**:
- データを最小化
- クエリをチューニング
- 余剰データは毎回のインタラクションでパフォーマンスと電力を浪費

### クライアントデバイスの活用

**エンボディッドカーボンの有効活用**:
- スマートフォン等のエンボディッドカーボンは巨大
- デバイスにより多くの処理をさせ、データセンターの負荷を減らす
- デバイスの寿命を延ばす

**追加のメリット**:
- バッテリーはグリッド負荷の平準化に貢献
- 低炭素電力でデバイスを充電可能
- ネットワーク障害への耐性向上（気候変動による不安定な気候への備え）

### ML管理（Manage Machine Learning）

**データ収集**:
- 大規模データセットは魅力的だが、Lean的には無駄が多い
- オープンソース・既存データセットの活用
- 過剰なデータ収集を避ける

**トレーニング**:
- モデルサイズを縮小（Federated Learning、Pruning、Compression、Distillation、Quantization）
- 事前学習済みモデルの活用
- エッジコンピューティングでの小型モデル
- **最重要**: トレーニングは緊急でないため、必ず carbon-aware に実行（低炭素電力を待つ）

---

## 運用効率テクニック（Operational Efficiency）

### マシン利用率（Machine Utilization）とは

**定義**: 単一マシンやクラスターに作業を詰め込み、CPU、メモリ、ネットワーク帯域幅、ディスクI/O、電力の利用を最大化すること。

**重要性**:
- コード効率だけでは不十分（CPUを99%削減しても、同じサーバーを使っていれば電力削減は限定的）
- 部分的に使用されているマシンも、フル稼働時と同程度の電力を消費（最大60%）
- エンボディッドカーボンの削減にも寄与

### ライトサイジング（Rightsizing）

**オーバープロビジョニング回避**:
- 必要以上に大きなマシンを使わない
- 高いマシン利用率 = 電力効率向上 + エンボディッドカーボン削減

**課題**:
- 新サービスの挙動が予測困難
- 大きめにしておくのはリスク管理として妥当
- 後でリサイズする時間がない

### オートスケーリング（Autoscaling）

**理論上は理想的**:
- 需要に応じてリソースを自動調整
- クラウド・オンプレミス両方で利用可能

**実際の課題**:
- スケールアップは簡単だが、スケールダウンはリスクが高い
- 自動スケールダウンが設定されていないことが多い
- 手動でのスケールダウンは手間がかかる

### バースタブルインスタンス（Burstable Instances）

**特性**:
- ベースラインCPUパフォーマンス + 必要時の短期バースト
- CPUクレジットで管理
- 一貫した高CPU性能より安価

**利点**:
- コスト削減
- グリーン（需要スパイク対応しつつ、通常時は省リソース）
- 自動スケールダウン
- サーバー密度管理をクラウドプロバイダーに委譲

**欠点**:
- CPUクレジット枯渇のリスク
- 一貫した高CPU需要には不向き
- パフォーマンスが可変
- CPUクレジット管理の複雑さ

### Infrastructure as Code (IaC) / GitOps

**IaCの利点**:
- インフラをコードで定義・設定・デプロイ
- 自動化、再現性、バージョン管理
- ライトサイジング・オートスケーリングの自動化を促進

**GitOps**:
- Gitをバージョン管理システムとして使用
- 変更はGitで管理され、リポジトリの希望状態と継続的に調整
- 監査証跡の提供

**GreenOps**:
- CNCF Environmental Sustainability Groupが推進
- **GreenOps = GitOps + FinOps** (Figure 4-1)
- コスト削減テクニック（FinOps）とグリーンは整合

### クラスターシケジューリング（Cluster Scheduling / DevOps Tetris）

**コンセプト**:
- 異なる形状のワークロードをサーバーに効率的にパッキング（DevOps Tetris）
- 最小限のマシンクラスターで同量の作業を実行

**仕組み**:
- 高I/O・低CPUのアプリと、高CPU・低I/Oのアプリを同一サーバーに配置
- ノード・ハードウェア・ネットワーク障害時に自動再起動
- 最大80%のマシン利用率を達成

**ツール**:
- **Kubernetes** (Googleの内部スケジューラBorgの簡易版)
- **HashiCorp Nomad**
- **EKS / GKS / AKS** (AWS / Google / Azure)
- **ECS** (AWS Container Service)

**要件**:
1. **ジョブのカプセル化** (依存関係を含めて移動可能にする)
2. **高速インスタンス化** (数分ではなく秒単位)
3. **ラベリング** (高可用性要件などをスケジューラに通知)

**カプセル化技術**:
- Docker / Containerd
- 軽量VM（AWS内部では軽量VMを使用）

**情報の必要性**:
- Kubernetes: Podの定義でCPU・メモリのrequests（最小）とlimits（最大）を指定
- 制約指定は困難
- **Kubernetes Vertical Pod Autoscaler**: レコメンダーモード・自動化モード

**クラウドでの恩恵**:
- クラウドプロバイダー独自のスケジューラが稼働
- 適切なインスタンスタイプを選ぶことでスケジューラに特性を伝える
- 専用インスタンス指定は避ける（カーボン意識が低く、マシン利用率が低い）
- オーバーサブスクリプション（過剰割り当て）でプロバイダーがリソース最適化

**混合ワークロード（Mixed Workloads）**:
- 多様で十分にラベル付けされたタスクと多数の物理マシンで最も効果的
- ハイパースケーラーには有利（多様な顧客ワークロード）
- 小規模セットアップ（オンプレの少数ノード、専用クラウドVM）では効果が限定的

**AWSの利用率**:
- オンプレより1/4以下のハードウェアで同量の作業を実行可能（と主張）
- 最適化されたサービスとスケジューラの活用が前提（lift-and-shiftは不可）

### タイムシフティング・スポットインスタンス

**タイムシフティングの追加次元**:
- 低優先度・遅延可能なジョブを認識・管理できるアーキテクチャ
- カーボン意識には不可欠
- Paul Johnston: "Always on is unsustainable"

**スポットインスタンス**:
- クラウドプロバイダーの余剰キャパシティを活用
- 完了保証なし、いつでもプリエンプト可能
- 90%割引
- ジョブをVMでラップ + 時間非感受性ラベル + プロバイダーに自由スケジュール

**事例: Skyscanner (Chaos Engineering)**:
- AWSスポットインスタンスに大部分移行
- 主な動機: カオスエンジニアリング（本番環境を不安定にして堅牢性向上）
- 副次効果: コスト削減、炭素排出削減
- 堅牢性、コスト削減、炭素削減の三方良し

### マルチテナンシー（Multitenancy）

**定義**: 単一サーバーインスタンスを複数ユーザーで共有

**重要性**:
- 高いマシン利用率には不可欠
- テナントが多様であるほど、利用率が向上

**相関需要の回避**:
- eコマース業者だけだと、Black Fridayやクリスマスに集中
- 時間非感受性ワークロード（MLトレーニング等）と混合が理想
- 異なる日時・時間帯に需要があるテナント混合が最適

### サーバーレスサービス（Serverless Services）

**特性**:
- マルチテナント
- カプセル化されたジョブ
- 高速インスタンス化
- 短時間・シンプルなジョブ
- スケールが大きい

**ポテンシャル**:
- 安価でグリーンになる大きなポテンシャル
- 現状はまだ改善の余地あり
- 利用者が増えるほど効率化が進む

**事例: AWS Lambda**:
- 初期はリソース消費大（グリーンではなかった）
- 需要が明確になり、Firecracker（軽量VM）を開発
- インスタンス化時間短縮、スケジューリング改善
- 需要拡大に伴い、さらなるコモディティ化が期待される

### ハイパースケーラーと利益（Hyperscalers and Profit）

**秘密**: 最も安価なサービスが最も利益率が高い（Adam Jackson, ex-Azure DevRel）

**理由**:
- 安価なサービスは効率的で高スケール
- 効率 ≒ グリーン
- Adam Smith: "自己利益の追求が社会の利益になる"

**ビジネスアライメント**:
- ホスティングコスト削減 = グリーン
- DC運営者にとっても利益になる
- 投資意欲と資本を持つプロバイダーを選ぶ

### SRE プラクティス（Site Reliability Engineering）

**SREとグリーンの整合性**:
- 監視（炭素排出を含む）
- CI/CD（炭素削減の高速・安全な提供）
- 自動化（IaC等、ライトサイジング支援）
- コンテナ化・マイクロサービス（オンデマンド不要、カーボン意識可能）

### LightSwitchOps（Holly Cummins, Red Hat）

**コンセプト**: 照明スイッチのように、簡単にマシンをオン・オフできる状態にする

**ゾンビワークロード**:
- もはや使われていないアプリケーション・サービス
- **VMware Singapore DC統合 (2019)**: ホストマシンの66%がゾンビだった

**ゾンビ撲滅手法**:
- **Scream Test**: サーバーを停止してみて、誰かが叫ぶか確認
- **固定有効期限**: 6ヶ月後に自動停止、継続使用は明示的リクエスト

**課題**: 再起動できるか不安

**LightSwitchOpsの実践**:
- 照明のように安心してオフにできる状態を維持
- Ross Fairbanks推奨: テスト・開発システムを夜間・週末に自動停止

**副次効果: セキュリティ**:
- Ed Harrison (元Metaswitch Security Head): 大規模サイバーセキュリティ事件は、誰も知らないシステムが原因
- セキュリティチームは攻撃面を削減したい
- 不要システムの停止はセキュリティ向上にもなる

### ロケーション選択（Location, Location, Location）

**重要性**: 最も簡単なグリーン運用の一歩

**低炭素電力地域**:
- フランス（原子力）
- スカンジナビア（風力・水力）

**事例: Financial Times**:
- オンプレミスDCからEUのサステナブルリージョンに移行（約10年）
- 2018年時点で75%完了、インフラの約67%が"カーボンニュートラル"サーバー
- 2020年完了後、AWSの100%再生可能エネルギー目標（2025年）を継承
- グリーンプラットフォームを選べば、努力が自動的に実現される

---

## 効率 vs レジリエンス（Efficiency versus Resilience）

### トレードオフ

効率とレジリエンスは常に緊張関係にある:
- 効率化は複雑さと脆弱性を増す
- 効率改善にはレジリエンス向上作業も必要

**例**:
- クラスターシケジューラは複雑でセットアップが難しい
- マルチテナンシーはプライバシー・セキュリティ・障害波及のリスク
- マシン停止もリスク
- オーバープロビジョニングは堅牢性向上の安価な手段（開発者時間的に）

### カウンターアーギュメント

クラスターシケジューラは効率だけでなくレジリエンスにも貢献:
- ノード・ハードウェア・ネットワーク障害時の自動再起動
- 高可用性の実現

### 実例

**Microsoft Teams (COVID-19)**:
- 効率改善だけでなく、テスト強化（カオスエンジニアリング）も必要

**Skyscanner**:
- スポットインスタンス採用でレジリエンス向上
- 動機はレジリエンステストの強制

### スケールと専門化のリスク

**EU懸念**: 数社の米国ハイパースケーラーへの過度な依存 → 脆弱性
- SDIA (Sustainable Digital Infrastructure Alliance) 設立
- 一方、集中によりマシン数・電力削減

**EU の取り組み**:
- 排出透明性義務化（支持）
- DC熱のプール・地域暖房利用義務（実効性に疑問）
- 都市部より風力・太陽光発電所近くへのDC配置を推奨

---

## まとめ: グリーン運用ツール・テクニック

### 基本原則: マシン利用率の最大化

1. **LightSwitchOps**: 使用頻度が低い・使っていない時間帯はオフ（テストシステムの週末停止等）
2. **オーバープロビジョニング回避**: ライトサイジング、オートスケーリング、バースタブルインスタンス（スケールダウンも忘れずに）
3. **コスト削減**: AWS Cost Explorer / Azure Cost Analysis / CloudZero / ControlPlane / Harness 等で監査 → 安価 ≒ グリーン
4. **コンテナ化マイクロサービス**: 低優先度・遅延可能タスク認識 → 高マシン利用率（ただしマイクロサービス過剰は逆効果、Sam Newman『Building Microservices』参照）
5. **クラウドインスタンスタイプ**: 専用インスタンス避ける、プロバイダーに柔軟性を与える
6. **マルチテナンシー**: 共有VM、マネージドコンテナプラットフォーム
7. **効率的クラウドサービス**: バースタブルインスタンス、マネージドDB、サーバーレス、または同等のOSSプロダクト（グリーンコミットメントとスケール必須）
8. **スポットインスタンス**: 安価、効率的、グリーン、レジリエンス促進
9. **SRE原則**: CI/CD、モニタリング、自動化
10. **ロケーション選択**: 低炭素電力地域

### 最も効果的なステップ（開発者・運用生産性との整合）

- SRE原則
- マルチテナンシー
- マネージドサービス
- グリーンOSSライブラリ
- スポットインスタンス

これらは長期的に開発・運用時間を削減し、コモディティ化・スケールにより安価でグリーンになる。

### 目標: 1000倍の炭素効率化

運用効率 + デマンドシフティング + （最終的に）コード効率の組み合わせで達成:
- 過去30年の開発者生産性向上分を開放
- **開発者生産性を維持したまま**

10年かかるが実現可能。すべてのプラットフォームサプライヤー（パブリッククラウド、OSS、クローズドソース）に、このレベルのグリーンを達成する信頼できる戦略があるか常に問う:

**"Is this a green platform?"**
