# CARBON-AWARENESS.md

カーボン意識（Carbon Awareness）の実践ガイド: デマンドシフティングとデマンドシェイピング。

---

## カーボン意識とは

**定義**: 電力がクリーン（低炭素）な時にアプリケーションで多くの処理を行い、ダーティ（高炭素）な時に少なくする考え方。

**注目度**:
- Green Software Foundation 2023 State of Green Software Report: "carbon-aware software is central to decarbonization"
- 現在8%が実践中、46%が開始を希望
- Microsoft Windows 11 (2022年9月): Windows Update がカーボン意識対応
- Google (2021年5月): カーボン意識アプローチを全面採用

---

## カーボンインテンシティ（Carbon Intensity of Electricity）

### 定義と測定

**カーボンインテンシティ**: 消費される電力1キロワット時（kWh）あたりに排出される二酸化炭素等価物（CO₂e）の量。

- **標準単位**: gCO₂e/kWh（グラムCO₂等価物/キロワット時）
- 再生可能エネルギー直接利用（風力発電等）: カーボンインテンシティは技術的にゼロ
- 実際のグリッド: 低炭素・高炭素源のミックス

**例: Google Cloud**:
- 200 gCO₂e/kWh 未満を "low carbon" リージョンと定義

### カーボンインテンシティの変動性

**地理的変動**:
- 台湾・英国: 風力発電が豊富（2023年Q1、英国で初めて風力発電がガス火力を上回った）
- 北欧諸国: 水力発電が主要な再生可能エネルギー源

**時間的変動**:
- 再生可能エネルギーは天候依存（風・太陽光）
- 夜間と朝8時の間は逆ベルカーブ（Figure 5-3）
- 1時間遅らせることで約100 gCO₂e/kWh削減可能

### 電力グリッドの仕組み

**電力需要**:
- 供給は常に需要に一致する必要がある
- 国家グリッドが需給バランスを維持

**ディスパッチ可能性（Dispatchability）**:
- 化石燃料: 即座に発電量調整可能（石炭燃焼の増減）
- 再生可能エネルギー: 天候制御不可、ディスパッチ可能性が低い

**ブラウンアウト vs ブラックアウト**:
- **ブラウンアウト**: 需要急増による電圧低下
- **ブラックアウト**: 完全な停電（供給過剰でインフラ保護のためブレーカートリップ）

**カーテイルメント（Curtailment）**:
- 再生可能電力が過剰な場合の意図的な供給削減
- ブラックアウト回避のため、余剰電力を捨てる

### マージナルパワー・マージナルエミッション

**マージナルパワープラント**:
- 追加需要を満たす最も安価で余剰キャパシティのある発電所
- コスト順にディスパッチ

**例**:
- グリッド構成: 太陽光50% + 石炭50%
- 追加電力需要 → 通常は石炭発電所が対応（高ディスパッチ可能性）
- 結果: マージナルエミッションの発生

**実例: 台湾・新竹の猛暑**:
- 早朝、多くの人がエアコン稼働
- 需要急増 → ガス火力発電所が即座に発電量増加（マージナルプラント）
- 朝のピーク終了 → 需要安定 → 再生可能エネルギー利用再開
- 日中の太陽光過剰 → カーテイルメント

---

## ツール（Tooling）

### 英国: Carbon Intensity API

- **提供**: UK National Grid + NGO + 学術機関
- **機能**: 英国各リージョンの96時間先までのカーボンインテンシティ予測（ML使用）
- **活用**: 電力使用スケジューリングで炭素排出最小化

### グローバル: Electricity Maps

- **パートナー**: AWS、Google、Salesforce等
- **カバー**: 50+カ国、160+ゾーン
- **データ**: 過去、リアルタイム、今後24時間予測
- **Google活用**: ワークロードシフト、24/7 CFE（Carbon-Free Energy）レポート
  - 目標: 2025年までに24/7 CFE運用の最初の主要クラウドプロバイダー

**24/7 CFE**: すべてのkWh消費をカーボンフリー発電と一致させる（国連の"完全に脱炭素化された電力システム"の最終目標）

### WattTime API

- カーボンインテンシティAPI

### Carbon Aware SDK（Green Software Foundation）

- **形態**: WebApi、CLI
- **用途**: カーボンインテンシティ情報の統合
- **活用例**: GSF初回ハッカソン Carbon Hack 22 で50以上のプロジェクト（Kubernetes拡張、UIデザイン調整等）

---

## デマンドシフティング（Demand Shifting）

### 基本戦略

**カーボン意識の核心**: カーボンインテンシティの変動に応じてアプリケーションの時間・場所を移動する。

**技術的背景**:
- ロードバランシング（LB）
- コンテンツデリバリーネットワーク（CDN）

### タイムシフティング（Time Shifting）

**定義**: カーボンインテンシティが低い時間帯にワークロードを移動。

**適用例**:
1. **MLモデルトレーニング**:
   - 時間非感受性
   - グリーンエネルギー時間帯に実行
   - University College Dublin研究: 45%～99%の炭素削減

2. **バッチ処理**:
   - ソフトウェア更新、システムバックアップ
   - 任意の時間帯に実行可能
   - Microsoft Windows Update: 99%炭素削減

3. **ビデオストリーミング・ゲーミング**:
   - 高電力消費
   - 柔軟な視聴（高炭素時間帯に一時停止、低炭素時間帯にダウンロード）
   - **システム変更推奨**: CDNへの自動キャッシング（グリーン電力時）→ ユーザーは昼夜問わず視聴可能

**効果**:
- ROI（投資収益率）向上
- パフォーマンス向上

### ロケーションシフティング（Location Shifting / Spatial Shifting）

**定義**: カーボンインテンシティの変化に応じて、アプリケーションを別の物理的場所に移動。

**適用例**:
- アジアのGCPリージョン → 低炭素エネルギー源のリージョン（レイテンシーが問題でない場合）
- 大規模データ処理、3Dアニメーションレンダリング等の短命・非リアルタイム計算

---

## デマンドシェイピング（Demand Shaping）

### 基本概念

**前提の違い**: デマンドシフティングは「一定の電力供給」を前提とするが、再生可能エネルギー供給は不安定。

**デマンドシェイピング**: カーボンインテンシティが低い時にソフトウェアで多く処理し、高い時に少なく処理する。

### 既存技術との類似性

**ビデオ会議アプリ（Zoom、Google Meet）**:
- ネットワーク帯域幅の変動に対応
- 帯域不足時: ビデオ品質を自動低下、音声を優先

**PWA（Progressive Web Applications）**:
- プログレッシブローディング（Lazy Loading）
- 遅いネットワークでのパフォーマンス向上

### カーボン意識への応用

**監視対象**: CO₂e排出量（電力生成の副産物）

**実装方法**:
1. **自動化**: ネットワーク不安定時の対応と同様、カーボンインテンシティに応じた自動調整
2. **ユーザー選択**: 消費削減（Consumption Reduction）の観点
   - 高炭素時間帯にプロセスキャンセル・ライブストリーミング停止のオプション提供

---

## 注意点・デビルズアドボケート（Devil's Advocates）

### ロケーションシフティングの課題

**過度な懸念（誤解）**:
- 全世界が低炭素リージョン（フランス等）にワークロード移動 → 過負荷、レイテンシー増加、サービス停止、スロットリング
- **現実**: マイクロサービス1つ移動するだけでも困難（技術実装、法的要件）

**考慮すべき実際の課題**:

1. **SLA（Service-Level Agreement）**:
   - 信頼性は環境より優先
   - ただし、SLA見直しは珍しくない（ビジネス要件・技術スタック変更時）

2. **リソース可用性**:
   - 移動先リージョンに十分なリソースがない場合は移行不可
   - カーボンインテンシティとリソース可用性の両方を監視

3. **追加作業とコスト**:
   - 追加メトリクス設定
   - クラウドコスト増加の可能性

4. **規制・法的要件**:
   - 各国のデータ保存・ガバナンス要件
   - プライバシー法
   - **最大のハードル**

### タイムシフティングの優位性

**ロケーションシフティングと比較して**:
- 国境を越えたデータ移動不要
- 新リージョンでのコンプライアンス不要
- パフォーマンス・レイテンシー懸念が少ない
- 追加リソース不要、転送コスト不要
- レイテンシー非感受性ワークロードはスポットインスタンスで安価運用可能

### 動的電力価格（Dynamic Electricity Pricing）

**現状**: ほとんどの国で固定価格（スペイン・北欧は既に導入）

**将来**: 再生可能エネルギー価格に基づく動的価格設定が全世界に普及

**影響**: カーボン意識がコスト削減にも直結

---

## 実世界の事例（Real-World Examples）

### Google

**タイムシフティング（2020年開始）**:
- 全データセンターで毎日、時間ごとのガイドライン計算
- Electricity Maps提供の予測（翌日のグリッドカーボンインテンシティ）
- Google内部の電力使用予測
- **結果**: 低炭素時間帯への負荷移動により、低炭素エネルギー消費増加

**ロケーションシフティング（2021年開始）**:
- 場所を問わない計算タスクを低炭素リージョンに移動
- **初期対象**: メディア処理（YouTube、Google Photos等のエンコード・分析・処理）
- **SLA/SLO違反なし**

### Xbox（2023年）

**タイムシフティング**:
- Microsoft カーボン意識 Windows Update を受け継ぎ
- 初のカーボン意識ゲームコンソール

**新機能**:
- ゲーム・アプリ・OS更新を夜間メンテナンス時間帯の特定時刻に実行
  - 従来: 午前2時～6時の間でランダム起動
  - 新方式: 最もクリーンな電力時刻に起動（コンソールが接続・インターネット利用可能時）

**Shutdownパワーセービングモード**:
- 電力消費を最大20倍削減
- パフォーマンス・機能に影響なし

### iPhone（iOS 16.1）

**Clean Energy Charging**:
- 低炭素電力でデバイス充電
- ユーザー体験を損なわずに環境配慮

### Carbon Hack 22（Green Software Foundation）

**優勝: Lowcarb**:
- 課題: MLモデルトレーニングの膨大なエネルギー需要
- ソリューション: Flower（フェデレーテッドラーニングフレームワーク）のプラグイン
- 機能: 様々な地理的リージョンのクライアントでトレーニングジョブをスケジュール
- **ベンチマーク（画像分類問題）**:
  - 13%炭素削減
  - トレーニング速度、最終精度、クライアント選択の公平性を犠牲にせず

**フェデレーテッドラーニング**: 複数拠点のデータで分散トレーニング（データは移動せず）、クライアント選択の公平性が重要

**注目アイデア: ウェブトラフィックレベルでのカーボン意識**:
- 課題: アプリケーションへのSDK実装、デプロイ・保守、SLOモニタリングの負担増
- ソリューション: ロードバランシング（LB）またはDNSレベルでカーボン意識機能を実装
- 適用: マルチリージョンアプリケーションで、最低カーボンインテンシティ地域へトラフィック優先リダイレクト（他のLB要件も満たしながら）
- メリット: 中央のネットワークチームが全社的に実装、アプリチームは負担なし

---

## まとめ: あなたもカーボン意識を（You're Carbon and Aware）

### キーポイント

1. **カーボン意識アプローチの理解**: タイムシフティング、ロケーションシフティング、デマンドシェイピング
2. **それぞれの利点・欠点の議論準備完了**
3. **速攻で実践すべきクイックウィン**: 時間非感受性アプリケーションのシンプルなタイムシフト

### 推奨事項

- **タイムシフティングを最優先**: 実装が容易、法的・規制的課題が少ない、コスト・パフォーマンスへの影響が小さい
- ツール活用: Carbon Intensity API、Electricity Maps、WattTime、Carbon Aware SDK
- 実世界の事例を参考に、自社の状況に合わせた実装を検討
- カーボン意識は将来的にコスト削減にも直結（動的電力価格の普及）

### 今後の展望

- グローバルでのカーボン意識採用拡大
- より多くのサービス・アプリケーションでの標準機能化
- クラウドプロバイダーのさらなる投資とイノベーション
- 24/7 CFE目標の達成に向けた業界全体の取り組み
