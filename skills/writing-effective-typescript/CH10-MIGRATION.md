# CH10 モダン化と移行

既存のJavaScriptプロジェクトをTypeScriptに移行するための実践的な手順と戦略。段階的な移行プロセス、よくある問題への対処法、移行完了後のメンテナンス方法を解説します。

---

## 項目79　モダンなJavaScriptを書く

**判断基準**: TypeScript移行の前準備として、まずモダンなJavaScript（ES2015+）の機能を採用します。これにより移行がスムーズになり、TypeScriptの型推論も改善されます。

### 覚えておくべきこと

- TypeScriptを使えば、実行環境がどんなものであっても、モダンなJavaScriptを書ける
- TypeScriptへの移行を容易にするため、ESモジュール（import/export）やクラスを採用する
- クラス、分割代入、async/awaitなどの言語機能を学ぶのに、TypeScriptを利用する

---

## 項目80　@ts-checkとJSDocを使ってTypeScriptを試す

**判断基準**: 大規模な書き換えをせずにTypeScriptの型チェックを試したい場合、JavaScriptファイルで@ts-checkを使用します。

### 覚えておくべきこと

- JavaScriptファイルの先頭に// @ts-checkを追加すれば、TypeScriptに書き換えなくても型チェックを有効にできる
- よくあるエラーを認識する。グローバル宣言の方法を知り、サードパーティライブラリの型宣言を追加する
- 型推論の改善と型アサーションのため、JSDocアノテーションを使う

---

## 項目81　allowJsを使ってTypeScriptとJavaScriptを共存させる

**判断基準**: 段階的な移行を行うため、TypeScriptとJavaScriptを同じプロジェクト内で共存させます。

### 覚えておくべきこと

- allowJsコンパイラーオプションを使って、移行中のJavaScriptとTypeScriptの共存をサポートする
- 大規模な移行を開始する前に、テストとビルドチェーンがTypeScriptを扱えるようにする

---

## 項目82　依存関係グラフの下から上へモジュールごとに移行する

**判断基準**: 効率的な移行のため、依存関係が少ないモジュール（ユーティリティ関数など）から始め、徐々に上位のモジュールへと進めます。

### 覚えておくべきこと

- サードパーティモジュールと外部APIコールに対応する@typesを追加することから移行を開始する
- 自分のモジュールの移行は、依存関係グラフの最下部から始め、上に向けて進めていく
- 奇妙な設計を発見しても、コードをリファクタリングしたくなる衝動を抑える
- 移行中に発生するよくあるエラーに注意する

---

## 項目83　noImplicitAnyを有効にするまで、移行が完了したと考えない

**判断基準**: すべてのファイルを.tsに変換しても、noImplicitAnyを有効にするまでは真の意味での移行完了ではありません。

### 覚えておくべきこと

- noImplicitAnyを有効にするまでは、TypeScriptへの移行が完了したと考えてはいけない
- noImplicitAnyを強制する前に、型エラーを徐々に修正する

---

## 項目84　コンパイラーオプションやリンターを使ってコードに規約を適用する

**判断基準**: チーム全体でコーディング規約を統一し、自動的に検出・修正できるようにします。

### 覚えておくべきこと

- コーディング規約はドキュメントに書くだけにとどめず、TypeScriptのコンパイラーオプションやリンターにまで反映する
- 一般的に問題があると見なされるコードの書き方に、有効なユースケースが例外的にある場合でも、その頻度が高くなければ設定で禁止することを検討する

---

## 移行ステップチェックリスト

### フェーズ1: 準備（1-2週間）

- [ ] プロジェクトの依存関係を最新化
- [ ] モダンJavaScript（ES2015+）の機能を採用
- [ ] TypeScriptとビルドツールのインストール
- [ ] tsconfig.jsonの作成（緩い設定）
- [ ] テストがTypeScriptで動作することを確認

### フェーズ2: 試験的導入（1週間）

- [ ] @ts-checkでJavaScriptファイルを試験的に型チェック
- [ ] サードパーティライブラリの型定義（@types）をインストール
- [ ] よくあるエラーパターンを特定
- [ ] チームメンバーへのトレーニング

### フェーズ3: 段階的移行（4-12週間）

- [ ] 依存関係グラフの可視化
- [ ] ユーティリティモジュールから.tsに変換開始
- [ ] 1日1-5ファイルのペースで移行
- [ ] 各モジュール移行後にテスト実行

### フェーズ4: 厳格化（2-4週間）

- [ ] すべてのファイルが.tsまたは.tsxに変換完了
- [ ] noImplicitAny: trueを有効化
- [ ] 暗黙のanyをすべて修正
- [ ] strictNullChecks: trueを有効化

### フェーズ5: 完成（1-2週間）

- [ ] strict: trueを有効化
- [ ] すべての型エラーを解決
- [ ] 型カバレッジを測定（目標95%以上）
- [ ] ESLintルールを設定
- [ ] CI/CDパイプラインに型チェックを追加
