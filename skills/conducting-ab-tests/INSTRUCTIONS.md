# A/Bテスト（オンラインコントロール実験）実践ガイド

## 1. 基礎概念

### 用語定義

**コントロール実験（A/Bテスト）**: ユーザーをランダムに2つ以上のグループに分割し、異なる体験を提供して因果関係を検証する実験。A/B/nテスト・フィールド実験・スプリットテストとも呼ばれる。

**主要用語**:

| 用語 | 定義 |
|------|------|
| **コントロール群** | 現状のままの体験を受けるグループ（A） |
| **介入群（Treatment）** | 変更された体験を受けるグループ（B） |
| **OEC（Overall Evaluation Criterion）** | 実験目標を定量化した総合評価基準 |
| **ランダム化単位** | ランダムに実験群へ割り当てる単位（通常はユーザー） |
| **実験群（Variant）** | テストされるユーザー体験。コントロール群と介入群を含む |
| **パラメータ** | OECや関心メトリクスに影響すると考えられる制御変数 |
| **統計的検出力** | 真の差があるときに検出できる確率 |
| **p値** | 帰無仮説が真であるとき、観察以上に極端な結果が起こる確率 |

### なぜ実験するのか（相関と因果）

相関関係は因果関係を示さない。例：「エラーメッセージを見たユーザーの解約率が低い」は「エラーを増やすと解約が減る」を意味しない（共通原因：ヘビーユーザーほどエラーに遭遇し、かつ解約しにくい）。

**コントロール実験の強み**:
- 因果関係を高い確率で確立できる唯一の科学的手法
- 微細な変化や予期しない副作用を検出可能
- アイデアの真の価値を評価できる（専門家の意見より正確）

### 実験実施の前提条件

1. **干渉しない実験単位が存在する** - 介入群ユーザーがコントロール群ユーザーに影響を与えない
2. **十分な実験単位数** - 最低でも数千ユーザー以上が必要
3. **測定可能なメトリクスの合意** - OECが定義されている
4. **変更が容易** - ソフトウェアサービスは通常この要件を満たせる

### 組織的な原則

実験を成功させる組織には以下の3原則がある:
1. データに基づいた意思決定をしており、OECを公式化している
2. 信用できる実験インフラへの投資意思がある
3. アイデアの価値評価が苦手であることを認識している

---

## 2. 実験の設計と実行

### 仮説の立て方

明確な仮説は「**変更Xを行うと、対象ユーザーYのメトリクスZが変化する**」の形で記述する。

例: 「購入確認ページにクーポン入力欄を追加すると、購入プロセスを開始するユーザー1人当たりの収益が低下する」

### OEC（総合評価基準）の定義

OECは以下の条件を満たす必要がある:
- **短期に測定可能** - 実験期間中に観測できる
- **長期目標を推進** - 戦略的ゴールと連動している
- **単一メトリクスが望ましい** - トレードオフを内包した合成指標

**良いOECの例**:
- 検索エンジン: ユーザーあたりセッション数 × 成功率 × 広告収益の合成
- EC: 購入プロセス開始ユーザーあたりの収益（全ユーザーではなく対象ユーザーで正規化）

**注意**: 収益の総計をOECにしない。実験群間のユーザー数の違いによるバイアスが生じる。「ユーザーあたりの収益」のように正規化する。

### 実験デザインの4つの決定

#### 1. ランダム化単位の選択

**ユーザーをランダム化単位とすることを強く推奨**。理由:
- 一貫したユーザー体験を保証できる
- あるユーザーの割り当てが他ユーザーの割り当てに依存しない

他の選択肢（ページ、セッション、デイ）については `references/STATISTICS.md` を参照。

#### 2. ターゲット母集団の定義

実験の影響を受けるユーザーのみを対象にする（トリガー分析）。
例: 購入確認ページの変更 → 購入プロセスを開始したユーザーのみを分析対象にする。

これにより分析の精度（感度）が上がる。ノイズとなる影響を受けないユーザーを除外できるため。

#### 3. 必要なサンプルサイズの計算

検出力分析（Power Analysis）で必要なユーザー数を決定する:

```
必要サンプルサイズ ≈ 16 × σ² / δ²
```

- `σ²`: メトリクスの分散
- `δ`: 検出したい最小差（実用的有意差）
- 検出力80〜90%が標準的な目標

**サンプルサイズを減らすには**:
- より感度の高いメトリクスに変更（分散が小さい）
- 実用的有意差の閾値を上げる（大きな効果だけを検出）

詳細は `references/STATISTICS.md` の「サンプルサイズ計算」を参照。

#### 4. 実験期間の決定

考慮すべき要因:
- **曜日効果**: 平日と週末でユーザー行動が異なる → 最低1週間実行
- **季節性**: 祝日・特定イベントの影響を考慮
- **プライマシー・ノベルティ効果**: 効果が時間的に変化する場合は長めに実行

---

## 3. 結果の分析と解釈

### 仮説検定の基礎

**帰無仮説**: コントロール群と介入群のメトリクスに差がない

**p値**: 帰無仮説が真のとき、観察された差以上の差が起こる確率
- p < 0.05 → 統計的に有意（帰無仮説を棄却）
- p ≥ 0.05 → 統計的に有意でない（帰無仮説を棄却できない）

### p値の正しい解釈（と誤った解釈）

**よくある誤解と正しい理解**:

| 誤解 | 正しい理解 |
|------|----------|
| p=0.05は帰無仮説が真の確率が5% | p値はそのような確率ではない（帰無仮説の条件付き確率） |
| 有意でない = 差がない | 有意でない = 検出力が不足している可能性がある |
| p=0.05は5%しか起こらないデータが観測された | 5%には「より極端な結果」も含まれる |
| p=0.05なら偽陽性率5% | 偽陽性率の計算にはベイズの定理が必要（事前確率が必要） |

### 信頼区間の正しい使い方

**95%信頼区間**: 繰り返し実験したとき、95%の確率で真の介入効果を含む区間

**重要**: 特定の信頼区間に真の値が含まれる確率は100%か0%のどちらか。「95%の確率で含む」という解釈は誤り。

**意思決定への活用**:
- 信頼区間がゼロを含まない → 統計的に有意（p < 0.05 と等価）
- 信頼区間が実用的有意差の閾値の外にある → ローンチを検討できる

### 実用的有意差 vs 統計的有意差

**統計的有意差**: 差がゼロでない可能性が高いこと
**実用的有意差**: ビジネス的に意味のある大きさの差であること

| 結果パターン | 判断 |
|------------|------|
| 統計的にも実用的にも有意 | ローンチを検討 |
| 統計的には有意だが実用的には有意でない | ローンチの価値が低い |
| 統計的に有意でない、信頼区間が実用閾値内 | 検出力不足 → 追加実験 |
| 実用的に有意に見えるが統計的に有意でない | 検出力不足 → より大きな規模で再実験 |

---

## 4. 実験の信用性（トワイマンの法則）

> 面白そうに見えるものや通常と異なるものはたいてい間違っている
> — トワイマンの法則

**驚くほど良い結果（または悪い結果）は検証必須**。多くの極端な結果は、計測装置の誤り・データの欠損・計算ミスが原因。

### 統計的検出力の不足

有意でない結果を「差がない」と結論付けるのは誤り。
**チェック**: 実用的に重要な差を検出できる十分な検出力があるか？

### p値のピーキング（多重比較問題）

実験中に継続的にp値を確認し、有意になった時点で止めると偽陽性が5〜10倍増加する。

**解決策**:
1. 事前に決めた期間（例: 1週間）が経過してから判定する
2. 逐次検定のフレームワーク（Sequential Testing）を使用する

多重比較の問題はピーキング以外にも発生する:
- 複数のメトリクスを同時に確認する
- ユーザーをセグメント別に分析する
- 同じ実験を複数回繰り返す

### サンプル比率のミスマッチ（SRM）

**定義**: 実験計画で設定した比率（例: 50/50）と実際の実験群比率が大きく乖離する状態

SRMが検出された場合は実験結果を信用してはならない。主な原因:

| 原因 | 説明 |
|------|------|
| ブラウザリダイレクト | リダイレクト方式はSRMを引き起こしやすい。サーバーサイド実装を推奨 |
| 計測の欠損 | クリックトラッキングの欠損率が実験群で異なる |
| ボットフィルタリング | 介入がボット判定基準に影響を与える場合 |
| 残留効果（キャリーオーバー） | 前回実験のデータがユーザーに残っている |
| 不適切なハッシュ関数 | ランダム化に使うハッシュ関数の品質問題 |

**SRM検出方法**: 比率の検定でp値が非常に低い（例: 0.001以下）場合に警告を出す。

### プライマシー効果とノベルティ効果

**ノベルティ効果**: 新機能に対してユーザーが珍しさから試す → 効果が時間とともに消える
**プライマシー効果**: ユーザーが古い体験に慣れているため、新機能の採用に時間がかかる

**検出方法**: 時間の経過に対して効果をプロットし、増減の傾向を確認する。効果が安定するまで実験期間を延長する。

### シンプソンのパラドックス

実験を段階的に拡大する際（例: 最初1%、次に50%）、各段階では介入群が優れていても、データを合計すると劣っているように見える現象。

**対策**: 異なるパーセンテージで収集されたデータを単純に集計しない。段階ごとに分析する。

### その他の内的妥当性への脅威

**SUTVA違反**: 実験単位が互いに干渉する状況（ソーシャルネットワーク、双方向マーケットプレイスなど）

**生存者バイアス**: 特定の期間アクティブなユーザーのみを分析すると偏りが生じる

**Intention-to-Treat**: 実際に介入を受けたかどうかにかかわらず、最初の割り当てで分析する。参加したユーザーのみを分析すると選択バイアスが生じる。

---

## 5. 意思決定フレームワーク

### ローンチ判断のチェックリスト

実験結果からローンチを決定する際は、純粋な統計的観点だけでなく以下を考慮する:

- [ ] **ガードレールメトリクスを確認** - 不変であるべきメトリクスが変化していないか
- [ ] **SRMチェックを通過** - サンプル比率が意図通りか
- [ ] **メトリクス間のトレードオフ** - 一部のメトリクスが悪化していないか
- [ ] **ローンチコスト** - 完全実装コスト・保守コストを考慮
- [ ] **判断を間違えた場合のリスク** - 変更の寿命や影響範囲を評価

### ユーザーへの確認（AskUserQuestion）

以下の場合はユーザーに確認を求める:
- 実験設計の実用的有意差の閾値が不明
- OECの定義について合意が必要
- 実験期間や対象母集団の判断
- SRM・ノベルティ効果等の問題が発見された場合の対処方針

---

## 参照

- 統計的検定・サンプルサイズ計算の詳細 → `references/STATISTICS.md`
- 実験プラットフォームの構築・組織文化 → `references/PLATFORM-AND-CULTURE.md`
