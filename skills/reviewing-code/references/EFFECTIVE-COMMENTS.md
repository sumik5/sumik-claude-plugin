# 効果的なコメント技法

## 3原則の概要

| 原則 | 目的 | 主要ツール |
|------|------|-----------|
| 客観性（Objectivity） | 主観・感情を排除する | 5Pプロセス、MMGエクスチェンジ |
| 具体性（Specificity） | 何を変えるかを明確に伝える | コメントシグナル、MoSCoW、Conventional Comments |
| 明確なアウトカム（Focused Outcome） | 次にすべきことを明示する | Triple-Rパターン |

---

## 原則1: 客観性（Objectivity）

### 5Pプロセス

コメントを送信する前に、自分の反応を検証するプロセス。

```
Pause → Ponder → Pass / Propose / Postpone
```

**Pause（一時停止）**

コードを見て「これは問題だ」という直感的な反応が出たとき、すぐにコメントを書かない。一息ついて、本当に問題があるのかを確認する時間を意図的に作る。

**Ponder（熟考）**

以下を自問する:
- このコードは実際に問題を引き起こすか？
- 私が見落としている背景情報はあるか？
- 著者には私が知らない制約があるのでは？
- これはチームの合意事項か、個人の好みか？
- 代替案は本当に優れているか、ただ違うだけか？

**Pass（パス）**

熟考の結果、問題ではないと判断した場合はコメントしない。以下はPassの対象:
- 個人の好みやスタイルの違い
- チームで合意されていないルール
- 「こうすれば良いのでは」という主観的な好み（代替案が明確に優れていない場合）

**Propose（提案）**

実際に問題があると判断した場合、具体的な改善案を添えてコメントする。「これは問題です」だけでなく、「こうすることで改善できます」という形で提示する。

**Postpone（延期）**

今この場で解決すべきではないが、将来チームで議論すべき問題の場合。コメントとして記録しつつ、チームの議題に追加する。このPRでのマージを阻止しない。

---

### MMGエクスチェンジ（Middle Ground Exchange）

レビュアーと著者の意見が対立したときに使う対話フレームワーク。

**前提**: 意見の対立は「どちらが正しいか」ではなく「どちらのコードがより良いか」の問題。勝ち負けではなく、最良のコードを共同で見つけることが目的。

**手順**:
1. 両者が自分の案とその理由を明確に述べる
2. 相手の案の「良い点」を認める
3. 両案の問題点を共有する
4. 両案のどちらでもない第3の案を共同で考える
5. 合意できた場合はその案を採用。できない場合はより広いチームに判断を委ねる

**MMGが有効な場面**:
- 命名に関する意見の相違（両方とも有効な命名の場合）
- アーキテクチャの選択（どちらのパターンを使うか）
- エラーハンドリングの方針
- 抽象化レベルの判断

**MMGが不要な場面**:
- 明確なバグや脆弱性（これはブロッキング指摘として扱う）
- チームで既に合意されているルール（alightコメントを使う）

---

## 原則2: 具体性（Specificity）

### コメントシグナルの詳細

コメントの種類と重要度を最初に明示することで、受け取る側が優先度を即座に判断できる。

**ブロッキングシグナル（マージ前に対応必須）**:

```
needs change: [具体的な変更内容]
```

コードが正しく動かない、セキュリティリスクがある、データ破損の可能性があるなど、このPRがそのままマージされると問題が発生するケース。変更内容を具体的に記述する。

```
needs rework: [問題の概要]
```

個々の修正では対応できない設計レベルの問題。コードの大幅な書き直しが必要。このシグナルを使う場合は、問題の全体像と改善の方向性を丁寧に説明する。著者が何から手をつければ良いかがわかるように記述する。

**要議論シグナル**:

```
align: [確認事項]
```

チームの標準・過去の決定・他のコードとの整合性の確認が必要。著者が知らない可能性のある決定事項への注意喚起。マージを即座にブロックするのではなく、議論を促す。

**非ブロッキングシグナル（マージは可能）**:

```
levelup: [教育的コメント]
```

成長のための情報提供。より良いパターン、背景知識、将来的に役立つ情報を共有する。著者のスキルアップが目的であり、このPRでの対応は必須でない。

```
nitpick: [軽微な改善提案]
```

コードの動作に影響しない軽微な改善（命名の微調整、コメント追加等）。対応するかどうかは著者の判断に委ねる。

**ポジティブシグナル**:

```
praise: [称賛の対象]
```

優れた実装、巧みな解決策、読みやすいコードへの称賛。レビューは改善指摘だけでなく、良い点を伝えることも重要な役割。

---

### MoSCoW優先度の使い方

複数の指摘がある場合、全体の優先順位をまとめて示すことで、著者が何から対応すべきかを明確にする。

**PR全体にMoSCoWを使う例**:

```
このPRのレビューコメントの優先度:

Must Have（マージ前に必須）:
- #3: SQLインジェクションの脆弱性対応
- #7: ヌルポインター例外の修正

Should Have（対応を強く推奨）:
- #1: エラーハンドリングの追加
- #5: 境界値テストの追加

Could Have（時間があれば）:
- #2: 変数名の改善
- #4: インラインコメントの追加

Won't Have（このPRでは対応不要）:
- #6: リファクタリング（別チケット #456 で追跡）
```

**MoSCoWを使うタイミング**:
- 指摘コメントが5件以上ある場合
- ブロッキングとノンブロッキングが混在する場合
- PRの対応に時間制約がある場合

---

### Conventional Commentsの完全仕様

一貫したフォーマットでコメントを書くことで、読み手がすぐに種類と重要度を把握できる。

**フォーマット**:

```
<label> [(decorations)]: <subject>

[discussion]
```

**label（必須）**:

| ラベル | 用途 |
|--------|------|
| `praise` | 良い実装への称賛 |
| `nitpick` | 軽微な改善（対応任意） |
| `suggestion` | 改善の提案（マージは可能） |
| `issue` | 問題の指摘（マージ前に確認推奨） |
| `todo` | 対応必須の修正 |
| `question` | 理解のための質問 |
| `thought` | 思考の共有（アクション不要） |
| `chore` | 軽微な整理（typo修正等） |
| `note` | 情報共有（アクション不要） |

**decorations（任意、カンマ区切り）**:

```
(non-blocking)  - マージを阻止しない
(blocking)      - マージを阻止する
(if-minor)      - 軽微な問題であれば非ブロッキング
```

**完全な例**:

```
suggestion (non-blocking): エラーメッセージをより具体的にすることを提案します

現在のメッセージ `"Error occurred"` はデバッグ時に有用な情報がありません。
`"Failed to fetch user data: connection timeout after 30s"` のように、
エラーの種類と詳細を含めることで、問題の特定が容易になります。

対応は任意ですが、将来の保守性向上のために検討をお願いします。
```

```
todo (blocking): パスワードをハッシュ化してから保存してください

現在の実装では平文パスワードがデータベースに保存されます。
bcryptなどの一方向ハッシュ関数を使用してください。
```

```
question: このアルゴリズムの時間計算量はどのくらいですか？

大量データを処理する場合のパフォーマンス特性を理解したいので、
可能であれば説明をお願いします。
```

---

## 原則3: 明確なアウトカム（Focused Outcome）

### Triple-Rパターンの詳細

各要素の詳細と書き方のヒント。

**Request（依頼）**
- 「何を」変えてほしいかを1文で明確に述べる
- 変更後のコードのイメージを示すと理解が早い
- 可能ならコードスニペットを添える

**Rationale（根拠）**
- なぜその変更が必要かを説明する
- 技術的な根拠（パフォーマンス、セキュリティ、保守性等）
- チームの合意事項・スタンダードへの参照
- 長い説明は避け、1-3文に収める

**Result（期待結果）**
- 変更後にどう改善されるかを具体的に述べる
- 測定可能な改善（応答時間、コードカバレッジ等）は数値で示す
- 定性的な改善（可読性、保守性等）も簡潔に述べる

**Triple-Rの完全な例**:

```
needs change: パスワードをハッシュ化してから保存してください

Request:
  `user.password = password` の代わりに、bcryptなどの一方向ハッシュ関数で
  パスワードをハッシュ化してから保存する。

Rationale:
  現在の実装では平文パスワードがデータベースに保存される。
  データベースが漏洩した際に、全ユーザーのパスワードが直接公開される。
  OWASP A02:2021（Cryptographic Failures）に該当するセキュリティ問題。

Result:
  bcryptでハッシュ化することで、データベース漏洩時でも元のパスワードの
  復元が極めて困難になる。セキュリティ基準への準拠にもなる。
```

```
nitpick: 変数名をより説明的にすることを提案します

Request:
  `d` を `daysSinceLastLogin` に変更する。

Rationale:
  1文字の変数名はコンテキストなしに意図を読み取ることが難しい。
  このコードを初めて読む人が変数の役割を即座に理解できない。

Result:
  変数名から役割が明確になり、コードの読解時間が短縮される。
  対応は任意です。
```

---

## トーン・声のトーン

### 「you」から「we」への変換

個人への批判ではなく、コードへのフィードバックとして表現することで、防衛的な反応を減らし、建設的な対話を促す。

| ❌ you文（個人批判） | ✅ we文（共同作業） |
|-------------------|------------------|
| 「あなたはここで例外処理を忘れています」 | 「ここで例外が発生した場合の処理を追加できますか？」 |
| 「あなたのコードは読みにくいです」 | 「このロジックをより明確にするために関数を分けることを検討できますか？」 |
| 「なぜこんな方法を使ったのですか？」 | 「このアプローチを選んだ理由を教えていただけますか？他の選択肢もあったかと思いまして」 |
| 「あなたはテストを書いていません」 | 「このケースのテストを追加することを検討していますか？」 |
| 「これは明らかに間違っています」 | 「このケースでは予期しない動作が発生する可能性があります」 |

### 質問形式の活用

命令ではなく質問形式で提案することで、著者の自律性を尊重し、思考の機会を与える。

**命令 → 質問・提案の変換例**:
- 「この関数を分割してください」
  → 「この関数を分割するとテストが書きやすくなりそうですが、どう思いますか？」
- 「エラーを適切に処理してください」
  → 「このエラーが発生した場合、ユーザーにどう通知する予定ですか？」
- 「変数名を改善してください」
  → 「`d` よりも `daysSinceLogin` のような名前だとより意図が伝わりやすいと思いますが、いかがでしょうか？」

**質問形式が特に有効な場面**:
- 著者の意図がわからない場合（判断を求める前に確認する）
- 代替案を提案したいが、著者が異なる理由で現在の実装を選んでいる可能性がある場合
- `levelup` コメントで教育的な内容を伝えたい場合

### コードコンプリメント

優れた実装を見つけたら積極的に称賛する。称賛はレビュー文化を健全に保つ重要な要素。

**効果的な称賛の例**:
- 「この再帰的な解決策、とてもエレガントです！計算量もO(log n)で最適ですね。」
- 「エラーハンドリングが丁寧で、全てのエッジケースがカバーされていますね。」
- 「このキャッシュ戦略、パフォーマンスの問題を上手く解決しています。」
- 「テストケースが網羅的で、今後のリグレッション防止に非常に役立ちます。」
- 「このデザインパターンの使い方、まさにこのユースケースにぴったりです。」

**称賛のポイント**:
- 具体的な箇所を指定する（「コード全体が良い」より「このエラー処理のパターンが良い」）
- なぜ良いのかを添える（何が優れているかを伝えることで学習効果が生まれる）
- 過剰にならない（本当に優れていると思ったときだけ称賛する）
- `praise:` シグナルを使って称賛であることを明示する

---

## コメントを受け取ったとき

著者としてコメントを受け取った際の対応方法。

**各コメントへの対応記録**:

| 対応内容 | 記録例 |
|---------|--------|
| 修正した | 「修正しました。[コミットリンク]」 |
| 代替案で対応 | 「別の方法（〇〇）で対応しました。理由: ~~」 |
| 却下（理由あり） | 「このPRのスコープ外のため、Issue #123 で追跡します」 |
| 質問に回答 | 「〇〇のためにこの実装を選びました」 |

**議論が長引く場合**:

コメントのやり取りが3往復を超えたら、口頭・Slackで同期的に解決する。非同期の文字コミュニケーションでは解決しにくい問題があることを認識し、効率的な方法に切り替える。
