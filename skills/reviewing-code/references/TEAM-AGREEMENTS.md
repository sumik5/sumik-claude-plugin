# チーム合意（Team Working Agreement）

## TWAとは

チーム内のコードレビューに関する「暗黙の期待」を明文化した文書。チームメンバー全員が合意した、コードレビューの運用ルール集。

**なぜTWAが必要か**:
- 「当然こうするものだ」という前提の違いが、摩擦・遅延・ストレスを生む
- 明文化することで、新しいメンバーのオンボーディングが容易になる
- 問題が起きたとき、「個人の好み」ではなく「合意」を根拠に対話できる
- 定期的な見直しでプロセスを継続的に改善できる

---

## TWAに含める要素

### 1. レスポンスタイム

レビュー依頼に対して、いつまでに初回レスポンスを返すかの合意。

**検討項目**:
- レビュー依頼から初回コメントまでの目標時間
- チームの規模・タイムゾーンに応じた調整
- レビューできない場合の連絡方法（コメント、Slack等）
- 優先度の高いPR（バグ修正・ホットフィックス等）の特別ルール

**例**:
```
- 通常のPR:       依頼から1営業日以内に初回レスポンス
- バグ修正PR:     4時間以内
- ホットフィックス: 1時間以内
- レビューできない場合: PRにコメントしてチームリードに連絡
```

### 2. PRサイズ制限

大きすぎるPRを防ぐためのガイドライン。

**推奨値**:
- 変更ファイル数: 20ファイル以下
- 変更行数: 500行以下（純増分。自動生成コードは除外可）
- 大きくなる場合: フィーチャーフラグや機能分割で段階的に提出

**例外ケース（チームで定義する）**:
```
以下は例外として大きなPRを許可する:
- 自動生成コード（型定義、マイグレーションスクリプト等）
- リネーム・移動のみの変更（ロジック変更なし）
- チームリードの事前承認がある場合
```

### 3. 最小承認者数

マージに必要な承認者数と種別の定義。

**例**:
```
- 通常のPR:          2名以上の承認
- ホットフィックス:   1名（上席者）の承認
- ドキュメントのみ:   1名の承認
- インフラ変更:       チームリードを含む2名の承認
- 破壊的変更（breaking）: チームリードを含む3名の承認
```

### 4. ブロッキング・ノンブロッキングの定義

どの種類のコメントがマージを阻止するかの明確な定義。

**ブロッキング（マージ前に対応必須）**:
- セキュリティ脆弱性（OWASP Top 10等）
- データ損失・データ不整合のリスク
- テストが通らない状態
- 既存APIの破壊的変更（ドキュメントなし）
- 承認者数が最小要件に未達
- [チームで追加]

**ノンブロッキング（マージ後に対応可能）**:
- コードスタイルの好み（自動化で対処できるものは除く）
- 将来的なリファクタリングの提案
- ドキュメントの充実化
- テストカバレッジの拡充（最低限はある場合）
- [チームで追加]

### 5. コメントシグナルの定義

チームで使用するコメントシグナルの合意。→ 詳細は EFFECTIVE-COMMENTS.md 参照

例:
```
- needs change: / needs rework: → ブロッキング
- align:                        → 要議論（デフォルトはノンブロッキング）
- nitpick: / levelup:           → ノンブロッキング
- praise:                       → 称賛（アクション不要）
```

### 6. 緊急対応のルール

緊急事態における標準プロセスのスキップ手順。→ 詳細は REVIEW-PROCESS.md 参照

TWAに記載すべき内容:
```
緊急承認権限者: [名前または役職]
事後レビューの期限: マージから24時間以内
月次上限: [X]件を超えた場合は振り返りを実施
```

### 7. コミュニケーションチャネル

| 内容 | チャネル |
|------|---------|
| コードの変更に関する議論 | PRコメント（記録が残る） |
| 緊急の同期対話 | Slackまたは口頭 |
| 設計上の大きな議論 | 別途MTGを設定（PRで解決しない） |
| TWAの変更提案 | Issue or Slack → 全員の合意 |

---

## TWAスターターテンプレート

以下をチームのWikiや `REVIEW-AGREEMENT.md` にコピーして使用する。

```markdown
# コードレビュー チーム合意（Team Working Agreement）

最終更新: YYYY-MM-DD
承認者: [チームメンバー全員の名前]

---

## 1. レスポンスタイム

| PRカテゴリ | 初回レスポンス期限 |
|-----------|----------------|
| 通常のPR | 1営業日以内 |
| バグ修正 | 4時間以内 |
| ホットフィックス | 1時間以内 |

レビューできない場合: PRにコメントし、チームSlackに連絡する。

## 2. PRサイズ

- 推奨: 変更20ファイル・500行以内
- 超過する場合: 事前にチームに相談し、分割を検討する
- 例外（自動生成コード等）: [チームで定義]

## 3. 承認要件

| PRカテゴリ | 必要な承認 |
|-----------|----------|
| 通常のPR | 2名以上 |
| ホットフィックス | 1名（上席者） |
| ドキュメントのみ | 1名 |
| インフラ変更 | チームリード含む2名 |

## 4. ブロッキング・ノンブロッキング

**ブロッキング（マージ前に対応必須）**:
- [ ] セキュリティ脆弱性
- [ ] データ損失・不整合のリスク
- [ ] テスト失敗
- [ ] 承認者数未達
- [ ] [チームで追加]

**ノンブロッキング（マージ後対応可）**:
- スタイルの好み（自動化で対処できるものは除く）
- 将来的なリファクタリング提案
- [チームで追加]

## 5. コメントシグナル

レビューコメントには以下のシグナルを使用する:
- `needs change:` — マージ前に必須（ブロッキング）
- `needs rework:` — 大幅な設計変更が必要（ブロッキング）
- `align:` — チーム標準との整合確認（要議論）
- `levelup:` — 教育的な情報共有（非ブロッキング）
- `nitpick:` — 対応任意の軽微な提案（非ブロッキング）
- `praise:` — 優れた実装への称賛

## 6. 緊急対応

緊急PRの定義:
- 本番に影響するインシデントが発生/48時間以内に発生する見込み
- この変更なしに問題を解決できない
- 通常プロセスを待つ余裕がない

緊急承認権限者: [名前または役職]
事後レビュー: マージから24時間以内に実施

## 7. 改善プロセス

このTWAは [四半期ごと等] に振り返りを実施する。
変更提案: [Issue作成 / Slackで提案] → 全員の合意で更新

---

*このドキュメントはチーム全員の合意のもとに作成・更新される。*
```

---

## TWAの作成・更新方法

### 初回作成

1. チームで「今のレビューで何に困っているか」を出し合う
2. 困っている点を解決するルールを提案する
3. 全員が合意できるルールをTWAに記載する
4. 反対意見があれば、全員が納得できる妥協点を探す
5. 試験期間（1-2ヶ月）を設けてTWAを適用する
6. 試験後に振り返り、TWAを更新する

**初回作成のポイント**:
- 完璧なTWAを目指さない。まず最小限のルールから始める
- 「現在の問題」を解決するルールを優先する
- 抽象的なルールより、具体的な数字（時間・行数等）を入れる

### 更新ルール

- 変更提案は誰でも出せる
- 変更は全員の合意が必要（多数決ではなく全員合意）
- 変更した場合は更新日と変更内容を記録する
- 新しいメンバーが入ったら、TWAの内容を一緒に確認する

### 振り返りのポイント

定期的な振り返り（スプリントレビュー・四半期レビュー等）で以下を確認:

- 今のレスポンスタイムは現実的か？守られているか？
- PRサイズの制限は適切か？守れていないケースの原因は何か？
- ブロッキング・ノンブロッキングの判断基準は一貫して使われているか？
- 守られていないルールがあれば、その理由は何か？（ルールが厳しすぎる？）
- 追加・削除したいルールはあるか？
- 新しいメンバーはTWAを理解できているか？

**振り返りの注意点**: TWAは「守らせるルール」ではなく「チームの合意」。守られていないルールは、削除か緩和を検討する。
