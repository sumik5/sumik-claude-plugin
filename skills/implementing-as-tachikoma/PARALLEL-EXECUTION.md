# タチコマ並列実行ガイド

## 並列実行の判断基準（デシジョンツリー）

Claude Code本体はタスクを受領したら、以下の基準で並列実行を判断する。

```
タスク分析
    ↓
【独立したサブタスクに分解可能？】
    ├─ Yes → 【2つ以上の関心事？】
    │          ├─ Yes → 並列実行（tachikoma1-N）
    │          └─ No  → 単体実行
    └─ No  → 単体実行
```

### 並列実行すべきケース（1つでも該当すれば並列）

| 条件 | 例 |
|------|-----|
| 2+ファイルを変更 かつ 変更が独立 | `Header.tsx` + `api/users.ts` |
| 異なる関心事が含まれる | UI実装 + API実装 + テスト作成 |
| フロントエンドとバックエンド両方 | React画面 + APIエンドポイント |
| 実装とテストが同時に必要 | 機能実装 + ユニットテスト |
| 複数の独立した機能追加 | ユーザー管理 + 通知機能 |

### 単体実行すべきケース

| 条件 | 例 |
|------|-----|
| 1ファイルのみの変更 | typo修正、設定変更 |
| 密結合した変更 | 前のタスクの出力が次の入力に必要 |
| 単一関心事の小さな修正 | バグ修正1件 |

## タスク分解パターン

### パターン1: フルスタック開発（最も一般的）

```
ユーザー要求: 「ユーザー登録機能を追加」
    ↓
Claude Code（タスク分解）:
    tachikoma1: フロントエンド（登録フォームUI）
    tachikoma2: バックエンド（APIエンドポイント + DB）
    tachikoma3: テスト（E2E + ユニットテスト）
    tachikoma4: ドキュメント（API仕様書）
```

### パターン2: マルチコンポーネント開発

```
ユーザー要求: 「ダッシュボードにチャートとテーブルを追加」
    ↓
Claude Code（タスク分解）:
    tachikoma1: チャートコンポーネント
    tachikoma2: テーブルコンポーネント
    tachikoma3: データフェッチング + 状態管理
```

### パターン3: リファクタリング + テスト

```
ユーザー要求: 「認証モジュールをリファクタリング」
    ↓
Claude Code（タスク分解）:
    tachikoma1: コードリファクタリング
    tachikoma2: テスト更新・追加
```

### パターン4: 複数独立機能

```
ユーザー要求: 「ダークモードとi18n対応を追加」
    ↓
Claude Code（タスク分解）:
    tachikoma1: ダークモード実装
    tachikoma2: i18n対応実装
```

## 起動テンプレート

### Claude Code本体が並列起動する際のプロンプト構造

各タチコマへの指示には以下を含めること:

1. **タスクの明確な範囲**: 何を担当するか（ファイル名レベルで明記）
2. **作業ディレクトリ**: worktreeパスまたはプロジェクトルート
3. **依存関係**: 他のタチコマの成果物に依存するかどうか
4. **品質基準**: SOLID原則、テスト、型安全性

```
## タスク: [具体的なタスク名]
担当: tachikoma[N]（[役割名]）
作業ディレクトリ: [パス]

### 変更対象ファイル
- [ファイル1]: [変更内容]
- [ファイル2]: [変更内容]

### 要件
[具体的な要件]

### 他のタチコマとの関係
- tachikoma[M]が[XXX]を担当しているため、[YYY]は変更しないこと
```

## アンチパターン（避けるべきこと）

### ❌ 同一ファイルへの並列書き込み
複数のタチコマが同じファイルを同時に編集すると競合が発生する。
タスク分解時に、各タチコマの担当ファイルが重複しないようにすること。

### ❌ 逐次実行すべきタスクの並列化
前のタスクの出力が次の入力になる場合は逐次実行する。
例: DBスキーマ作成 → スキーマに依存するAPI実装

### ❌ 単一タスクの無理な分割
1ファイルの小さな修正を複数タチコマに分割しない。
オーバーヘッドが実装時間を上回る。

### ❌ コンテキスト不足での起動
各タチコマに十分な情報（要件、ファイルパス、制約）を渡さずに起動しない。
タチコマは独立して動作するため、指示に含まれない情報はアクセスできない。

## docs連携による実行管理

並列実行時、各タチコマへの指示はTask toolのpromptパラメータで渡される。しかしコンテキスト消失（compaction、タイムアウト、エラー等）が発生すると、指示内容が失われ再開が不可能になる。

この問題を解決するため、`docs/plan-xxx.md`に実行指示を永続化する。

### なぜdocsに書くか

| 理由 | 説明 |
|------|------|
| **再開可能性** | コンテキスト消失後もdocsファイルから未完了タスクを特定し再起動できる |
| **進捗可視化** | チェックリストと実行ログにより、全タスクの状態が一目で把握できる |
| **指示の永続化** | 各タチコマの担当範囲・要件・排他情報がファイルとして残る |

### docs連携フロー

```
Claude Code本体（タスク分析・計画作成）
    ↓
docs/plan-xxx.md に計画を作成
    ↓ ユーザー確認
    ↓
docs/plan-xxx.md に「🚀 実行指示」セクションを追加
    ├─ 全体チェックリスト
    ├─ 各タチコマの担当・要件・排他情報
    └─ 実行ログテーブル（空）
    ↓
タチコマ並列起動（各タチコマにdocsファイルパスと担当セクション名を指示）
    ↓
各タチコマが担当セクションを読み込み作業実行
    ↓
完了報告 → Claude Code本体がチェックリスト更新・実行ログ記録
    ↓
全タスク完了 → 統合確認
```

### 実行指示テンプレート

Claude Code本体が`docs/plan-xxx.md`の末尾に追加する「🚀 実行指示」セクションのテンプレート:

````markdown
---
## 🚀 実行指示（タチコマ用）

### 全体チェックリスト
- [ ] tachikoma1: [タスク名]
- [ ] tachikoma2: [タスク名]
- [ ] tachikoma3: [タスク名]（必要な場合）
- [ ] tachikoma4: [タスク名]（必要な場合）
- [ ] CodeGuard実行
- [ ] 統合確認

### tachikoma1: [役割名]
**担当ファイル**:
- `[パス/ファイル1]`: [変更内容の概要]
- `[パス/ファイル2]`: [変更内容の概要]

**要件**:
- [具体的な要件1]
- [具体的な要件2]
- [具体的な要件3]

**他のタチコマとの関係**:
- tachikoma2が[XXX]を担当。[YYY]には触れないこと

### tachikoma2: [役割名]
**担当ファイル**:
- `[パス/ファイル3]`: [変更内容の概要]

**要件**:
- [具体的な要件1]
- [具体的な要件2]

**他のタチコマとの関係**:
- tachikoma1が[XXX]を担当。[YYY]には触れないこと

### tachikoma3: [役割名]（必要な場合）
（同様の構造）

### tachikoma4: [役割名]（必要な場合）
（同様の構造）

---
## 📋 実行ログ
| 時刻 | Agent | 状態 | 概要 |
|------|-------|------|------|
````

#### テンプレート記入ガイド

- **`[タスク名]`**: 各タチコマが担当する作業の簡潔な名称（例: 「フロントエンドUI実装」）
- **`[役割名]`**: タチコマの専門領域（例: 「フロントエンド」「バックエンド」「テスト」）
- **`[パス/ファイルN]`**: 変更対象の絶対パスまたはプロジェクトルートからの相対パス
- **担当ファイルの重複禁止**: 各タチコマの担当ファイルが重複しないように分割すること
- **排他情報の明記**: 「他のタチコマとの関係」で、触れてはいけないファイル・領域を明示すること

### チェックリスト管理

チェックリストと実行ログの更新は**Claude Code本体の責任**で行う。タチコマ自身はdocsファイルを更新しない。

#### 更新手順

1. **タチコマから完了報告を受信**
2. Claude Code本体が`docs/plan-xxx.md`を開く
3. 該当するチェックリスト項目を `- [x]` に更新
4. 実行ログテーブルに完了記録を追加

#### 実行ログの記入例

```markdown
## 📋 実行ログ
| 時刻 | Agent | 状態 | 概要 |
|------|-------|------|------|
| 14:30 | tachikoma1 | 完了 | Header.tsx、Sidebar.tsx のUI実装完了 |
| 14:32 | tachikoma2 | 完了 | /api/users エンドポイント実装完了 |
| 14:35 | tachikoma3 | 完了 | ユニットテスト15件追加、全件パス |
| 14:40 | Claude Code | 完了 | CodeGuard実行、統合確認完了 |
```

#### ルール

- **タチコマはdocsファイルを編集しない**: 進捗管理はClaude Code本体が一元管理する
- **チェックリストは完了確認後に更新**: タチコマの完了報告を検証してからチェックする
- **実行ログは時系列順**: 発生順に記録し、状態は「開始」「進行中」「完了」「失敗」のいずれか

### 再開手順（コンテキスト消失時）

compaction、セッションタイムアウト、予期しないエラー等でコンテキストが消失した場合、以下の手順で作業を再開する。

#### 再開フロー

```
コンテキスト消失を検知
    ↓
1. docs/plan-xxx.md を読み込む
    ↓
2. 「全体チェックリスト」で未完了（- [ ]）のタスクを特定
    ↓
3. 「実行ログ」で各タスクの最終状態を確認
    ↓
4. 未完了タスクの担当セクションを読み込み
    ↓
5. 該当するタチコマを再起動（docsファイルパスと担当セクション名を指示）
    ↓
6. 再開したタチコマが既存の成果物を確認し、差分のみ実装
```

#### 再開時の注意事項

- **部分完了の確認**: 失敗したタチコマが途中まで作業していた場合、成果物の状態を確認してから再開する
- **実行ログの活用**: 最後に記録された状態から、どこまで進んだかを推定する
- **チェック済みタスクはスキップ**: `- [x]` のタスクは再実行しない
- **依存関係の再確認**: 再開するタスクが他のタスクの成果物に依存する場合、先行タスクの完了を確認する
