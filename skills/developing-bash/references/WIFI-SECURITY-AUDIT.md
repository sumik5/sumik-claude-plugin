# Wi-Fiセキュリティ監査 リファレンス

> **前提**: 本リファレンスの全技術は、**自組織が管理・所有するワイヤレスネットワークへの認可された監査**を前提とする。
> 他者のネットワークへの無断アクセス・攻撃は違法である。

---

## 1. ワイヤレスセキュリティプロトコルの理解

### プロトコル進化の概要

自組織のWi-Fiが適切に保護されているかを評価するには、各プロトコルの強度と弱点を理解することが重要。

### WEP（Wired Equivalent Privacy）

- **標準化**: 1999年9月
- **現状**: ❌ 完全に廃止（使用禁止）
- **問題点**: 脆弱な暗号アルゴリズム（RC4）と短い鍵長により、数分で解読可能。米国の輸出規制により強い暗号が使えなかった歴史的事情がある
- **対応**: WEPデバイスを発見したら**即時交換を推奨**

### WPA（Wi-Fi Protected Access）

- **標準化**: WEPの後継（2003年）
- **現状**: ❌ 廃止（2010年以降非推奨）
- **問題点**: WEPと同じ基盤技術を使用しており、後にセキュリティ上の弱点が発見された
- **認証モード**: WPA-Personal（パスワード共有）、WPA-Enterprise（証明書認証）
- **対応**: WPA環境は**WPA2またはWPA3への移行を推奨**

### WPA2（Wi-Fi Protected Access 2）

- **標準化**: WPAの完全置き換え
- **現状**: ⚠️ 現役だが移行推奨
- **強み**: AES暗号化を採用し、WPAより大幅に強化
- **弱点**:
  - クライアント認証時の4-wayハンドシェイクをキャプチャされると、オフライン辞書攻撃の対象になる
  - Forward Secrecyがないため、過去のトラフィックが後日解読される可能性がある
  - PMKIDキーが盗まれる可能性がある
- **必須対策**: 辞書に存在しない強力なパスワード（32文字以上のランダム文字列推奨）を使用する

### WPA3（Wi-Fi Protected Access 3）

- **標準化**: 現在の最新標準
- **現状**: ✅ 推奨
- **強み**:
  - SAE（Simultaneous Authentication of Equals）によりブルートフォース/辞書攻撃を理論上不可能にした
  - Forward Secrecyにより過去のトラフィックが保護される
  - 従来型の攻撃（ハンドシェイクキャプチャ・PMKID攻撃）は効果なし
- **注意**: ローグAPによるダウングレード攻撃、実装上の脆弱性（CVEデータベース参照）が存在する可能性がある
- **Wi-Fi Certified要件**: 現在、Wi-Fi Alliance認証にはWPA3対応が必須

### プロトコル比較まとめ

| プロトコル | 暗号化 | Forward Secrecy | 推奨 |
|-----------|--------|----------------|------|
| WEP | RC4（弱） | なし | ❌ 即時廃止 |
| WPA | RC4（弱） | なし | ❌ 廃止 |
| WPA2 | AES | なし | ⚠️ 移行推奨 |
| WPA3 | AES + SAE | あり | ✅ 推奨 |

---

## 2. デフォルト認証情報の監査

### 問題の概要

多くのネットワーク機器（ルーター、アクセスポイント等）は出荷時にデフォルトの認証情報が設定されている。変更せずに運用すると深刻なリスクになる。

### デフォルトパスワードの3パターン

| パターン | 例 | リスク |
|---------|-----|-------|
| 機器ごとに異なる | ラベルに印刷された個別パスワード | パターンが推測可能な場合は危険 |
| 全機器共通 | `admin/admin`、`admin/password` 等 | 公開されているリストで即試行される |
| 初期セットアップ用のみ | 初回ログイン後に変更強制 | 最も安全なパターン |

### 自組織の監査手順

```
1. 管理対象のネットワーク機器（ルーター、AP、スイッチ等）を棚卸し
2. 各機器のデフォルト認証情報をメーカー文書で確認
3. 現在の認証情報がデフォルトのまま残っていないか確認
4. デフォルトのままの機器は即時パスワード変更
5. パスワードマネージャーを使った強力なパスワードで管理
```

### 推奨対策

- 機器導入時に必ずデフォルトパスワードを変更する
- 管理画面へのアクセスを内部ネットワークのみに制限する
- ファームウェアを最新に保つ
- 管理画面のログイン試行を監視する

---

## 3. ワイヤレス環境の可視化（Kismet）

### Kismetとは

Kismetはパッシブ偵察型のワイヤレスネットワーク分析ツール。自組織のワイヤレス環境を可視化し、以下のリスクを検出するために使用する:

- **不正なアクセスポイント（Rogue AP）の検出**: 同一ESSIDの偽APが設置されていないか
- **ワイヤレスデバイスの棚卸し**: 自組織のデバイスすべてが把握されているか
- **スペクトラム分析**: ボトルネックや通信カバレッジの問題
- **プロトコル監査**: WEP/WPAを使用している古いデバイスの特定

Kismetは**パッシブ**（送信なし・受信のみ）のため、検知されにくく合法的な環境調査が可能。

### 収集できる情報

| フィールド | 内容 |
|-----------|------|
| ESSID / BSSID | アクセスポイント名とMACアドレス |
| Encryption | 使用している暗号化プロトコル（WEP/WPA/WPA2/WPA3） |
| Channel | 使用チャンネル（2.4GHz帯・5GHz帯） |
| Signal | 電波強度（dBm） |
| Manufacturer | デバイスメーカー（MACアドレスから推定） |
| Clients | 接続しているクライアントデバイス数 |

### セットアップ手順

```bash
# 1. kismetグループにユーザーを追加（sudo不要で実行するため）
sudo usermod -a -G kismet "${USER}"
# ← ログアウト・再ログインして反映させる

# 2. ワイヤレスアダプターをモニターモードに設定
#    （モニターモード: 他デバイス宛のパケットも受信可能にする）
sudo airmon-ng start wlan0
#    ← wlan0mon という名前になる（変わらない場合もある）

# 3. NetworkManagerとwpa_supplicantを停止
#    （これらがチャンネルを変更してKismetと干渉するため）
sudo airmon-ng check kill

# 4. Kismet起動（モニターモードのインターフェースを指定）
kismet -c wlan0mon
# ブラウザで http://localhost:2501 を開いて操作

# 5. 監査完了後: ネットワーキングサービスを元に戻す
sudo airmon-ng stop wlan0mon
sudo systemctl start NetworkManager
sudo systemctl start wpa_supplicant
```

### Kismet画面の見方

Kismet WebUIで確認すべき主要な列:

| 列名 | 確認ポイント |
|------|------------|
| **Name（ESSID）** | 自組織のAPと一致しない不審なAPがないか |
| **Encryption** | WEP/WPAを使用しているAPがないか（→ 更新推奨） |
| **Clients** | 不審なデバイスが接続していないか |
| **Manufacturer** | 見覚えのないメーカーのデバイスがないか |

### Kismetログの分析

Kismetは自動的にSQLiteデータベースとしてセッションをログに記録する:

```bash
# ログファイルの確認
ls -l Kismet-*.kismet

# SQLiteブラウザで詳細確認
sqlitebrowser Kismet-<タイムスタンプ>.kismet
```

---

## 4. 暗号化強度の検証（WPA2環境の評価）

### 評価の目的

自組織のWPA2ネットワークが十分な強度で保護されているかを確認する。

### 必要な機器要件

監査に使用するワイヤレスアダプターは**パケットインジェクション対応**である必要がある:

```bash
# アダプターがパケットインジェクションに対応しているか確認
sudo airmon-ng start wlan0
sudo aireplay-ng -9 wlan0mon

# 出力例（対応している場合）:
# Injection is working!
# Found 5 APs

# 出力例（非対応の場合）:
# No Answer...
# Found 0 APs
```

ノートPC内蔵アダプターは通常パケットインジェクション非対応。外付けUSBアダプターが必要。

### Wifiteを使った自組織Wi-Fi強度評価

Wifiteは複数の攻撃手法を自動的に試みるPythonスクリプト。自組織のWPA2ネットワークが脆弱でないかを評価するために使用する。

```bash
# 必要なツールのインストール（Kali Linux）
sudo apt install hcxdumptool hcxtools

# Wifite起動（--kill: NetworkManagerを自動停止）
sudo wifite --kill

# 複数アダプターがある場合はインターフェースを指定
sudo wifite --kill -i wlan1

# カスタムワードリストを使用
sudo wifite --kill --dict /usr/share/wordlists/rockyou.txt
```

### Wifiteが試みる攻撃ベクター

| 攻撃手法 | 対象 | 前提条件 |
|---------|------|---------|
| **4-wayハンドシェイク** | WPA/WPA2 | クライアントの接続/再接続が必要 |
| **PMKID攻撃** | WPA/WPA2 | クライアント接続不要（APにPMKIDが存在する場合） |
| **WPS攻撃** | WPS有効なAP | WPSの設定による |

### 4-wayハンドシェイク評価の仕組み

WPA2はクライアント認証時に4-wayハンドシェイクが発生する。このハンドシェイクをキャプチャすることで、オフラインでパスワード強度を検証できる:

1. Wifiteがアダプターをモニターモードに設定
2. パッシブにハンドシェイクを待機、またはde-auth送信で強制再認証
3. キャプチャしたハンドシェイクに対して辞書/ブルートフォース攻撃
4. パスワードが辞書に存在すれば解読される → **強力なパスワードへの変更が必要**

### PMKID攻撃評価の仕組み

PMKIDはWPA/WPA2のローミング高速化のためにAPが保持するキー。特徴:

- クライアントが接続していなくても攻撃可能
- APに対してリクエストを送るだけでPMKIDを取得できる
- 取得したPMKIDはオフラインで解析される

**PMKIDが危険な理由**: 誰もネットワークに接続していない夜間でも、外からPMKIDを収集してオフラインで解析できる。

### WPA3への耐性確認

```bash
# WPA3対応APに対してWifiteを実行した場合の期待される結果:
# PMKID CAPTURE: Failed to capture PMKID    ← PMKID攻撃が失敗
# WPA Handshake capture FAILED: Timed out  ← ハンドシェイクキャプチャ失敗
# → WPA3は従来の攻撃に対して有効に機能している
```

---

## 5. セキュリティ改善の推奨事項

### プロトコル設定の改善

| 現状 | 推奨 | 優先度 |
|------|------|-------|
| WEP使用中 | WPA3対応機器へ交換 | 🔴 緊急 |
| WPA使用中 | WPA2以上へ移行 | 🔴 緊急 |
| WPA2のみ | WPA3への移行計画を策定 | 🟡 高 |
| WPA3使用中 | ファームウェアを最新に保つ | 🟢 低 |

### パスワード強化

```
推奨: 32文字以上のランダム文字列（英数字・記号混在）
例のような弱いパスワード: password, company123, WiFi2024
→ rockyou.txt等の辞書に含まれるパスワードは危険

ツール: KeePass / Bitwarden等のパスワードマネージャーで生成・管理
```

### アクセスポイント名（ESSID）の設計

- **避けるべきESSID**: 会社名、場所、個人名を含むもの（攻撃対象を特定されやすい）
- **推奨**: 組織や場所を特定できない中立的な名前を使用

### WPS設定の確認

WPS（Wi-Fi Protected Setup）は利便性のためPINを使った接続を可能にするが、設定によっては脆弱になる:

```
WPS Pixie-Dust: WPS PIN not found → 問題なし
WPS NULL PIN: Locked             → 問題なし
WPS PIN Attack: Locked           → 問題なし（ロック機能が機能している）
```

**WPSを使用する場合**: メーカーのドキュメントを参照し、ブルートフォース保護（ロックアウト機能）が有効になっていることを確認する。使用しない場合はWPSを無効化する。

### ダウングレード攻撃への対策

WPA3対応APでも、WPA/WPA2のクライアントが接続するとダウングレードが発生する可能性がある:

1. WPA3のみのモードを使用する（WPA2/WPA3混在モードを避ける）
2. WPA3非対応の旧デバイスは別のSSID（WPA2専用ネットワーク）に分離する
3. ゲスト用ネットワークを社内ネットワークから完全に分離する

### 定期的な監査スケジュール

| 頻度 | 内容 |
|------|------|
| 月次 | Kismetによるワイヤレス環境スキャン（不正AP検出） |
| 四半期 | WPA2パスワード強度評価（Wifite） |
| 年次 | プロトコル更新検討・全APのファームウェア確認 |
| 機器追加時 | デフォルト認証情報確認・設定標準への適合確認 |

---

## 6. セキュリティ監査チェックリスト

### 実施前確認

- [ ] 評価スコープ（対象AP・SSID・エリア）を文書化した
- [ ] 組織の管理者から書面による認可を取得した
- [ ] 周辺の第三者ネットワークへの誤った干渉リスクを認識している
- [ ] 監査結果の取り扱い手順を確認した

### 評価項目

**プロトコル確認**
- [ ] WEP/WPA使用APが存在しないか（Kismetで確認）
- [ ] 全APがWPA2以上を使用しているか
- [ ] WPA3への移行計画が存在するか

**デバイス設定確認**
- [ ] デフォルト認証情報が変更されているか
- [ ] ファームウェアが最新か
- [ ] WPSの設定が適切か（不使用の場合は無効化）

**パスワード強度検証**
- [ ] 辞書攻撃でパスワードが解読されないか（Wifiteで確認）
- [ ] パスワードが32文字以上のランダム文字列か

**環境確認**
- [ ] 不正なAPが存在しないか（Kismetで確認）
- [ ] 接続している不審なデバイスがないか
- [ ] ゲストネットワークが適切に分離されているか

### 修正優先度の基準

| 重要度 | 条件 | 対応期限 |
|-------|------|---------|
| 🔴 緊急 | WEPまたはWPA検出、デフォルトパスワード使用中 | 即時（24時間以内） |
| 🟠 高 | 弱いパスワード（辞書で解読可）、WPSが脆弱 | 1週間以内 |
| 🟡 中 | WPA2からWPA3への未移行、ファームウェア未更新 | 1ヶ月以内 |
| 🟢 低 | ESSIDに組織名が含まれている等の設定最適化 | 次回メンテナンス時 |
