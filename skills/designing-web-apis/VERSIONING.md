# API バージョニング

設計変更をしやすい Web API を構築するためのバージョニング戦略。

---

## API 変更の難しさ

API の仕様変更が影響するケース:

| ケース | 影響の大きさ | 特記事項 |
|--------|------------|---------|
| 外部公開 API（LSUDs） | 🔴 非常に大きい | 利用者数が不明。予告なし変更は信頼失墜 |
| モバイルアプリ向け（SSKDs） | 🟡 中程度 | 古いクライアントが残存。アプリ審査に時間がかかる |
| 自社 Web サービス向け | 🟢 比較的小さい | 同時デプロイ可能。ただしブラウザキャッシュに注意 |

一度公開した API の仕様変更は、すべてのケースで問題発生のリスクがある。

---

## バージョニング戦略

### バージョン指定方法の比較

| 方法 | 例 | メリット | デメリット |
|------|-----|---------|-----------|
| URI パス（推奨） | `/v1/users` | 一目瞭然。最も普及 | URI が純粋なリソース表現でなくなる |
| クエリパラメータ | `?v=1.5` | 省略可能 | 省略時のデフォルト問題 |
| メディアタイプ | `Accept: application/vnd.example.v2+json` | HTTP 仕様に忠実 | 実装の敷居が高い |
| カスタムヘッダ | `API-Version: 3.0` | URI がクリーン | 直感的でない |

**推奨**: URI パスにメジャーバージョンを埋め込む方式。`v` プレフィックスを付ける（`/v1/`, `/v2/`）。

### バージョン番号のルール

- **整数（メジャーバージョンのみ）** を推奨
- セマンティックバージョニングのメジャーバージョンに相当
- 頻繁にバージョンを上げない（メンテナンスコスト増大）
- マイナーバージョン（1.1, 2.0 等）を URI に含めるのは少数派

---

## バージョンを上げるべき/上げるべきでない変更

### バージョンアップが必要な変更（後方互換性なし）

- 認証方式の変更（ベーシック認証 → OAuth 限定化等）
- レスポンスフィールドのデータ型変更（数値 → 文字列等）
- 必須パラメータの追加
- エンドポイントの構造的変更

### バージョンアップ不要な変更（後方互換性あり）

- 新しいエンドポイントの追加
- レスポンスに新しいフィールドを追加（既存フィールドは維持）
- オプショナルパラメータの追加
- バグ修正

### 後方互換性を保つテクニック

- 数値 → 文字列に変更したい場合: `gender`（数値）を残したまま `gender_str`（文字列）を追加
- 旧フィールドを deprecated とマークし、次期メジャーバージョンで削除

---

## API 提供終了の手順

### 推奨フロー

1. **事前告知**: 新バージョンリリースと同時に旧バージョンの廃止予定日を告知
2. **移行期間**: 最低 6 ヶ月（大規模 API は 1〜2 年）の並行運用
3. **Blackout Test**: 一時的に旧バージョンを停止するテストを実施
4. **段階的廃止**: テスト → 告知再確認 → 最終廃止

### 廃止時のレスポンス

廃止予定 API には警告ヘッダを追加:

```http
X-API-Warn: This API version is deprecated. Please migrate to /v2/
Sunset: Sat, 01 Jan 2025 00:00:00 GMT
```

廃止後は 410 Gone + 移行先情報を返す:

```http
HTTP/1.1 410 Gone
Content-Type: application/json

{
  "error": "This API version has been discontinued",
  "message": "Please use /v2/ instead",
  "docs": "https://example.com/docs/migration"
}
```

---

## 最新版エイリアスは不要

- バージョン番号なしで最新版にアクセスできるエイリアスは**非推奨**
- 理由: 将来の挙動変化でクライアントが突然壊れるリスク
- バージョン省略時はサポート中の最も古いバージョンとして扱うのがより安全

---

## オーケストレーション層

- LSUDs 向けの汎用 API + SSKDs 向けの専用 API を使い分ける概念
- 汎用 API の上に SSKDs 向けの最適化レイヤーを置く
- モバイルアプリ向けに複数 API を束ねたエンドポイントを提供する等
- Backend for Frontend (BFF) パターンとも関連

### BFF パターンの利点

- クライアント種別ごとに最適化されたエンドポイント
- 複数のマイクロサービスを束ねて 1 回の API コールで必要なデータを返す
- モバイル向けにペイロードサイズを削減
- Web 向けにリアルタイム更新機能を追加

### 実装例

```
/api/v1/users       # 汎用 API（LSUD）
/api/mobile/v1/     # モバイル専用 BFF（SSKD）
/api/web/v1/        # Web 専用 BFF（SSKD）
```

各 BFF は内部で汎用 API を呼び出し、クライアントに最適化したレスポンスを返す。
