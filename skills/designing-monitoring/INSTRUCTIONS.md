# Designing Monitoring

## 概要

監視（Monitoring）とは、「何かがおかしい時に知らせてくれるもの」ではありません。**システムの現在の状態を理解し、ビジネス価値と技術指標を結びつけるための包括的なプラクティス**です。

**監視の本質:**
- システムが「動いている」状態を正確に定義する
- ビジネスKPIと技術指標を紐付ける
- ユーザーに最も近いところから監視を開始する
- 問題の早期発見とトラブルシューティング
- データに基づく意思決定を可能にする

**監視は複雑な問題をひとくくりにしたもの:**

監視という言葉は、データ収集、メトリクス、ログ、可視化、アラート、インシデント管理など、多数の異なる関心事を包含します。単一のツールですべてを解決することはできません。

**オブザーバビリティ:**

オブザーバビリティ（可観測性）は、モニタリングを補完する概念です。モニタリングが「既知の問題を検知する」のに対し、オブザーバビリティは「未知の問題を探索・解明する」能力を提供します。構造化イベント、コア分析ループ、SLOベースの信頼性設計など、現代の分散システムに不可欠な実践を含みます。

詳細は [OBSERVABILITY.md](./references/OBSERVABILITY.md) を参照してください。

---

## 監視のアンチパターン

以下の5つのアンチパターンを避けることで、効果的な監視システムを構築できます。

| アンチパターン | 説明 | 対策 |
|--------------|------|------|
| **1. ツール依存** | 「このツールを導入すれば監視が完璧になる」という誤解。監視は複雑な問題の集合であり、単一ツールで解決できない | 組み合わせ可能な監視（Composable Monitoring）を採用。データ収集、メトリクス、ログ、可視化、アラートを個別コンポーネントとして選択 |
| **2. 役割としての監視** | 「監視チーム」を作り、開発者は監視の責任を持たないという考え方。これはDevOpsと対立する | 開発者全員の責務にする。コードを書く人が監視設定も行う |
| **3. チェックボックス監視** | CPU使用率をチェックしただけで「監視している」とする。OSメトリクスだけでアラートを出しても意味がない | 「動いている」の定義を明確にする。ユーザー視点で監視する（HTTP 200 OKから始める） |
| **4. 監視を支えにする** | 壊れやすいアプリケーションを監視でカバーしようとする。根本原因を修正せずに対処療法に頼る | アプリケーションの品質を向上させる。監視は健康状態の確認であり、応急処置ではない |
| **5. 手動設定** | クラウド環境で手動でホスト登録し、手動で設定を更新する | サービスディスカバリと自動設定を採用。インフラがコード化されている前提で監視も自動化 |

### アンチパターン1: ツール依存

**カーゴ・カルトなツール選択を避ける:**
- 「大企業が使っているから」という理由だけでツールを選ばない
- 自社の規模・課題・技術スタックに合ったツールを選択する
- 必要に応じて自作ツールも検討する（既存ツールが要件を満たさない場合）

**「一目で分かる」は迷信:**
- NOC（Network Operations Center）の巨大モニター壁は見栄えが良いが、実用性は低い
- 42インチディスプレイで6つのグラフを表示しても、細かい異常は見えない
- 効果的な監視は「異常を検知してアラートを出すこと」であり、「常時画面を見張ること」ではない

### アンチパターン2: 役割としての監視

**DevOps的アプローチを採用:**
- 監視は開発者、運用担当者、全員の責務
- コードを書く人が、そのコードの監視設定も行う
- 「監視専任チーム」を作ると、開発チームが監視の責任を放棄する

**Observability（可観測性）:**
- システムが「観測可能」であることは、設計段階から組み込むべき要件
- 後付けで監視を追加するのではなく、最初から監視を考慮したアーキテクチャにする

### アンチパターン3: チェックボックス監視

**「動いている」の定義を明確にする:**
- CPU使用率が5%だからといって「動いている」とは限らない
- Webサーバなら「HTTP GET / が HTTP 200 OKを返すこと」が「動いている」の定義
- ビジネスロジックが正常に機能しているかを確認する

**OSメトリクスだけでアラートしない:**
- CPU使用率やメモリ使用率は「参考情報」であり、アラート基準にはならない
- OSメトリクスが99%正常でも、ユーザーには障害が発生している可能性がある
- ユーザーに最も近いレイヤーから監視を始める

**メトリクス取得頻度を上げる:**
- 従来の監視ツール（Nagios等）は2分〜30分間隔でチェック
- 現代の監視では5秒〜10秒間隔が推奨
- 60秒間隔では10秒間のCPUスパイクを見逃す可能性がある

### アンチパターン4: 監視を支えにする

**根本原因を修正する:**
- PHP Fatal Errorが頻繁に発生するなら、監視を強化するのではなくコードを修正する
- 監視は「健康状態の確認」であり、「応急処置」ではない
- アラートが頻繁に発生するなら、それは監視の問題ではなくシステムの問題

### アンチパターン5: 手動設定

**クラウド環境では自動検出・自動設定が必須:**
- Auto Scalingでインスタンスが増減するたびに手動設定するのは非現実的
- サービスディスカバリ（Consul, etcd等）を使用してホストを自動検出
- Infrastructure as Code (IaC) と連携して監視設定も自動化

**手順書依存も避ける:**
- Runbook（手順書）は必要だが、それに頼りすぎない
- 繰り返し実行する作業は自動化する（自動復旧、auto-healing）

---

## 監視のデザインパターン

以下の4つのデザインパターンを採用することで、効果的な監視システムを構築できます。

| デザインパターン | 説明 | 主なメリット |
|----------------|------|-------------|
| **1. 組み合わせ可能な監視** | データ収集、メトリクス、ログ、可視化、アラートを個別コンポーネントとして組み合わせる。Unixの哲学を監視に適用 | 柔軟性、拡張性、ベストオブブリード |
| **2. ユーザ視点での監視** | ユーザーに最も近いところ（ロードバランサ等）から監視を始め、下流へ向かう。HTTPレスポンスコードから始める | ユーザー影響を即座に検知、根本原因の特定が容易 |
| **3. 作るのではなく買う** | SaaS監視を推奨。コスト・専門性・プロダクトフォーカスの3観点から、自社構築よりもSaaSが有利 | コスト削減、専門家の知見活用、プロダクト開発に集中 |
| **4. 継続的改善** | 監視は一度設定して終わりではない。継続的に改善し続ける。最初は完璧でなくてよい | 段階的な改善、学習と適応 |

### デザインパターン1: 組み合わせ可能な監視（Composable Monitoring）

**Unixの哲学を監視に適用:**
- 各コンポーネントは1つのことをうまくやる
- 小さなツールを組み合わせて複雑なシステムを構築
- モノリシックツール（Nagios等）から脱却

**歴史的背景:**
- 2011年に #monitoringsucks というハッシュタグがTwitterで話題に
- モノリシックツールへの不満が高まる
- Graphite, Sensu, logstash, collectd等のモジュラーツールが登場
- 現在は #monitoringlove として、組み合わせ可能な監視が主流に

**監視サービスのコンポーネント:**

監視システムは以下の5つの主要コンポーネントで構成されます。

#### 1. データ収集

**プッシュ型 vs プル型:**

| 方式 | 説明 | 利点 | 欠点 |
|------|------|------|------|
| **プッシュ型** | アプリケーション/ホストが監視サーバーにデータを送信 | ファイアウォール内のホスト監視が容易、リアルタイム性が高い | 監視サーバーへの負荷が集中、ホスト側の設定が必要 |
| **プル型** | 監視サーバーが定期的にホストからデータを取得 | 監視サーバー側で取得間隔を制御可能、ホスト側の負荷が低い | ファイアウォール越しの監視が困難、取得間隔の遅延 |

**主な収集方法:**
- **SNMP** — ネットワーク機器、ハードウェアの標準プロトコル
- **/health エンドポイント** — アプリケーションの健全性チェック（後述）
- **Syslog** — システムログの標準プロトコル
- **collectd, StatsD** — メトリクス収集エージェント
- **サービスディスカバリ（Consul, etcd）** — 動的なホスト検出

#### 2. メトリクス

**2つの基本型:**

| 型 | 説明 | 例 |
|----|------|-----|
| **Counter** | 単調増加する値。リセットされるまで増え続ける | Webリクエスト数、エラー数 |
| **Gauge** | 上下する値。現在の状態を表す | CPU使用率（0-100%）、メモリ使用量（32GB中の使用量） |

**Time Series Database (TSDB):**
- メトリクスは時系列データベースに保存される
- Graphite Whisper, Prometheus, InfluxDB等
- Roll-up（集約）機能: 古いデータは粗い粒度に集約して保存容量を削減
  - 例: 60秒間隔で収集 → 3日後は5分間隔に集約 → 24日後は削除

#### 3. ログ

**構造化ログを推奨:**

非構造化ログ（従来型）:
```
192.34.63.77 - - [26/Jun/2016:14:06:22 -0400] "GET / HTTP/1.1" 301 184 "-" "Mozilla/5.0..."
```

構造化ログ（JSON形式）:
```json
{
  "remote_addr": "192.34.63.77",
  "remote_user": "-",
  "time": "2016-06-26T14:06:22-04:00",
  "request": "GET / HTTP/1.1",
  "status": "301",
  "body_bytes_sent": "184",
  "http_referrer": "-",
  "http_user_agent": "Mozilla/5.0 (Windows NT 10.0; WOW64)...",
  "http_x_forwarded_for": "-"
}
```

**構造化ログのメリット:**
- フィールド単位で検索可能
- 集約・分析が容易
- 正規表現が不要（パフォーマンス向上）

**ログの保存:**
- Elasticsearch等の検索エンジンに保存
- 1TB以上のデータになる可能性があるため、保持期間を慎重に設定

#### 4. 可視化

**ダッシュボード設計の原則:**
- 1つのダッシュボードに1つのテーマ
- グラフの種類を適切に選択（折れ線グラフ、ストリップチャート等）
- 色使いに一貫性を持たせる

**推奨ツール:**
- **Grafana** — 高機能ダッシュボードツール
- **Smashing** — カスタムダッシュボード構築フレームワーク

**推奨書籍:**
- Edward Tufte「The Visual Display of Quantitative Information」
- Stephen Few「Information Dashboard Design」

#### 5. アラート

**アラート設計の詳細は OPERATIONS.md を参照してください。**

主要原則:
- メール通知を廃止し、PagerDuty/VictorOps等の専用ツールを使用
- すべてのアラートに手順書（Runbook）を添付
- 固定閾値だけでなく、動的閾値（moving average, confidence band）を活用
- アラートは継続的にチューニング・削除する

---

## レイヤー別監視の概要

監視は以下の6つのレイヤーに分けて戦略を立てます。

| レイヤー | 監視対象 | 主な目的 |
|---------|---------|---------|
| **1. ビジネス監視** | ビジネスKPI（売上、ユーザー数、コンバージョン率等） | ビジネス価値と技術指標を紐付ける |
| **2. フロントエンド監視** | ブラウザパフォーマンス、ユーザー体験 | 遅いアプリケーションのコストを可視化 |
| **3. アプリケーション監視** | アプリケーションコード、API、マイクロサービス | コードの動作状況、パフォーマンス、エラー率を追跡 |
| **4. サーバ監視** | OS、Web/DB/LB/MQ/Cache/DNS | インフラの健全性、リソース使用率 |
| **5. ネットワーク監視** | SNMP、フロー監視、キャパシティプランニング | ネットワークの可用性、帯域幅使用率 |
| **6. セキュリティ監視** | auditd、HIDS/NIDS、コンプライアンス | 侵入検知、監査対応 |

**各レイヤーの詳細は [STRATEGY.md](./references/STRATEGY.md) を参照してください。**

---

## テレメトリーパイプライン概要

監視システムの基盤となるテレメトリーパイプラインは、以下の3ステージアーキテクチャで構成されます。

```
[Production Systems]
        |
        v
┌─────────────────┐
│ Emitting Stage  │  テレメトリーを発信
│ (発信ステージ)   │  - ログファイル
│                 │  - システムログ (Syslog)
│                 │  - 標準出力
└────────┬────────┘
         |
         v
┌─────────────────┐
│ Shipping Stage  │  テレメトリーを移送・格納
│ (移送ステージ)   │  - フォーマット統一
│                 │  - エンリッチメント
│                 │  - ストレージへの書き込み
└────────┬────────┘
         |
         v
┌─────────────────┐
│Presentation Stage│ テレメトリーを表示
│ (表示ステージ)   │  - グラフ・ダッシュボード
│                 │  - 検索・分析
│                 │  - アラート
└─────────────────┘
```

**各ステージの役割:**
- **Emitting**: プロダクションコードやハードウェアがテレメトリーを生成し、次のステージに渡す
- **Shipping**: 受け取ったテレメトリーを変換・加工し、ストレージに保存
- **Presentation**: 保存されたテレメトリーを検索・可視化し、意思決定を支援

**詳細は [TELEMETRY-PIPELINE.md](./references/TELEMETRY-PIPELINE.md) を参照してください。**

---

## ユーザー確認の原則（AskUserQuestion）

以下の判断が必要な場合、AskUserQuestionで選択肢を提示してください:

### 1. 監視ツールの選定

**確認すべき場面:**
- 新規監視システム構築時
- 既存システムの移行時

**選択肢の提示例:**
```
監視ツールの選定方針を教えてください:
- SaaS監視サービス（Datadog, New Relic等）を使用
- OSS監視ツール（Prometheus, Grafana等）を自社運用
- ハイブリッド（一部SaaS、一部OSS）
```

### 2. SaaS vs 自社構築の判断

**確認すべき場面:**
- 監視システムの初期設計時
- コスト最適化の検討時

**判断基準を提示:**
- **コスト**: SaaSは月額$6,000-$9,000程度。自社構築は初期投資+人件費で年間$150,000以上
- **専門性**: 監視ツールの専門家を社内に抱えるか、SaaSベンダーの専門知識を活用するか
- **プロダクトフォーカス**: 監視インフラの運用に時間を使うか、プロダクト開発に集中するか

### 3. アラート通知方法

**確認すべき場面:**
- アラート設計時

**選択肢の提示例:**
```
アラート通知方法を教えてください:
- PagerDuty / VictorOps / OpsGenie等の専用ツール（推奨）
- Slackへの通知
- メール通知（非推奨）
```

### 確認不要な場面

以下はベストプラクティスが明確なため、確認なしで適用してください:

1. **構造化ログの採用** — 常に推奨（JSON形式）
2. **ユーザー視点での監視** — ロードバランサから監視開始
3. **メトリクス取得頻度** — 5秒〜10秒間隔を推奨
4. **サービスディスカバリの採用** — クラウド環境では必須

---

## サブファイル参照一覧

- [STRATEGY.md](./references/STRATEGY.md) — レイヤー別監視戦略（ビジネス、フロントエンド、アプリケーション、サーバ、ネットワーク、セキュリティ）
- [OPERATIONS.md](./references/OPERATIONS.md) — アラート設計、オンコール運用、インシデント管理、統計入門
- [TELEMETRY-PIPELINE.md](./references/TELEMETRY-PIPELINE.md) — Emit/Ship/Presentステージの詳細設計
- [STORAGE-SYSTEMS.md](./references/STORAGE-SYSTEMS.md) — ストレージシステム比較（Elasticsearch, Prometheus等）
- [DATA-LIFECYCLE.md](./references/DATA-LIFECYCLE.md) — 保持ポリシー、集約、サンプリング、法的対応
- [TECHNIQUES.md](./references/TECHNIQUES.md) — 正規表現最適化、構造化ログ、カーディナリティ管理
- [USE-CASES.md](./references/USE-CASES.md) — 組織規模別のテレメトリーシステム設計
- [CHECKLIST.md](./references/CHECKLIST.md) — 監視アセスメント実施ガイド
- [OBSERVABILITY.md](./references/OBSERVABILITY.md) — オブザーバビリティの定義・哲学、構造化イベント、コア分析ループ
- [SLO-RELIABILITY.md](./references/SLO-RELIABILITY.md) — SLI/SLO/SLA、エラーバジェット、SLOベースアラート
- [OBSERVABILITY-PRACTICES.md](./references/OBSERVABILITY-PRACTICES.md) — ODD、計装イテレーション、ビジネス事例、利害関係者
- [SAMPLING-STRATEGIES.md](./references/SAMPLING-STRATEGIES.md) — ヘッド/テール/動的サンプリング戦略
- [MATURITY-MODEL.md](./references/MATURITY-MODEL.md) — オブザーバビリティ成熟度モデル（OMM）

---

## 関連スキル

- **implementing-opentelemetry** — OpenTelemetry SDK/API実装、分散トレーシング
- **designing-frontend** — フロントエンドパフォーマンス監視の実装
- **automating-browser** — Synthetic Monitoring（合成監視）の実装
- **modernizing-architecture** — 社会技術的アーキテクチャ、組織変革
