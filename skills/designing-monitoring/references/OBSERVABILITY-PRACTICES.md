# オブザーバビリティの実践

オブザーバビリティはソフトウェア開発ライフサイクルの初期段階から適用でき、組織全体に展開することでビジネス価値を最大化できます。

---

## チームへの適用

### コミュニティグループに参加する

オブザーバビリティは新しい取り組みであり、アプローチは急速に進化しています。同じテーマで苦労している人々のコミュニティに参加することで多くを学べます。

**コミュニティ参加のメリット:**

- 同じ課題に直面している人たちと話すことで、すぐに学習できる
- 異なるバックグラウンドを持つ人たちとつながることができる
- 他のチームの経験から学び、比較検討できる
- 技術スタック、チームサイズ、組織力学などの共通点を持つメンバーを発見できる
- 新しい開発にアンテナを張っておける

**良いコミュニティ市民になるために:**

- しばらくの間グループに参加し、手助けをする
- 自分が何かを必要としているときだけ声を上げるのではなく、貢献する
- コミュニティは、あなたが作ることによってのみ強くなる

### 最大の問題点から始める

**小さく始めることは大きな過ちの一つです。**

オブザーバビリティツールは、捉えどころのない問題を素早く発見するために設計されています。目立たない、比較的重要でないサービスから始めると、オブザーバビリティの価値を証明するのと正反対の効果になってしまいます。

| アプローチ | 結果 |
|----------|------|
| ❌ 小さく・目立たないサービスから開始 | チームは作業を経験するが、何のメリットも得られない |
| ✅ 最大の問題点から開始 | 素早く価値を示し、好奇心を刺激し、興味を引き付ける |

**推奨される開始方法:**

1. サービスの不具合で何週間も眠れずにいる問題を選ぶ
2. データベースが常に混雑しているが原因不明の問題を選ぶ
3. 正体不明のユーザーによる不可解な負荷の問題を選ぶ
4. コードを計装し、本番環境にデプロイする
5. 好奇心を持って探求し、答えを見つける方法を見つける
6. 成功を周りの人に共有する
7. 発見と方法論を書き上げ、社内で共有する

**素早く価値を示すことで:**

- 否定的な意見に打ち勝つ
- さらなる支持を生み出す
- オブザーバビリティの採用をさらに推進できる

### 作るより買う

最大の問題点から始めるのと同様に、オブザーバビリティツールを自作するか、市販のソリューションを購入するかの決定は、投資収益率（ROI）を迅速に証明することに帰結します。

| 選択肢 | 特徴 |
|--------|------|
| **自社構築** | 最大の労力、価値実現までの時間が最長、継続的なメンテナンスコスト高 |
| **購入** | 最小の労力、価値実現までの時間が最短、機能要件を満たすツールを複数試せる |

**OpenTelemetryを使った計装を推奨:**

- ベンダーの独自エージェントやライブラリより若干の時間投資が必要
- 後で複数のソリューションを試して、どれが自分のニーズに最も合っているかを確認できる
- ベンダーロックインの罠を回避できる

**主なオープンソースツールの限界:**

| ツール | 役割 | 限界 |
|--------|------|------|
| **Prometheus** | メトリクスモニタリングのためのTSDB | メトリクスベースのモニタリング世界でのみ動作、固有の限界がある |
| **ELKスタック** | ログストレージとクエリー | プレーンテキスト検索に最適化、複合的な質問に対する答えを検索する際に実用的でない |
| **Jaeger** | イベントベースの分散トレース | トレースデータを分析・セグメント化する高度な機能は持っていない |

**ストレステストの実施:**

- すべての高カーディナリティで高ディメンションのフィールドを含むシステムの状態をデバッグできるか確認
- インタラクティブかつ高性能なリアルタイム探索によってデバッグする能力が必要
- 分析や反復的な調査を行うことができるか確認

### 計装を繰り返し完成させる

適切な計装には時間がかかります。OpenTelemetryの自動計装は開始するには良い場所ですが、最も価値のある計装は、個々のアプリケーションのニーズに特化したものです。

**計装のイテレーション戦略:**

1. できるだけ多くの有用な計装から始める
2. 徐々に計装を発展させる
3. 1つか2つの面倒なサービスを計装する
4. その計装をパイロットチームの参照ポイント・学習用演習として使用する
5. 新しいデバッグ状況を利用して、より多くの有用な計装を導入する

**オンコール対応エンジニアの活用:**

- 本番環境で問題が発生したとき、最初に新しいツールを使って計装する
- 新しい計装を使用して、問題が発生している場所を突き止める
- 2〜3回行うと、最初に計装を導入することでデバッグが簡単で時間がかからないことを理解する

**フィードバックループの形成:**

このフィードバックループは罰ではなく、コードのオーナーシップに不可欠なものです。エラーのフィードバックから遮断されていると、高品質のコードをリリースするために必要な直感やプラクティスを身につけられません。

**計装の規約に関する注意点:**

計装を始めるときの焦点は、選んだオブザーバビリティツールで可能な限り多くの価値を証明することです。しかし、計装が大きくなり、チーム全体に採用が広がると、生成するカスタムテレメトリーデータの命名規約を導入する必要があります。

### 既存の努力を活用する機会を探す

新しい技術を採用する際の最大の障壁の一つは、「埋没費用（サンクコスト）の誤謬」です。常に、他の作業をオブザーバビリティのイニシアティブの俎上に載せる機会を探し、それを利用してください。

**活用例:**

| 既存システム | 活用方法 |
|------------|---------|
| **ELKスタック** | ソースストリームの出力を二次的な送信先にフォークし、オブザーバビリティツールに送る |
| **構造化ログ** | ログイベントに一意のIDを追加し、既存のログ分析ツールとオブザーバビリティツールの両方に送信 |
| **既存APMソリューション** | オブザーバビリティの計装と一緒に実行し、体験を比較対照する |
| **Ganglia** | `/var/tmp`に書き込んだXMLダンプを解析し、cronジョブでオブザーバビリティツールに取り込む |
| **モニタリングダッシュボード** | 最も有用なものを新しいオブザーバビリティツールで簡単に参照できるクエリーとして再作成 |

世界を融合するためにできることは何でも、採用への障壁を低くするのに役立ちます。親しみやすさを求めることで、新しいツールの使い方がひどくても、物の名前がなじみのあるもので、データも知っているものであれば、完全にスクラッチのデータセットよりも、人々を対話に誘えます。

### 最後のひと押しに備える

最大の問題点に最初に取り組み、反復的なアプローチを採用することで、開始当初から迅速な進捗が見込めます。しかし、これらの戦略は、ゴールラインを超えることを考慮していません。

**完了計画の必要性:**

- ある程度勢いがついてきたところで、残りの作業を完成させるための戦略が必要
- オンコール対応の一環として新しい計装を繰り返し展開することで、半分から3分の2の作業を完了できる
- スタックのほとんど触れられていない部分については、しっかりとした完了計画が必要

**最終的なゴール:**

何か問題が発生したときに、本番環境のアプリケーションの状態を完全に理解するために使用できる、信頼性の高いデバッグソリューションを構築すること。

**推奨される完了戦略:**

- ゴールマイルストーンを設定する（オブザーバビリティツールを使用できるようにするために必要な残りの計装作業を達成する）
- ハックウィークのような特別な後押しを設定し、プロジェクトを完了させる
- できるだけ頻繁に計装を汎用化し、他のアプリケーションや組織内の他のチームでも再利用できるようにする
- 汎用的なオブザーバビリティライブラリを作成し、コード内部に入り込むことなく根本的なソリューションを交換できるようにする

---

## オブザーバビリティ駆動開発（ODD）

### テスト駆動開発との関係

**TDDの強み:**

- 制御された状態におけるアプリケーションに期待される動作を正確に定義した仕様を作成
- 決定論的な繰り返し実行可能な一連のテスト
- 当てずっぽうな作業を排除し、成果に一貫性を持たせる

**TDDの限界:**

- 分離されたテストを実行しても、顧客がサービスで良い経験をしているかどうかはわからない
- テストが成功しても、本番環境にリリースする前にエラーやリグレッションを迅速かつ直接的に分離して修正できるわけではない
- 本番環境に一貫性などない
- 再現性がない、仕様に合わない、計画通りにいかないなどの理由で、テストから除外される異常に対して準備できない

**オブザーバビリティの役割:**

オブザーバビリティは、より良いコードを書き、リリースするのに役立ちます。エンジニアがコードのバグを素早く発見するためのツール、プロセス、文化の一部です。

### 開発サイクルにおけるオブザーバビリティ

バグを迅速に解決するには、**原作者の頭の中に新鮮な意思が残っているうちに**、問題を検証できるかどうかに強く依存しています。

**早くデバッグしたい理由:**

- コードを書いてリリースした直後のタイミングのように、簡単に問題をデバッグできることは二度とない
- そこから先は難しくなるばかりで、スピードこそがカギ
- バグが誤ってリリースされてから、そのバグを含むコードに問題がないかを調べるまでの時間が長ければ長いほど、多くの人間が無駄な時間を過ごすことになる

### デバッグする場所を決定する

**オブザーバビリティの目的:**

オブザーバビリティはコードのロジックをデバッグするためのものではありません。**オブザーバビリティは、デバッグが必要なコードがシステムのどこにあるかを見つけ出すためのものです。**

| ツール | スケール | 主な用途 |
|--------|---------|---------|
| **オブザーバビリティツール** | システムレベル | 問題が発生している箇所を迅速に絞り込む（望遠鏡） |
| **デバッガー（GDB等）** | コードレベル | コードのロジックを行レベルでデバッグ（顕微鏡） |

**オブザーバビリティが答える質問:**

- どのコンポーネントでエラーが発生したのか
- どこで遅延が発生しているのか
- データの一部を壊したのはどこか
- どの通信に最も処理時間がかかっているのか
- その待ち時間は全ユーザーに均等なのか、それとも一部のユーザーだけが遭遇しているのか

### マイクロサービス時代のデバッグ

サービス要求がその機能を果たすためにネットワークを横断するようになると、運用やアーキテクチャ、インフラストラクチャなどのさまざまな複雑性に加え、ロジック上のバグも不可分に絡み合うようになりました。

**モノリシックシステムとの違い:**

- かつて: 構成要素の数が少なく、推論が容易だった
- 現在: デバッガーはネットワークを横断できず、うまく機能しない

**遅さの原因の複雑性:**

- あなたのコードのバグ
- 特定のユーザーの利用パターンの変化
- データベースのキャパシティ超過
- ネットワーク接続の制限
- ロードバランサーの設定ミス
- サービス登録やサービスディスカバリーでの問題
- 以上のいくつかの要因の組み合わせ

### 計装でオブザーバビリティを駆動する

**良い計装はオブザーバビリティを駆動します。**

計装を開発する際に役立つ目標は、強化メカニズムを作り、フィードバックのループを小さくすることです。言い換えれば、コードをリリースしてからエラーの結果を実感するまでのループを緊密なものにすることです。

**ソフトウェアエンジニアをオンコール担当にする:**

リリースされるコードをマージした担当者を、自動的にページングします。30分から1時間程度の短い期間、本番環境でアラートが発生した場合、そのアラートを担当者にルーティングします。

**フィードバックループの重要性:**

このフィードバックループは罰ではありません。むしろ、コードのオーナーシップに不可欠なものです。エラーのフィードバックから遮断されていると、高品質のコードをリリースするために必要な直感やプラクティスを身につけられません。

**すべてのエンジニアがデプロイ後すぐに答えられるべき質問:**

- コードは意図通り動くか
- 前のバージョンと比較してどうか
- ユーザーはコードを使えているか
- 異常事態は発生していないか

**より高度なアプローチ:**

エンジニアが本番環境の小さなサブセットに対してコードをテストできるようにすることで、フィードバックループはわずか数秒や数分に短縮できます。

- 新しい機能を機能フラグのもとでデプロイして一部のユーザーだけに公開
- ある機能を本番環境に直接デプロイして特定のユーザーからのリクエストのみをその新機能にルーティング

### オブザーバビリティをシフトレフトする

**TDD vs ODD:**

| アプローチ | 目的 |
|----------|------|
| **TDD（テスト駆動開発）** | 開発したソフトウェアが隔離された仕様に準拠していることを保証 |
| **ODD（オブザーバビリティ駆動開発）** | 本番環境というやっかいな現実の中でソフトウェアが機能することを保証 |

**本番環境の変化:**

- 従来: ガラスの城のような、時間をかけて設計された美しい記念碑のようなもの
- ODD採用後: インタラクティブな遊び場に変身

優れたテレメトリーとオブザーバビリティを備えたコードを書き、デプロイし、活用するエンジニアリングスキルを身につけることで、チームは本番環境で実際に何が起こっているかを推論する能力を身につけられます。

### オブザーバビリティを活用してソフトウェアデリバリーを高速化する

**スピードと品質の関係:**

従来の認識では、スピードと品質はトレードオフの関係にある、つまり、ソフトウェアを早くリリースすることと高品質のソフトウェアをリリースすることとは両立できないとされていました。しかし、この逆相関関係は神話です。

| パフォーマンス | スピードと品質の関係 |
|--------------|-------------------|
| **エリートパフォーマー** | スピードが速くなれば、障害は小さくなり、発生頻度も減り、発生しても回復しやすくなる |
| **スピードが遅いチーム** | 障害はより頻繁に発生し、回復にかなりの時間がかかる傾向 |

**コードの本番環境へのデリバリーを高速化する方法:**

1. コードのまとまった変更を一度に1つずつ、1人のエンジニアが1回マージしてリリースする
2. デプロイプロセスとコードに、真のエンジニアリングの労力を費やす
3. 経験豊富なエンジニアに担当させる
4. 全員がデプロイパイプラインを理解し、継続的に改善する権限があると感じられるようにする
5. 一人のエンジニアやチームの専売特許にしない

---

## ソフトウェアサプライチェーンのオブザーバビリティ

**ソフトウェアサプライチェーン:** 開発からCI/CDパイプラインを経て、本番環境にデプロイされるまでのソフトウェアに入るもの、あるいは影響を与えるものすべて。

### なぜオブザーバビリティが必要なのか

**開発環境の複雑性:**

- コードのテストやデプロイのワークフローは、一部の本番サービスよりも複雑になることがよくある
- インフラの種類やランタイムのバージョンなど、根底にある依存関係が予期せず変化し、意図しない不具合が発生する可能性がある
- 問題は予測不可能な場所に隠されている可能性がある

**内部ツールの特性:**

- カーディナリティは大幅に低くなる
- 単一のイベントとスパンの重要度は大幅に高くなる
- 依存するシステムで障害が発生すると、開発速度の低下とチームのフラストレーション、そして最終的には顧客へのソフトウェア提供の遅れを意味する

### 計装：共有クライアントライブラリとディメンション

**ディメンションの役割:**

各ステージでは、CI内での処理にコンテキスト与える追加のディメンションが表示されます。エンジニアは、本番環境でパフォーマンスや信頼性の問題が発生した場合、単一または複数のディメンションを組み合わせてパンくずとして使用し、実行内容を調査します。

**ディメンションの活用例:**

| 用途 | 使用するディメンション |
|------|---------------------|
| **並行性の問題特定** | ホスト名、Jenkinsワーカーのグループ |
| **一般的なビルドの失敗識別** | コミットヘッド、コミットメインブランチ |

追加された各ディメンションは、問題調査時の方向性と手がかりとなります。手がかりを組み合わせて、デプロイされたコード内の特定の問題を繰り返し掘り下げられます。

### ツールによるコンテキストの理解

**小さなオブザーバビリティ駆動なフィードバックループの形成:**

1. テストプラットフォームのトレースによる計装で、これまで未解明だった実行時変数を捕捉する
2. 小さなオブザーバビリティ駆動なフィードバックループを形成し、興味深いディメンションを探索する
3. 脆弱なテスト構成と相関のあるディメンションで可逆的な実験を実行する

計装を始めてから数日以内に、複数のディメンションが、フレーク率の高いテストスイートと非常に高い相関関係を示す場合があります。データによって強化されたエンジニアは、プラットフォームのより良いデフォルト設定を決め、不安定な構成のためのガードレールを配置するために実験をします。

### アクション可能なアラートの組み込み

トレースによるオブザーバビリティは、メッセージや設定されたダッシュボードから指示することで、エンジニアの仕事を支援する上で重要な役割を担っています。

1つのテスト実行は、コード、インフラ、または製品の機能によって、異なる方法で理解されるかもしれません。各チームやプラットフォームは、テスト実行のさまざまな部分に対して複数のSLOを持つかもしれません。

---

## ビジネス事例の構築

### リアクティブな変革の落とし穴

**変革は困難です。** 壊れていないもの（あるいはそのように思われているもの）を、わざわざ直すのは珍しいことでしょう。

**リアクティブなアプローチの問題:**

- ミッションクリティカルなビジネス上の問題を解決しようと急ぐあまり、過度に単純化したアプローチを取ってしまう
- 症状に対処するが、根本的な原因を治療しない
- 許容されてしまっている時代遅れな機能不全を認識できない

**オブザーバビリティが確保されていない兆候:**

- 本番環境における重大なバグは、社内で発見され対処されるよりもずっと前に、顧客が発見し報告する
- マイナーなインシデントが発生した場合、その検出と復旧に時間がかかり、長期的なサービス停止に発展してしまうことがよくある
- インシデントやバグのトラブルシューティングに必要な調査のバックログが増え続ける
- 壊れたものを直すような運用作業に費やす時間は、新機能の提供に費やす時間を上回っている
- サポートチームはパフォーマンス問題を検証、再現、解決できないことが多く、サービスに対する顧客満足度が低下する
- さまざまなサービスがどのように相互作用しているかを把握するのが困難で、予見できない作業がエンジニアリングチームで処理できないほど大量に積み上がる

### オブザーバビリティの投資対効果（ROI）

オブザーバビリティは普遍的に、4つの重要な方法で最終損益に影響を与えます。

| 影響領域 | 内容 |
|---------|------|
| **収益の増加** | 稼働時間とパフォーマンスの向上、コード品質の向上による直接的な収益増加 |
| **インシデント対応の迅速化** | MTTD・MTTRの短縮、クエリーの応答時間改善、ボトルネックの早期発見、通話時間の短縮、ロールバック回避による時間短縮 |
| **インシデント回避** | 問題が重大かつ長期化する前にその原因を発見し、インシデントを防止 |
| **従業員の離職率の低下** | 仕事の満足度が向上し、開発者の燃え尽き、アラート、オンコールでの疲労、そして離職が減少 |

### プロアクティブなアプローチ

変化を導入するためのプロアクティブなアプローチは、リアクティブな状況における症状を、異常であり予防可能であると認識することから始まります。

**最初のビジネス事例の2つの要素:**

1. **TTD（検出時間）の削減:** 従来のモニタリングツールでは発見できなかった個々のユーザーの問題を発見できるようになる
2. **TTR（解決時間）の削減:** コア分析ループを自動化することで、問題の原因を正しく切り分けるのに必要な時間を劇的に短縮

**二次的な利点:**

- 問題をより早く発見して解決できるようになると、予期せぬ障害対応の業務量が減る
- 問題のトリアージにかかる負担が軽減され、オンコールのストレスが低下する
- アプリケーションの課題に関するバックログを減らし、バグの解決に費やす時間を減らし、新機能の作成と提供により多くの時間を費やす
- 従業員の定着率と満足度を高める

**第三の利点:**

個々のユーザーリクエストのパフォーマンスとボトルネックの原因を理解できるということがあります。顧客満足度の向上と顧客維持が、オブザーバビリティのもうひとつの明白なビジネス事例です。

---

## ツール選定

### 計装

**OpenTelemetry推奨:**

- フレームワークとアプリケーションコードの両方を計装できる
- さまざまなオープンソースのメトリクスやトレース分析のプラットフォームをサポート
- この分野のほぼすべての商用ベンダーがサポート
- もはや特定のベンダーの計装フレームワークに縛られる理由はない

**3つの柱の落とし穴:**

オブザーバビリティをメトリクス、ロギング、トレースのようなカテゴリに単純化するのはやりすぎです。これらはオブザーバビリティに関するデータの便利なカテゴリではあるものの、オブザーバビリティを達成するためには、これらのデータタイプを適切なビューで相互作用させる必要があります。

### データの保持と分析

**商用ベンダー:**

通常、データの保持と分析をバンドルしています。各ベンダーは保持と分析について差別化した機能を備えており、オブザーバビリティの目標を達成するために、どの機能が最も有効かを検討する必要があります。

**オープンソースソリューション:**

通常、データの保持と分析に別々のアプローチが必要になります。オープンソースのフロントエンド（Grafana、Prometheus、Jaegerなど）とデータストレージ層（Cassandra、Elasticsearch、M3、InfluxDBなど）を組み合わせます。

**注意点:**

- オープンソースソフトウェアがどのようにライセンスされているか確認
- データ保持のクラスタを自前で運用する際の運用負荷について慎重に検討
- オブザーバビリティのデータ保持を検討する場合、それぞれのデータに対して別々のソリューションを用意するのは避ける
- シームレスに動作する、ひとつのまとまったソリューションの方が優れている

### チームでツールを使い始める

**重要な確認事項:**

ビジネスニーズの中核をなす差別化要因に貴重なエンジニアリングサイクルを投資しているかを確認することが重要です。

**自問すべき質問:**

- そのツールはより多くのイノベーションを提供できるよう能力を伸ばすのか、それとも、その能力を独自ソリューションの管理に費やすことになるのか
- ツールの選択により、管理のために大規模で独立したチームを作る必要が出てくるか
- オブザーバビリティのゴールは、エンジニアの組織内にオーダーメイドの仕事を作り出すことではなく、品質を向上させながら、ビジネスの時間とコストを削減すること

---

## ユーザー確認の原則（AskUserQuestion）

以下の状況では、AskUserQuestionツールを使用してユーザーに確認してください:

| 確認が必要な場合 | 質問例 |
|---------------|--------|
| **ツール選定** | 「オブザーバビリティツールの選定において、以下のどのアプローチを優先しますか？」 |
| **導入範囲** | 「オブザーバビリティをどのサービスから導入しますか？最大の問題点から始めますか？」 |
| **計装戦略** | 「計装のイテレーション戦略について、どのアプローチを採用しますか？」 |
| **リソース配分** | 「オブザーバビリティ導入のためにどの程度のリソース（時間・予算）を割り当てますか？」 |

