# PO Agent 戦略決定ガイド

このドキュメントでは、PO Agentの判断基準と戦略決定プロセスを詳細に説明します。

## 🎯 戦略決定の3つの柱

PO Agentは以下の3つの視点で戦略を決定します：

1. **Worktree管理判断** - 新規作業か既存作業か
2. **技術選定** - 最適な技術スタックの選択
3. **優先順位付け** - タスクの重要度と順序

---

## 1️⃣ Worktree管理判断

### 🚨 Step 1: Submoduleの有無を最初に確認（必須）

```bash
ls -la .gitmodules
git submodule status
```

### Step 2: Submoduleの有無に応じた判断

#### 【Submoduleがない場合】

通常のworktree作成フローに従います。

##### ✅ 新規worktree作成が必要なケース

| 状況 | 理由 | worktree名の例 |
|------|------|----------------|
| **既存の作業と独立した新機能** | 並行開発を可能にする | `wt-feat-user-auth` |
| **異なる実装方針のプロトタイプ** | 複数アプローチの比較検証 | `wt-exp-new-arch` |
| **緊急のバグ修正（hotfix）** | メイン開発を妨げない | `wt-hotfix-security` |
| **リリース準備作業** | 安定版の準備と本番環境調整 | `wt-release-v2.0.0` |

##### ❌ 既存worktree継続が適切なケース

| 状況 | 理由 | 対応 |
|------|------|------|
| **既存機能の拡張** | 同じコンテキストで作業 | 既存worktreeで継続 |
| **現在作業中の機能の改善** | 既存ブランチでのイテレーション | 既存worktreeで継続 |
| **関連するバグ修正** | 同じ機能領域の修正 | 既存worktreeで継続 |

#### 【Submoduleがある場合】→ 🚨変更対象を厳密に判断

**⚠️ 絶対ルール: submodule内のコードを変更する場合、親gitにworktreeを作成してはいけない**

##### 変更対象の判断

| 変更対象 | worktree作成場所 | worktreeパスの例 |
|---------|-----------------|-----------------|
| **親git自体のコード** | 親gitルート | `wt-feat-xxx`（親gitルート直下） |
| **Submodule内のコード** | 対象submodule内のみ | `submodule1/wt-feat-xxx`（🚫親gitには作らない） |

### 判断フローチャート

```
新しいタスク受信
    ↓
現在の作業と関連？
    ├─ Yes → 既存worktree継続
    │        └─ worktree名を把握してManagerに伝達
    │
    └─ No → 新規worktree必要
         ↓
         Step 1: Submoduleの有無を確認
         ├─ Submoduleなし → 通常フロー
         │   ↓
         │   プロジェクトルートにworktree作成
         │
         └─ Submoduleあり → 🚨変更対象を厳密に判断
             ↓
             「何を変更するか？」を明確化
             ├─ 親git自体のコード変更 → 親gitルートに作成
             │
             └─ Submodule内のコード変更
                 🚫 親gitにworktreeを作成してはいけない
                 ↓
                 対象submodule内にのみworktree作成
                 worktreeパス: submodule名/wt-xxx
         ↓
         ユーザーに確認
         ↓
         承認後に作成
```

### Worktree命名規則

#### カテゴリ別プレフィックス

| カテゴリ | プレフィックス | ブランチ | 例 |
|---------|---------------|---------|-----|
| **機能開発** | `wt-feat-` | `feature/` | `wt-feat-payment` |
| **バグ修正** | `wt-fix-` | `hotfix/` | `wt-fix-memory-leak` |
| **緊急修正** | `wt-hotfix-` | `hotfix/` | `wt-hotfix-security` |
| **実験的開発** | `wt-exp-` | `experimental/` | `wt-exp-new-arch` |
| **リリース準備** | `wt-release-` | `release/` | `wt-release-v2.0.0` |

#### 命名のベストプラクティス
- **短く明確**: 機能名を簡潔に表現
- **小文字とハイフン**: `wt-feat-user-auth`（`wt-feat-UserAuth`ではない）
- **意図が明確**: 名前から作業内容が分かる

---

## 2️⃣ 技術選定

### 選定の5つの軸

#### 1. 最新性（Up-to-date）
- 最新の技術トレンドとの整合性
- 将来的な技術サポートの継続性
- エコシステムの活性度

**確認方法**: kagi MCPで最新技術トレンドを調査
```python
# 最新のベストプラクティス確認
kagi MCPで "React 2024 best practices" を検索
```

#### 2. 安定性（Stability）
- 本番環境での実績
- バグの少なさ
- コミュニティの成熟度

**確認方法**: serena MCPで既存実装の安定性を分析

#### 3. 保守性（Maintainability）
- 長期的なメンテナンス容易性
- ドキュメントの充実度
- コードの可読性

**判断基準**:
- ✅ シンプルで理解しやすいAPI
- ✅ 豊富な公式ドキュメント
- ✅ アクティブなコミュニティサポート

#### 4. パフォーマンス（Performance）
- システム要件との適合性
- スケーラビリティ
- リソース効率

**考慮事項**:
- レスポンスタイム要件
- 同時接続数
- データ処理量

#### 5. チーム習熟度（Team Familiarity）
- 開発チームのスキルセット
- 学習曲線
- 既存知識の活用可能性

**判断基準**:
- チームが既に使用している技術を優先
- 学習コストを考慮
- 知識移転の容易性

### 技術選定の決定プロセス

```
技術候補のリストアップ
    ↓
5つの軸で評価
    ├─ 最新性: ⭐⭐⭐⭐⭐
    ├─ 安定性: ⭐⭐⭐⭐☆
    ├─ 保守性: ⭐⭐⭐⭐⭐
    ├─ パフォーマンス: ⭐⭐⭐⭐☆
    └─ チーム習熟度: ⭐⭐⭐☆☆
    ↓
総合評価（重み付け）
    ↓
最適な技術を選定
    ↓
実装方針に反映
```

### 技術選定の例

#### ケーススタディ: 認証システムの技術選定

| 技術候補 | 最新性 | 安定性 | 保守性 | パフォーマンス | 習熟度 | 総合 |
|---------|--------|--------|--------|---------------|--------|------|
| **NextAuth.js** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐☆ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐☆ | ⭐⭐⭐⭐☆ | **推奨** |
| **Passport.js** | ⭐⭐⭐☆☆ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐☆☆ | ⭐⭐⭐⭐☆ | ⭐⭐⭐⭐⭐ | 次点 |
| **Auth0** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐☆ | ⭐⭐⭐⭐⭐ | ⭐⭐☆☆☆ | 検討 |

**結論**: NextAuth.jsを選定
- Next.jsプロジェクトとの統合が優れている
- 最新のベストプラクティスに準拠
- チームの習熟度も高い

---

## 3️⃣ 優先順位付け

### 優先順位付けのフレームワーク

#### アイゼンハワーマトリクス

```
        重要度
         高
    │
    │  緊急度低    緊急度高
    │  重要度高    重要度高
    │  [計画]      [実行]
    │  優先度: 2   優先度: 1
────┼────────────────────
    │  緊急度低    緊急度高
    │  重要度低    重要度低
    │  [削除]      [委任]
    │  優先度: 4   優先度: 3
    │
   低
```

#### 優先度レベル

| レベル | 定義 | 対応 | 例 |
|--------|------|------|-----|
| **優先度1（緊急・重要）** | 今すぐ実施 | 即座に取り組む | セキュリティ脆弱性修正 |
| **優先度2（計画的）** | スケジュール | 計画的に実施 | 新機能開発 |
| **優先度3（委任）** | 効率化検討 | 簡略化または自動化 | 定型的な作業 |
| **優先度4（削除）** | 実施不要 | 削除または保留 | 価値の低いタスク |

### タスク優先順位の決定手順

#### ステップ1: タスクの分類
各タスクを以下の基準で評価：
- **緊急度**: 期限までの時間
- **重要度**: ビジネス価値とユーザーインパクト
- **依存関係**: 他のタスクとの関連性
- **リスク**: 実施しないことのリスク

#### ステップ2: スコアリング
各項目を1-5点で評価：
```
総合スコア = (緊急度 × 0.3) + (重要度 × 0.4) + (依存関係 × 0.2) + (リスク × 0.1)
```

#### ステップ3: 順序付け
総合スコアの高い順に並べ替え

### 優先順位付けの実例

#### プロジェクト: ECサイトリニューアル

```markdown
## 優先順位

### 優先度1: 最優先（緊急・重要）
1. セキュリティ脆弱性の修正（CVE対応）
2. 決済システムのバグ修正
3. パフォーマンス問題の解決（ページ読み込み5秒超）

### 優先度2: 計画的実施（重要だが緊急ではない）
1. 新しい決済方法の追加（Apple Pay対応）
2. ユーザーレビュー機能の実装
3. レコメンデーションエンジンの改善

### 優先度3: 効率化検討（緊急だが重要ではない）
1. 管理画面の使い勝手改善
2. ログ出力の最適化
3. デプロイプロセスの自動化

### 優先度4: 保留または削除（緊急でも重要でもない）
1. デザインの微調整
2. 古いブラウザ対応
3. 使用頻度の低い機能の拡張
```

---

## 🔄 戦略決定の統合

### 3つの柱を統合した意思決定

```
Worktree判断
    ↓
技術選定
    ↓
優先順位付け
    ↓
統合された戦略
    ├─ Worktree情報
    ├─ 技術スタック
    ├─ 実装順序
    └─ リソース配分
    ↓
Manager Agentへの指示
```

### 統合戦略の例

```markdown
## 統合戦略

### Worktree管理
- 新規worktree作成: `wt-feat-user-reviews`
- ブランチ: `feature/user-reviews`
- 理由: 既存の作業と独立した新機能

### 技術選定
- フレームワーク: Next.js 14（App Router）
- データベース: PostgreSQL + Prisma ORM
- UI: shadcn/ui
- 理由: チームの習熟度が高く、最新のベストプラクティスに準拠

### 優先順位
1. レビュー投稿機能（優先度1）
2. レビュー表示機能（優先度1）
3. レビュー管理機能（優先度2）
4. レビュー分析機能（優先度3）
```

---

## ⚡ 戦略決定の最適化

### sequentialthinking MCPの活用

複雑な戦略決定にはsequentialthinking MCPを使用：

```python
# 段階的思考プロセス
mcp__sequentialthinking__sequentialthinking({
    "thought": "ユーザーレビュー機能の実装戦略を検討",
    "thoughtNumber": 1,
    "totalThoughts": 7,
    "nextThoughtNeeded": True
})

# 思考の進化
# 1. 要件の明確化
# 2. 技術候補のリストアップ
# 3. 各技術の評価
# 4. リスクの洗い出し
# 5. 優先順位の決定
# 6. 実装計画の策定
# 7. 最終決定
```

### 情報収集の効率化

#### serena MCPでプロジェクト分析
```python
# 既存実装の確認
mcp__serena__find_symbol(
    name_path="Review",
    relative_path="src/models"
)

# 関連コードの調査
mcp__serena__search_for_pattern(
    substring_pattern="review|rating",
    relative_path="src"
)
```

#### kagi MCPで最新情報取得
```python
# 最新のベストプラクティス検索
kagi MCPで以下を検索:
- "Next.js 14 review system best practices"
- "PostgreSQL rating system schema design"
- "shadcn/ui rating component"
```

---

## 📝 戦略決定チェックリスト

### Worktree判断
- [ ] **Step 1: Submoduleの有無を確認した**
- [ ] 新規作業か既存作業かを判断した
- [ ] **【Submoduleがある場合】変更対象を厳密に判断した**
  - 親git自体のコード変更？ → 親gitルートに作成
  - Submodule内のコード変更？ → 対象submodule内にのみ作成（🚫親gitには作らない）
- [ ] 新規の場合、適切なworktree名とworktreeパスを決定した
- [ ] ユーザーに確認を取った（新規の場合）

### 技術選定
- [ ] 技術候補をリストアップした
- [ ] 5つの軸で評価した（最新性、安定性、保守性、パフォーマンス、習熟度）
- [ ] 最適な技術を選定した
- [ ] 選定理由を明確にした

### 優先順位付け
- [ ] タスクを分類した（緊急度・重要度）
- [ ] 優先度レベルを割り当てた
- [ ] 実装順序を決定した
- [ ] リソース配分を考慮した

---

## 🔗 関連ドキュメント

- [WORKFLOWS.md](WORKFLOWS.md) - 戦略決定を含む全体ワークフロー
- [TOOLS.md](TOOLS.md) - 戦略決定に使用するMCPツール
- [REFERENCE.md](REFERENCE.md) - 戦略決定の成果物フォーマット

---

**重要**: すべての戦略決定は、PO Agentが単独で行います。実装作業はDeveloper Agentに委ねます。
